"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getServerSideProps = getServerSideProps;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const react_native_1 = require("react-native");
const TextField_1 = __importDefault(require("@components/TextField"));
const picker_1 = require("@react-native-picker/picker");
const Text_1 = __importDefault(require("@components/common/Text"));
const RegularCard_1 = __importDefault(require("@components/RegularCard"));
const Button_1 = __importDefault(require("@components/Button"));
const theme_1 = require("@lib/theme/theme");
const supertokens_node_1 = __importDefault(require("supertokens-node"));
const backendConfig_1 = require("@config/backendConfig");
const session_1 = __importDefault(require("supertokens-node/recipe/session"));
async function getServerSideProps({ req, res }) {
    // Notice how the server uses `API` from `withSSRContext`, instead of the top-level `API`.
    // const SSR = withSSRContext({ req })
    // this runs on the backend, so we must call init on supertokens-node SDK
    supertokens_node_1.default.init((0, backendConfig_1.backendConfig)());
    let session;
    try {
        session = await session_1.default.getSession(req, res, {
            overrideGlobalClaimValidators: async function () {
                return [];
            },
        });
    }
    catch (err) {
        if (err.type === session_1.default.Error.TRY_REFRESH_TOKEN) {
            return { props: { fromSupertokens: 'needs-refresh' } };
        }
        else if (err.type === session_1.default.Error.UNAUTHORISED) {
            // this will force the frontend to try and refresh which will fail
            // clearing all cookies and redirecting the user to the login screen.
            return { props: { fromSupertokens: 'needs-refresh' } };
        }
        throw err;
    }
    if (!session?.getUserId()) {
        return {
            redirect: {
                destination: '/User/Login/UserLogin',
                permanent: false,
            },
        };
    }
    return {
        props: {
            sub: session.getUserId(),
        }
    };
}
function UserIntegrationItem(props) {
    const { index, token: oldToken, resource: oldResource, resourceId: oldResourceId, name: oldName, tableName: oldTableName, updateParentTokenValue, updateParentResourceValue, updateParentResourceIdValue, updateParentNameValue, updateParentTableNameValue, removeParentIntegration, } = props;
    const [token, setToken] = (0, react_1.useState)(oldToken || '');
    const [resource, setResource] = (0, react_1.useState)(oldResource || '');
    const [resourceId, setResourceId] = (0, react_1.useState)(oldResourceId || '');
    const [name, setName] = (0, react_1.useState)(oldName || '');
    const [tableName, setTableName] = (0, react_1.useState)(oldTableName);
    const dark = (0, react_native_1.useColorScheme)() === 'dark';
    const updateTokenValue = (value) => {
        setToken(value);
        updateParentTokenValue(index, value);
    };
    const updateResourceValue = (value) => {
        setResource(value);
        updateParentResourceValue(index, value);
    };
    const updateResourceIdValue = (value) => {
        setResourceId(value);
        updateParentResourceIdValue(index, value);
    };
    const updateNameValue = (value) => {
        setName(value);
        updateParentNameValue(index, value);
    };
    const updateTableNameValue = (value) => {
        setTableName(value);
        updateParentTableNameValue(index, value);
    };
    const removeIntegration = async () => {
        try {
            await removeParentIntegration(index);
        }
        catch (e) {
            console.log(e, ' unable to remove integration');
        }
    };
    return ((0, jsx_runtime_1.jsx)(react_native_1.TouchableWithoutFeedback, { style: { width: '100%' }, onPress: react_native_1.Keyboard.dismiss, children: (0, jsx_runtime_1.jsxs)(RegularCard_1.default, { justifyContent: "center", alignItems: "center", style: { width: '97%' }, children: [(0, jsx_runtime_1.jsx)(Text_1.default, { variant: "optionHeader", p: { phone: 's', tablet: 'm' }, children: name }), (0, jsx_runtime_1.jsx)(TextField_1.default, { onChange: (e) => updateNameValue(e?.target?.value), value: name, placeholder: "Notion", label: "Name", style: { width: '80%' }, hint: "Type name of connected app here - required" }), (0, jsx_runtime_1.jsx)(TextField_1.default, { onChange: (e) => updateTokenValue(e?.target?.value), value: token, placeholder: "abc123", label: "Token", style: { width: '80%' }, hint: "Copy and Paste token here - optional" }), (0, jsx_runtime_1.jsx)(TextField_1.default, { onChange: (e) => updateResourceValue(e?.target?.value), value: resource, placeholder: "database", label: "Resource", style: { width: '80%' }, hint: "Name of resource that is part of the connected app - optional" }), (0, jsx_runtime_1.jsx)(TextField_1.default, { onChange: (e) => updateResourceIdValue(e?.target?.value), value: resourceId, placeholder: "abc123", label: "Resource Id", style: { width: '80%' }, hint: "Resource Id that is part of the connected app - optional" }), (0, jsx_runtime_1.jsxs)(picker_1.Picker, { selectedValue: tableName, onValueChange: updateTableNameValue, style: { width: '80%', color: dark ? theme_1.palette.white : theme_1.palette.textBlack }, children: [(0, jsx_runtime_1.jsx)(picker_1.Picker.Item, { color: dark ? theme_1.palette.white : theme_1.palette.textBlack, value: "Daily", label: "Daily" }, "Daily"), (0, jsx_runtime_1.jsx)(picker_1.Picker.Item, { color: dark ? theme_1.palette.white : theme_1.palette.textBlack, value: "Weekly", label: "Weekly" }, "Weekly"), (0, jsx_runtime_1.jsx)(picker_1.Picker.Item, { color: dark ? theme_1.palette.white : theme_1.palette.textBlack, value: "Master", label: "Master" }, "Master"), (0, jsx_runtime_1.jsx)(picker_1.Picker.Item, { color: dark ? theme_1.palette.white : theme_1.palette.textBlack, value: "Grocery", label: "Grocery" }, "Grocery")] }), (0, jsx_runtime_1.jsx)(Button_1.default, { onClick: () => removeIntegration(), children: "Remove" })] }) }));
}
exports.default = UserIntegrationItem;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXNlckludGVncmF0aW9uSXRlbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlVzZXJJbnRlZ3JhdGlvbkl0ZW0udHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBbUJBLGdEQXFDQzs7QUF4REQsaUNBQXVDO0FBQ3ZDLCtDQUlzQjtBQUV0QixzRUFBNkM7QUFDN0Msd0RBQWtEO0FBQ2xELG1FQUEwQztBQUMxQywwRUFBaUQ7QUFDakQsZ0VBQXVDO0FBRXZDLDRDQUEwQztBQUUxQyx3RUFBOEM7QUFDOUMseURBQXFEO0FBQ3JELDhFQUFxRDtBQUU5QyxLQUFLLFVBQVUsa0JBQWtCLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFpRDtJQUNoRywwRkFBMEY7SUFDMUYsc0NBQXNDO0lBQ3RDLHlFQUF5RTtJQUN6RSwwQkFBZSxDQUFDLElBQUksQ0FBQyxJQUFBLDZCQUFhLEdBQUUsQ0FBQyxDQUFBO0lBQ3JDLElBQUksT0FBTyxDQUFBO0lBQ1gsSUFBSSxDQUFDO1FBQ0QsT0FBTyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRTtZQUN6Qyw2QkFBNkIsRUFBRSxLQUFLO2dCQUNoQyxPQUFPLEVBQUUsQ0FBQTtZQUNiLENBQUM7U0FDSixDQUFDLENBQUE7SUFDTixDQUFDO0lBQUMsT0FBTyxHQUFRLEVBQUUsQ0FBQztRQUNoQixJQUFJLEdBQUcsQ0FBQyxJQUFJLEtBQUssaUJBQU8sQ0FBQyxLQUFLLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztZQUMvQyxPQUFPLEVBQUUsS0FBSyxFQUFFLEVBQUUsZUFBZSxFQUFFLGVBQWUsRUFBRSxFQUFFLENBQUE7UUFDMUQsQ0FBQzthQUFNLElBQUksR0FBRyxDQUFDLElBQUksS0FBSyxpQkFBTyxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUNqRCxrRUFBa0U7WUFDbEUscUVBQXFFO1lBQ3JFLE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBRSxlQUFl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LEVBQzVHLHVCQUFDLGVBQU0sQ0FBQyxJQUFJLElBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsZUFBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsZUFBTyxDQUFDLFNBQVMsRUFBZ0IsS0FBSyxFQUFDLFFBQVEsRUFBQyxLQUFLLEVBQUMsUUFBUSxJQUF0QyxRQUFRLENBQWlDLEVBQzVHLHVCQUFDLGVBQU0sQ0FBQyxJQUFJLElBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsZUFBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsZUFBTyxDQUFDLFNBQVMsRUFBaUIsS0FBSyxFQUFDLFNBQVMsRUFBQyxLQUFLLEVBQUMsU0FBUyxJQUF6QyxTQUFTLENBQW1DLElBQzFHLEVBQ1QsdUJBQUMsZ0JBQU0sSUFBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsaUJBQWlCLEVBQUUsdUJBRWpDLElBQ0csR0FDVyxDQUM1QixDQUFBO0FBRUgsQ0FBQztBQUNELGtCQUFlLG1CQUFtQixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IHVzZVN0YXRlIH0gZnJvbSAncmVhY3QnXG5pbXBvcnQge1xuICB1c2VDb2xvclNjaGVtZSxcbiAgS2V5Ym9hcmQsXG4gIFRvdWNoYWJsZVdpdGhvdXRGZWVkYmFjayxcbiB9IGZyb20gJ3JlYWN0LW5hdGl2ZSdcblxuaW1wb3J0IFRleHRGaWVsZCBmcm9tICdAY29tcG9uZW50cy9UZXh0RmllbGQnXG5pbXBvcnQge1BpY2tlcn0gZnJvbSAnQHJlYWN0LW5hdGl2ZS1waWNrZXIvcGlja2VyJ1xuaW1wb3J0IFRleHQgZnJvbSAnQGNvbXBvbmVudHMvY29tbW9uL1RleHQnXG5pbXBvcnQgUmVndWxhckNhcmQgZnJvbSAnQGNvbXBvbmVudHMvUmVndWxhckNhcmQnXG5pbXBvcnQgQnV0dG9uIGZyb20gJ0Bjb21wb25lbnRzL0J1dHRvbidcblxuaW1wb3J0IHsgcGFsZXR0ZSB9IGZyb20gJ0BsaWIvdGhlbWUvdGhlbWUnXG5pbXBvcnQgeyBOZXh0QXBpUmVxdWVzdCwgTmV4dEFwaVJlc3BvbnNlIH0gZnJvbSAnbmV4dCc7XG5pbXBvcnQgc3VwZXJ0b2tlbnNOb2RlIGZyb20gJ3N1cGVydG9rZW5zLW5vZGUnXG5pbXBvcnQgeyBiYWNrZW5kQ29uZmlnIH0gZnJvbSAnQGNvbmZpZy9iYWNrZW5kQ29uZmlnJ1xuaW1wb3J0IFNlc3Npb24gZnJvbSAnc3VwZXJ0b2tlbnMtbm9kZS9yZWNpcGUvc2Vzc2lvbidcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNlcnZlclNpZGVQcm9wcyh7IHJlcSwgcmVzIH06IHsgcmVxOiBOZXh0QXBpUmVxdWVzdCwgcmVzOiBOZXh0QXBpUmVzcG9uc2UgfSkge1xuICAgIC8vIE5vdGljZSBob3cgdGhlIHNlcnZlciB1c2VzIGBBUElgIGZyb20gYHdpdGhTU1JDb250ZXh0YCwgaW5zdGVhZCBvZiB0aGUgdG9wLWxldmVsIGBBUElgLlxuICAgIC8vIGNvbnN0IFNTUiA9IHdpdGhTU1JDb250ZXh0KHsgcmVxIH0pXG4gICAgLy8gdGhpcyBydW5zIG9uIHRoZSBiYWNrZW5kLCBzbyB3ZSBtdXN0IGNhbGwgaW5pdCBvbiBzdXBlcnRva2Vucy1ub2RlIFNES1xuICAgIHN1cGVydG9rZW5zTm9kZS5pbml0KGJhY2tlbmRDb25maWcoKSlcbiAgICBsZXQgc2Vzc2lvblxuICAgIHRyeSB7XG4gICAgICAgIHNlc3Npb24gPSBhd2FpdCBTZXNzaW9uLmdldFNlc3Npb24ocmVxLCByZXMsIHtcbiAgICAgICAgICAgIG92ZXJyaWRlR2xvYmFsQ2xhaW1WYWxpZGF0b3JzOiBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFtdXG4gICAgICAgICAgICB9LFxuICAgICAgICB9KVxuICAgIH0gY2F0Y2ggKGVycjogYW55KSB7XG4gICAgICAgIGlmIChlcnIudHlwZSA9PT0gU2Vzc2lvbi5FcnJvci5UUllfUkVGUkVTSF9UT0tFTikge1xuICAgICAgICAgICAgcmV0dXJuIHsgcHJvcHM6IHsgZnJvbVN1cGVydG9rZW5zOiAnbmVlZHMtcmVmcmVzaCcgfSB9XG4gICAgICAgIH0gZWxzZSBpZiAoZXJyLnR5cGUgPT09IFNlc3Npb24uRXJyb3IuVU5BVVRIT1JJU0VEKSB7XG4gICAgICAgICAgICAvLyB0aGlzIHdpbGwgZm9yY2UgdGhlIGZyb250ZW5kIHRvIHRyeSBhbmQgcmVmcmVzaCB3aGljaCB3aWxsIGZhaWxcbiAgICAgICAgICAgIC8vIGNsZWFyaW5nIGFsbCBjb29raWVzIGFuZCByZWRpcmVjdGluZyB0aGUgdXNlciB0byB0aGUgbG9naW4gc2NyZWVuLlxuICAgICAgICAgICAgcmV0dXJuIHsgcHJvcHM6IHsgZnJvbVN1cGVydG9rZW5zOiAnbmVlZHMtcmVmcmVzaCcgfSB9XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgZXJyXG4gICAgfVxuXG4gICAgaWYgKCFzZXNzaW9uPy5nZXRVc2VySWQoKSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgcmVkaXJlY3Q6IHtcbiAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbjogJy9Vc2VyL0xvZ2luL1VzZXJMb2dpbicsXG4gICAgICAgICAgICAgICAgcGVybWFuZW50OiBmYWxzZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBwcm9wczoge1xuICAgICAgICBzdWI6IHNlc3Npb24uZ2V0VXNlcklkKCksXG4gICAgICAgIH1cbiAgICB9XG59XG5cbnR5cGUgUHJvcHMgPSB7XG4gIGluZGV4OiBudW1iZXIsXG4gIHRva2VuPzogc3RyaW5nLFxuICByZXNvdXJjZT86IHN0cmluZyxcbiAgcmVzb3VyY2VJZD86IHN0cmluZyxcbiAgbmFtZT86IHN0cmluZyxcbiAgdGFibGVOYW1lPzogc3RyaW5nLFxuICB1cGRhdGVQYXJlbnRUb2tlblZhbHVlOiAoaW5kZXg6IG51bWJlciwgdmFsdWU6IHN0cmluZykgPT4gdm9pZCxcbiAgdXBkYXRlUGFyZW50UmVzb3VyY2VWYWx1ZTogKGluZGV4OiBudW1iZXIsIHZhbHVlOiBzdHJpbmcpID0+IHZvaWQsXG4gIHVwZGF0ZVBhcmVudFJlc291cmNlSWRWYWx1ZTogKGluZGV4OiBudW1iZXIsIHZhbHVlOiBzdHJpbmcpID0+IHZvaWQsXG4gIHVwZGF0ZVBhcmVudE5hbWVWYWx1ZTogKGluZGV4OiBudW1iZXIsIHZhbHVlOiBzdHJpbmcpID0+IHZvaWQsXG4gIHVwZGF0ZVBhcmVudFRhYmxlTmFtZVZhbHVlOiAoaW5kZXg6IG51bWJlciwgdmFsdWU6IHN0cmluZykgPT4gdm9pZCxcbiAgcmVtb3ZlUGFyZW50SW50ZWdyYXRpb246IChpbmRleDogbnVtYmVyKSA9PiBQcm9taXNlPHZvaWQ+LFxufVxuXG5mdW5jdGlvbiBVc2VySW50ZWdyYXRpb25JdGVtKHByb3BzOiBQcm9wcykge1xuXG4gIGNvbnN0IHtcbiAgICBpbmRleCxcbiAgICB0b2tlbjogb2xkVG9rZW4sXG4gICAgcmVzb3VyY2U6IG9sZFJlc291cmNlLFxuICAgIHJlc291cmNlSWQ6IG9sZFJlc291cmNlSWQsXG4gICAgbmFtZTogb2xkTmFtZSxcbiAgICB0YWJsZU5hbWU6IG9sZFRhYmxlTmFtZSxcbiAgICB1cGRhdGVQYXJlbnRUb2tlblZhbHVlLFxuICAgIHVwZGF0ZVBhcmVudFJlc291cmNlVmFsdWUsXG4gICAgdXBkYXRlUGFyZW50UmVzb3VyY2VJZFZhbHVlLFxuICAgIHVwZGF0ZVBhcmVudE5hbWVWYWx1ZSxcbiAgICB1cGRhdGVQYXJlbnRUYWJsZU5hbWVWYWx1ZSxcbiAgICByZW1vdmVQYXJlbnRJbnRlZ3JhdGlvbixcbiAgfSA9IHByb3BzXG5cbiAgY29uc3QgW3Rva2VuLCBzZXRUb2tlbl0gPSB1c2VTdGF0ZTxzdHJpbmc+KG9sZFRva2VuIHx8ICcnKVxuICBjb25zdCBbcmVzb3VyY2UsIHNldFJlc291cmNlXSA9IHVzZVN0YXRlPHN0cmluZz4ob2xkUmVzb3VyY2UgfHwgJycpXG4gIGNvbnN0IFtyZXNvdXJjZUlkLCBzZXRSZXNvdXJjZUlkXSA9IHVzZVN0YXRlPHN0cmluZz4ob2xkUmVzb3VyY2VJZCB8fCAnJylcbiAgY29uc3QgW25hbWUsIHNldE5hbWVdID0gdXNlU3RhdGU8c3RyaW5nPihvbGROYW1lIHx8ICcnKVxuICBjb25zdCBbdGFibGVOYW1lLCBzZXRUYWJsZU5hbWVdID0gdXNlU3RhdGU8c3RyaW5nPihvbGRUYWJsZU5hbWUpXG5cblxuICBjb25zdCBkYXJrID0gdXNlQ29sb3JTY2hlbWUoKSA9PT0gJ2RhcmsnXG5cbiAgY29uc3QgdXBkYXRlVG9rZW5WYWx1ZSA9ICh2YWx1ZTogc3RyaW5nKSA9PiB7XG4gICAgc2V0VG9rZW4odmFsdWUpXG4gICAgdXBkYXRlUGFyZW50VG9rZW5WYWx1ZShpbmRleCwgdmFsdWUpXG4gIH1cblxuICBjb25zdCB1cGRhdGVSZXNvdXJjZVZhbHVlID0gKHZhbHVlOiBzdHJpbmcpID0+IHtcbiAgICBzZXRSZXNvdXJjZSh2YWx1ZSlcbiAgICB1cGRhdGVQYXJlbnRSZXNvdXJjZVZhbHVlKGluZGV4LCB2YWx1ZSlcbiAgfVxuXG4gIGNvbnN0IHVwZGF0ZVJlc291cmNlSWRWYWx1ZSA9ICh2YWx1ZTogc3RyaW5nKSA9PiB7XG4gICAgc2V0UmVzb3VyY2VJZCh2YWx1ZSlcbiAgICB1cGRhdGVQYXJlbnRSZXNvdXJjZUlkVmFsdWUoaW5kZXgsIHZhbHVlKVxuICB9XG5cbiAgY29uc3QgdXBkYXRlTmFtZVZhbHVlID0gKHZhbHVlOiBzdHJpbmcpID0+IHtcbiAgICBzZXROYW1lKHZhbHVlKVxuICAgIHVwZGF0ZVBhcmVudE5hbWVWYWx1ZShpbmRleCwgdmFsdWUpXG4gIH1cblxuICBjb25zdCB1cGRhdGVUYWJsZU5hbWVWYWx1ZSA9ICh2YWx1ZTogc3RyaW5nKSA9PiB7XG4gICAgc2V0VGFibGVOYW1lKHZhbHVlKVxuICAgIHVwZGF0ZVBhcmVudFRhYmxlTmFtZVZhbHVlKGluZGV4LCB2YWx1ZSlcbiAgfVxuXG4gIGNvbnN0IHJlbW92ZUludGVncmF0aW9uID0gYXN5bmMgKCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCByZW1vdmVQYXJlbnRJbnRlZ3JhdGlvbihpbmRleClcbiAgICB9IGNhdGNoKGUpIHtcbiAgICAgIGNvbnNvbGUubG9nKGUsICcgdW5hYmxlIHRvIHJlbW92ZSBpbnRlZ3JhdGlvbicpXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIChcbiAgICA8VG91Y2hhYmxlV2l0aG91dEZlZWRiYWNrIHN0eWxlPXt7IHdpZHRoOiAnMTAwJScgfX0gb25QcmVzcz17S2V5Ym9hcmQuZGlzbWlzc30+XG4gICAgICA8UmVndWxhckNhcmQganVzdGlmeUNvbnRlbnQ9XCJjZW50ZXJcIiBhbGlnbkl0ZW1zPVwiY2VudGVyXCIgc3R5bGU9e3sgd2lkdGg6ICc5NyUnIH19PlxuICAgICAgICA8VGV4dCB2YXJpYW50PVwib3B0aW9uSGVhZGVyXCIgcD17eyBwaG9uZTogJ3MnLCB0YWJsZXQ6ICdtJyB9fT5cbiAgICAgICAgICB7bmFtZX1cbiAgICAgICAgPC9UZXh0PlxuICAgICAgICAgIDxUZXh0RmllbGRcbiAgICAgICAgICAgIG9uQ2hhbmdlPXsoZTogeyB0YXJnZXQ6IHsgdmFsdWU6IHN0cmluZyB9IH0pID0+IHVwZGF0ZU5hbWVWYWx1ZShlPy50YXJnZXQ/LnZhbHVlKX1cbiAgICAgICAgICAgIHZhbHVlPXtuYW1lfVxuICAgICAgICAgICAgcGxhY2Vob2xkZXI9XCJOb3Rpb25cIlxuICAgICAgICAgICAgbGFiZWw9XCJOYW1lXCJcbiAgICAgICAgICAgIHN0eWxlPXt7IHdpZHRoOiAnODAlJyB9fVxuICAgICAgICAgICAgaGludD1cIlR5cGUgbmFtZSBvZiBjb25uZWN0ZWQgYXBwIGhlcmUgLSByZXF1aXJlZFwiXG4gICAgICAgICAgLz5cbiAgICAgICAgICA8VGV4dEZpZWxkXG4gICAgICAgICAgICBvbkNoYW5nZT17KGU6IHsgdGFyZ2V0OiB7IHZhbHVlOiBzdHJpbmcgfSB9KSA9PiB1cGRhdGVUb2tlblZhbHVlKGU/LnRhcmdldD8udmFsdWUpfVxuICAgICAgICAgICAgdmFsdWU9e3Rva2VufVxuICAgICAgICAgICAgcGxhY2Vob2xkZXI9XCJhYmMxMjNcIlxuICAgICAgICAgICAgbGFiZWw9XCJUb2tlblwiXG4gICAgICAgICAgICBzdHlsZT17eyB3aWR0aDogJzgwJScgfX1cbiAgICAgICAgICAgIGhpbnQ9XCJDb3B5IGFuZCBQYXN0ZSB0b2tlbiBoZXJlIC0gb3B0aW9uYWxcIlxuICAgICAgICAgIC8+XG4gICAgICAgICAgPFRleHRGaWVsZFxuICAgICAgICAgICAgb25DaGFuZ2U9eyhlOiB7IHRhcmdldDogeyB2YWx1ZTogc3RyaW5nIH0gfSkgPT4gdXBkYXRlUmVzb3VyY2VWYWx1ZShlPy50YXJnZXQ/LnZhbHVlKX1cbiAgICAgICAgICAgIHZhbHVlPXtyZXNvdXJjZX1cbiAgICAgICAgICAgIHBsYWNlaG9sZGVyPVwiZGF0YWJhc2VcIlxuICAgICAgICAgICAgbGFiZWw9XCJSZXNvdXJjZVwiXG4gICAgICAgICAgICBzdHlsZT17eyB3aWR0aDogJzgwJScgfX1cbiAgICAgICAgICAgIGhpbnQ9XCJOYW1lIG9mIHJlc291cmNlIHRoYXQgaXMgcGFydCBvZiB0aGUgY29ubmVjdGVkIGFwcCAtIG9wdGlvbmFsXCJcbiAgICAgICAgICAvPlxuICAgICAgICAgIDxUZXh0RmllbGRcbiAgICAgICAgICAgIG9uQ2hhbmdlPXsoZTogeyB0YXJnZXQ6IHsgdmFsdWU6IHN0cmluZyB9IH0pID0+IHVwZGF0ZVJlc291cmNlSWRWYWx1ZShlPy50YXJnZXQ/LnZhbHVlKX1cbiAgICAgICAgICAgIHZhbHVlPXtyZXNvdXJjZUlkfVxuICAgICAgICAgICAgcGxhY2Vob2xkZXI9XCJhYmMxMjNcIlxuICAgICAgICAgICAgbGFiZWw9XCJSZXNvdXJjZSBJZFwiXG4gICAgICAgICAgICBzdHlsZT17eyB3aWR0aDogJzgwJScgfX1cbiAgICAgICAgICAgIGhpbnQ9XCJSZXNvdXJjZSBJZCB0aGF0IGlzIHBhcnQgb2YgdGhlIGNvbm5lY3RlZCBhcHAgLSBvcHRpb25hbFwiXG4gICAgICAgICAgLz5cbiAgICAgICAgPFBpY2tlclxuICAgICAgICAgIHNlbGVjdGVkVmFsdWU9e3RhYmxlTmFtZX1cbiAgICAgICAgICBvblZhbHVlQ2hhbmdlPXt1cGRhdGVUYWJsZU5hbWVWYWx1ZX1cbiAgICAgICAgICBzdHlsZT17eyB3aWR0aDogJzgwJScsIGNvbG9yOiBkYXJrID8gcGFsZXR0ZS53aGl0ZSA6IHBhbGV0dGUudGV4dEJsYWNrfX1cbiAgICAgICAgPlxuICAgICAgICAgICAgPFBpY2tlci5JdGVtIGNvbG9yPXtkYXJrID8gcGFsZXR0ZS53aGl0ZSA6IHBhbGV0dGUudGV4dEJsYWNrfSAga2V5PVwiRGFpbHlcIiB2YWx1ZT1cIkRhaWx5XCIgbGFiZWw9XCJEYWlseVwiIC8+XG4gICAgICAgICAgICA8UGlja2VyLkl0ZW0gY29sb3I9e2RhcmsgPyBwYWxldHRlLndoaXRlIDogcGFsZXR0ZS50ZXh0QmxhY2t9ICBrZXk9XCJXZWVrbHlcIiB2YWx1ZT1cIldlZWtseVwiIGxhYmVsPVwiV2Vla2x5XCIgLz5cbiAgICAgICAgICAgIDxQaWNrZXIuSXRlbSBjb2xvcj17ZGFyayA/IHBhbGV0dGUud2hpdGUgOiBwYWxldHRlLnRleHRCbGFja30gIGtleT1cIk1hc3RlclwiIHZhbHVlPVwiTWFzdGVyXCIgbGFiZWw9XCJNYXN0ZXJcIiAvPlxuICAgICAgICAgICAgPFBpY2tlci5JdGVtIGNvbG9yPXtkYXJrID8gcGFsZXR0ZS53aGl0ZSA6IHBhbGV0dGUudGV4dEJsYWNrfSAga2V5PVwiR3JvY2VyeVwiIHZhbHVlPVwiR3JvY2VyeVwiIGxhYmVsPVwiR3JvY2VyeVwiIC8+XG4gICAgICAgIDwvUGlja2VyPlxuICAgICAgICA8QnV0dG9uIG9uQ2xpY2s9eygpID0+IHJlbW92ZUludGVncmF0aW9uKCl9PlxuICAgICAgICAgIFJlbW92ZVxuICAgICAgICA8L0J1dHRvbj5cbiAgICAgIDwvUmVndWxhckNhcmQ+XG4gICAgPC9Ub3VjaGFibGVXaXRob3V0RmVlZGJhY2s+XG4gIClcblxufVxuZXhwb3J0IGRlZmF1bHQgVXNlckludGVncmF0aW9uSXRlbVxuIl19