"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getServerSideProps = getServerSideProps;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const react_native_1 = require("react-native");
const io_1 = require("react-icons/io");
const md_1 = require("react-icons/md");
const react_2 = require("@chakra-ui/react");
const Box_1 = __importDefault(require("@components/common/Box"));
const Text_1 = __importDefault(require("@components/common/Text"));
const Button_1 = __importDefault(require("@components/Button"));
const CategoryHelper_1 = require("@lib/Category/CategoryHelper");
const theme_1 = require("@lib/theme/theme");
const TextField_1 = __importDefault(require("@components/TextField"));
const user_context_1 = require("@lib/user-context");
const router_1 = require("next/router");
const supertokens_node_1 = __importDefault(require("supertokens-node"));
const backendConfig_1 = require("@config/backendConfig");
const session_1 = __importDefault(require("supertokens-node/recipe/session"));
async function getServerSideProps({ req, res }) {
    // Notice how the server uses `API` from `withSSRContext`, instead of the top-level `API`.
    // const SSR = withSSRContext({ req })
    // this runs on the backend, so we must call init on supertokens-node SDK
    supertokens_node_1.default.init((0, backendConfig_1.backendConfig)());
    let session;
    try {
        session = await session_1.default.getSession(req, res, {
            overrideGlobalClaimValidators: async function () {
                return [];
            },
        });
    }
    catch (err) {
        if (err.type === session_1.default.Error.TRY_REFRESH_TOKEN) {
            return { props: { fromSupertokens: 'needs-refresh' } };
        }
        else if (err.type === session_1.default.Error.UNAUTHORISED) {
            // this will force the frontend to try and refresh which will fail
            // clearing all cookies and redirecting the user to the login screen.
            return { props: { fromSupertokens: 'needs-refresh' } };
        }
        throw err;
    }
    if (!session?.getUserId()) {
        return {
            redirect: {
                destination: '/User/Login/UserLogin',
                permanent: false,
            },
        };
    }
    return {
        props: {
            sub: session.getUserId(),
        }
    };
}
function UserEditCategories() {
    const [categories, setCategories] = (0, react_1.useState)([]);
    const [name, setName] = (0, react_1.useState)('');
    const router = (0, router_1.useRouter)();
    const { sub, client } = (0, user_context_1.useAppContext)();
    const userId = sub;
    const isUpdate = router.query?.isUpdate;
    const toast = (0, react_2.useToast)();
    // get categories
    (0, react_1.useEffect)(() => {
        (async () => {
            try {
                const existingCategories = await (0, CategoryHelper_1.listUserCategories)(client, userId);
                if (existingCategories.length === 0) {
                    toast({
                        status: 'warning',
                        title: 'No tags found',
                        description: 'Please add a tag',
                        duration: 9000,
                        isClosable: true,
                    });
                }
                setCategories(existingCategories);
            }
            catch (e) {
                console.log(e, 'error in useEffect for UserEditCategories');
            }
        })();
    }, [client, isUpdate, userId, toast]);
    // add new category to categories
    const addCategory = async () => {
        try {
            // validate
            if (name.length === 0) {
                return;
            }
            const newCategory = await (0, CategoryHelper_1.addCategoryToUser)(client, userId, name);
            setCategories([...categories, newCategory]);
            setName('');
        }
        catch (error) {
            console.log(error);
        }
    };
    // remove category from categories
    const removeCategoryForUser = async (categoryId) => {
        try {
            setCategories(categories.filter(category => category.id !== categoryId));
            await (0, CategoryHelper_1.removeCategory)(client, categoryId);
            await (0, CategoryHelper_1.removeEventConnectionsForCategory)(client, categoryId);
        }
        catch (error) {
            console.log(error);
        }
    };
    const onPress = (categoryId, name) => {
        console.log(categoryId, name, ' categoryId, name, inside onPress');
        if (!categoryId) {
            return;
        }
        if (!name) {
            return;
        }
        router.push({ pathname: '/Settings/UserEditCategory', query: {
                categoryId,
                name,
            } });
    };
    return ((0, jsx_runtime_1.jsxs)(Box_1.default, { justifyContent: "center", alignItems: "center", width: "100%", children: [(0, jsx_runtime_1.jsx)(Box_1.default, { justifyContent: "center", alignItems: "center", minHeight: "60vh", width: "80%", children: (0, jsx_runtime_1.jsx)(react_native_1.FlatList, { data: categories, renderItem: ({ item, index }) => ((0, jsx_runtime_1.jsx)(Box_1.default, { pt: { phone: 's', tablet: 'm' }, justifyContent: "center", alignItems: "center", width: "100%", children: (0, jsx_runtime_1.jsxs)(Box_1.default, { flexDirection: "row", justifyContent: "space-between", alignItems: "center", width: "100%", children: [(0, jsx_runtime_1.jsx)(Box_1.default, { justifyContent: "center", alignItems: "flex-start", mr: { phone: 's', tablet: 'm' }, children: (0, jsx_runtime_1.jsx)(Text_1.default, { variant: "optionHeader", children: item.name }) }), (0, jsx_runtime_1.jsxs)(Box_1.default, { flexDirection: "row", justifyContent: "space-between", alignItems: "center", children: [(0, jsx_runtime_1.jsx)(react_native_1.Pressable, { hitSlop: 15, onPress: () => onPress(item?.id, item?.name), children: (0, jsx_runtime_1.jsx)(md_1.MdPlaylistAdd, { size: "3em", color: theme_1.palette.purplePrimary }) }), (0, jsx_runtime_1.jsx)(react_native_1.Pressable, { hitSlop: 15, onPress: () => removeCategoryForUser(categories?.[index]?.id), children: (0, jsx_runtime_1.jsx)(io_1.IoIosClose, { size: "3em", color: theme_1.palette.red }) })] })] }) })), keyExtractor: (item) => item.id }) }), (0, jsx_runtime_1.jsx)(Box_1.default, { children: (0, jsx_runtime_1.jsx)(Box_1.default, { pt: { phone: 'xs', tablet: 's' }, children: (0, jsx_runtime_1.jsx)(TextField_1.default, { onChange: (e) => setName(e?.target?.value), value: name, placeholder: "Get together", label: "Tag" }) }) }), (0, jsx_runtime_1.jsx)(Box_1.default, { pt: { phone: 'xs', tablet: 's' }, justifyContent: "center", alignItems: "center", children: (0, jsx_runtime_1.jsx)(Button_1.default, { onClick: addCategory, children: "Add New Tag" }) })] }));
}
exports.default = UserEditCategories;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXNlckVkaXRDYXRlZ29yaWVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiVXNlckVkaXRDYXRlZ29yaWVzLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQWdDQSxnREFxQ0M7O0FBckVELGlDQUdjO0FBQ2QsK0NBR3FCO0FBQ3JCLHVDQUEyQztBQUMzQyx1Q0FBK0M7QUFDL0MsNENBQTJDO0FBQzNDLGlFQUF3QztBQUN4QyxtRUFBMEM7QUFDMUMsZ0VBQXVDO0FBR3ZDLGlFQUtxQztBQUVyQyw0Q0FBMEM7QUFDMUMsc0VBQTZDO0FBQzdDLG9EQUFpRDtBQUNqRCx3Q0FBdUM7QUFFdkMsd0VBQThDO0FBQzlDLHlEQUFxRDtBQUNyRCw4RUFBcUQ7QUFFOUMsS0FBSyxVQUFVLGtCQUFrQixDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBaUQ7SUFDaEcsMEZBQTBGO0lBQzFGLHNDQUFzQztJQUN0Qyx5RUFBeUU7SUFDekUsMEJBQWUsQ0FBQyxJQUFJLENBQUMsSUFBQSw2QkFBYSxHQUFFLENBQUMsQ0FBQTtJQUNyQyxJQUFJLE9BQU8sQ0FBQTtJQUNYLElBQUksQ0FBQztRQUNELE9BQU8sR0FBRyxNQUFNLGlCQUFPLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUU7WUFDekMsNkJBQTZCLEVBQUUsS0FBSztnQkFDaEMsT0FBTyxFQUFFLENBQUE7WUFDYixDQUFDO1NBQ0osQ0FBQyxDQUFBO0lBQ04sQ0FBQztJQUFDLE9BQU8sR0FBUSxFQUFFLENBQUM7UUFDaEIsSUFBSSxHQUFHLENBQUMsSUFBSSxLQUFLLGlCQUFPLENBQUMsS0FBSyxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFDL0MsT0FBTyxFQUFFLEtBQUssRUFBRSxFQUFFLGVBQWUsRUFBRSxlQUFlLEVBQUUsRUFBRSxDQUFBO1FBQzFELENBQUM7YUFBTSxJQUFJLEdBQUcsQ0FBQyxJQUFJLEtBQUssaUJBQU8sQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUM7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ZUFBTyxDQUFDLEdBQUcsR0FBSSxHQUNyQyxJQUNWLElBQ0osR0FDSixDQUNULEVBQ0QsWUFBWSxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUNqQyxHQUNBLEVBQ04sdUJBQUMsYUFBRyxjQUNBLHVCQUFDLGFBQUcsSUFBQyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsWUFFN0IsdUJBQUMsbUJBQVMsSUFDTixRQUFRLEVBQUUsQ0FBQyxDQUFnQyxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxLQUFLLENBQUMsRUFDekUsS0FBSyxFQUFFLElBQUksRUFDWCxXQUFXLEVBQUMsY0FBYyxFQUMxQixLQUFLLEVBQUMsS0FBSyxHQUViLEdBRUosR0FDSixFQUNOLHVCQUFDLGFBQUcsSUFBRSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsRUFBRSxjQUFjLEVBQUMsUUFBUSxFQUFDLFVBQVUsRUFBQyxRQUFRLFlBQy9FLHVCQUFDLGdCQUFNLElBQUMsT0FBTyxFQUFFLFdBQVcsNEJBRW5CLEdBQ1AsSUFDSixDQUNULENBQUE7QUFFTCxDQUFDO0FBRUQsa0JBQWUsa0JBQWtCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHtcbiAgICB1c2VTdGF0ZSxcbiAgICB1c2VFZmZlY3QsXG59IGZyb20gJ3JlYWN0J1xuaW1wb3J0IHtcbiAgICBGbGF0TGlzdCxcbiAgICBQcmVzc2FibGUsXG59IGZyb20gJ3JlYWN0LW5hdGl2ZSdcbmltcG9ydCB7IElvSW9zQ2xvc2UgfSBmcm9tIFwicmVhY3QtaWNvbnMvaW9cIlxuaW1wb3J0IHsgTWRQbGF5bGlzdEFkZCB9IGZyb20gXCJyZWFjdC1pY29ucy9tZFwiO1xuaW1wb3J0IHsgdXNlVG9hc3QgfSBmcm9tICdAY2hha3JhLXVpL3JlYWN0J1xuaW1wb3J0IEJveCBmcm9tICdAY29tcG9uZW50cy9jb21tb24vQm94J1xuaW1wb3J0IFRleHQgZnJvbSAnQGNvbXBvbmVudHMvY29tbW9uL1RleHQnXG5pbXBvcnQgQnV0dG9uIGZyb20gJ0Bjb21wb25lbnRzL0J1dHRvbidcblxuaW1wb3J0IHsgQ2F0ZWdvcnlUeXBlIH0gZnJvbSAnQGxpYi9kYXRhVHlwZXMvQ2F0ZWdvcnlUeXBlJ1xuaW1wb3J0IHtcbiAgICBhZGRDYXRlZ29yeVRvVXNlcixcbiAgICBsaXN0VXNlckNhdGVnb3JpZXMsXG4gICAgcmVtb3ZlQ2F0ZWdvcnksXG4gICAgcmVtb3ZlRXZlbnRDb25uZWN0aW9uc0ZvckNhdGVnb3J5LFxufSBmcm9tICdAbGliL0NhdGVnb3J5L0NhdGVnb3J5SGVscGVyJ1xuXG5pbXBvcnQgeyBwYWxldHRlIH0gZnJvbSAnQGxpYi90aGVtZS90aGVtZSdcbmltcG9ydCBUZXh0RmllbGQgZnJvbSAnQGNvbXBvbmVudHMvVGV4dEZpZWxkJ1xuaW1wb3J0IHsgdXNlQXBwQ29udGV4dCB9IGZyb20gJ0BsaWIvdXNlci1jb250ZXh0J1xuaW1wb3J0IHsgdXNlUm91dGVyIH0gZnJvbSAnbmV4dC9yb3V0ZXInXG5pbXBvcnQgeyBOZXh0QXBpUmVxdWVzdCwgTmV4dEFwaVJlc3BvbnNlIH0gZnJvbSAnbmV4dCc7XG5pbXBvcnQgc3VwZXJ0b2tlbnNOb2RlIGZyb20gJ3N1cGVydG9rZW5zLW5vZGUnXG5pbXBvcnQgeyBiYWNrZW5kQ29uZmlnIH0gZnJvbSAnQGNvbmZpZy9iYWNrZW5kQ29uZmlnJ1xuaW1wb3J0IFNlc3Npb24gZnJvbSAnc3VwZXJ0b2tlbnMtbm9kZS9yZWNpcGUvc2Vzc2lvbidcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNlcnZlclNpZGVQcm9wcyh7IHJlcSwgcmVzIH06IHsgcmVxOiBOZXh0QXBpUmVxdWVzdCwgcmVzOiBOZXh0QXBpUmVzcG9uc2UgfSkge1xuICAgIC8vIE5vdGljZSBob3cgdGhlIHNlcnZlciB1c2VzIGBBUElgIGZyb20gYHdpdGhTU1JDb250ZXh0YCwgaW5zdGVhZCBvZiB0aGUgdG9wLWxldmVsIGBBUElgLlxuICAgIC8vIGNvbnN0IFNTUiA9IHdpdGhTU1JDb250ZXh0KHsgcmVxIH0pXG4gICAgLy8gdGhpcyBydW5zIG9uIHRoZSBiYWNrZW5kLCBzbyB3ZSBtdXN0IGNhbGwgaW5pdCBvbiBzdXBlcnRva2Vucy1ub2RlIFNES1xuICAgIHN1cGVydG9rZW5zTm9kZS5pbml0KGJhY2tlbmRDb25maWcoKSlcbiAgICBsZXQgc2Vzc2lvblxuICAgIHRyeSB7XG4gICAgICAgIHNlc3Npb24gPSBhd2FpdCBTZXNzaW9uLmdldFNlc3Npb24ocmVxLCByZXMsIHtcbiAgICAgICAgICAgIG92ZXJyaWRlR2xvYmFsQ2xhaW1WYWxpZGF0b3JzOiBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFtdXG4gICAgICAgICAgICB9LFxuICAgICAgICB9KVxuICAgIH0gY2F0Y2ggKGVycjogYW55KSB7XG4gICAgICAgIGlmIChlcnIudHlwZSA9PT0gU2Vzc2lvbi5FcnJvci5UUllfUkVGUkVTSF9UT0tFTikge1xuICAgICAgICAgICAgcmV0dXJuIHsgcHJvcHM6IHsgZnJvbVN1cGVydG9rZW5zOiAnbmVlZHMtcmVmcmVzaCcgfSB9XG4gICAgICAgIH0gZWxzZSBpZiAoZXJyLnR5cGUgPT09IFNlc3Npb24uRXJyb3IuVU5BVVRIT1JJU0VEKSB7XG4gICAgICAgICAgICAvLyB0aGlzIHdpbGwgZm9yY2UgdGhlIGZyb250ZW5kIHRvIHRyeSBhbmQgcmVmcmVzaCB3aGljaCB3aWxsIGZhaWxcbiAgICAgICAgICAgIC8vIGNsZWFyaW5nIGFsbCBjb29raWVzIGFuZCByZWRpcmVjdGluZyB0aGUgdXNlciB0byB0aGUgbG9naW4gc2NyZWVuLlxuICAgICAgICAgICAgcmV0dXJuIHsgcHJvcHM6IHsgZnJvbVN1cGVydG9rZW5zOiAnbmVlZHMtcmVmcmVzaCcgfSB9XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgZXJyXG4gICAgfVxuXG4gICAgaWYgKCFzZXNzaW9uPy5nZXRVc2VySWQoKSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgcmVkaXJlY3Q6IHtcbiAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbjogJy9Vc2VyL0xvZ2luL1VzZXJMb2dpbicsXG4gICAgICAgICAgICAgICAgcGVybWFuZW50OiBmYWxzZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBwcm9wczoge1xuICAgICAgICBzdWI6IHNlc3Npb24uZ2V0VXNlcklkKCksXG4gICAgICAgIH1cbiAgICB9XG59XG5cbmZ1bmN0aW9uIFVzZXJFZGl0Q2F0ZWdvcmllcygpIHtcbiAgICBjb25zdCBbY2F0ZWdvcmllcywgc2V0Q2F0ZWdvcmllc10gPSB1c2VTdGF0ZTxDYXRlZ29yeVR5cGVbXT4oW10pXG4gICAgY29uc3QgW25hbWUsIHNldE5hbWVdID0gdXNlU3RhdGU8c3RyaW5nPignJylcblxuICAgIGNvbnN0IHJvdXRlciA9IHVzZVJvdXRlcigpXG4gICAgY29uc3QgeyBzdWIsIGNsaWVudCB9ID0gdXNlQXBwQ29udGV4dCgpXG4gICAgY29uc3QgdXNlcklkID0gc3ViXG4gICAgY29uc3QgaXNVcGRhdGUgPSByb3V0ZXIucXVlcnk/LmlzVXBkYXRlIGFzIHN0cmluZ1xuICAgIGNvbnN0IHRvYXN0ID0gdXNlVG9hc3QoKVxuXG4gICAgLy8gZ2V0IGNhdGVnb3JpZXNcbiAgICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCBleGlzdGluZ0NhdGVnb3JpZXMgPSBhd2FpdCBsaXN0VXNlckNhdGVnb3JpZXMoY2xpZW50LCB1c2VySWQpXG4gICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nQ2F0ZWdvcmllcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdG9hc3Qoe1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiAnd2FybmluZycsXG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogJ05vIHRhZ3MgZm91bmQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICdQbGVhc2UgYWRkIGEgdGFnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiA5MDAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNDbG9zYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBzZXRDYXRlZ29yaWVzKGV4aXN0aW5nQ2F0ZWdvcmllcylcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlLCAnZXJyb3IgaW4gdXNlRWZmZWN0IGZvciBVc2VyRWRpdENhdGVnb3JpZXMnKVxuICAgICAgICAgICAgfVxuICAgICAgICB9KSgpXG4gICAgfSwgW2NsaWVudCwgaXNVcGRhdGUsIHVzZXJJZCwgdG9hc3RdKVxuXG4gICAgLy8gYWRkIG5ldyBjYXRlZ29yeSB0byBjYXRlZ29yaWVzXG4gICAgY29uc3QgYWRkQ2F0ZWdvcnkgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyB2YWxpZGF0ZVxuICAgICAgICAgICAgaWYgKG5hbWUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBuZXdDYXRlZ29yeSA9IGF3YWl0IGFkZENhdGVnb3J5VG9Vc2VyKGNsaWVudCwgdXNlcklkLCBuYW1lKVxuICAgICAgICAgICAgc2V0Q2F0ZWdvcmllcyhbLi4uY2F0ZWdvcmllcywgbmV3Q2F0ZWdvcnldKVxuICAgICAgICAgICAgc2V0TmFtZSgnJylcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gcmVtb3ZlIGNhdGVnb3J5IGZyb20gY2F0ZWdvcmllc1xuICAgIGNvbnN0IHJlbW92ZUNhdGVnb3J5Rm9yVXNlciA9IGFzeW5jIChjYXRlZ29yeUlkOiBzdHJpbmcpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHNldENhdGVnb3JpZXMoY2F0ZWdvcmllcy5maWx0ZXIoY2F0ZWdvcnkgPT4gY2F0ZWdvcnkuaWQgIT09IGNhdGVnb3J5SWQpKVxuICAgICAgICAgICAgYXdhaXQgcmVtb3ZlQ2F0ZWdvcnkoY2xpZW50LCBjYXRlZ29yeUlkKVxuICAgICAgICAgICAgYXdhaXQgcmVtb3ZlRXZlbnRDb25uZWN0aW9uc0ZvckNhdGVnb3J5KGNsaWVudCwgY2F0ZWdvcnlJZClcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3Qgb25QcmVzcyA9IChjYXRlZ29yeUlkOiBzdHJpbmcsIG5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhjYXRlZ29yeUlkLCBuYW1lLCAnIGNhdGVnb3J5SWQsIG5hbWUsIGluc2lkZSBvblByZXNzJylcbiAgICAgICAgaWYgKCFjYXRlZ29yeUlkKSB7XG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuICAgICAgICBpZiAoIW5hbWUpIHtcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgcm91dGVyLnB1c2goeyBwYXRobmFtZTogJy9TZXR0aW5ncy9Vc2VyRWRpdENhdGVnb3J5JywgcXVlcnk6IHtcbiAgICAgICAgICAgIGNhdGVnb3J5SWQsXG4gICAgICAgICAgICBuYW1lLFxuICAgICAgICB9fSlcbiAgICB9XG5cblxuXG4gICAgcmV0dXJuIChcbiAgICAgICAgPEJveCBqdXN0aWZ5Q29udGVudD1cImNlbnRlclwiIGFsaWduSXRlbXM9XCJjZW50ZXJcIiB3aWR0aD1cIjEwMCVcIj5cbiAgICAgICAgICAgIDxCb3gganVzdGlmeUNvbnRlbnQ9XCJjZW50ZXJcIiBhbGlnbkl0ZW1zPVwiY2VudGVyXCIgbWluSGVpZ2h0PVwiNjB2aFwiIHdpZHRoPVwiODAlXCI+XG4gICAgICAgICAgICAgICAgPEZsYXRMaXN0XG4gICAgICAgICAgICAgICAgICAgIGRhdGE9e2NhdGVnb3JpZXN9XG4gICAgICAgICAgICAgICAgICAgIHJlbmRlckl0ZW09eyh7IGl0ZW0sIGluZGV4IH0pID0+IChcbiAgICAgICAgICAgICAgICAgICAgICAgIDxCb3ggcHQ9e3sgcGhvbmU6ICdzJywgdGFibGV0OiAnbSd9fSBqdXN0aWZ5Q29udGVudD1cImNlbnRlclwiIGFsaWduSXRlbXM9XCJjZW50ZXJcIiB3aWR0aD1cIjEwMCVcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8Qm94IGZsZXhEaXJlY3Rpb249XCJyb3dcIiBqdXN0aWZ5Q29udGVudD1cInNwYWNlLWJldHdlZW5cIiBhbGlnbkl0ZW1zPVwiY2VudGVyXCIgd2lkdGg9XCIxMDAlXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxCb3gganVzdGlmeUNvbnRlbnQ9XCJjZW50ZXJcIiBhbGlnbkl0ZW1zPVwiZmxleC1zdGFydFwiIG1yPXt7IHBob25lOidzJywgdGFibGV0OiAnbScgfX0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8VGV4dCB2YXJpYW50PVwib3B0aW9uSGVhZGVyXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge2l0ZW0ubmFtZX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvVGV4dD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9Cb3g+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxCb3ggZmxleERpcmVjdGlvbj1cInJvd1wiIGp1c3RpZnlDb250ZW50PVwic3BhY2UtYmV0d2VlblwiIGFsaWduSXRlbXM9XCJjZW50ZXJcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxQcmVzc2FibGUgaGl0U2xvcD17MTV9IG9uUHJlc3M9eygpID0+IG9uUHJlc3MoaXRlbT8uaWQsIGl0ZW0/Lm5hbWUpfT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8TWRQbGF5bGlzdEFkZCBzaXplPVwiM2VtXCIgY29sb3I9e3BhbGV0dGUucHVycGxlUHJpbWFyeX0gLz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvUHJlc3NhYmxlPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPFByZXNzYWJsZSBoaXRTbG9wPXsxNX0gb25QcmVzcz17KCkgPT4gcmVtb3ZlQ2F0ZWdvcnlGb3JVc2VyKGNhdGVnb3JpZXM/LltpbmRleF0/LmlkKX0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPElvSW9zQ2xvc2Ugc2l6ZT1cIjNlbVwiIGNvbG9yPXtwYWxldHRlLnJlZH0gLz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvUHJlc3NhYmxlPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L0JveD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L0JveD5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvQm94PlxuICAgICAgICAgICAgICAgICAgICApfVxuICAgICAgICAgICAgICAgICAgICBrZXlFeHRyYWN0b3I9eyhpdGVtKSA9PiBpdGVtLmlkfVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICA8L0JveD5cbiAgICAgICAgICAgIDxCb3ggPlxuICAgICAgICAgICAgICAgIDxCb3ggcHQ9e3sgcGhvbmU6ICd4cycsIHRhYmxldDogJ3MnIH19PlxuXG4gICAgICAgICAgICAgICAgICAgICAgICA8VGV4dEZpZWxkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9eyhlOiB7IHRhcmdldDogeyB2YWx1ZTogc3RyaW5nIH0gfSkgPT4gc2V0TmFtZShlPy50YXJnZXQ/LnZhbHVlKX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZT17bmFtZX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj1cIkdldCB0b2dldGhlclwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw9XCJUYWdcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIDwvQm94PlxuICAgICAgICAgICAgPC9Cb3g+XG4gICAgICAgICAgICA8Qm94ICBwdD17eyBwaG9uZTogJ3hzJywgdGFibGV0OiAncycgfX0ganVzdGlmeUNvbnRlbnQ9XCJjZW50ZXJcIiBhbGlnbkl0ZW1zPVwiY2VudGVyXCI+XG4gICAgICAgICAgICAgICAgPEJ1dHRvbiBvbkNsaWNrPXthZGRDYXRlZ29yeX0+XG4gICAgICAgICAgICAgICAgICAgIEFkZCBOZXcgVGFnXG4gICAgICAgICAgICAgICAgPC9CdXR0b24+XG4gICAgICAgICAgICA8L0JveD5cbiAgICAgICAgPC9Cb3g+XG4gICAgKVxuXG59XG5cbmV4cG9ydCBkZWZhdWx0IFVzZXJFZGl0Q2F0ZWdvcmllc1xuXG5cbiJdfQ==