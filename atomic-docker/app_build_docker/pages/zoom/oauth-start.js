"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getServerSideProps = getServerSideProps;
const jsx_runtime_1 = require("react/jsx-runtime");
const constants_1 = require("@lib/constants");
const react_1 = require("@chakra-ui/react");
const react_2 = require("react");
const router_1 = require("next/router");
const image_1 = __importDefault(require("next/image"));
const appStoreAndroid_png_1 = __importDefault(require("public/images/appStoreAndroid.png"));
const appStoreIos_png_1 = __importDefault(require("public/images/appStoreIos.png"));
const user_context_1 = require("@lib/user-context");
const supertokens_node_1 = __importDefault(require("supertokens-node"));
const backendConfig_1 = require("@config/backendConfig");
const session_1 = __importDefault(require("supertokens-node/recipe/session"));
const ZoomIcon = (props) => ((0, jsx_runtime_1.jsxs)(react_1.Icon, { viewBox: "0 0 1329.08 1329.08", ...props, children: [(0, jsx_runtime_1.jsx)("path", { d: "M664.54 0c367.02 0 664.54 297.52 664.54 664.54s-297.52 664.54-664.54 664.54S0 1031.56 0 664.54 297.52 0 664.54 0z", fill: "#e5e5e4", fillRule: "nonzero" }), (0, jsx_runtime_1.jsx)("path", { className: "fil1", d: "M664.54 12.94c359.87 0 651.6 291.73 651.6 651.6s-291.73 651.6-651.6 651.6-651.6-291.73-651.6-651.6 291.74-651.6 651.6-651.6z" }), (0, jsx_runtime_1.jsx)("path", { d: "M664.54 65.21c331 0 599.33 268.33 599.33 599.33 0 331-268.33 599.33-599.33 599.33-331 0-599.33-268.33-599.33-599.33 0-331 268.33-599.33 599.33-599.33z", fill: "#4a8cff", fillRule: "nonzero" }), (0, jsx_runtime_1.jsx)("path", { className: "fil1", d: "M273.53 476.77v281.65c.25 63.69 52.27 114.95 115.71 114.69h410.55c11.67 0 21.06-9.39 21.06-20.81V570.65c-.25-63.69-52.27-114.95-115.7-114.69H294.6c-11.67 0-21.06 9.39-21.06 20.81zm573.45 109.87l169.5-123.82c14.72-12.18 26.13-9.14 26.13 12.94v377.56c0 25.12-13.96 22.08-26.13 12.94l-169.5-123.57V586.64z" })] }));
async function getServerSideProps({ req, res }) {
    // Notice how the server uses `API` from `withSSRContext`, instead of the top-level `API`.
    // const SSR = withSSRContext({ req })
    // this runs on the backend, so we must call init on supertokens-node SDK
    supertokens_node_1.default.init((0, backendConfig_1.backendConfig)());
    let session;
    try {
        session = await session_1.default.getSession(req, res, {
            overrideGlobalClaimValidators: async function () {
                return [];
            },
        });
    }
    catch (err) {
        if (err.type === session_1.default.Error.TRY_REFRESH_TOKEN) {
            return { props: { fromSupertokens: 'needs-refresh' } };
        }
        else if (err.type === session_1.default.Error.UNAUTHORISED) {
            // this will force the frontend to try and refresh which will fail
            // clearing all cookies and redirecting the user to the login screen.
            return { props: { fromSupertokens: 'needs-refresh' } };
        }
        throw err;
    }
    if (!session?.getUserId()) {
        return {
            redirect: {
                destination: '/User/Login/UserLogin',
                permanent: false,
            },
        };
    }
    return {
        props: {
            sub: session?.getUserId(),
        }
    };
}
const ZoomWebStart = () => {
    const [url, setUrl] = (0, react_2.useState)('');
    const router = (0, router_1.useRouter)();
    const { sub } = (0, user_context_1.useAppContext)();
    const userId = sub;
    (0, react_2.useEffect)(() => {
        const makeLink = () => {
            const newUrl = new URL(constants_1.zoomAuthUrl);
            newUrl.searchParams.set('response_type', 'code');
            // dev only
            newUrl.searchParams.set('redirect_uri', process.env.NEXT_PUBLIC_ZOOM_REDIRECT_URL);
            // prod - ZOOM_REDIRECT_URI
            newUrl.searchParams.set('client_id', process.env.NEXT_PUBLIC_ZOOM_CLIENT_ID);
            newUrl.searchParams.set('state', userId);
            setUrl(newUrl.href);
        };
        makeLink();
    }, [userId]);
    const routeToZoomAuth = (e) => {
        e?.preventDefault();
        // https://zoom.us/oauth/authorize?response_type=code&client_id=OrxpodmORP2eDHug8x0jbQ&redirect_uri=https://oauth.atomiclife.app/api/integrations/zoomvideo/callback
        const newUrl = new URL(constants_1.zoomAuthUrl);
        newUrl.searchParams.set('response_type', 'code');
        // dev only
        newUrl.searchParams.set('redirect_uri', process.env.NEXT_PUBLIC_ZOOM_REDIRECT_URL);
        newUrl.searchParams.set('client_id', process.env.NEXT_PUBLIC_ZOOM_CLIENT_ID);
        newUrl.searchParams.set('state', userId);
        window.location.href = newUrl.href;
    };
    return ((0, jsx_runtime_1.jsxs)("div", { className: "flex flex-col justify-center items-center h-screen w-full dark:bg-black", style: { minHeight: '70vh' }, children: [(0, jsx_runtime_1.jsx)("a", { href: url, onClick: routeToZoomAuth, children: (0, jsx_runtime_1.jsx)(react_1.Button, { leftIcon: (0, jsx_runtime_1.jsx)(ZoomIcon, {}), colorScheme: 'messenger', bg: "purple.700", variant: 'solid', children: (0, jsx_runtime_1.jsx)("span", { className: "text-black", children: "Start Zoom OAuth" }) }) }), (0, jsx_runtime_1.jsx)("p", { className: "mt-1.5 text-sm text-gray-500", children: "Zoom authentication via Web is not tested yet. You can use mobile if this doesn't work. ðŸ˜Š " }), (0, jsx_runtime_1.jsxs)("div", { className: "flex items-center justify-between mt-3", children: [(0, jsx_runtime_1.jsx)("a", { href: "https://apps.apple.com/us/app/atomic-life/id1594368125", className: "pr-2", children: (0, jsx_runtime_1.jsx)(image_1.default, { width: 177, src: appStoreIos_png_1.default, alt: "App Store" }) }), (0, jsx_runtime_1.jsx)("a", { href: "https://play.google.com/store/apps/details?id=com.atomiclifenoexpo", className: "pl-2", children: (0, jsx_runtime_1.jsx)(image_1.default, { width: 177, src: appStoreAndroid_png_1.default, alt: "App Store" }) })] })] }));
};
exports.default = ZoomWebStart;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2F1dGgtc3RhcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJvYXV0aC1zdGFydC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFzQkEsZ0RBc0NDOztBQTVERCw4Q0FBNEM7QUFDNUMsNENBQStDO0FBQy9DLGlDQUEyQztBQUUzQyx3Q0FBdUM7QUFDdkMsdURBQThCO0FBQzlCLDRGQUErRDtBQUMvRCxvRkFBdUQ7QUFFdkQsb0RBQWlEO0FBRWpELHdFQUE4QztBQUM5Qyx5REFBcUQ7QUFDckQsOEVBQXFEO0FBR3JELE1BQU0sUUFBUSxHQUFHLENBQUMsS0FBVSxFQUFFLEVBQUUsQ0FBQyxDQUM3Qix3QkFBQyxZQUFJLElBQUMsT0FBTyxFQUFDLHFCQUFxQixLQUFLLEtBQUssYUFDekMsaUNBQU0sQ0FBQyxFQUFDLG1IQUFtSCxFQUFDLElBQUksRUFBQyxTQUFTLEVBQUMsUUFBUSxFQUFDLFNBQVMsR0FBRyxFQUFBLGlDQUFNLFNBQVMsRUFBQyxNQUFNLEVBQUMsQ0FBQyxFQUFDLDhIQUE4SCxHQUFHLEVBQUEsaUNBQU0sQ0FBQyxFQUFDLHdKQUF3SixFQUFDLElBQUksRUFBQyxTQUFTLEVBQUMsUUFBUSxFQUFDLFNBQVMsR0FBRyxFQUFBLGlDQUFNLFNBQVMsRUFBQyxNQUFNLEVBQUMsQ0FBQyxFQUFDLGdUQUFnVCxHQUFHLElBQ3gwQixDQUNWLENBQUE7QUFFTSxLQUFLLFVBQVUsa0JBQWtCLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFnRDtJQUNqRywwRkFBMEY7SUFDeEYsc0NBQXNDO0lBQ3RDLHlFQUF5RTtJQUN6RSwwQkFBZSxDQUFDLElBQUksQ0FBQyxJQUFBLDZCQUFhLEdBQUUsQ0FBQyxDQUFBO0lBQ3JDLElBQUksT0FBTyxDQUFBO0lBQ1gsSUFBSSxDQUFDO1FBQ0QsT0FBTyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRTtZQUN6Qyw2QkFBNkIsRUFBRSxLQUFLO2dC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QyxZQUFZLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQTtRQUN4QyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFBO0lBQ3RDLENBQUMsQ0FBQTtJQUVELE9BQU8sQ0FDSCxpQ0FBSyxTQUFTLEVBQUMseUVBQXlFLEVBQUMsS0FBSyxFQUFFLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBQyxhQUNoSCw4QkFBRyxJQUFJLEVBQUUsR0FBRyxFQUFHLE9BQU8sRUFBRSxlQUFlLFlBQ25DLHVCQUFDLGNBQU0sSUFBQyxRQUFRLEVBQUUsdUJBQUMsUUFBUSxLQUFHLEVBQUUsV0FBVyxFQUFDLFdBQVcsRUFBQyxFQUFFLEVBQUMsWUFBWSxFQUFDLE9BQU8sRUFBQyxPQUFPLFlBQ25GLGlDQUFNLFNBQVMsRUFBQyxZQUFZLGlDQUF3QixHQUMvQyxHQUNULEVBQ0osOEJBQUcsU0FBUyxFQUFDLDhCQUE4QixZQUN0Qyw2RkFBNkYsR0FDOUYsRUFDSixpQ0FBSyxTQUFTLEVBQUMsd0NBQXdDLGFBQ25ELDhCQUFHLElBQUksRUFBQyx3REFBd0QsRUFBQyxTQUFTLEVBQUMsTUFBTSxZQUM3RSx1QkFBQyxlQUFLLElBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUseUJBQVcsRUFBRSxHQUFHLEVBQUMsV0FBVyxHQUFHLEdBQ3ZELEVBQ0osOEJBQUcsSUFBSSxFQUFDLG9FQUFvRSxFQUFDLFNBQVMsRUFBQyxNQUFNLFlBQ3pGLHVCQUFDLGVBQUssSUFBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSw2QkFBZSxFQUFFLEdBQUcsRUFBQyxXQUFXLEdBQUcsR0FDM0QsSUFDRixJQUNKLENBQ1QsQ0FBQTtBQUVMLENBQUMsQ0FBQTtBQUVELGtCQUFlLFlBQVksQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHpvb21BdXRoVXJsIH0gZnJvbSBcIkBsaWIvY29uc3RhbnRzXCJcbmltcG9ydCB7IEljb24sIEJ1dHRvbiB9IGZyb20gJ0BjaGFrcmEtdWkvcmVhY3QnXG5pbXBvcnQgeyB1c2VFZmZlY3QsIHVzZVN0YXRlIH0gZnJvbSBcInJlYWN0XCJcbmltcG9ydCB7IE5leHRQYWdlIH0gZnJvbSBcIm5leHRcIlxuaW1wb3J0IHsgdXNlUm91dGVyIH0gZnJvbSBcIm5leHQvcm91dGVyXCJcbmltcG9ydCBJbWFnZSBmcm9tICduZXh0L2ltYWdlJ1xuaW1wb3J0IGFwcFN0b3JlQW5kcm9pZCBmcm9tICdwdWJsaWMvaW1hZ2VzL2FwcFN0b3JlQW5kcm9pZC5wbmcnXG5pbXBvcnQgYXBwU3RvcmVJb3MgZnJvbSAncHVibGljL2ltYWdlcy9hcHBTdG9yZUlvcy5wbmcnXG5cbmltcG9ydCB7IHVzZUFwcENvbnRleHQgfSBmcm9tIFwiQGxpYi91c2VyLWNvbnRleHRcIlxuaW1wb3J0IHsgTmV4dEFwaVJlcXVlc3QsIE5leHRBcGlSZXNwb25zZSB9IGZyb20gJ25leHQnO1xuaW1wb3J0IHN1cGVydG9rZW5zTm9kZSBmcm9tICdzdXBlcnRva2Vucy1ub2RlJ1xuaW1wb3J0IHsgYmFja2VuZENvbmZpZyB9IGZyb20gJ0Bjb25maWcvYmFja2VuZENvbmZpZydcbmltcG9ydCBTZXNzaW9uIGZyb20gJ3N1cGVydG9rZW5zLW5vZGUvcmVjaXBlL3Nlc3Npb24nXG5cblxuY29uc3QgWm9vbUljb24gPSAocHJvcHM6IGFueSkgPT4gKFxuICAgIDxJY29uIHZpZXdCb3g9XCIwIDAgMTMyOS4wOCAxMzI5LjA4XCIgey4uLnByb3BzfT5cbiAgICAgICAgPHBhdGggZD1cIk02NjQuNTQgMGMzNjcuMDIgMCA2NjQuNTQgMjk3LjUyIDY2NC41NCA2NjQuNTRzLTI5Ny41MiA2NjQuNTQtNjY0LjU0IDY2NC41NFMwIDEwMzEuNTYgMCA2NjQuNTQgMjk3LjUyIDAgNjY0LjU0IDB6XCIgZmlsbD1cIiNlNWU1ZTRcIiBmaWxsUnVsZT1cIm5vbnplcm9cIiAvPjxwYXRoIGNsYXNzTmFtZT1cImZpbDFcIiBkPVwiTTY2NC41NCAxMi45NGMzNTkuODcgMCA2NTEuNiAyOTEuNzMgNjUxLjYgNjUxLjZzLTI5MS43MyA2NTEuNi02NTEuNiA2NTEuNi02NTEuNi0yOTEuNzMtNjUxLjYtNjUxLjYgMjkxLjc0LTY1MS42IDY1MS42LTY1MS42elwiIC8+PHBhdGggZD1cIk02NjQuNTQgNjUuMjFjMzMxIDAgNTk5LjMzIDI2OC4zMyA1OTkuMzMgNTk5LjMzIDAgMzMxLTI2OC4zMyA1OTkuMzMtNTk5LjMzIDU5OS4zMy0zMzEgMC01OTkuMzMtMjY4LjMzLTU5OS4zMy01OTkuMzMgMC0zMzEgMjY4LjMzLTU5OS4zMyA1OTkuMzMtNTk5LjMzelwiIGZpbGw9XCIjNGE4Y2ZmXCIgZmlsbFJ1bGU9XCJub256ZXJvXCIgLz48cGF0aCBjbGFzc05hbWU9XCJmaWwxXCIgZD1cIk0yNzMuNTMgNDc2Ljc3djI4MS42NWMuMjUgNjMuNjkgNTIuMjcgMTE0Ljk1IDExNS43MSAxMTQuNjloNDEwLjU1YzExLjY3IDAgMjEuMDYtOS4zOSAyMS4wNi0yMC44MVY1NzAuNjVjLS4yNS02My42OS01Mi4yNy0xMTQuOTUtMTE1LjctMTE0LjY5SDI5NC42Yy0xMS42NyAwLTIxLjA2IDkuMzktMjEuMDYgMjAuODF6bTU3My40NSAxMDkuODdsMTY5LjUtMTIzLjgyYzE0LjcyLTEyLjE4IDI2LjEzLTkuMTQgMjYuMTMgMTIuOTR2Mzc3LjU2YzAgMjUuMTItMTMuOTYgMjIuMDgtMjYuMTMgMTIuOTRsLTE2OS41LTEyMy41N1Y1ODYuNjR6XCIgLz5cbiAgICA8L0ljb24+XG4pXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRTZXJ2ZXJTaWRlUHJvcHMoeyByZXEsIHJlcyB9OiB7IHJlcTogTmV4dEFwaVJlcXVlc3QsIHJlczogTmV4dEFwaVJlc3BvbnNlfSkge1xuICAvLyBOb3RpY2UgaG93IHRoZSBzZXJ2ZXIgdXNlcyBgQVBJYCBmcm9tIGB3aXRoU1NSQ29udGV4dGAsIGluc3RlYWQgb2YgdGhlIHRvcC1sZXZlbCBgQVBJYC5cbiAgICAvLyBjb25zdCBTU1IgPSB3aXRoU1NSQ29udGV4dCh7IHJlcSB9KVxuICAgIC8vIHRoaXMgcnVucyBvbiB0aGUgYmFja2VuZCwgc28gd2UgbXVzdCBjYWxsIGluaXQgb24gc3VwZXJ0b2tlbnMtbm9kZSBTREtcbiAgICBzdXBlcnRva2Vuc05vZGUuaW5pdChiYWNrZW5kQ29uZmlnKCkpXG4gICAgbGV0IHNlc3Npb25cbiAgICB0cnkge1xuICAgICAgICBzZXNzaW9uID0gYXdhaXQgU2Vzc2lvbi5nZXRTZXNzaW9uKHJlcSwgcmVzLCB7XG4gICAgICAgICAgICBvdmVycmlkZUdsb2JhbENsYWltVmFsaWRhdG9yczogYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBbXVxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSlcbiAgICB9IGNhdGNoIChlcnI6IGFueSkge1xuICAgICAgICBpZiAoZXJyLnR5cGUgPT09IFNlc3Npb24uRXJyb3IuVFJZX1JFRlJFU0hfVE9LRU4pIHtcbiAgICAgICAgICAgIHJldHVybiB7IHByb3BzOiB7IGZyb21TdXBlcnRva2VuczogJ25lZWRzLXJlZnJlc2gnIH0gfVxuICAgICAgICB9IGVsc2UgaWYgKGVyci50eXBlID09PSBTZXNzaW9uLkVycm9yLlVOQVVUSE9SSVNFRCkge1xuICAgICAgICAgICAgLy8gdGhpcyB3aWxsIGZvcmNlIHRoZSBmcm9udGVuZCB0byB0cnkgYW5kIHJlZnJlc2ggd2hpY2ggd2lsbCBmYWlsXG4gICAgICAgICAgICAvLyBjbGVhcmluZyBhbGwgY29va2llcyBhbmQgcmVkaXJlY3RpbmcgdGhlIHVzZXIgdG8gdGhlIGxvZ2luIHNjcmVlbi5cbiAgICAgICAgICAgIHJldHVybiB7IHByb3BzOiB7IGZyb21TdXBlcnRva2VuczogJ25lZWRzLXJlZnJlc2gnIH0gfVxuICAgICAgICB9XG4gICAgICAgIHRocm93IGVyclxuICAgIH1cblxuICAgIGlmICghc2Vzc2lvbj8uZ2V0VXNlcklkKCkpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHJlZGlyZWN0OiB7XG4gICAgICAgICAgICAgICAgZGVzdGluYXRpb246ICcvVXNlci9Mb2dpbi9Vc2VyTG9naW4nLFxuICAgICAgICAgICAgICAgIHBlcm1hbmVudDogZmFsc2UsXG4gICAgICAgICAgICB9LFxuICAgICAgICB9XG4gICAgfVxuXG5cbiAgcmV0dXJuIHtcbiAgICBwcm9wczoge1xuICAgICAgc3ViOiBzZXNzaW9uPy5nZXRVc2VySWQoKSxcbiAgICB9XG4gIH1cbn1cblxuY29uc3QgWm9vbVdlYlN0YXJ0OiBOZXh0UGFnZSA9ICgpID0+IHtcbiAgICBjb25zdCBbdXJsLCBzZXRVcmxdID0gdXNlU3RhdGUoJycpXG4gICAgY29uc3Qgcm91dGVyID0gdXNlUm91dGVyKClcblxuICAgIGNvbnN0IHsgc3ViIH0gPSB1c2VBcHBDb250ZXh0KClcbiAgICBjb25zdCB1c2VySWQgPSBzdWJcblxuICAgIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgICAgIGNvbnN0IG1ha2VMaW5rID0gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbmV3VXJsID0gbmV3IFVSTCh6b29tQXV0aFVybClcbiAgICAgICAgICAgIG5ld1VybC5zZWFyY2hQYXJhbXMuc2V0KCdyZXNwb25zZV90eXBlJywgJ2NvZGUnKVxuICAgICAgICAgICAgLy8gZGV2IG9ubHlcbiAgICAgICAgICAgIG5ld1VybC5zZWFyY2hQYXJhbXMuc2V0KCdyZWRpcmVjdF91cmknLCBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19aT09NX1JFRElSRUNUX1VSTCBhcyBzdHJpbmcpXG4gICAgICAgICAgICAvLyBwcm9kIC0gWk9PTV9SRURJUkVDVF9VUklcbiAgICAgICAgICAgIG5ld1VybC5zZWFyY2hQYXJhbXMuc2V0KCdjbGllbnRfaWQnLCBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19aT09NX0NMSUVOVF9JRCBhcyBzdHJpbmcpXG4gICAgICAgICAgICBuZXdVcmwuc2VhcmNoUGFyYW1zLnNldCgnc3RhdGUnLCB1c2VySWQpXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHNldFVybChuZXdVcmwuaHJlZilcbiAgICAgICAgfVxuICAgICAgICBtYWtlTGluaygpXG4gICAgfSwgW3VzZXJJZF0pXG5cbiAgICBjb25zdCByb3V0ZVRvWm9vbUF1dGggPSAoZTogeyBwcmV2ZW50RGVmYXVsdDogKCkgPT4gdm9pZCB9KSA9PiB7XG4gICAgICAgIGU/LnByZXZlbnREZWZhdWx0KClcbiAgICAgICAgLy8gaHR0cHM6Ly96b29tLnVzL29hdXRoL2F1dGhvcml6ZT9yZXNwb25zZV90eXBlPWNvZGUmY2xpZW50X2lkPU9yeHBvZG1PUlAyZURIdWc4eDBqYlEmcmVkaXJlY3RfdXJpPWh0dHBzOi8vb2F1dGguYXRvbWljbGlmZS5hcHAvYXBpL2ludGVncmF0aW9ucy96b29tdmlkZW8vY2FsbGJhY2tcbiAgICAgICAgY29uc3QgbmV3VXJsID0gbmV3IFVSTCh6b29tQXV0aFVybClcbiAgICAgICAgbmV3VXJsLnNlYXJjaFBhcmFtcy5zZXQoJ3Jlc3BvbnNlX3R5cGUnLCAnY29kZScpXG4gICAgICAgIC8vIGRldiBvbmx5XG4gICAgICAgIG5ld1VybC5zZWFyY2hQYXJhbXMuc2V0KCdyZWRpcmVjdF91cmknLCBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19aT09NX1JFRElSRUNUX1VSTCBhcyBzdHJpbmcpXG4gICAgICAgIG5ld1VybC5zZWFyY2hQYXJhbXMuc2V0KCdjbGllbnRfaWQnLCBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19aT09NX0NMSUVOVF9JRCBhcyBzdHJpbmcpXG4gICAgICAgIG5ld1VybC5zZWFyY2hQYXJhbXMuc2V0KCdzdGF0ZScsIHVzZXJJZClcbiAgICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBuZXdVcmwuaHJlZlxuICAgIH1cblxuICAgIHJldHVybiAoXG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiZmxleCBmbGV4LWNvbCBqdXN0aWZ5LWNlbnRlciBpdGVtcy1jZW50ZXIgaC1zY3JlZW4gdy1mdWxsIGRhcms6YmctYmxhY2tcIiBzdHlsZT17eyBtaW5IZWlnaHQ6ICc3MHZoJ319PlxuICAgICAgICAgICAgPGEgaHJlZj17dXJsfSAgb25DbGljaz17cm91dGVUb1pvb21BdXRofT5cbiAgICAgICAgICAgICAgICA8QnV0dG9uIGxlZnRJY29uPXs8Wm9vbUljb24gLz59IGNvbG9yU2NoZW1lPSdtZXNzZW5nZXInIGJnPVwicHVycGxlLjcwMFwiIHZhcmlhbnQ9J3NvbGlkJz5cbiAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPVwidGV4dC1ibGFja1wiPlN0YXJ0IFpvb20gT0F1dGg8L3NwYW4+XG4gICAgICAgICAgICAgICAgPC9CdXR0b24+XG4gICAgICAgICAgICA8L2E+XG4gICAgICAgICAgICA8cCBjbGFzc05hbWU9XCJtdC0xLjUgdGV4dC1zbSB0ZXh0LWdyYXktNTAwXCI+XG4gICAgICAgICAgICAgICAge1wiWm9vbSBhdXRoZW50aWNhdGlvbiB2aWEgV2ViIGlzIG5vdCB0ZXN0ZWQgeWV0LiBZb3UgY2FuIHVzZSBtb2JpbGUgaWYgdGhpcyBkb2Vzbid0IHdvcmsuIPCfmIogXCJ9XG4gICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImZsZXggaXRlbXMtY2VudGVyIGp1c3RpZnktYmV0d2VlbiBtdC0zXCI+XG4gICAgICAgICAgICAgICAgPGEgaHJlZj1cImh0dHBzOi8vYXBwcy5hcHBsZS5jb20vdXMvYXBwL2F0b21pYy1saWZlL2lkMTU5NDM2ODEyNVwiIGNsYXNzTmFtZT1cInByLTJcIj5cbiAgICAgICAgICAgICAgICAgICAgPEltYWdlIHdpZHRoPXsxNzd9IHNyYz17YXBwU3RvcmVJb3N9IGFsdD1cIkFwcCBTdG9yZVwiIC8+XG4gICAgICAgICAgICAgICAgPC9hPlxuICAgICAgICAgICAgICAgIDxhIGhyZWY9XCJodHRwczovL3BsYXkuZ29vZ2xlLmNvbS9zdG9yZS9hcHBzL2RldGFpbHM/aWQ9Y29tLmF0b21pY2xpZmVub2V4cG9cIiBjbGFzc05hbWU9XCJwbC0yXCI+XG4gICAgICAgICAgICAgICAgICAgIDxJbWFnZSB3aWR0aD17MTc3fSBzcmM9e2FwcFN0b3JlQW5kcm9pZH0gYWx0PVwiQXBwIFN0b3JlXCIgLz5cbiAgICAgICAgICAgICAgICA8L2E+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9kaXY+XG4gICAgKVxuXG59XG5cbmV4cG9ydCBkZWZhdWx0IFpvb21XZWJTdGFydFxuIl19