"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const process_recorded_audio_note_1 = __importDefault(require("../process-recorded-audio-note")); // Adjust path to your API route
const node_mocks_http_1 = require("node-mocks-http"); // For mocking req/res
const formidable_1 = __importDefault(require("formidable"));
const fs_1 = __importDefault(require("fs"));
const logger_1 = require("../../../lib/logger"); // Actual logger
const api_backend_helper_1 = require("../../../lib/api-backend-helper"); // The resilientGot we want to mock
// Mock formidable
jest.mock('formidable');
// Mock fs, specifically createReadStream and unlink
jest.mock('fs', () => ({
    ...jest.requireActual('fs'), // Import and retain default behavior
    createReadStream: jest
        .fn()
        .mockReturnValue({ pipe: jest.fn(), on: jest.fn() }), // Simple mock for stream
    unlink: jest.fn((path, callback) => callback(null)), // Mock unlink to succeed by default
}));
// Mock resilientGot from its actual module path
jest.mock('../../../lib/api-backend-helper', () => ({
    ...jest.requireActual('../../../lib/api-backend-helper'), // Keep other exports
    resilientGot: jest.fn(), // Mock resilientGot specifically
}));
const mockedResilientGot = api_backend_helper_1.resilientGot;
// Mock the logger
jest.mock('../../../lib/logger', () => ({
    appServiceLogger: {
        info: jest.fn(),
        warn: jest.fn(),
        error: jest.fn(),
        debug: jest.fn(),
    },
}));
const mockedLogger = logger_1.appServiceLogger;
describe('/api/process-recorded-audio-note API Endpoint', () => {
    let mockParse;
    beforeEach(() => {
        mockedLogger.info.mockClear();
        mockedLogger.warn.mockClear();
        mockedLogger.error.mockClear();
        mockedLogger.debug.mockClear();
        mockedResilientGot.mockReset();
        fs_1.default.unlink.mockClear();
        // Setup formidable mock for each test
        mockParse = jest.fn((req, callback) => {
            // Simulate successful parsing with mock data by default
            const mockFiles = {
                audio_file: [
                    { filepath: 'mock/path/audio.wav', originalFilename: 'audio.wav' },
                ],
            };
            const mockFields = {
                title: ['Test Title'],
                user_id: ['test-user-id'],
            };
            callback(null, mockFields, mockFiles);
        });
        formidable_1.default.mockImplementation(() => ({
            parse: mockParse,
            keepExtensions: true,
        }));
    });
    it('should return 405 if method is not POST', async () => {
        const { req, res } = (0, node_mocks_http_1.createMocks)({ method: 'GET' });
        await (0, process_recorded_audio_note_1.default)(req, res);
        expect(res._getStatusCode()).toBe(405);
    });
    it('should return 400 if audio_file is missing', async () => {
        mockParse.mockImplementationOnce((req, callback) => {
            callback(null, { title: ['Test'], user_id: ['user1'] }, {}); // No audio_file
        });
        const { req, res } = (0, node_mocks_http_1.createMocks)({ method: 'POST' });
        await (0, process_recorded_audio_note_1.default)(req, res);
        expect(res._getStatusCode()).toBe(400);
        expect(JSON.parse(res._getData()).error.message).toBe('No audio file uploaded.');
    });
    it('should return 400 if title is missing', async () => {
        mockParse.mockImplementationOnce((req, callback) => {
            callback(null, { user_id: ['user1'] }, { audio_file: [{ filepath: 'mock/path/audio.wav' }] });
        });
        const { req, res } = (0, node_mocks_http_1.createMocks)({ method: 'POST' });
        await (0, process_recorded_audio_note_1.default)(req, res);
        expect(res._getStatusCode()).toBe(400);
        expect(JSON.parse(res._getData()).error.message).toBe('Missing title for the audio note.');
    });
    it('should call Python backend via resilientGot and return success if Python backend succeeds', async () => {
        const mockPythonResponse = {
            ok: true,
            data: {
                notion_page_url: 'http://notion.so/page',
                title: 'Processed Title',
            },
        };
        mockedResilientGot.mockResolvedValueOnce(mockPythonResponse);
        const { req, res } = (0, node_mocks_http_1.createMocks)({ method: 'POST' });
        // Simulate formidable parsing correctly
        // Default mockParse setup already does this.
        await (0, process_recorded_audio_note_1.default)(req, res);
        expect(res._getStatusCode()).toBe(200);
        expect(JSON.parse(res._getData()).data).toEqual(mockPythonResponse.data);
        expect(mockedResilientGot).toHaveBeenCalledTimes(1);
        expect(mockedResilientGot).toHaveBeenCalledWith('post', expect.stringContaining('/api/internal/process_audio_note_data'), expect.objectContaining({ body: expect.any(FormData) }), // Check that body is FormData
        expect.stringContaining('_PythonBackendCall'));
        expect(mockedLogger.info).toHaveBeenCalledWith(expect.stringContaining('Python backend processed audio successfully.'), expect.anything());
        expect(fs_1.default.unlink).toHaveBeenCalledWith('mock/path/audio.wav', expect.any(Function));
    });
    it('should return 500 and log error if Python backend returns an error status', async () => {
        const mockPythonErrorResponse = {
            ok: false,
            error: { message: 'Python processing error', code: 'PYTHON_ERROR' },
        };
        mockedResilientGot.mockResolvedValueOnce(mockPythonErrorResponse); // resilientGot succeeds, but Python service returns error
        const { req, res } = (0, node_mocks_http_1.createMocks)({ method: 'POST' });
        await (0, process_recorded_audio_note_1.default)(req, res);
        expect(res._getStatusCode()).toBe(500);
        expect(JSON.parse(res._getData()).error.message).toBe('Python processing error');
        expect(mockedLogger.error).toHaveBeenCalledWith(expect.stringContaining('Error response from Python backend.'), expect.objectContaining({ errorMsg: 'Python processing error' }));
        expect(fs_1.default.unlink).toHaveBeenCalledWith('mock/path/audio.wav', expect.any(Function));
    });
    it('should return 502 and log error if resilientGot throws (Python service communication failure)', async () => {
        const resilientGotError = new Error('Network connection to Python service failed');
        mockedResilientGot.mockRejectedValueOnce(resilientGotError);
        const { req, res } = (0, node_mocks_http_1.createMocks)({ method: 'POST' });
        await (0, process_recorded_audio_note_1.default)(req, res);
        expect(res._getStatusCode()).toBe(502);
        expect(JSON.parse(res._getData()).error.message).toBe('Network connection to Python service failed');
        expect(mockedLogger.error).toHaveBeenCalledWith(expect.stringContaining('Error calling Python backend or during file ops.'), expect.objectContaining({ error: resilientGotError.message }));
        expect(fs_1.default.unlink).toHaveBeenCalledWith('mock/path/audio.wav', expect.any(Function));
    });
    it('should log formidable parsing error and return 500', async () => {
        const parsingError = new Error('Formidable failed');
        mockParse.mockImplementationOnce((req, callback) => {
            callback(parsingError, {}, {});
        });
        const { req, res } = (0, node_mocks_http_1.createMocks)({ method: 'POST' });
        await (0, process_recorded_audio_note_1.default)(req, res);
        expect(res._getStatusCode()).toBe(500);
        expect(JSON.parse(res._getData()).error.message).toContain('Server error: Formidable failed');
        expect(mockedLogger.error).toHaveBeenCalledWith(expect.stringContaining('Formidable parsing error.'), expect.objectContaining({ error: parsingError.message }));
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzcy1yZWNvcmRlZC1hdWRpby1ub3RlLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwcm9jZXNzLXJlY29yZGVkLWF1ZGlvLW5vdGUudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLGlHQUFxRCxDQUFDLGdDQUFnQztBQUN0RixxREFBNkQsQ0FBQyxzQkFBc0I7QUFDcEYsNERBQW9DO0FBQ3BDLDRDQUFvQjtBQUNwQixnREFBdUQsQ0FBQyxnQkFBZ0I7QUFDeEUsd0VBQStELENBQUMsbUNBQW1DO0FBRW5HLGtCQUFrQjtBQUNsQixJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBRXhCLG9EQUFvRDtBQUNwRCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3JCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxxQ0FBcUM7SUFDbEUsZ0JBQWdCLEVBQUUsSUFBSTtTQUNuQixFQUFFLEVBQUU7U0FDSixlQUFlLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLHlCQUF5QjtJQUNqRixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLG9DQUFvQztDQUMxRixDQUFDLENBQUMsQ0FBQztBQUVKLGdEQUFnRDtBQUNoRCxJQUFJLENBQUMsSUFBSSxDQUFDLGlDQUFpQyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDbEQsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlDQUFpQyxDQUFDLEVBQUUscUJBQXFCO0lBQy9FLFlBQVksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsaUNBQWlD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QUFvRCxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQ2xFLE1BQU0sWUFBWSxHQUFHLElBQUksS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDcEQsU0FBUyxDQUFDLHNCQUFzQixDQUFDLENBQUMsR0FBRyxFQUFFLFFBQVEsRUFBRSxFQUFFO1lBQ2pELFFBQVEsQ0FBQyxZQUFZLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2pDLENBQUMsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFBLDZCQUFXLEVBQUMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUVyRCxNQUFNLElBQUEscUNBQU8sRUFBQyxHQUFVLEVBQUUsR0FBVSxDQUFDLENBQUM7UUFFdEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN2QyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsU0FBUyxDQUN4RCxpQ0FBaUMsQ0FDbEMsQ0FBQztRQUNGLE1BQU0sQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsb0JBQW9CLENBQzdDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQywyQkFBMkIsQ0FBQyxFQUNwRCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxLQUFLLEVBQUUsWUFBWSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQ3pELENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGhhbmRsZXIgZnJvbSAnLi4vcHJvY2Vzcy1yZWNvcmRlZC1hdWRpby1ub3RlJzsgLy8gQWRqdXN0IHBhdGggdG8geW91ciBBUEkgcm91dGVcbmltcG9ydCB7IGNyZWF0ZU1vY2tzLCBSZXF1ZXN0TWV0aG9kIH0gZnJvbSAnbm9kZS1tb2Nrcy1odHRwJzsgLy8gRm9yIG1vY2tpbmcgcmVxL3Jlc1xuaW1wb3J0IGZvcm1pZGFibGUgZnJvbSAnZm9ybWlkYWJsZSc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgYXBwU2VydmljZUxvZ2dlciB9IGZyb20gJy4uLy4uLy4uL2xpYi9sb2dnZXInOyAvLyBBY3R1YWwgbG9nZ2VyXG5pbXBvcnQgeyByZXNpbGllbnRHb3QgfSBmcm9tICcuLi8uLi8uLi9saWIvYXBpLWJhY2tlbmQtaGVscGVyJzsgLy8gVGhlIHJlc2lsaWVudEdvdCB3ZSB3YW50IHRvIG1vY2tcblxuLy8gTW9jayBmb3JtaWRhYmxlXG5qZXN0Lm1vY2soJ2Zvcm1pZGFibGUnKTtcblxuLy8gTW9jayBmcywgc3BlY2lmaWNhbGx5IGNyZWF0ZVJlYWRTdHJlYW0gYW5kIHVubGlua1xuamVzdC5tb2NrKCdmcycsICgpID0+ICh7XG4gIC4uLmplc3QucmVxdWlyZUFjdHVhbCgnZnMnKSwgLy8gSW1wb3J0IGFuZCByZXRhaW4gZGVmYXVsdCBiZWhhdmlvclxuICBjcmVhdGVSZWFkU3RyZWFtOiBqZXN0XG4gICAgLmZuKClcbiAgICAubW9ja1JldHVyblZhbHVlKHsgcGlwZTogamVzdC5mbigpLCBvbjogamVzdC5mbigpIH0pLCAvLyBTaW1wbGUgbW9jayBmb3Igc3RyZWFtXG4gIHVubGluazogamVzdC5mbigocGF0aCwgY2FsbGJhY2spID0+IGNhbGxiYWNrKG51bGwpKSwgLy8gTW9jayB1bmxpbmsgdG8gc3VjY2VlZCBieSBkZWZhdWx0XG59KSk7XG5cbi8vIE1vY2sgcmVzaWxpZW50R290IGZyb20gaXRzIGFjdHVhbCBtb2R1bGUgcGF0aFxuamVzdC5tb2NrKCcuLi8uLi8uLi9saWIvYXBpLWJhY2tlbmQtaGVscGVyJywgKCkgPT4gKHtcbiAgLi4uamVzdC5yZXF1aXJlQWN0dWFsKCcuLi8uLi8uLi9saWIvYXBpLWJhY2tlbmQtaGVscGVyJyksIC8vIEtlZXAgb3RoZXIgZXhwb3J0c1xuICByZXNpbGllbnRHb3Q6IGplc3QuZm4oKSwgLy8gTW9jayByZXNpbGllbnRHb3Qgc3BlY2lmaWNhbGx5XG59KSk7XG5jb25zdCBtb2NrZWRSZXNpbGllbnRHb3QgPSByZXNpbGllbnRHb3QgYXMgamVzdC5Nb2NrO1xuXG4vLyBNb2NrIHRoZSBsb2dnZXJcbmplc3QubW9jaygnLi4vLi4vLi4vbGliL2xvZ2dlcicsICgpID0+ICh7XG4gIGFwcFNlcnZpY2VMb2dnZXI6IHtcbiAgICBpbmZvOiBqZXN0LmZuKCksXG4gICAgd2FybjogamVzdC5mbigpLFxuICAgIGVycm9yOiBqZXN0LmZuKCksXG4gICAgZGVidWc6IGplc3QuZm4oKSxcbiAgfSxcbn0pKTtcbmNvbnN0IG1vY2tlZExvZ2dlciA9IGFwcFNlcnZpY2VMb2dnZXIgYXMgamVzdC5Nb2NrZWQ8dHlwZW9mIGFwcFNlcnZpY2VMb2dnZXI+O1xuXG5kZXNjcmliZSgnL2FwaS9wcm9jZXNzLXJlY29yZGVkLWF1ZGlvLW5vdGUgQVBJIEVuZHBvaW50JywgKCkgPT4ge1xuICBsZXQgbW9ja1BhcnNlOiBqZXN0Lk1vY2s7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgbW9ja2VkTG9nZ2VyLmluZm8ubW9ja0NsZWFyKCk7XG4gICAgbW9ja2VkTG9nZ2VyLndhcm4ubW9ja0NsZWFyKCk7XG4gICAgbW9ja2VkTG9nZ2VyLmVycm9yLm1vY2tDbGVhcigpO1xuICAgIG1vY2tlZExvZ2dlci5kZWJ1Zy5tb2NrQ2xlYXIoKTtcbiAgICBtb2NrZWRSZXNpbGllbnRHb3QubW9ja1Jlc2V0KCk7XG4gICAgKGZzLnVubGluayBhcyBqZXN0Lk1vY2spLm1vY2tDbGVhcigpO1xuXG4gICAgLy8gU2V0dXAgZm9ybWlkYWJsZSBtb2NrIGZvciBlYWNoIHRlc3RcbiAgICBtb2NrUGFyc2UgPSBqZXN0LmZuKChyZXEsIGNhbGxiYWNrKSA9PiB7XG4gICAgICAvLyBTaW11bGF0ZSBzdWNjZXNzZnVsIHBhcnNpbmcgd2l0aCBtb2NrIGRhdGEgYnkgZGVmYXVsdFxuICAgICAgY29uc3QgbW9ja0ZpbGVzID0ge1xuICAgICAgICBhdWRpb19maWxlOiBbXG4gICAgICAgICAgeyBmaWxlcGF0aDogJ21vY2svcGF0aC9hdWRpby53YXYnLCBvcmlnaW5hbEZpbGVuYW1lOiAnYXVkaW8ud2F2JyB9LFxuICAgICAgICBdLFxuICAgICAgfTtcbiAgICAgIGNvbnN0IG1vY2tGaWVsZHMgPSB7XG4gICAgICAgIHRpdGxlOiBbJ1Rlc3QgVGl0bGUnXSxcbiAgICAgICAgdXNlcl9pZDogWyd0ZXN0LXVzZXItaWQnXSxcbiAgICAgIH07XG4gICAgICBjYWxsYmFjayhudWxsLCBtb2NrRmllbGRzLCBtb2NrRmlsZXMpO1xuICAgIH0pO1xuICAgIChmb3JtaWRhYmxlIGFzIGplc3QuTW9jaykubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gICAgICBwYXJzZTogbW9ja1BhcnNlLFxuICAgICAga2VlcEV4dGVuc2lvbnM6IHRydWUsXG4gICAgfSkpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJldHVybiA0MDUgaWYgbWV0aG9kIGlzIG5vdCBQT1NUJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHsgcmVxLCByZXMgfSA9IGNyZWF0ZU1vY2tzKHsgbWV0aG9kOiAnR0VUJyB9KTtcbiAgICBhd2FpdCBoYW5kbGVyKHJlcSBhcyBhbnksIHJlcyBhcyBhbnkpO1xuICAgIGV4cGVjdChyZXMuX2dldFN0YXR1c0NvZGUoKSkudG9CZSg0MDUpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJldHVybiA0MDAgaWYgYXVkaW9fZmlsZSBpcyBtaXNzaW5nJywgYXN5bmMgKCkgPT4ge1xuICAgIG1vY2tQYXJzZS5tb2NrSW1wbGVtZW50YXRpb25PbmNlKChyZXEsIGNhbGxiYWNrKSA9PiB7XG4gICAgICBjYWxsYmFjayhudWxsLCB7IHRpdGxlOiBbJ1Rlc3QnXSwgdXNlcl9pZDogWyd1c2VyMSddIH0sIHt9KTsgLy8gTm8gYXVkaW9fZmlsZVxuICAgIH0pO1xuICAgIGNvbnN0IHsgcmVxLCByZXMgfSA9IGNyZWF0ZU1vY2tzKHsgbWV0aG9kOiAnUE9TVCcgfSk7XG4gICAgYXdhaXQgaGFuZGxlcihyZXEgYXMgYW55LCByZXMgYXMgYW55KTtcbiAgICBleHBlY3QocmVzLl9nZXRTdGF0dXNDb2RlKCkpLnRvQmUoNDAwKTtcbiAgICBleHBlY3QoSlNPTi5wYXJzZShyZXMuX2dldERhdGEoKSkuZXJyb3IubWVzc2FnZSkudG9CZShcbiAgICAgICdObyBhdWRpbyBmaWxlIHVwbG9hZGVkLidcbiAgICApO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJldHVybiA0MDAgaWYgdGl0bGUgaXMgbWlzc2luZycsIGFzeW5jICgpID0+IHtcbiAgICBtb2NrUGFyc2UubW9ja0ltcGxlbWVudGF0aW9uT25jZSgocmVxLCBjYWxsYmFjaykgPT4ge1xuICAgICAgY2FsbGJhY2soXG4gICAgICAgIG51bGwsXG4gICAgICAgIHsgdXNlcl9pZDogWyd1c2VyMSddIH0sXG4gICAgICAgIHsgYXVkaW9fZmlsZTogW3sgZmlsZXBhdGg6ICdtb2NrL3BhdGgvYXVkaW8ud2F2JyB9XSB9XG4gICAgICApO1xuICAgIH0pO1xuICAgIGNvbnN0IHsgcmVxLCByZXMgfSA9IGNyZWF0ZU1vY2tzKHsgbWV0aG9kOiAnUE9TVCcgfSk7XG4gICAgYXdhaXQgaGFuZGxlcihyZXEgYXMgYW55LCByZXMgYXMgYW55KTtcbiAgICBleHBlY3QocmVzLl9nZXRTdGF0dXNDb2RlKCkpLnRvQmUoNDAwKTtcbiAgICBleHBlY3QoSlNPTi5wYXJzZShyZXMuX2dldERhdGEoKSkuZXJyb3IubWVzc2FnZSkudG9CZShcbiAgICAgICdNaXNzaW5nIHRpdGxlIGZvciB0aGUgYXVkaW8gbm90ZS4nXG4gICAgKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBjYWxsIFB5dGhvbiBiYWNrZW5kIHZpYSByZXNpbGllbnRHb3QgYW5kIHJldHVybiBzdWNjZXNzIGlmIFB5dGhvbiBiYWNrZW5kIHN1Y2NlZWRzJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vY2tQeXRob25SZXNwb25zZSA9IHtcbiAgICAgIG9rOiB0cnVlLFxuICAgICAgZGF0YToge1xuICAgICAgICBub3Rpb25fcGFnZV91cmw6ICdodHRwOi8vbm90aW9uLnNvL3BhZ2UnLFxuICAgICAgICB0aXRsZTogJ1Byb2Nlc3NlZCBUaXRsZScsXG4gICAgICB9LFxuICAgIH07XG4gICAgbW9ja2VkUmVzaWxpZW50R290Lm1vY2tSZXNvbHZlZFZhbHVlT25jZShtb2NrUHl0aG9uUmVzcG9uc2UpO1xuXG4gICAgY29uc3QgeyByZXEsIHJlcyB9ID0gY3JlYXRlTW9ja3MoeyBtZXRob2Q6ICdQT1NUJyB9KTtcbiAgICAvLyBTaW11bGF0ZSBmb3JtaWRhYmxlIHBhcnNpbmcgY29ycmVjdGx5XG4gICAgLy8gRGVmYXVsdCBtb2NrUGFyc2Ugc2V0dXAgYWxyZWFkeSBkb2VzIHRoaXMuXG5cbiAgICBhd2FpdCBoYW5kbGVyKHJlcSBhcyBhbnksIHJlcyBhcyBhbnkpO1xuXG4gICAgZXhwZWN0KHJlcy5fZ2V0U3RhdHVzQ29kZSgpKS50b0JlKDIwMCk7XG4gICAgZXhwZWN0KEpTT04ucGFyc2UocmVzLl9nZXREYXRhKCkpLmRhdGEpLnRvRXF1YWwobW9ja1B5dGhvblJlc3BvbnNlLmRhdGEpO1xuICAgIGV4cGVjdChtb2NrZWRSZXNpbGllbnRHb3QpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICBleHBlY3QobW9ja2VkUmVzaWxpZW50R290KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICdwb3N0JyxcbiAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCcvYXBpL2ludGVybmFsL3Byb2Nlc3NfYXVkaW9fbm90ZV9kYXRhJyksXG4gICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7IGJvZHk6IGV4cGVjdC5hbnkoRm9ybURhdGEpIH0pLCAvLyBDaGVjayB0aGF0IGJvZHkgaXMgRm9ybURhdGFcbiAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdfUHl0aG9uQmFja2VuZENhbGwnKVxuICAgICk7XG4gICAgZXhwZWN0KG1vY2tlZExvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdQeXRob24gYmFja2VuZCBwcm9jZXNzZWQgYXVkaW8gc3VjY2Vzc2Z1bGx5LicpLFxuICAgICAgZXhwZWN0LmFueXRoaW5nKClcbiAgICApO1xuICAgIGV4cGVjdChmcy51bmxpbmspLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgJ21vY2svcGF0aC9hdWRpby53YXYnLFxuICAgICAgZXhwZWN0LmFueShGdW5jdGlvbilcbiAgICApO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJldHVybiA1MDAgYW5kIGxvZyBlcnJvciBpZiBQeXRob24gYmFja2VuZCByZXR1cm5zIGFuIGVycm9yIHN0YXR1cycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2NrUHl0aG9uRXJyb3JSZXNwb25zZSA9IHtcbiAgICAgIG9rOiBmYWxzZSxcbiAgICAgIGVycm9yOiB7IG1lc3NhZ2U6ICdQeXRob24gcHJvY2Vzc2luZyBlcnJvcicsIGNvZGU6ICdQWVRIT05fRVJST1InIH0sXG4gICAgfTtcbiAgICBtb2NrZWRSZXNpbGllbnRHb3QubW9ja1Jlc29sdmVkVmFsdWVPbmNlKG1vY2tQeXRob25FcnJvclJlc3BvbnNlKTsgLy8gcmVzaWxpZW50R290IHN1Y2NlZWRzLCBidXQgUHl0aG9uIHNlcnZpY2UgcmV0dXJucyBlcnJvclxuXG4gICAgY29uc3QgeyByZXEsIHJlcyB9ID0gY3JlYXRlTW9ja3MoeyBtZXRob2Q6ICdQT1NUJyB9KTtcbiAgICBhd2FpdCBoYW5kbGVyKHJlcSBhcyBhbnksIHJlcyBhcyBhbnkpO1xuXG4gICAgZXhwZWN0KHJlcy5fZ2V0U3RhdHVzQ29kZSgpKS50b0JlKDUwMCk7XG4gICAgZXhwZWN0KEpTT04ucGFyc2UocmVzLl9nZXREYXRhKCkpLmVycm9yLm1lc3NhZ2UpLnRvQmUoXG4gICAgICAnUHl0aG9uIHByb2Nlc3NpbmcgZXJyb3InXG4gICAgKTtcbiAgICBleHBlY3QobW9ja2VkTG9nZ2VyLmVycm9yKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdFcnJvciByZXNwb25zZSBmcm9tIFB5dGhvbiBiYWNrZW5kLicpLFxuICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoeyBlcnJvck1zZzogJ1B5dGhvbiBwcm9jZXNzaW5nIGVycm9yJyB9KVxuICAgICk7XG4gICAgZXhwZWN0KGZzLnVubGluaykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAnbW9jay9wYXRoL2F1ZGlvLndhdicsXG4gICAgICBleHBlY3QuYW55KEZ1bmN0aW9uKVxuICAgICk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgcmV0dXJuIDUwMiBhbmQgbG9nIGVycm9yIGlmIHJlc2lsaWVudEdvdCB0aHJvd3MgKFB5dGhvbiBzZXJ2aWNlIGNvbW11bmljYXRpb24gZmFpbHVyZSknLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcmVzaWxpZW50R290RXJyb3IgPSBuZXcgRXJyb3IoXG4gICAgICAnTmV0d29yayBjb25uZWN0aW9uIHRvIFB5dGhvbiBzZXJ2aWNlIGZhaWxlZCdcbiAgICApO1xuICAgIG1vY2tlZFJlc2lsaWVudEdvdC5tb2NrUmVqZWN0ZWRWYWx1ZU9uY2UocmVzaWxpZW50R290RXJyb3IpO1xuXG4gICAgY29uc3QgeyByZXEsIHJlcyB9ID0gY3JlYXRlTW9ja3MoeyBtZXRob2Q6ICdQT1NUJyB9KTtcbiAgICBhd2FpdCBoYW5kbGVyKHJlcSBhcyBhbnksIHJlcyBhcyBhbnkpO1xuXG4gICAgZXhwZWN0KHJlcy5fZ2V0U3RhdHVzQ29kZSgpKS50b0JlKDUwMik7XG4gICAgZXhwZWN0KEpTT04ucGFyc2UocmVzLl9nZXREYXRhKCkpLmVycm9yLm1lc3NhZ2UpLnRvQmUoXG4gICAgICAnTmV0d29yayBjb25uZWN0aW9uIHRvIFB5dGhvbiBzZXJ2aWNlIGZhaWxlZCdcbiAgICApO1xuICAgIGV4cGVjdChtb2NrZWRMb2dnZXIuZXJyb3IpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoXG4gICAgICAgICdFcnJvciBjYWxsaW5nIFB5dGhvbiBiYWNrZW5kIG9yIGR1cmluZyBmaWxlIG9wcy4nXG4gICAgICApLFxuICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoeyBlcnJvcjogcmVzaWxpZW50R290RXJyb3IubWVzc2FnZSB9KVxuICAgICk7XG4gICAgZXhwZWN0KGZzLnVubGluaykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAnbW9jay9wYXRoL2F1ZGlvLndhdicsXG4gICAgICBleHBlY3QuYW55KEZ1bmN0aW9uKVxuICAgICk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgbG9nIGZvcm1pZGFibGUgcGFyc2luZyBlcnJvciBhbmQgcmV0dXJuIDUwMCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBwYXJzaW5nRXJyb3IgPSBuZXcgRXJyb3IoJ0Zvcm1pZGFibGUgZmFpbGVkJyk7XG4gICAgbW9ja1BhcnNlLm1vY2tJbXBsZW1lbnRhdGlvbk9uY2UoKHJlcSwgY2FsbGJhY2spID0+IHtcbiAgICAgIGNhbGxiYWNrKHBhcnNpbmdFcnJvciwge30sIHt9KTtcbiAgICB9KTtcbiAgICBjb25zdCB7IHJlcSwgcmVzIH0gPSBjcmVhdGVNb2Nrcyh7IG1ldGhvZDogJ1BPU1QnIH0pO1xuXG4gICAgYXdhaXQgaGFuZGxlcihyZXEgYXMgYW55LCByZXMgYXMgYW55KTtcblxuICAgIGV4cGVjdChyZXMuX2dldFN0YXR1c0NvZGUoKSkudG9CZSg1MDApO1xuICAgIGV4cGVjdChKU09OLnBhcnNlKHJlcy5fZ2V0RGF0YSgpKS5lcnJvci5tZXNzYWdlKS50b0NvbnRhaW4oXG4gICAgICAnU2VydmVyIGVycm9yOiBGb3JtaWRhYmxlIGZhaWxlZCdcbiAgICApO1xuICAgIGV4cGVjdChtb2NrZWRMb2dnZXIuZXJyb3IpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ0Zvcm1pZGFibGUgcGFyc2luZyBlcnJvci4nKSxcbiAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHsgZXJyb3I6IHBhcnNpbmdFcnJvci5tZXNzYWdlIH0pXG4gICAgKTtcbiAgfSk7XG59KTtcbiJdfQ==