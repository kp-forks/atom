"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const _taskId_1 = __importDefault(require("../[taskId]")); // Adjust path to your API route
const node_mocks_http_1 = require("node-mocks-http");
const nextjs_1 = require("supertokens-node/nextjs");
const logger_1 = require("../../../../lib/logger"); // Actual logger
// Mock pg Pool
const mockQuery = jest.fn();
const mockRelease = jest.fn();
const mockConnect = jest.fn().mockResolvedValue({
    query: mockQuery,
    release: mockRelease,
});
jest.mock('pg', () => {
    const actualPg = jest.requireActual('pg');
    return {
        ...actualPg,
        Pool: jest.fn(() => ({
            connect: mockConnect,
        })),
    };
});
// Mock Supertokens getSession
jest.mock('supertokens-node/nextjs');
const mockedGetSession = nextjs_1.getSession;
// Mock the logger
jest.mock('../../../../lib/logger', () => ({
    appServiceLogger: {
        info: jest.fn(),
        warn: jest.fn(),
        error: jest.fn(),
        debug: jest.fn(),
        fatal: jest.fn(),
    },
}));
const mockedLogger = logger_1.appServiceLogger;
describe('/api/meeting_attendance_status/[taskId] API Endpoint', () => {
    const taskId = 'task-123';
    const userId = 'user-abc';
    const mockStatusRecord = {
        task_id: taskId,
        user_id: userId,
        platform: 'zoom',
        meeting_identifier: 'zoom-meeting-id',
        status_timestamp: new Date().toISOString(),
        current_status_message: 'In Progress',
        final_notion_page_url: null,
        error_details: null,
        created_at: new Date().toISOString(),
    };
    beforeEach(() => {
        mockQuery.mockReset();
        mockRelease.mockReset();
        mockConnect.mockClear(); // Clear connect mock calls too
        mockedGetSession.mockReset();
        Object.values(mockedLogger).forEach((mockFn) => mockFn.mockReset());
        // Default successful session
        mockedGetSession.mockResolvedValue({
            getUserId: () => userId,
            // Add other session methods if your handler uses them
        });
    });
    it('should return 405 if method is not GET', async () => {
        const { req, res } = (0, node_mocks_http_1.createMocks)({ method: 'POST', query: { taskId } });
        await (0, _taskId_1.default)(req, res);
        expect(res._getStatusCode()).toBe(405);
        expect(mockedLogger.warn).toHaveBeenCalledWith(expect.stringContaining('Method not allowed'), expect.anything());
    });
    it('should return 401 if session is not found', async () => {
        mockedGetSession.mockResolvedValueOnce(null);
        const { req, res } = (0, node_mocks_http_1.createMocks)({ method: 'GET', query: { taskId } });
        await (0, _taskId_1.default)(req, res);
        expect(res._getStatusCode()).toBe(401);
        expect(JSON.parse(res._getData()).error).toBe('Unauthorized. Please log in.');
        expect(mockedLogger.warn).toHaveBeenCalledWith(expect.stringContaining('Unauthorized attempt: No active session.'), expect.anything());
    });
    it('should return 400 if taskId is missing', async () => {
        const { req, res } = (0, node_mocks_http_1.createMocks)({ method: 'GET', query: {} }); // No taskId
        await (0, _taskId_1.default)(req, res);
        expect(res._getStatusCode()).toBe(400);
        expect(JSON.parse(res._getData()).error).toBe('Task ID is required and must be a string.');
        expect(mockedLogger.warn).toHaveBeenCalledWith(expect.stringContaining('Invalid or missing taskId.'), expect.anything());
    });
    it('should fetch and return status record successfully', async () => {
        mockQuery.mockResolvedValueOnce({ rows: [mockStatusRecord] });
        const { req, res } = (0, node_mocks_http_1.createMocks)({ method: 'GET', query: { taskId } });
        await (0, _taskId_1.default)(req, res);
        expect(res._getStatusCode()).toBe(200);
        const responseData = JSON.parse(res._getData());
        // Timestamps are stringified, compare relevant parts or re-parse
        expect(responseData.task_id).toEqual(mockStatusRecord.task_id);
        expect(responseData.current_status_message).toEqual(mockStatusRecord.current_status_message);
        expect(mockConnect).toHaveBeenCalledTimes(1);
        expect(mockQuery).toHaveBeenCalledWith(expect.any(String), [
            taskId,
            userId,
        ]);
        expect(mockRelease).toHaveBeenCalledTimes(1);
        expect(mockedLogger.info).toHaveBeenCalledWith(expect.stringContaining('Status found for task.'), expect.anything());
    });
    it('should return 404 if task is not found or not authorized', async () => {
        mockQuery.mockResolvedValueOnce({ rows: [] }); // No rows found
        const { req, res } = (0, node_mocks_http_1.createMocks)({ method: 'GET', query: { taskId } });
        await (0, _taskId_1.default)(req, res);
        expect(res._getStatusCode()).toBe(404);
        expect(JSON.parse(res._getData()).error).toBe('Task not found or not authorized.');
        expect(mockedLogger.info).toHaveBeenCalledWith(expect.stringContaining('Task not found or not authorized for user.'), expect.anything());
    });
    it('should return 500 and log error if database query fails', async () => {
        const dbError = new Error('DB query failed');
        mockQuery.mockRejectedValueOnce(dbError);
        const { req, res } = (0, node_mocks_http_1.createMocks)({ method: 'GET', query: { taskId } });
        await (0, _taskId_1.default)(req, res);
        expect(res._getStatusCode()).toBe(500);
        expect(JSON.parse(res._getData()).error).toBe('Internal Server Error');
        expect(mockedLogger.error).toHaveBeenCalledWith(expect.stringContaining('Database query or connection failed.'), expect.objectContaining({ error: dbError.message }));
    });
    it('should return 500 if Supertokens getSession fails', async () => {
        const sessionError = new Error('Supertokens down');
        mockedGetSession.mockRejectedValueOnce(sessionError);
        const { req, res } = (0, node_mocks_http_1.createMocks)({ method: 'GET', query: { taskId } });
        await (0, _taskId_1.default)(req, res);
        expect(res._getStatusCode()).toBe(500);
        expect(JSON.parse(res._getData()).error).toBe('Authentication error');
        expect(mockedLogger.error).toHaveBeenCalledWith(expect.stringContaining('Supertokens getSession error.'), expect.objectContaining({ error: sessionError.message }));
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiW3Rhc2tJZF0udGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlt0YXNrSWRdLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwwREFBa0MsQ0FBQyxnQ0FBZ0M7QUFDbkUscURBQTZEO0FBRTdELG9EQUFxRDtBQUNyRCxtREFBMEQsQ0FBQyxnQkFBZ0I7QUFFM0UsZUFBZTtBQUNmLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUM1QixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7QUFDOUIsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDO0lBQzlDLEtBQUssRUFBRSxTQUFTO0lBQ2hCLE9BQU8sRUFBRSxXQUFXO0NBQ3JCLENBQUMsQ0FBQztBQUNILElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRTtJQUNuQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzFDLE9BQU87UUFDTCxHQUFHLFFBQVE7UUFDWCxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ25CLE9BQU8sRUFBRSxXQUFXO1NBQ3JCLENBQUMsQ0FBQztLQUNKLENBQUM7QUFDSixDQUFDLENBQUMsQ0FBQztBQUVILDhCQUE4QjtBQUM5QixJQUFJLENBQUMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLENBQUM7QUFDckMsTUFBTSxnQkFBZ0IsR0FBRyxtQkFBdUIsQ0FBQztBQUVqRCxrQkFBa0I7QUFDbEIsSUFBSSxDQUFDLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3pDLGdCQUFnQixFQUFFO1FBQ2hCLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2YsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFF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LEVBQUUsWUFBWSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQ3pELENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGhhbmRsZXIgZnJvbSAnLi4vW3Rhc2tJZF0nOyAvLyBBZGp1c3QgcGF0aCB0byB5b3VyIEFQSSByb3V0ZVxuaW1wb3J0IHsgY3JlYXRlTW9ja3MsIFJlcXVlc3RNZXRob2QgfSBmcm9tICdub2RlLW1vY2tzLWh0dHAnO1xuaW1wb3J0IHsgUG9vbCB9IGZyb20gJ3BnJztcbmltcG9ydCB7IGdldFNlc3Npb24gfSBmcm9tICdzdXBlcnRva2Vucy1ub2RlL25leHRqcyc7XG5pbXBvcnQgeyBhcHBTZXJ2aWNlTG9nZ2VyIH0gZnJvbSAnLi4vLi4vLi4vLi4vbGliL2xvZ2dlcic7IC8vIEFjdHVhbCBsb2dnZXJcblxuLy8gTW9jayBwZyBQb29sXG5jb25zdCBtb2NrUXVlcnkgPSBqZXN0LmZuKCk7XG5jb25zdCBtb2NrUmVsZWFzZSA9IGplc3QuZm4oKTtcbmNvbnN0IG1vY2tDb25uZWN0ID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgcXVlcnk6IG1vY2tRdWVyeSxcbiAgcmVsZWFzZTogbW9ja1JlbGVhc2UsXG59KTtcbmplc3QubW9jaygncGcnLCAoKSA9PiB7XG4gIGNvbnN0IGFjdHVhbFBnID0gamVzdC5yZXF1aXJlQWN0dWFsKCdwZycpO1xuICByZXR1cm4ge1xuICAgIC4uLmFjdHVhbFBnLFxuICAgIFBvb2w6IGplc3QuZm4oKCkgPT4gKHtcbiAgICAgIGNvbm5lY3Q6IG1vY2tDb25uZWN0LFxuICAgIH0pKSxcbiAgfTtcbn0pO1xuXG4vLyBNb2NrIFN1cGVydG9rZW5zIGdldFNlc3Npb25cbmplc3QubW9jaygnc3VwZXJ0b2tlbnMtbm9kZS9uZXh0anMnKTtcbmNvbnN0IG1vY2tlZEdldFNlc3Npb24gPSBnZXRTZXNzaW9uIGFzIGplc3QuTW9jaztcblxuLy8gTW9jayB0aGUgbG9nZ2VyXG5qZXN0Lm1vY2soJy4uLy4uLy4uLy4uL2xpYi9sb2dnZXInLCAoKSA9PiAoe1xuICBhcHBTZXJ2aWNlTG9nZ2VyOiB7XG4gICAgaW5mbzogamVzdC5mbigpLFxuICAgIHdhcm46IGplc3QuZm4oKSxcbiAgICBlcnJvcjogamVzdC5mbigpLFxuICAgIGRlYnVnOiBqZXN0LmZuKCksXG4gICAgZmF0YWw6IGplc3QuZm4oKSxcbiAgfSxcbn0pKTtcbmNvbnN0IG1vY2tlZExvZ2dlciA9IGFwcFNlcnZpY2VMb2dnZXIgYXMgamVzdC5Nb2NrZWQ8dHlwZW9mIGFwcFNlcnZpY2VMb2dnZXI+O1xuXG5kZXNjcmliZSgnL2FwaS9tZWV0aW5nX2F0dGVuZGFuY2Vfc3RhdHVzL1t0YXNrSWRdIEFQSSBFbmRwb2ludCcsICgpID0+IHtcbiAgY29uc3QgdGFza0lkID0gJ3Rhc2stMTIzJztcbiAgY29uc3QgdXNlcklkID0gJ3VzZXItYWJjJztcbiAgY29uc3QgbW9ja1N0YXR1c1JlY29yZCA9IHtcbiAgICB0YXNrX2lkOiB0YXNrSWQsXG4gICAgdXNlcl9pZDogdXNlcklkLFxuICAgIHBsYXRmb3JtOiAnem9vbScsXG4gICAgbWVldGluZ19pZGVudGlmaWVyOiAnem9vbS1tZWV0aW5nLWlkJyxcbiAgICBzdGF0dXNfdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgY3VycmVudF9zdGF0dXNfbWVzc2FnZTogJ0luIFByb2dyZXNzJyxcbiAgICBmaW5hbF9ub3Rpb25fcGFnZV91cmw6IG51bGwsXG4gICAgZXJyb3JfZGV0YWlsczogbnVsbCxcbiAgICBjcmVhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gIH07XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgbW9ja1F1ZXJ5Lm1vY2tSZXNldCgpO1xuICAgIG1vY2tSZWxlYXNlLm1vY2tSZXNldCgpO1xuICAgIG1vY2tDb25uZWN0Lm1vY2tDbGVhcigpOyAvLyBDbGVhciBjb25uZWN0IG1vY2sgY2FsbHMgdG9vXG4gICAgbW9ja2VkR2V0U2Vzc2lvbi5tb2NrUmVzZXQoKTtcbiAgICBPYmplY3QudmFsdWVzKG1vY2tlZExvZ2dlcikuZm9yRWFjaCgobW9ja0ZuKSA9PiBtb2NrRm4ubW9ja1Jlc2V0KCkpO1xuXG4gICAgLy8gRGVmYXVsdCBzdWNjZXNzZnVsIHNlc3Npb25cbiAgICBtb2NrZWRHZXRTZXNzaW9uLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgIGdldFVzZXJJZDogKCkgPT4gdXNlcklkLFxuICAgICAgLy8gQWRkIG90aGVyIHNlc3Npb24gbWV0aG9kcyBpZiB5b3VyIGhhbmRsZXIgdXNlcyB0aGVtXG4gICAgfSk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgcmV0dXJuIDQwNSBpZiBtZXRob2QgaXMgbm90IEdFVCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCB7IHJlcSwgcmVzIH0gPSBjcmVhdGVNb2Nrcyh7IG1ldGhvZDogJ1BPU1QnLCBxdWVyeTogeyB0YXNrSWQgfSB9KTtcbiAgICBhd2FpdCBoYW5kbGVyKHJlcSBhcyBhbnksIHJlcyBhcyBhbnkpO1xuICAgIGV4cGVjdChyZXMuX2dldFN0YXR1c0NvZGUoKSkudG9CZSg0MDUpO1xuICAgIGV4cGVjdChtb2NrZWRMb2dnZXIud2FybikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnTWV0aG9kIG5vdCBhbGxvd2VkJyksXG4gICAgICBleHBlY3QuYW55dGhpbmcoKVxuICAgICk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgcmV0dXJuIDQwMSBpZiBzZXNzaW9uIGlzIG5vdCBmb3VuZCcsIGFzeW5jICgpID0+IHtcbiAgICBtb2NrZWRHZXRTZXNzaW9uLm1vY2tSZXNvbHZlZFZhbHVlT25jZShudWxsKTtcbiAgICBjb25zdCB7IHJlcSwgcmVzIH0gPSBjcmVhdGVNb2Nrcyh7IG1ldGhvZDogJ0dFVCcsIHF1ZXJ5OiB7IHRhc2tJZCB9IH0pO1xuICAgIGF3YWl0IGhhbmRsZXIocmVxIGFzIGFueSwgcmVzIGFzIGFueSk7XG4gICAgZXhwZWN0KHJlcy5fZ2V0U3RhdHVzQ29kZSgpKS50b0JlKDQwMSk7XG4gICAgZXhwZWN0KEpTT04ucGFyc2UocmVzLl9nZXREYXRhKCkpLmVycm9yKS50b0JlKFxuICAgICAgJ1VuYXV0aG9yaXplZC4gUGxlYXNlIGxvZyBpbi4nXG4gICAgKTtcbiAgICBleHBlY3QobW9ja2VkTG9nZ2VyLndhcm4pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ1VuYXV0aG9yaXplZCBhdHRlbXB0OiBObyBhY3RpdmUgc2Vzc2lvbi4nKSxcbiAgICAgIGV4cGVjdC5hbnl0aGluZygpXG4gICAgKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCByZXR1cm4gNDAwIGlmIHRhc2tJZCBpcyBtaXNzaW5nJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHsgcmVxLCByZXMgfSA9IGNyZWF0ZU1vY2tzKHsgbWV0aG9kOiAnR0VUJywgcXVlcnk6IHt9IH0pOyAvLyBObyB0YXNrSWRcbiAgICBhd2FpdCBoYW5kbGVyKHJlcSBhcyBhbnksIHJlcyBhcyBhbnkpO1xuICAgIGV4cGVjdChyZXMuX2dldFN0YXR1c0NvZGUoKSkudG9CZSg0MDApO1xuICAgIGV4cGVjdChKU09OLnBhcnNlKHJlcy5fZ2V0RGF0YSgpKS5lcnJvcikudG9CZShcbiAgICAgICdUYXNrIElEIGlzIHJlcXVpcmVkIGFuZCBtdXN0IGJlIGEgc3RyaW5nLidcbiAgICApO1xuICAgIGV4cGVjdChtb2NrZWRMb2dnZXIud2FybikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnSW52YWxpZCBvciBtaXNzaW5nIHRhc2tJZC4nKSxcbiAgICAgIGV4cGVjdC5hbnl0aGluZygpXG4gICAgKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBmZXRjaCBhbmQgcmV0dXJuIHN0YXR1cyByZWNvcmQgc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgIG1vY2tRdWVyeS5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoeyByb3dzOiBbbW9ja1N0YXR1c1JlY29yZF0gfSk7XG4gICAgY29uc3QgeyByZXEsIHJlcyB9ID0gY3JlYXRlTW9ja3MoeyBtZXRob2Q6ICdHRVQnLCBxdWVyeTogeyB0YXNrSWQgfSB9KTtcblxuICAgIGF3YWl0IGhhbmRsZXIocmVxIGFzIGFueSwgcmVzIGFzIGFueSk7XG5cbiAgICBleHBlY3QocmVzLl9nZXRTdGF0dXNDb2RlKCkpLnRvQmUoMjAwKTtcbiAgICBjb25zdCByZXNwb25zZURhdGEgPSBKU09OLnBhcnNlKHJlcy5fZ2V0RGF0YSgpKTtcbiAgICAvLyBUaW1lc3RhbXBzIGFyZSBzdHJpbmdpZmllZCwgY29tcGFyZSByZWxldmFudCBwYXJ0cyBvciByZS1wYXJzZVxuICAgIGV4cGVjdChyZXNwb25zZURhdGEudGFza19pZCkudG9FcXVhbChtb2NrU3RhdHVzUmVjb3JkLnRhc2tfaWQpO1xuICAgIGV4cGVjdChyZXNwb25zZURhdGEuY3VycmVudF9zdGF0dXNfbWVzc2FnZSkudG9FcXVhbChcbiAgICAgIG1vY2tTdGF0dXNSZWNvcmQuY3VycmVudF9zdGF0dXNfbWVzc2FnZVxuICAgICk7XG5cbiAgICBleHBlY3QobW9ja0Nvbm5lY3QpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICBleHBlY3QobW9ja1F1ZXJ5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3QuYW55KFN0cmluZyksIFtcbiAgICAgIHRhc2tJZCxcbiAgICAgIHVzZXJJZCxcbiAgICBdKTtcbiAgICBleHBlY3QobW9ja1JlbGVhc2UpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICBleHBlY3QobW9ja2VkTG9nZ2VyLmluZm8pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ1N0YXR1cyBmb3VuZCBmb3IgdGFzay4nKSxcbiAgICAgIGV4cGVjdC5hbnl0aGluZygpXG4gICAgKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCByZXR1cm4gNDA0IGlmIHRhc2sgaXMgbm90IGZvdW5kIG9yIG5vdCBhdXRob3JpemVkJywgYXN5bmMgKCkgPT4ge1xuICAgIG1vY2tRdWVyeS5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoeyByb3dzOiBbXSB9KTsgLy8gTm8gcm93cyBmb3VuZFxuICAgIGNvbnN0IHsgcmVxLCByZXMgfSA9IGNyZWF0ZU1vY2tzKHsgbWV0aG9kOiAnR0VUJywgcXVlcnk6IHsgdGFza0lkIH0gfSk7XG5cbiAgICBhd2FpdCBoYW5kbGVyKHJlcSBhcyBhbnksIHJlcyBhcyBhbnkpO1xuXG4gICAgZXhwZWN0KHJlcy5fZ2V0U3RhdHVzQ29kZSgpKS50b0JlKDQwNCk7XG4gICAgZXhwZWN0KEpTT04ucGFyc2UocmVzLl9nZXREYXRhKCkpLmVycm9yKS50b0JlKFxuICAgICAgJ1Rhc2sgbm90IGZvdW5kIG9yIG5vdCBhdXRob3JpemVkLidcbiAgICApO1xuICAgIGV4cGVjdChtb2NrZWRMb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnVGFzayBub3QgZm91bmQgb3Igbm90IGF1dGhvcml6ZWQgZm9yIHVzZXIuJyksXG4gICAgICBleHBlY3QuYW55dGhpbmcoKVxuICAgICk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgcmV0dXJuIDUwMCBhbmQgbG9nIGVycm9yIGlmIGRhdGFiYXNlIHF1ZXJ5IGZhaWxzJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGRiRXJyb3IgPSBuZXcgRXJyb3IoJ0RCIHF1ZXJ5IGZhaWxlZCcpO1xuICAgIG1vY2tRdWVyeS5tb2NrUmVqZWN0ZWRWYWx1ZU9uY2UoZGJFcnJvcik7XG4gICAgY29uc3QgeyByZXEsIHJlcyB9ID0gY3JlYXRlTW9ja3MoeyBtZXRob2Q6ICdHRVQnLCBxdWVyeTogeyB0YXNrSWQgfSB9KTtcblxuICAgIGF3YWl0IGhhbmRsZXIocmVxIGFzIGFueSwgcmVzIGFzIGFueSk7XG5cbiAgICBleHBlY3QocmVzLl9nZXRTdGF0dXNDb2RlKCkpLnRvQmUoNTAwKTtcbiAgICBleHBlY3QoSlNPTi5wYXJzZShyZXMuX2dldERhdGEoKSkuZXJyb3IpLnRvQmUoJ0ludGVybmFsIFNlcnZlciBFcnJvcicpO1xuICAgIGV4cGVjdChtb2NrZWRMb2dnZXIuZXJyb3IpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ0RhdGFiYXNlIHF1ZXJ5IG9yIGNvbm5lY3Rpb24gZmFpbGVkLicpLFxuICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoeyBlcnJvcjogZGJFcnJvci5tZXNzYWdlIH0pXG4gICAgKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCByZXR1cm4gNTAwIGlmIFN1cGVydG9rZW5zIGdldFNlc3Npb24gZmFpbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3Qgc2Vzc2lvbkVycm9yID0gbmV3IEVycm9yKCdTdXBlcnRva2VucyBkb3duJyk7XG4gICAgbW9ja2VkR2V0U2Vzc2lvbi5tb2NrUmVqZWN0ZWRWYWx1ZU9uY2Uoc2Vzc2lvbkVycm9yKTtcbiAgICBjb25zdCB7IHJlcSwgcmVzIH0gPSBjcmVhdGVNb2Nrcyh7IG1ldGhvZDogJ0dFVCcsIHF1ZXJ5OiB7IHRhc2tJZCB9IH0pO1xuXG4gICAgYXdhaXQgaGFuZGxlcihyZXEgYXMgYW55LCByZXMgYXMgYW55KTtcblxuICAgIGV4cGVjdChyZXMuX2dldFN0YXR1c0NvZGUoKSkudG9CZSg1MDApO1xuICAgIGV4cGVjdChKU09OLnBhcnNlKHJlcy5fZ2V0RGF0YSgpKS5lcnJvcikudG9CZSgnQXV0aGVudGljYXRpb24gZXJyb3InKTtcbiAgICBleHBlY3QobW9ja2VkTG9nZ2VyLmVycm9yKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdTdXBlcnRva2VucyBnZXRTZXNzaW9uIGVycm9yLicpLFxuICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoeyBlcnJvcjogc2Vzc2lvbkVycm9yLm1lc3NhZ2UgfSlcbiAgICApO1xuICB9KTtcbn0pO1xuIl19