-- atomic-docker/project/initdb.d/0002-create-pending-jobs-table.sql

-- Table to store information about scheduling jobs pending a callback from atomic-scheduler
CREATE TABLE IF NOT EXISTS pending_scheduling_jobs (
    file_key TEXT PRIMARY KEY NOT NULL,
    user_id TEXT NOT NULL,
    host_id TEXT NOT NULL,
    singleton_id TEXT NOT NULL,
    original_query TEXT,
    submitted_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    status TEXT NOT NULL DEFAULT 'PENDING'
);

-- Optional: Add comments on table and columns for clarity in psql or other DB tools
COMMENT ON TABLE pending_scheduling_jobs IS 'Stores context for scheduling jobs awaiting an asynchronous callback from the atomic-scheduler service.';
COMMENT ON COLUMN pending_scheduling_jobs.file_key IS 'Unique key for correlating callbacks, generated by the agent.';
COMMENT ON COLUMN pending_scheduling_jobs.user_id IS 'Agent''s internal user ID that initiated the request.';
COMMENT ON COLUMN pending_scheduling_jobs.host_id IS 'Host ID sent to the atomic-scheduler.';
COMMENT ON COLUMN pending_scheduling_jobs.singleton_id IS 'Singleton ID (job ID) sent to the atomic-scheduler.';
COMMENT ON COLUMN pending_scheduling_jobs.original_query IS 'Optional: The original natural language query from the user.';
COMMENT ON COLUMN pending_scheduling_jobs.submitted_at IS 'Timestamp when the job was submitted to the scheduler.';
COMMENT ON COLUMN pending_scheduling_jobs.status IS 'Current status of the pending job (e.g., PENDING, PROCESSING_CALLBACK, COMPLETED, ERROR).';

-- Optional: Add indexes for columns frequently used in WHERE clauses beyond the PK
-- CREATE INDEX IF NOT EXISTS idx_pending_jobs_submitted_at ON pending_scheduling_jobs(submitted_at);
-- CREATE INDEX IF NOT EXISTS idx_pending_jobs_status ON pending_scheduling_jobs(status);

-- Log completion of this script (optional, for Docker entrypoint logs)
DO $$
BEGIN
    RAISE NOTICE 'Migration 0002-create-pending-jobs-table.sql executed successfully.';
END;
$$;
