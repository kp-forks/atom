import { scheduleTask, cancelTask, } from '../schedulingSkills';
// Mock the agendaService
const mockAgendaSchedule = jest.fn();
const mockAgendaEvery = jest.fn();
const mockAgendaCancel = jest.fn();
jest.mock('../../../agendaService', () => ({
    __esModule: true, // Needed for ES module imports
    agenda: {
        schedule: mockAgendaSchedule,
        every: mockAgendaEvery,
        cancel: mockAgendaCancel,
    },
    // We don't need to mock ScheduledAgentTaskData as it's an interface
}));
describe('schedulingSkills (Agenda-based)', () => {
    beforeEach(() => {
        // Reset mocks before each test
        mockAgendaSchedule.mockReset().mockResolvedValue({}); // Default to resolve successfully
        mockAgendaEvery.mockReset().mockResolvedValue({}); // Default to resolve successfully
        mockAgendaCancel.mockReset().mockResolvedValue(1); // Default to 1 job cancelled
    });
    describe('scheduleTask', () => {
        const baseJobData = {
            originalUserIntent: 'TEST_INTENT',
            entities: { data: 'sample' },
            userId: 'user-123',
            conversationId: 'conv-456',
        };
        const baseParams = {
            when: '2024-09-01T10:00:00Z',
            originalUserIntent: baseJobData.originalUserIntent,
            entities: baseJobData.entities,
            userId: baseJobData.userId,
            conversationId: baseJobData.conversationId,
            taskDescription: 'Test task scheduling',
        };
        it('should schedule a one-time task using agenda.schedule', async () => {
            const params = { ...baseParams, isRecurring: false };
            const result = await scheduleTask(params);
            expect(result).toBe(`Task "${params.taskDescription}" has been scheduled for ${params.when}.`);
            expect(mockAgendaSchedule).toHaveBeenCalledTimes(1);
            expect(mockAgendaSchedule).toHaveBeenCalledWith(params.when, 'EXECUTE_AGENT_ACTION', baseJobData);
            expect(mockAgendaEvery).not.toHaveBeenCalled();
        });
        it('should schedule a recurring task using agenda.every', async () => {
            const params = {
                ...baseParams,
                isRecurring: true,
                repeatInterval: 'every day at 10am',
                repeatTimezone: 'America/New_York',
            };
            const result = await scheduleTask(params);
            expect(result).toBe(`Recurring task "${params.taskDescription}" scheduled to run based on interval: ${params.repeatInterval}.`);
            expect(mockAgendaEvery).toHaveBeenCalledTimes(1);
            expect(mockAgendaEvery).toHaveBeenCalledWith(params.repeatInterval, 'EXECUTE_AGENT_ACTION', baseJobData, { timezone: params.repeatTimezone });
            expect(mockAgendaSchedule).not.toHaveBeenCalled();
        });
        it('should schedule a recurring task without timezone if not provided', async () => {
            const params = {
                ...baseParams,
                isRecurring: true,
                repeatInterval: '0 0 * * *', // every day at midnight
            };
            await scheduleTask(params);
            expect(mockAgendaEvery).toHaveBeenCalledTimes(1);
            expect(mockAgendaEvery).toHaveBeenCalledWith(params.repeatInterval, 'EXECUTE_AGENT_ACTION', baseJobData, {} // Empty options because timezone is undefined
            );
        });
        it('should return an error message if agenda.schedule fails', async () => {
            const error = new Error('Agenda schedule failed');
            mockAgendaSchedule.mockRejectedValue(error);
            const result = await scheduleTask(baseParams);
            expect(result).toBe(`Failed to schedule task: ${error.message}`);
            expect(mockAgendaSchedule).toHaveBeenCalledTimes(1);
        });
        it('should return an error message if agenda.every fails', async () => {
            const error = new Error('Agenda every failed');
            mockAgendaEvery.mockRejectedValue(error);
            const params = {
                ...baseParams,
                isRecurring: true,
                repeatInterval: '1 day',
            };
            const result = await scheduleTask(params);
            expect(result).toBe(`Failed to schedule task: ${error.message}`);
            expect(mockAgendaEvery).toHaveBeenCalledTimes(1);
        });
        it('should validate required parameters: when (for one-time)', async () => {
            const params = { ...baseParams, when: undefined };
            const result = await scheduleTask(params);
            expect(result).toBe("Scheduling time ('when') must be provided.");
            expect(mockAgendaSchedule).not.toHaveBeenCalled();
        });
        it('should validate required parameters: originalUserIntent', async () => {
            const params = { ...baseParams, originalUserIntent: undefined };
            const result = await scheduleTask(params);
            expect(result).toBe('The original user intent to be scheduled must be provided.');
            expect(mockAgendaSchedule).not.toHaveBeenCalled();
        });
    });
    describe('cancelTask', () => {
        it('should cancel tasks based on provided criteria', async () => {
            const params = {
                jobName: 'EXECUTE_AGENT_ACTION',
                userId: 'user-123',
                originalUserIntent: 'TEST_INTENT',
            };
            const query = {
                name: params.jobName,
                'data.userId': params.userId,
                'data.originalUserIntent': params.originalUserIntent,
            };
            mockAgendaCancel.mockResolvedValue(2); // Simulate 2 jobs cancelled
            const result = await cancelTask(params);
            expect(result).toBe('Successfully cancelled 2 task(s) matching criteria.');
            expect(mockAgendaCancel).toHaveBeenCalledTimes(1);
            expect(mockAgendaCancel).toHaveBeenCalledWith(query);
        });
        it('should return a message if no tasks were cancelled', async () => {
            mockAgendaCancel.mockResolvedValue(0); // Simulate 0 jobs cancelled
            const params = { userId: 'user-nonexistent' };
            const result = await cancelTask(params);
            expect(result).toBe('No tasks found matching the criteria to cancel.');
            expect(mockAgendaCancel).toHaveBeenCalledWith({
                'data.userId': 'user-nonexistent',
            });
        });
        it('should return an error if no criteria provided for cancellation', async () => {
            const result = await cancelTask({});
            expect(result).toBe('No criteria provided to cancel tasks. Please specify jobName, userId, or originalUserIntent.');
            expect(mockAgendaCancel).not.toHaveBeenCalled();
        });
        it('should return an error message if agenda.cancel fails', async () => {
            const error = new Error('Agenda cancel failed');
            mockAgendaCancel.mockRejectedValue(error);
            const params = { userId: 'user-123' };
            const result = await cancelTask(params);
            expect(result).toBe(`Failed to cancel task(s): ${error.message}`);
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZWR1bGluZ1NraWxscy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2NoZWR1bGluZ1NraWxscy50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxZQUFZLEVBQ1osVUFBVSxHQUdYLE1BQU0scUJBQXFCLENBQUM7QUFHN0IseUJBQXlCO0FBQ3pCLE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQ3JDLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUNsQyxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUVuQyxJQUFJLENBQUMsSUFBSSxDQUFDLHdCQUF3QixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDekMsVUFBVSxFQUFFLElBQUksRUFBRSwrQkFBK0I7SUFDakQsTUFBTSxFQUFFO1FBQ04sUUFBUSxFQUFFLGtCQUFrQjtRQUM1QixLQUFLLEVBQUUsZUFBZTtRQUN0QixNQUFNLEVBQUUsZ0JBQWdCO0tBQ3pCO0lBQ0Qsb0VBQW9FO0NBQ3JFLENBQUMsQ0FBQyxDQUFDO0FBRUosUUFBUSxDQUFDLGlDQUFpQyxFQUFFLEdBQUcsRUFBRTtJQUMvQyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsK0JBQStCO1FBQy9CLGtCQUFrQixDQUFDLFNBQVMsRUFBRSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsa0NBQWtDO1FBQ3hGLGVBQWUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLGtDQUFrQztRQUNyRixnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLDZCQUE2QjtJQUNsRixDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFO1FBQzVCLE1BQU0s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Q0FBQztZQUNoRCxnQkFBZ0IsQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMxQyxNQUFNLE1BQU0sR0FBcUIsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLENBQUM7WUFDeEQsTUFBTSxNQUFNLEdBQUcsTUFBTSxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFeEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyw2QkFBNkIsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDcEUsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgc2NoZWR1bGVUYXNrLFxuICBjYW5jZWxUYXNrLFxuICBTY2hlZHVsZVRhc2tQYXJhbXMsXG4gIENhbmNlbFRhc2tQYXJhbXMsXG59IGZyb20gJy4uL3NjaGVkdWxpbmdTa2lsbHMnO1xuaW1wb3J0IHsgYWdlbmRhLCBTY2hlZHVsZWRBZ2VudFRhc2tEYXRhIH0gZnJvbSAnLi4vLi4vLi4vYWdlbmRhU2VydmljZSc7IC8vIEFjdHVhbCBpbXBvcnQgZm9yIHR5cGUsIG1vY2sgaGFuZGxlcyBpbXBsZW1lbnRhdGlvblxuXG4vLyBNb2NrIHRoZSBhZ2VuZGFTZXJ2aWNlXG5jb25zdCBtb2NrQWdlbmRhU2NoZWR1bGUgPSBqZXN0LmZuKCk7XG5jb25zdCBtb2NrQWdlbmRhRXZlcnkgPSBqZXN0LmZuKCk7XG5jb25zdCBtb2NrQWdlbmRhQ2FuY2VsID0gamVzdC5mbigpO1xuXG5qZXN0Lm1vY2soJy4uLy4uLy4uL2FnZW5kYVNlcnZpY2UnLCAoKSA9PiAoe1xuICBfX2VzTW9kdWxlOiB0cnVlLCAvLyBOZWVkZWQgZm9yIEVTIG1vZHVsZSBpbXBvcnRzXG4gIGFnZW5kYToge1xuICAgIHNjaGVkdWxlOiBtb2NrQWdlbmRhU2NoZWR1bGUsXG4gICAgZXZlcnk6IG1vY2tBZ2VuZGFFdmVyeSxcbiAgICBjYW5jZWw6IG1vY2tBZ2VuZGFDYW5jZWwsXG4gIH0sXG4gIC8vIFdlIGRvbid0IG5lZWQgdG8gbW9jayBTY2hlZHVsZWRBZ2VudFRhc2tEYXRhIGFzIGl0J3MgYW4gaW50ZXJmYWNlXG59KSk7XG5cbmRlc2NyaWJlKCdzY2hlZHVsaW5nU2tpbGxzIChBZ2VuZGEtYmFzZWQpJywgKCkgPT4ge1xuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAvLyBSZXNldCBtb2NrcyBiZWZvcmUgZWFjaCB0ZXN0XG4gICAgbW9ja0FnZW5kYVNjaGVkdWxlLm1vY2tSZXNldCgpLm1vY2tSZXNvbHZlZFZhbHVlKHt9KTsgLy8gRGVmYXVsdCB0byByZXNvbHZlIHN1Y2Nlc3NmdWxseVxuICAgIG1vY2tBZ2VuZGFFdmVyeS5tb2NrUmVzZXQoKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSk7IC8vIERlZmF1bHQgdG8gcmVzb2x2ZSBzdWNjZXNzZnVsbHlcbiAgICBtb2NrQWdlbmRhQ2FuY2VsLm1vY2tSZXNldCgpLm1vY2tSZXNvbHZlZFZhbHVlKDEpOyAvLyBEZWZhdWx0IHRvIDEgam9iIGNhbmNlbGxlZFxuICB9KTtcblxuICBkZXNjcmliZSgnc2NoZWR1bGVUYXNrJywgKCkgPT4ge1xuICAgIGNvbnN0IGJhc2VKb2JEYXRhOiBTY2hlZHVsZWRBZ2VudFRhc2tEYXRhID0ge1xuICAgICAgb3JpZ2luYWxVc2VySW50ZW50OiAnVEVTVF9JTlRFTlQnLFxuICAgICAgZW50aXRpZXM6IHsgZGF0YTogJ3NhbXBsZScgfSxcbiAgICAgIHVzZXJJZDogJ3VzZXItMTIzJyxcbiAgICAgIGNvbnZlcnNhdGlvbklkOiAnY29udi00NTYnLFxuICAgIH07XG5cbiAgICBjb25zdCBiYXNlUGFyYW1zOiBTY2hlZHVsZVRhc2tQYXJhbXMgPSB7XG4gICAgICB3aGVuOiAnMjAyNC0wOS0wMVQxMDowMDowMFonLFxuICAgICAgb3JpZ2luYWxVc2VySW50ZW50OiBiYXNlSm9iRGF0YS5vcmlnaW5hbFVzZXJJbnRlbnQsXG4gICAgICBlbnRpdGllczogYmFzZUpvYkRhdGEuZW50aXRpZXMsXG4gICAgICB1c2VySWQ6IGJhc2VKb2JEYXRhLnVzZXJJZCxcbiAgICAgIGNvbnZlcnNhdGlvbklkOiBiYXNlSm9iRGF0YS5jb252ZXJzYXRpb25JZCxcbiAgICAgIHRhc2tEZXNjcmlwdGlvbjogJ1Rlc3QgdGFzayBzY2hlZHVsaW5nJyxcbiAgICB9O1xuXG4gICAgaXQoJ3Nob3VsZCBzY2hlZHVsZSBhIG9uZS10aW1lIHRhc2sgdXNpbmcgYWdlbmRhLnNjaGVkdWxlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcGFyYW1zOiBTY2hlZHVsZVRhc2tQYXJhbXMgPSB7IC4uLmJhc2VQYXJhbXMsIGlzUmVjdXJyaW5nOiBmYWxzZSB9O1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2NoZWR1bGVUYXNrKHBhcmFtcyk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoXG4gICAgICAgIGBUYXNrIFwiJHtwYXJhbXMudGFza0Rlc2NyaXB0aW9ufVwiIGhhcyBiZWVuIHNjaGVkdWxlZCBmb3IgJHtwYXJhbXMud2hlbn0uYFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrQWdlbmRhU2NoZWR1bGUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdChtb2NrQWdlbmRhU2NoZWR1bGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBwYXJhbXMud2hlbixcbiAgICAgICAgJ0VYRUNVVEVfQUdFTlRfQUNUSU9OJyxcbiAgICAgICAgYmFzZUpvYkRhdGFcbiAgICAgICk7XG4gICAgICBleHBlY3QobW9ja0FnZW5kYUV2ZXJ5KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBzY2hlZHVsZSBhIHJlY3VycmluZyB0YXNrIHVzaW5nIGFnZW5kYS5ldmVyeScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHBhcmFtczogU2NoZWR1bGVUYXNrUGFyYW1zID0ge1xuICAgICAgICAuLi5iYXNlUGFyYW1zLFxuICAgICAgICBpc1JlY3VycmluZzogdHJ1ZSxcbiAgICAgICAgcmVwZWF0SW50ZXJ2YWw6ICdldmVyeSBkYXkgYXQgMTBhbScsXG4gICAgICAgIHJlcGVhdFRpbWV6b25lOiAnQW1lcmljYS9OZXdfWW9yaycsXG4gICAgICB9O1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2NoZWR1bGVUYXNrKHBhcmFtcyk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoXG4gICAgICAgIGBSZWN1cnJpbmcgdGFzayBcIiR7cGFyYW1zLnRhc2tEZXNjcmlwdGlvbn1cIiBzY2hlZHVsZWQgdG8gcnVuIGJhc2VkIG9uIGludGVydmFsOiAke3BhcmFtcy5yZXBlYXRJbnRlcnZhbH0uYFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrQWdlbmRhRXZlcnkpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdChtb2NrQWdlbmRhRXZlcnkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBwYXJhbXMucmVwZWF0SW50ZXJ2YWwsXG4gICAgICAgICdFWEVDVVRFX0FHRU5UX0FDVElPTicsXG4gICAgICAgIGJhc2VKb2JEYXRhLFxuICAgICAgICB7IHRpbWV6b25lOiBwYXJhbXMucmVwZWF0VGltZXpvbmUgfVxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrQWdlbmRhU2NoZWR1bGUpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHNjaGVkdWxlIGEgcmVjdXJyaW5nIHRhc2sgd2l0aG91dCB0aW1lem9uZSBpZiBub3QgcHJvdmlkZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwYXJhbXM6IFNjaGVkdWxlVGFza1BhcmFtcyA9IHtcbiAgICAgICAgLi4uYmFzZVBhcmFtcyxcbiAgICAgICAgaXNSZWN1cnJpbmc6IHRydWUsXG4gICAgICAgIHJlcGVhdEludGVydmFsOiAnMCAwICogKiAqJywgLy8gZXZlcnkgZGF5IGF0IG1pZG5pZ2h0XG4gICAgICB9O1xuICAgICAgYXdhaXQgc2NoZWR1bGVUYXNrKHBhcmFtcyk7XG5cbiAgICAgIGV4cGVjdChtb2NrQWdlbmRhRXZlcnkpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdChtb2NrQWdlbmRhRXZlcnkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBwYXJhbXMucmVwZWF0SW50ZXJ2YWwsXG4gICAgICAgICdFWEVDVVRFX0FHRU5UX0FDVElPTicsXG4gICAgICAgIGJhc2VKb2JEYXRhLFxuICAgICAgICB7fSAvLyBFbXB0eSBvcHRpb25zIGJlY2F1c2UgdGltZXpvbmUgaXMgdW5kZWZpbmVkXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gYW4gZXJyb3IgbWVzc2FnZSBpZiBhZ2VuZGEuc2NoZWR1bGUgZmFpbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignQWdlbmRhIHNjaGVkdWxlIGZhaWxlZCcpO1xuICAgICAgbW9ja0FnZW5kYVNjaGVkdWxlLm1vY2tSZWplY3RlZFZhbHVlKGVycm9yKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNjaGVkdWxlVGFzayhiYXNlUGFyYW1zKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZShgRmFpbGVkIHRvIHNjaGVkdWxlIHRhc2s6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgIGV4cGVjdChtb2NrQWdlbmRhU2NoZWR1bGUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGFuIGVycm9yIG1lc3NhZ2UgaWYgYWdlbmRhLmV2ZXJ5IGZhaWxzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ0FnZW5kYSBldmVyeSBmYWlsZWQnKTtcbiAgICAgIG1vY2tBZ2VuZGFFdmVyeS5tb2NrUmVqZWN0ZWRWYWx1ZShlcnJvcik7XG4gICAgICBjb25zdCBwYXJhbXM6IFNjaGVkdWxlVGFza1BhcmFtcyA9IHtcbiAgICAgICAgLi4uYmFzZVBhcmFtcyxcbiAgICAgICAgaXNSZWN1cnJpbmc6IHRydWUsXG4gICAgICAgIHJlcGVhdEludGVydmFsOiAnMSBkYXknLFxuICAgICAgfTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNjaGVkdWxlVGFzayhwYXJhbXMpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKGBGYWlsZWQgdG8gc2NoZWR1bGUgdGFzazogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgZXhwZWN0KG1vY2tBZ2VuZGFFdmVyeSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB2YWxpZGF0ZSByZXF1aXJlZCBwYXJhbWV0ZXJzOiB3aGVuIChmb3Igb25lLXRpbWUpJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcGFyYW1zOiBhbnkgPSB7IC4uLmJhc2VQYXJhbXMsIHdoZW46IHVuZGVmaW5lZCB9O1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2NoZWR1bGVUYXNrKHBhcmFtcyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKFwiU2NoZWR1bGluZyB0aW1lICgnd2hlbicpIG11c3QgYmUgcHJvdmlkZWQuXCIpO1xuICAgICAgZXhwZWN0KG1vY2tBZ2VuZGFTY2hlZHVsZSkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdmFsaWRhdGUgcmVxdWlyZWQgcGFyYW1ldGVyczogb3JpZ2luYWxVc2VySW50ZW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcGFyYW1zOiBhbnkgPSB7IC4uLmJhc2VQYXJhbXMsIG9yaWdpbmFsVXNlckludGVudDogdW5kZWZpbmVkIH07XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzY2hlZHVsZVRhc2socGFyYW1zKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoXG4gICAgICAgICdUaGUgb3JpZ2luYWwgdXNlciBpbnRlbnQgdG8gYmUgc2NoZWR1bGVkIG11c3QgYmUgcHJvdmlkZWQuJ1xuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrQWdlbmRhU2NoZWR1bGUpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjYW5jZWxUYXNrJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY2FuY2VsIHRhc2tzIGJhc2VkIG9uIHByb3ZpZGVkIGNyaXRlcmlhJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcGFyYW1zOiBDYW5jZWxUYXNrUGFyYW1zID0ge1xuICAgICAgICBqb2JOYW1lOiAnRVhFQ1VURV9BR0VOVF9BQ1RJT04nLFxuICAgICAgICB1c2VySWQ6ICd1c2VyLTEyMycsXG4gICAgICAgIG9yaWdpbmFsVXNlckludGVudDogJ1RFU1RfSU5URU5UJyxcbiAgICAgIH07XG4gICAgICBjb25zdCBxdWVyeSA9IHtcbiAgICAgICAgbmFtZTogcGFyYW1zLmpvYk5hbWUsXG4gICAgICAgICdkYXRhLnVzZXJJZCc6IHBhcmFtcy51c2VySWQsXG4gICAgICAgICdkYXRhLm9yaWdpbmFsVXNlckludGVudCc6IHBhcmFtcy5vcmlnaW5hbFVzZXJJbnRlbnQsXG4gICAgICB9O1xuXG4gICAgICBtb2NrQWdlbmRhQ2FuY2VsLm1vY2tSZXNvbHZlZFZhbHVlKDIpOyAvLyBTaW11bGF0ZSAyIGpvYnMgY2FuY2VsbGVkXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjYW5jZWxUYXNrKHBhcmFtcyk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoXG4gICAgICAgICdTdWNjZXNzZnVsbHkgY2FuY2VsbGVkIDIgdGFzayhzKSBtYXRjaGluZyBjcml0ZXJpYS4nXG4gICAgICApO1xuICAgICAgZXhwZWN0KG1vY2tBZ2VuZGFDYW5jZWwpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdChtb2NrQWdlbmRhQ2FuY2VsKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChxdWVyeSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBhIG1lc3NhZ2UgaWYgbm8gdGFza3Mgd2VyZSBjYW5jZWxsZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrQWdlbmRhQ2FuY2VsLm1vY2tSZXNvbHZlZFZhbHVlKDApOyAvLyBTaW11bGF0ZSAwIGpvYnMgY2FuY2VsbGVkXG4gICAgICBjb25zdCBwYXJhbXM6IENhbmNlbFRhc2tQYXJhbXMgPSB7IHVzZXJJZDogJ3VzZXItbm9uZXhpc3RlbnQnIH07XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjYW5jZWxUYXNrKHBhcmFtcyk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoJ05vIHRhc2tzIGZvdW5kIG1hdGNoaW5nIHRoZSBjcml0ZXJpYSB0byBjYW5jZWwuJyk7XG4gICAgICBleHBlY3QobW9ja0FnZW5kYUNhbmNlbCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xuICAgICAgICAnZGF0YS51c2VySWQnOiAndXNlci1ub25leGlzdGVudCcsXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGFuIGVycm9yIGlmIG5vIGNyaXRlcmlhIHByb3ZpZGVkIGZvciBjYW5jZWxsYXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjYW5jZWxUYXNrKHt9KTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoXG4gICAgICAgICdObyBjcml0ZXJpYSBwcm92aWRlZCB0byBjYW5jZWwgdGFza3MuIFBsZWFzZSBzcGVjaWZ5IGpvYk5hbWUsIHVzZXJJZCwgb3Igb3JpZ2luYWxVc2VySW50ZW50LidcbiAgICAgICk7XG4gICAgICBleHBlY3QobW9ja0FnZW5kYUNhbmNlbCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGFuIGVycm9yIG1lc3NhZ2UgaWYgYWdlbmRhLmNhbmNlbCBmYWlscycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCdBZ2VuZGEgY2FuY2VsIGZhaWxlZCcpO1xuICAgICAgbW9ja0FnZW5kYUNhbmNlbC5tb2NrUmVqZWN0ZWRWYWx1ZShlcnJvcik7XG4gICAgICBjb25zdCBwYXJhbXM6IENhbmNlbFRhc2tQYXJhbXMgPSB7IHVzZXJJZDogJ3VzZXItMTIzJyB9O1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY2FuY2VsVGFzayhwYXJhbXMpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKGBGYWlsZWQgdG8gY2FuY2VsIHRhc2socyk6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==