import { enableAutopilot, disableAutopilot, getAutopilotStatus, } from './autopilotSkills';
import * as apiHelper from '../../autopilot/_libs/api-helper'; // To mock its functions
// Mock the api-helper module
jest.mock('../../autopilot/_libs/api-helper', () => ({
    createDailyFeaturesApplyEventTrigger: jest.fn(),
    upsertAutopilotOne: jest.fn(),
    deleteScheduledEventForAutopilot: jest.fn(),
    deleteAutopilotGivenId: jest.fn(),
    listAutopilotsGivenUserId: jest.fn(),
    getAutopilotGivenId: jest.fn(),
}));
// Mock dayjs for consistent date generation if needed, though current skills might not require deep mocking of it.
// For now, we'll rely on the actual dayjs unless tests become flaky due to timestamps.
// jest.mock('dayjs', () => {
//   const actualDayjs = jest.requireActual('dayjs');
//   // Mock specific functions if needed, e.g., actualDayjs.tz.guess = () => 'Test/Timezone';
//   return actualDayjs;
// });
describe('Autopilot Skills', () => {
    const userId = 'test-user-123';
    beforeEach(() => {
        // Reset mocks before each test
        jest.clearAllMocks();
    });
    describe('enableAutopilot', () => {
        const mockQueryComplex = JSON.stringify({
            timezone: 'America/New_York',
            payload: {
                windowStartDate: '2024-09-01T09:00:00.000Z',
                windowEndDate: '2024-09-08T17:00:00.000Z',
            },
        });
        const mockAutopilotData = { id: 'event-id-123', userId };
        it('should enable autopilot successfully when all API calls succeed', async () => {
            apiHelper.createDailyFeaturesApplyEventTrigger.mockResolvedValue({ ok: true, data: 'event-id-123' });
            apiHelper.upsertAutopilotOne.mockResolvedValue({
                ok: true,
                data: mockAutopilotData,
            });
            const result = await enableAutopilot(userId, mockQueryComplex);
            expect(apiHelper.createDailyFeaturesApplyEventTrigger).toHaveBeenCalled();
            expect(apiHelper.upsertAutopilotOne).toHaveBeenCalled();
            expect(result.ok).toBe(true);
            expect(result.data).toEqual(mockAutopilotData);
        });
        it('should return error if createDailyFeaturesApplyEventTrigger fails', async () => {
            apiHelper.createDailyFeaturesApplyEventTrigger.mockResolvedValue({
                ok: false,
                error: { code: 'API_ERROR', message: 'Trigger failed' },
            });
            const result = await enableAutopilot(userId, mockQueryComplex);
            expect(apiHelper.createDailyFeaturesApplyEventTrigger).toHaveBeenCalled();
            expect(apiHelper.upsertAutopilotOne).not.toHaveBeenCalled();
            expect(result.ok).toBe(false);
            expect(result.error?.message).toBe('Trigger failed');
        });
        it('should call deleteScheduledEventForAutopilot if upsertAutopilotOne fails', async () => {
            apiHelper.createDailyFeaturesApplyEventTrigger.mockResolvedValue({ ok: true, data: 'event-id-123' });
            apiHelper.upsertAutopilotOne.mockResolvedValue({
                ok: false,
                error: { code: 'DB_ERROR', message: 'Upsert failed' },
            });
            apiHelper.deleteScheduledEventForAutopilot.mockResolvedValue({ ok: true, data: { success: true } }); // Mock cleanup
            const result = await enableAutopilot(userId, mockQueryComplex);
            expect(apiHelper.createDailyFeaturesApplyEventTrigger).toHaveBeenCalled();
            expect(apiHelper.upsertAutopilotOne).toHaveBeenCalled();
            expect(apiHelper.deleteScheduledEventForAutopilot).toHaveBeenCalledWith('event-id-123');
            expect(result.ok).toBe(false);
            expect(result.error?.message).toBe('Upsert failed');
        });
        it('should handle simple string query for default behavior', async () => {
            apiHelper.createDailyFeaturesApplyEventTrigger.mockResolvedValue({ ok: true, data: 'event-id-default' });
            apiHelper.upsertAutopilotOne.mockResolvedValue({
                ok: true,
                data: { ...mockAutopilotData, id: 'event-id-default' },
            });
            const simpleQuery = 'just enable it'; // Not JSON
            await enableAutopilot(userId, simpleQuery);
            expect(apiHelper.createDailyFeaturesApplyEventTrigger).toHaveBeenCalledWith(expect.objectContaining({ userId }), expect.objectContaining({ userId }));
            // Check that payload uses defaults (hard to check exact dates without more complex mocking of dayjs)
            const callArgs = apiHelper.createDailyFeaturesApplyEventTrigger.mock.calls[0];
            expect(callArgs[0].payload.timezone).toBeDefined(); // Default timezone was applied
        });
    });
    describe('disableAutopilot', () => {
        const eventId = 'event-to-disable-456';
        it('should disable autopilot successfully when all API calls succeed', async () => {
            apiHelper.deleteScheduledEventForAutopilot.mockResolvedValue({ ok: true, data: { success: true } });
            apiHelper.deleteAutopilotGivenId.mockResolvedValue({
                ok: true,
                data: { id: eventId },
            }); // Mock the deleted record
            const result = await disableAutopilot(userId, eventId); // Query is eventId directly
            expect(apiHelper.deleteScheduledEventForAutopilot).toHaveBeenCalledWith(eventId);
            expect(apiHelper.deleteAutopilotGivenId).toHaveBeenCalledWith(eventId);
            expect(result.ok).toBe(true);
            expect(result.data?.success).toBe(true);
        });
        it('should return error if eventId is not provided in query', async () => {
            const result = await disableAutopilot(userId, ''); // Empty query
            expect(result.ok).toBe(false);
            expect(result.error?.code).toBe('VALIDATION_ERROR');
            expect(result.error?.message).toContain('eventId (autopilotId) is required');
            expect(apiHelper.deleteScheduledEventForAutopilot).not.toHaveBeenCalled();
            expect(apiHelper.deleteAutopilotGivenId).not.toHaveBeenCalled();
        });
        it('should proceed to delete DB record even if deleting scheduled event fails, but reflect overall outcome based on DB deletion', async () => {
            apiHelper.deleteScheduledEventForAutopilot.mockResolvedValue({
                ok: false,
                error: { code: 'API_ERROR', message: 'Event deletion failed' },
            });
            apiHelper.deleteAutopilotGivenId.mockResolvedValue({
                ok: true,
                data: { id: eventId },
            });
            const result = await disableAutopilot(userId, eventId);
            expect(apiHelper.deleteScheduledEventForAutopilot).toHaveBeenCalledWith(eventId);
            expect(apiHelper.deleteAutopilotGivenId).toHaveBeenCalledWith(eventId);
            // This scenario is tricky: if event deletion fails, it's a warning. Success depends on DB deletion.
            // The current logic in disableAutopilot returns ok:true if deleteAutopilotGivenId is ok.
            expect(result.ok).toBe(true);
            expect(result.data?.success).toBe(true);
        });
        it('should return error if deleteAutopilotGivenId fails', async () => {
            apiHelper.deleteScheduledEventForAutopilot.mockResolvedValue({ ok: true, data: { success: true } });
            apiHelper.deleteAutopilotGivenId.mockResolvedValue({
                ok: false,
                error: { code: 'DB_ERROR', message: 'DB deletion failed' },
            });
            const result = await disableAutopilot(userId, eventId);
            expect(apiHelper.deleteScheduledEventForAutopilot).toHaveBeenCalledWith(eventId);
            expect(apiHelper.deleteAutopilotGivenId).toHaveBeenCalledWith(eventId);
            expect(result.ok).toBe(false);
            expect(result.error?.message).toBe('DB deletion failed');
        });
    });
    describe('getAutopilotStatus', () => {
        const specificAutopilotId = 'ap-specific-789';
        const mockAutopilotDetail = {
            id: specificAutopilotId,
            userId,
            scheduleAt: 'tomorrow',
        };
        const mockAutopilotList = [
            { id: 'ap-list-001', userId, scheduleAt: 'today' },
        ];
        it('should call getAutopilotGivenId if autopilotId is provided in query', async () => {
            apiHelper.getAutopilotGivenId.mockResolvedValue({
                ok: true,
                data: mockAutopilotDetail,
            });
            const result = await getAutopilotStatus(userId, specificAutopilotId); // Query is autopilotId
            expect(apiHelper.getAutopilotGivenId).toHaveBeenCalledWith(specificAutopilotId);
            expect(apiHelper.listAutopilotsGivenUserId).not.toHaveBeenCalled();
            expect(result.ok).toBe(true);
            expect(result.data).toEqual(mockAutopilotDetail);
        });
        it('should call listAutopilotsGivenUserId if no autopilotId is provided in query', async () => {
            // Note: listAutopilotsGivenUserId in api-helper returns a single AutopilotType | null, not an array.
            // The skill reflects this. If it were to return an array, this test and skill would change.
            apiHelper.listAutopilotsGivenUserId.mockResolvedValue({
                ok: true,
                data: mockAutopilotList[0],
            });
            const result = await getAutopilotStatus(userId, ''); // Empty query
            expect(apiHelper.listAutopilotsGivenUserId).toHaveBeenCalledWith(userId);
            expect(apiHelper.getAutopilotGivenId).not.toHaveBeenCalled();
            expect(result.ok).toBe(true);
            expect(result.data).toEqual(mockAutopilotList[0]);
        });
        it('should handle JSON query for specific autopilotId', async () => {
            apiHelper.getAutopilotGivenId.mockResolvedValue({
                ok: true,
                data: mockAutopilotDetail,
            });
            const queryJson = JSON.stringify({ autopilotId: specificAutopilotId });
            await getAutopilotStatus(userId, queryJson);
            expect(apiHelper.getAutopilotGivenId).toHaveBeenCalledWith(specificAutopilotId);
        });
        it('should return error if the API call fails (getAutopilotGivenId)', async () => {
            apiHelper.getAutopilotGivenId.mockResolvedValue({
                ok: false,
                error: { code: 'API_ERROR', message: 'Fetch failed' },
            });
            const result = await getAutopilotStatus(userId, specificAutopilotId);
            expect(result.ok).toBe(false);
            expect(result.error?.message).toBe('Fetch failed');
        });
        it('should return error if the API call fails (listAutopilotsGivenUserId)', async () => {
            apiHelper.listAutopilotsGivenUserId.mockResolvedValue({
                ok: false,
                error: { code: 'API_ERROR', message: 'List fetch failed' },
            });
            const result = await getAutopilotStatus(userId, '');
            expect(result.ok).toBe(false);
            expect(result.error?.message).toBe('List fetch failed');
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0b3BpbG90U2tpbGxzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhdXRvcGlsb3RTa2lsbHMudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsZUFBZSxFQUNmLGdCQUFnQixFQUNoQixrQkFBa0IsR0FDbkIsTUFBTSxtQkFBbUIsQ0FBQztBQUMzQixPQUFPLEtBQUssU0FBUyxNQUFNLGtDQUFrQyxDQUFDLENBQUMsd0JBQXdCO0FBT3ZGLDZCQUE2QjtBQUM3QixJQUFJLENBQUMsSUFBSSxDQUFDLGtDQUFrQyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDbkQsb0NBQW9DLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUMvQyxrQkFBa0IsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0lBQzdCLGdDQUFnQyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7SUFDM0Msc0JBQXNCLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUNqQyx5QkFBeUIsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0lBQ3BDLG1CQUFtQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Q0FDL0IsQ0FBQyxDQUFDLENBQUM7QUFFSixtSEFBbUg7QUFDbkgsdUZBQXVGO0FBQ3ZGLDZCQUE2QjtBQUM3QixxREFBcUQ7QUFDckQsOEZBQThGO0FBQzlGLHdCQUF3QjtBQUN4QixNQUFNO0FBRU4sUUFBUSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRTtJQUNoQyxNQUFNLE1BQU0sR0FBRyxlQUFlLENBQUM7SUFFL0IsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLCtCQUErQjtRQUMvQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkIsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO1FBQy9CLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUN0QyxRQUFRLEVB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bUJBQWlDLENBQUMsaUJBQWlCLENBQUM7Z0JBQzdELEVBQUUsRUFBRSxLQUFLO2dCQUNULEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsT0FBTyxFQUFFLGNBQWMsRUFBRTthQUN0RCxDQUFDLENBQUM7WUFDSCxNQUFNLE1BQU0sR0FBRyxNQUFNLGtCQUFrQixDQUFDLE1BQU0sRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO1lBQ3JFLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzlCLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNyRCxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyx1RUFBdUUsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNwRixTQUFTLENBQUMseUJBQXVDLENBQUMsaUJBQWlCLENBQUM7Z0JBQ25FLEVBQUUsRUFBRSxLQUFLO2dCQUNULEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFO2FBQzNELENBQUMsQ0FBQztZQUNILE1BQU0sTUFBTSxHQUFHLE1BQU0sa0JBQWtCLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ3BELE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzlCLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBQzFELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIGVuYWJsZUF1dG9waWxvdCxcbiAgZGlzYWJsZUF1dG9waWxvdCxcbiAgZ2V0QXV0b3BpbG90U3RhdHVzLFxufSBmcm9tICcuL2F1dG9waWxvdFNraWxscyc7XG5pbXBvcnQgKiBhcyBhcGlIZWxwZXIgZnJvbSAnLi4vLi4vYXV0b3BpbG90L19saWJzL2FwaS1oZWxwZXInOyAvLyBUbyBtb2NrIGl0cyBmdW5jdGlvbnNcbmltcG9ydCB7XG4gIEF1dG9waWxvdFR5cGUsXG4gIFNjaGVkdWxlQXNzaXN0V2l0aE1lZXRpbmdRdWV1ZUJvZHlUeXBlLFxuICBBdXRvcGlsb3RBcGlSZXNwb25zZSxcbn0gZnJvbSAnLi4vLi4vYXV0b3BpbG90L19saWJzL3R5cGVzJztcblxuLy8gTW9jayB0aGUgYXBpLWhlbHBlciBtb2R1bGVcbmplc3QubW9jaygnLi4vLi4vYXV0b3BpbG90L19saWJzL2FwaS1oZWxwZXInLCAoKSA9PiAoe1xuICBjcmVhdGVEYWlseUZlYXR1cmVzQXBwbHlFdmVudFRyaWdnZXI6IGplc3QuZm4oKSxcbiAgdXBzZXJ0QXV0b3BpbG90T25lOiBqZXN0LmZuKCksXG4gIGRlbGV0ZVNjaGVkdWxlZEV2ZW50Rm9yQXV0b3BpbG90OiBqZXN0LmZuKCksXG4gIGRlbGV0ZUF1dG9waWxvdEdpdmVuSWQ6IGplc3QuZm4oKSxcbiAgbGlzdEF1dG9waWxvdHNHaXZlblVzZXJJZDogamVzdC5mbigpLFxuICBnZXRBdXRvcGlsb3RHaXZlbklkOiBqZXN0LmZuKCksXG59KSk7XG5cbi8vIE1vY2sgZGF5anMgZm9yIGNvbnNpc3RlbnQgZGF0ZSBnZW5lcmF0aW9uIGlmIG5lZWRlZCwgdGhvdWdoIGN1cnJlbnQgc2tpbGxzIG1pZ2h0IG5vdCByZXF1aXJlIGRlZXAgbW9ja2luZyBvZiBpdC5cbi8vIEZvciBub3csIHdlJ2xsIHJlbHkgb24gdGhlIGFjdHVhbCBkYXlqcyB1bmxlc3MgdGVzdHMgYmVjb21lIGZsYWt5IGR1ZSB0byB0aW1lc3RhbXBzLlxuLy8gamVzdC5tb2NrKCdkYXlqcycsICgpID0+IHtcbi8vICAgY29uc3QgYWN0dWFsRGF5anMgPSBqZXN0LnJlcXVpcmVBY3R1YWwoJ2RheWpzJyk7XG4vLyAgIC8vIE1vY2sgc3BlY2lmaWMgZnVuY3Rpb25zIGlmIG5lZWRlZCwgZS5nLiwgYWN0dWFsRGF5anMudHouZ3Vlc3MgPSAoKSA9PiAnVGVzdC9UaW1lem9uZSc7XG4vLyAgIHJldHVybiBhY3R1YWxEYXlqcztcbi8vIH0pO1xuXG5kZXNjcmliZSgnQXV0b3BpbG90IFNraWxscycsICgpID0+IHtcbiAgY29uc3QgdXNlcklkID0gJ3Rlc3QtdXNlci0xMjMnO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIC8vIFJlc2V0IG1vY2tzIGJlZm9yZSBlYWNoIHRlc3RcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2VuYWJsZUF1dG9waWxvdCcsICgpID0+IHtcbiAgICBjb25zdCBtb2NrUXVlcnlDb21wbGV4ID0gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgdGltZXpvbmU6ICdBbWVyaWNhL05ld19Zb3JrJyxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgd2luZG93U3RhcnREYXRlOiAnMjAyNC0wOS0wMVQwOTowMDowMC4wMDBaJyxcbiAgICAgICAgd2luZG93RW5kRGF0ZTogJzIwMjQtMDktMDhUMTc6MDA6MDAuMDAwWicsXG4gICAgICB9LFxuICAgIH0pO1xuICAgIGNvbnN0IG1vY2tBdXRvcGlsb3REYXRhID0geyBpZDogJ2V2ZW50LWlkLTEyMycsIHVzZXJJZCB9IGFzIEF1dG9waWxvdFR5cGU7XG5cbiAgICBpdCgnc2hvdWxkIGVuYWJsZSBhdXRvcGlsb3Qgc3VjY2Vzc2Z1bGx5IHdoZW4gYWxsIEFQSSBjYWxscyBzdWNjZWVkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgKFxuICAgICAgICBhcGlIZWxwZXIuY3JlYXRlRGFpbHlGZWF0dXJlc0FwcGx5RXZlbnRUcmlnZ2VyIGFzIGplc3QuTW9ja1xuICAgICAgKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IG9rOiB0cnVlLCBkYXRhOiAnZXZlbnQtaWQtMTIzJyB9KTtcbiAgICAgIChhcGlIZWxwZXIudXBzZXJ0QXV0b3BpbG90T25lIGFzIGplc3QuTW9jaykubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBvazogdHJ1ZSxcbiAgICAgICAgZGF0YTogbW9ja0F1dG9waWxvdERhdGEsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZW5hYmxlQXV0b3BpbG90KHVzZXJJZCwgbW9ja1F1ZXJ5Q29tcGxleCk7XG5cbiAgICAgIGV4cGVjdChhcGlIZWxwZXIuY3JlYXRlRGFpbHlGZWF0dXJlc0FwcGx5RXZlbnRUcmlnZ2VyKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QoYXBpSGVscGVyLnVwc2VydEF1dG9waWxvdE9uZSkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5vaykudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuZGF0YSkudG9FcXVhbChtb2NrQXV0b3BpbG90RGF0YSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBlcnJvciBpZiBjcmVhdGVEYWlseUZlYXR1cmVzQXBwbHlFdmVudFRyaWdnZXIgZmFpbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAoXG4gICAgICAgIGFwaUhlbHBlci5jcmVhdGVEYWlseUZlYXR1cmVzQXBwbHlFdmVudFRyaWdnZXIgYXMgamVzdC5Nb2NrXG4gICAgICApLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgb2s6IGZhbHNlLFxuICAgICAgICBlcnJvcjogeyBjb2RlOiAnQVBJX0VSUk9SJywgbWVzc2FnZTogJ1RyaWdnZXIgZmFpbGVkJyB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGVuYWJsZUF1dG9waWxvdCh1c2VySWQsIG1vY2tRdWVyeUNvbXBsZXgpO1xuXG4gICAgICBleHBlY3QoYXBpSGVscGVyLmNyZWF0ZURhaWx5RmVhdHVyZXNBcHBseUV2ZW50VHJpZ2dlcikudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KGFwaUhlbHBlci51cHNlcnRBdXRvcGlsb3RPbmUpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QocmVzdWx0Lm9rKS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3I/Lm1lc3NhZ2UpLnRvQmUoJ1RyaWdnZXIgZmFpbGVkJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGNhbGwgZGVsZXRlU2NoZWR1bGVkRXZlbnRGb3JBdXRvcGlsb3QgaWYgdXBzZXJ0QXV0b3BpbG90T25lIGZhaWxzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgKFxuICAgICAgICBhcGlIZWxwZXIuY3JlYXRlRGFpbHlGZWF0dXJlc0FwcGx5RXZlbnRUcmlnZ2VyIGFzIGplc3QuTW9ja1xuICAgICAgKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IG9rOiB0cnVlLCBkYXRhOiAnZXZlbnQtaWQtMTIzJyB9KTtcbiAgICAgIChhcGlIZWxwZXIudXBzZXJ0QXV0b3BpbG90T25lIGFzIGplc3QuTW9jaykubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBvazogZmFsc2UsXG4gICAgICAgIGVycm9yOiB7IGNvZGU6ICdEQl9FUlJPUicsIG1lc3NhZ2U6ICdVcHNlcnQgZmFpbGVkJyB9LFxuICAgICAgfSk7XG4gICAgICAoXG4gICAgICAgIGFwaUhlbHBlci5kZWxldGVTY2hlZHVsZWRFdmVudEZvckF1dG9waWxvdCBhcyBqZXN0Lk1vY2tcbiAgICAgICkubW9ja1Jlc29sdmVkVmFsdWUoeyBvazogdHJ1ZSwgZGF0YTogeyBzdWNjZXNzOiB0cnVlIH0gfSk7IC8vIE1vY2sgY2xlYW51cFxuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBlbmFibGVBdXRvcGlsb3QodXNlcklkLCBtb2NrUXVlcnlDb21wbGV4KTtcblxuICAgICAgZXhwZWN0KGFwaUhlbHBlci5jcmVhdGVEYWlseUZlYXR1cmVzQXBwbHlFdmVudFRyaWdnZXIpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIGV4cGVjdChhcGlIZWxwZXIudXBzZXJ0QXV0b3BpbG90T25lKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QoYXBpSGVscGVyLmRlbGV0ZVNjaGVkdWxlZEV2ZW50Rm9yQXV0b3BpbG90KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ2V2ZW50LWlkLTEyMydcbiAgICAgICk7XG4gICAgICBleHBlY3QocmVzdWx0Lm9rKS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3I/Lm1lc3NhZ2UpLnRvQmUoJ1Vwc2VydCBmYWlsZWQnKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBzaW1wbGUgc3RyaW5nIHF1ZXJ5IGZvciBkZWZhdWx0IGJlaGF2aW9yJywgYXN5bmMgKCkgPT4ge1xuICAgICAgKFxuICAgICAgICBhcGlIZWxwZXIuY3JlYXRlRGFpbHlGZWF0dXJlc0FwcGx5RXZlbnRUcmlnZ2VyIGFzIGplc3QuTW9ja1xuICAgICAgKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IG9rOiB0cnVlLCBkYXRhOiAnZXZlbnQtaWQtZGVmYXVsdCcgfSk7XG4gICAgICAoYXBpSGVscGVyLnVwc2VydEF1dG9waWxvdE9uZSBhcyBqZXN0Lk1vY2spLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgb2s6IHRydWUsXG4gICAgICAgIGRhdGE6IHsgLi4ubW9ja0F1dG9waWxvdERhdGEsIGlkOiAnZXZlbnQtaWQtZGVmYXVsdCcgfSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBzaW1wbGVRdWVyeSA9ICdqdXN0IGVuYWJsZSBpdCc7IC8vIE5vdCBKU09OXG4gICAgICBhd2FpdCBlbmFibGVBdXRvcGlsb3QodXNlcklkLCBzaW1wbGVRdWVyeSk7XG5cbiAgICAgIGV4cGVjdChcbiAgICAgICAgYXBpSGVscGVyLmNyZWF0ZURhaWx5RmVhdHVyZXNBcHBseUV2ZW50VHJpZ2dlclxuICAgICAgKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoeyB1c2VySWQgfSksXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHsgdXNlcklkIH0pXG4gICAgICApO1xuICAgICAgLy8gQ2hlY2sgdGhhdCBwYXlsb2FkIHVzZXMgZGVmYXVsdHMgKGhhcmQgdG8gY2hlY2sgZXhhY3QgZGF0ZXMgd2l0aG91dCBtb3JlIGNvbXBsZXggbW9ja2luZyBvZiBkYXlqcylcbiAgICAgIGNvbnN0IGNhbGxBcmdzID0gKFxuICAgICAgICBhcGlIZWxwZXIuY3JlYXRlRGFpbHlGZWF0dXJlc0FwcGx5RXZlbnRUcmlnZ2VyIGFzIGplc3QuTW9ja1xuICAgICAgKS5tb2NrLmNhbGxzWzBdO1xuICAgICAgZXhwZWN0KGNhbGxBcmdzWzBdLnBheWxvYWQudGltZXpvbmUpLnRvQmVEZWZpbmVkKCk7IC8vIERlZmF1bHQgdGltZXpvbmUgd2FzIGFwcGxpZWRcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2Rpc2FibGVBdXRvcGlsb3QnLCAoKSA9PiB7XG4gICAgY29uc3QgZXZlbnRJZCA9ICdldmVudC10by1kaXNhYmxlLTQ1Nic7XG5cbiAgICBpdCgnc2hvdWxkIGRpc2FibGUgYXV0b3BpbG90IHN1Y2Nlc3NmdWxseSB3aGVuIGFsbCBBUEkgY2FsbHMgc3VjY2VlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIChcbiAgICAgICAgYXBpSGVscGVyLmRlbGV0ZVNjaGVkdWxlZEV2ZW50Rm9yQXV0b3BpbG90IGFzIGplc3QuTW9ja1xuICAgICAgKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IG9rOiB0cnVlLCBkYXRhOiB7IHN1Y2Nlc3M6IHRydWUgfSB9KTtcbiAgICAgIChhcGlIZWxwZXIuZGVsZXRlQXV0b3BpbG90R2l2ZW5JZCBhcyBqZXN0Lk1vY2spLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgb2s6IHRydWUsXG4gICAgICAgIGRhdGE6IHsgaWQ6IGV2ZW50SWQgfSBhcyBBdXRvcGlsb3RUeXBlLFxuICAgICAgfSk7IC8vIE1vY2sgdGhlIGRlbGV0ZWQgcmVjb3JkXG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRpc2FibGVBdXRvcGlsb3QodXNlcklkLCBldmVudElkKTsgLy8gUXVlcnkgaXMgZXZlbnRJZCBkaXJlY3RseVxuXG4gICAgICBleHBlY3QoYXBpSGVscGVyLmRlbGV0ZVNjaGVkdWxlZEV2ZW50Rm9yQXV0b3BpbG90KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXZlbnRJZFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChhcGlIZWxwZXIuZGVsZXRlQXV0b3BpbG90R2l2ZW5JZCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXZlbnRJZCk7XG4gICAgICBleHBlY3QocmVzdWx0Lm9rKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5kYXRhPy5zdWNjZXNzKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZXJyb3IgaWYgZXZlbnRJZCBpcyBub3QgcHJvdmlkZWQgaW4gcXVlcnknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkaXNhYmxlQXV0b3BpbG90KHVzZXJJZCwgJycpOyAvLyBFbXB0eSBxdWVyeVxuICAgICAgZXhwZWN0KHJlc3VsdC5vaykudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3QocmVzdWx0LmVycm9yPy5jb2RlKS50b0JlKCdWQUxJREFUSU9OX0VSUk9SJyk7XG4gICAgICBleHBlY3QocmVzdWx0LmVycm9yPy5tZXNzYWdlKS50b0NvbnRhaW4oXG4gICAgICAgICdldmVudElkIChhdXRvcGlsb3RJZCkgaXMgcmVxdWlyZWQnXG4gICAgICApO1xuICAgICAgZXhwZWN0KGFwaUhlbHBlci5kZWxldGVTY2hlZHVsZWRFdmVudEZvckF1dG9waWxvdCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIGV4cGVjdChhcGlIZWxwZXIuZGVsZXRlQXV0b3BpbG90R2l2ZW5JZCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcHJvY2VlZCB0byBkZWxldGUgREIgcmVjb3JkIGV2ZW4gaWYgZGVsZXRpbmcgc2NoZWR1bGVkIGV2ZW50IGZhaWxzLCBidXQgcmVmbGVjdCBvdmVyYWxsIG91dGNvbWUgYmFzZWQgb24gREIgZGVsZXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICAoXG4gICAgICAgIGFwaUhlbHBlci5kZWxldGVTY2hlZHVsZWRFdmVudEZvckF1dG9waWxvdCBhcyBqZXN0Lk1vY2tcbiAgICAgICkubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBvazogZmFsc2UsXG4gICAgICAgIGVycm9yOiB7IGNvZGU6ICdBUElfRVJST1InLCBtZXNzYWdlOiAnRXZlbnQgZGVsZXRpb24gZmFpbGVkJyB9LFxuICAgICAgfSk7XG4gICAgICAoYXBpSGVscGVyLmRlbGV0ZUF1dG9waWxvdEdpdmVuSWQgYXMgamVzdC5Nb2NrKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgIG9rOiB0cnVlLFxuICAgICAgICBkYXRhOiB7IGlkOiBldmVudElkIH0gYXMgQXV0b3BpbG90VHlwZSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkaXNhYmxlQXV0b3BpbG90KHVzZXJJZCwgZXZlbnRJZCk7XG5cbiAgICAgIGV4cGVjdChhcGlIZWxwZXIuZGVsZXRlU2NoZWR1bGVkRXZlbnRGb3JBdXRvcGlsb3QpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBldmVudElkXG4gICAgICApO1xuICAgICAgZXhwZWN0KGFwaUhlbHBlci5kZWxldGVBdXRvcGlsb3RHaXZlbklkKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChldmVudElkKTtcbiAgICAgIC8vIFRoaXMgc2NlbmFyaW8gaXMgdHJpY2t5OiBpZiBldmVudCBkZWxldGlvbiBmYWlscywgaXQncyBhIHdhcm5pbmcuIFN1Y2Nlc3MgZGVwZW5kcyBvbiBEQiBkZWxldGlvbi5cbiAgICAgIC8vIFRoZSBjdXJyZW50IGxvZ2ljIGluIGRpc2FibGVBdXRvcGlsb3QgcmV0dXJucyBvazp0cnVlIGlmIGRlbGV0ZUF1dG9waWxvdEdpdmVuSWQgaXMgb2suXG4gICAgICBleHBlY3QocmVzdWx0Lm9rKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5kYXRhPy5zdWNjZXNzKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZXJyb3IgaWYgZGVsZXRlQXV0b3BpbG90R2l2ZW5JZCBmYWlscycsIGFzeW5jICgpID0+IHtcbiAgICAgIChcbiAgICAgICAgYXBpSGVscGVyLmRlbGV0ZVNjaGVkdWxlZEV2ZW50Rm9yQXV0b3BpbG90IGFzIGplc3QuTW9ja1xuICAgICAgKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IG9rOiB0cnVlLCBkYXRhOiB7IHN1Y2Nlc3M6IHRydWUgfSB9KTtcbiAgICAgIChhcGlIZWxwZXIuZGVsZXRlQXV0b3BpbG90R2l2ZW5JZCBhcyBqZXN0Lk1vY2spLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgb2s6IGZhbHNlLFxuICAgICAgICBlcnJvcjogeyBjb2RlOiAnREJfRVJST1InLCBtZXNzYWdlOiAnREIgZGVsZXRpb24gZmFpbGVkJyB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRpc2FibGVBdXRvcGlsb3QodXNlcklkLCBldmVudElkKTtcblxuICAgICAgZXhwZWN0KGFwaUhlbHBlci5kZWxldGVTY2hlZHVsZWRFdmVudEZvckF1dG9waWxvdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV2ZW50SWRcbiAgICAgICk7XG4gICAgICBleHBlY3QoYXBpSGVscGVyLmRlbGV0ZUF1dG9waWxvdEdpdmVuSWQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGV2ZW50SWQpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5vaykudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3QocmVzdWx0LmVycm9yPy5tZXNzYWdlKS50b0JlKCdEQiBkZWxldGlvbiBmYWlsZWQnKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2dldEF1dG9waWxvdFN0YXR1cycsICgpID0+IHtcbiAgICBjb25zdCBzcGVjaWZpY0F1dG9waWxvdElkID0gJ2FwLXNwZWNpZmljLTc4OSc7XG4gICAgY29uc3QgbW9ja0F1dG9waWxvdERldGFpbCA9IHtcbiAgICAgIGlkOiBzcGVjaWZpY0F1dG9waWxvdElkLFxuICAgICAgdXNlcklkLFxuICAgICAgc2NoZWR1bGVBdDogJ3RvbW9ycm93JyxcbiAgICB9IGFzIEF1dG9waWxvdFR5cGU7XG4gICAgY29uc3QgbW9ja0F1dG9waWxvdExpc3QgPSBbXG4gICAgICB7IGlkOiAnYXAtbGlzdC0wMDEnLCB1c2VySWQsIHNjaGVkdWxlQXQ6ICd0b2RheScgfSxcbiAgICBdIGFzIEF1dG9waWxvdFR5cGVbXTtcblxuICAgIGl0KCdzaG91bGQgY2FsbCBnZXRBdXRvcGlsb3RHaXZlbklkIGlmIGF1dG9waWxvdElkIGlzIHByb3ZpZGVkIGluIHF1ZXJ5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgKGFwaUhlbHBlci5nZXRBdXRvcGlsb3RHaXZlbklkIGFzIGplc3QuTW9jaykubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBvazogdHJ1ZSxcbiAgICAgICAgZGF0YTogbW9ja0F1dG9waWxvdERldGFpbCxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBnZXRBdXRvcGlsb3RTdGF0dXModXNlcklkLCBzcGVjaWZpY0F1dG9waWxvdElkKTsgLy8gUXVlcnkgaXMgYXV0b3BpbG90SWRcblxuICAgICAgZXhwZWN0KGFwaUhlbHBlci5nZXRBdXRvcGlsb3RHaXZlbklkKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgc3BlY2lmaWNBdXRvcGlsb3RJZFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChhcGlIZWxwZXIubGlzdEF1dG9waWxvdHNHaXZlblVzZXJJZCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIGV4cGVjdChyZXN1bHQub2spLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QocmVzdWx0LmRhdGEpLnRvRXF1YWwobW9ja0F1dG9waWxvdERldGFpbCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGNhbGwgbGlzdEF1dG9waWxvdHNHaXZlblVzZXJJZCBpZiBubyBhdXRvcGlsb3RJZCBpcyBwcm92aWRlZCBpbiBxdWVyeScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIE5vdGU6IGxpc3RBdXRvcGlsb3RzR2l2ZW5Vc2VySWQgaW4gYXBpLWhlbHBlciByZXR1cm5zIGEgc2luZ2xlIEF1dG9waWxvdFR5cGUgfCBudWxsLCBub3QgYW4gYXJyYXkuXG4gICAgICAvLyBUaGUgc2tpbGwgcmVmbGVjdHMgdGhpcy4gSWYgaXQgd2VyZSB0byByZXR1cm4gYW4gYXJyYXksIHRoaXMgdGVzdCBhbmQgc2tpbGwgd291bGQgY2hhbmdlLlxuICAgICAgKGFwaUhlbHBlci5saXN0QXV0b3BpbG90c0dpdmVuVXNlcklkIGFzIGplc3QuTW9jaykubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBvazogdHJ1ZSxcbiAgICAgICAgZGF0YTogbW9ja0F1dG9waWxvdExpc3RbMF0sXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2V0QXV0b3BpbG90U3RhdHVzKHVzZXJJZCwgJycpOyAvLyBFbXB0eSBxdWVyeVxuXG4gICAgICBleHBlY3QoYXBpSGVscGVyLmxpc3RBdXRvcGlsb3RzR2l2ZW5Vc2VySWQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHVzZXJJZCk7XG4gICAgICBleHBlY3QoYXBpSGVscGVyLmdldEF1dG9waWxvdEdpdmVuSWQpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QocmVzdWx0Lm9rKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5kYXRhKS50b0VxdWFsKG1vY2tBdXRvcGlsb3RMaXN0WzBdKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIEpTT04gcXVlcnkgZm9yIHNwZWNpZmljIGF1dG9waWxvdElkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgKGFwaUhlbHBlci5nZXRBdXRvcGlsb3RHaXZlbklkIGFzIGplc3QuTW9jaykubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBvazogdHJ1ZSxcbiAgICAgICAgZGF0YTogbW9ja0F1dG9waWxvdERldGFpbCxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgcXVlcnlKc29uID0gSlNPTi5zdHJpbmdpZnkoeyBhdXRvcGlsb3RJZDogc3BlY2lmaWNBdXRvcGlsb3RJZCB9KTtcbiAgICAgIGF3YWl0IGdldEF1dG9waWxvdFN0YXR1cyh1c2VySWQsIHF1ZXJ5SnNvbik7XG4gICAgICBleHBlY3QoYXBpSGVscGVyLmdldEF1dG9waWxvdEdpdmVuSWQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBzcGVjaWZpY0F1dG9waWxvdElkXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZXJyb3IgaWYgdGhlIEFQSSBjYWxsIGZhaWxzIChnZXRBdXRvcGlsb3RHaXZlbklkKScsIGFzeW5jICgpID0+IHtcbiAgICAgIChhcGlIZWxwZXIuZ2V0QXV0b3BpbG90R2l2ZW5JZCBhcyBqZXN0Lk1vY2spLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgb2s6IGZhbHNlLFxuICAgICAgICBlcnJvcjogeyBjb2RlOiAnQVBJX0VSUk9SJywgbWVzc2FnZTogJ0ZldGNoIGZhaWxlZCcgfSxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2V0QXV0b3BpbG90U3RhdHVzKHVzZXJJZCwgc3BlY2lmaWNBdXRvcGlsb3RJZCk7XG4gICAgICBleHBlY3QocmVzdWx0Lm9rKS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3I/Lm1lc3NhZ2UpLnRvQmUoJ0ZldGNoIGZhaWxlZCcpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZXJyb3IgaWYgdGhlIEFQSSBjYWxsIGZhaWxzIChsaXN0QXV0b3BpbG90c0dpdmVuVXNlcklkKScsIGFzeW5jICgpID0+IHtcbiAgICAgIChhcGlIZWxwZXIubGlzdEF1dG9waWxvdHNHaXZlblVzZXJJZCBhcyBqZXN0Lk1vY2spLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgb2s6IGZhbHNlLFxuICAgICAgICBlcnJvcjogeyBjb2RlOiAnQVBJX0VSUk9SJywgbWVzc2FnZTogJ0xpc3QgZmV0Y2ggZmFpbGVkJyB9LFxuICAgICAgfSk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBnZXRBdXRvcGlsb3RTdGF0dXModXNlcklkLCAnJyk7XG4gICAgICBleHBlY3QocmVzdWx0Lm9rKS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3I/Lm1lc3NhZ2UpLnRvQmUoJ0xpc3QgZmV0Y2ggZmFpbGVkJyk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=