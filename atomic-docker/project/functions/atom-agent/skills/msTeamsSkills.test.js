import { listMicrosoftTeamsMeetings, getMicrosoftTeamsMeetingDetails, resetMSGraphTokenCache, } from './msTeamsSkills';
import axios from 'axios';
import * as constants from '../_libs/constants';
import { ConfidentialClientApplication, } from '@azure/msal-node';
// Mock external dependencies
jest.mock('axios');
const mockedAxios = axios;
// Mock MSAL ConfidentialClientApplication
const mockAcquireTokenByClientCredential = jest.fn();
jest.mock('@azure/msal-node', () => ({
    ...jest.requireActual('@azure/msal-node'), // Import and retain actual LogLevel, etc.
    ConfidentialClientApplication: jest.fn().mockImplementation(() => ({
        acquireTokenByClientCredential: mockAcquireTokenByClientCredential,
    })),
}));
jest.mock('../_libs/constants', () => ({
    ATOM_MSGRAPH_CLIENT_ID: 'test-client-id',
    ATOM_MSGRAPH_CLIENT_SECRET: 'test-client-secret',
    ATOM_MSGRAPH_TENANT_ID: 'test-tenant-id',
    ATOM_MSGRAPH_AUTHORITY: 'https://login.microsoftonline.com/test-tenant-id',
    ATOM_MSGRAPH_SCOPES: ['https://graph.microsoft.com/.default'],
}));
// Spy on console.error and console.log
let consoleErrorSpy;
let consoleLogSpy;
describe('msTeamsSkills', () => {
    const userPrincipalNameOrId = 'user@example.com';
    beforeEach(() => {
        mockedAxios.get.mockReset();
        mockAcquireTokenByClientCredential.mockReset();
        resetMSGraphTokenCache(); // Reset the in-memory token cache
        // Set default mock values for constants for each test
        // These can be overridden using jest.spyOn within specific tests if needed
        Object.defineProperty(constants, 'ATOM_MSGRAPH_CLIENT_ID', {
            value: 'test-client-id',
            configurable: true,
        });
        Object.defineProperty(constants, 'ATOM_MSGRAPH_CLIENT_SECRET', {
            value: 'test-client-secret',
            configurable: true,
        });
        Object.defineProperty(constants, 'ATOM_MSGRAPH_TENANT_ID', {
            value: 'test-tenant-id',
            configurable: true,
        });
        Object.defineProperty(constants, 'ATOM_MSGRAPH_AUTHORITY', {
            value: `https://login.microsoftonline.com/test-tenant-id`,
            configurable: true,
        });
        Object.defineProperty(constants, 'ATOM_MSGRAPH_SCOPES', {
            value: ['https://graph.microsoft.com/.default'],
            configurable: true,
        });
        consoleErrorSpy = jest.spyOn(console, 'error').mockImplementation(() => { });
        consoleLogSpy = jest.spyOn(console, 'log').mockImplementation(() => { });
    });
    afterEach(() => {
        jest.clearAllMocks();
        consoleErrorSpy.mockRestore();
        consoleLogSpy.mockRestore();
    });
    describe('MSAL Token Logic (implicitly via skill calls)', () => {
        it('should fetch and cache a new MSAL token', async () => {
            mockAcquireTokenByClientCredential.mockResolvedValueOnce({
                accessToken: 'new_token_123',
                expiresOn: new Date(Date.now() + 3600 * 1000), // Expires in 1 hour
            });
            mockedAxios.get.mockResolvedValueOnce({ data: { value: [] } }); // For listMicrosoftTeamsMeetings
            await listMicrosoftTeamsMeetings(userPrincipalNameOrId); // First call
            expect(mockAcquireTokenByClientCredential).toHaveBeenCalledTimes(1);
            expect(ConfidentialClientApplication).toHaveBeenCalledTimes(1); // Client app initialized once
            mockedAxios.get.mockResolvedValueOnce({ data: { value: [] } }); // For second call
            await listMicrosoftTeamsMeetings(userPrincipalNameOrId); // Second call
            expect(mockAcquireTokenByClientCredential).toHaveBeenCalledTimes(1); // Token reused from cache
        });
        it('should refresh MSAL token if expired', async () => {
            mockAcquireTokenByClientCredential.mockResolvedValueOnce({
                accessToken: 'initial_token',
                expiresOn: new Date(Date.now() + 500), // Expires in 0.5 seconds
            });
            mockAcquireTokenByClientCredential.mockResolvedValueOnce({
                // For the refresh
                accessToken: 'refreshed_token',
                expiresOn: new Date(Date.now() + 3600 * 1000),
            });
            mockedAxios.get.mockResolvedValue({ data: { value: [] } }); // Mock for all GET calls
            await listMicrosoftTeamsMeetings(userPrincipalNameOrId); // Initial call
            expect(mockAcquireTokenByClientCredential).toHaveBeenCalledTimes(1);
            jest.useFakeTimers();
            jest.advanceTimersByTime(1000); // Advance time by 1 second (token expires)
            jest.useRealTimers();
            await listMicrosoftTeamsMeetings(userPrincipalNameOrId); // Second call, should refresh
            expect(mockAcquireTokenByClientCredential).toHaveBeenCalledTimes(2);
            expect(mockedAxOS.get.mock.calls[1][1]?.headers?.Authorization).toBe('Bearer refreshed_token');
        });
        it('should return error if MSAL constants are missing for token fetch', async () => {
            Object.defineProperty(constants, 'ATOM_MSGRAPH_CLIENT_ID', { value: '' }); // Simulate missing client ID
            const result = await listMicrosoftTeamsMeetings(userPrincipalNameOrId);
            expect(result.ok).toBe(false);
            expect(result.error).toContain('Failed to obtain MS Graph access token.');
            expect(consoleErrorSpy).toHaveBeenCalledWith('MS Graph API client credentials (Client ID, Authority, Client Secret) not configured.');
        });
        it('should return error if acquireTokenByClientCredential fails', async () => {
            mockAcquireTokenByClientCredential.mockRejectedValueOnce(new Error('MSAL Auth Error'));
            const result = await listMicrosoftTeamsMeetings(userPrincipalNameOrId);
            expect(result.ok).toBe(false);
            expect(result.error).toContain('Failed to obtain MS Graph access token.');
            expect(consoleErrorSpy).toHaveBeenCalledWith('Error acquiring MS Graph token by client credential:', expect.any(Error));
        });
    });
    describe('listMicrosoftTeamsMeetings', () => {
        beforeEach(() => {
            // Ensure a valid token for these specific tests
            mockAcquireTokenByClientCredential.mockResolvedValue({
                accessToken: 'valid_graph_token',
                expiresOn: new Date(Date.now() + 3600 * 1000),
            });
        });
        it('should list Teams meetings successfully with default filter', async () => {
            const mockEvents = [
                { subject: 'Teams Meeting 1', id: 'evt1' },
            ];
            mockedAxios.get.mockResolvedValueOnce({
                data: { value: mockEvents, '@odata.nextLink': 'nextLink123' },
            });
            const result = await listMicrosoftTeamsMeetings(userPrincipalNameOrId, {
                limit: 5,
            });
            expect(result.ok).toBe(true);
            expect(result.events).toEqual(mockEvents);
            expect(result.nextLink).toBe('nextLink123');
            expect(mockedAxios.get).toHaveBeenCalledWith(expect.stringContaining(`/users/${userPrincipalNameOrId}/calendar/events`), expect.objectContaining({
                headers: { Authorization: 'Bearer valid_graph_token' },
            }));
            const calledUrl = mockedAxios.get.mock.calls[0][0];
            expect(calledUrl).toContain('$select=id,subject,start,end,isOnlineMeeting,onlineMeeting,webLink,bodyPreview');
            expect(calledUrl).toContain('$orderby=start/dateTime ASC');
            expect(calledUrl).toContain('$top=5');
            expect(calledUrl).toContain(`$filter=isOnlineMeeting eq true and onlineMeeting/onlineMeetingProvider eq 'teamsForBusiness'`);
        });
        it('should list meetings without Teams filter if options.filterForTeams is false', async () => {
            mockedAxios.get.mockResolvedValueOnce({ data: { value: [] } });
            await listMicrosoftTeamsMeetings(userPrincipalNameOrId, {
                filterForTeams: false,
            });
            const calledUrl = mockedAxios.get.mock.calls[0][0];
            expect(calledUrl).not.toContain('$filter=');
        });
        it('should use nextLink for pagination if provided', async () => {
            const mockNextLink = 'https://graph.microsoft.com/v1.0/users/someuser/calendar/events?$skipToken=abc';
            mockedAxios.get.mockResolvedValueOnce({
                data: { value: [{ id: 'evt2' }] },
            });
            await listMicrosoftTeamsMeetings(userPrincipalNameOrId, {
                nextLink: mockNextLink,
            });
            expect(mockedAxios.get).toHaveBeenCalledWith(mockNextLink, // Directly uses the nextLink
            expect.objectContaining({
                headers: { Authorization: 'Bearer valid_graph_token' },
            }));
        });
        it('should handle API error when listing meetings', async () => {
            const graphError = {
                isAxiosError: true,
                response: { data: { error: { message: 'Graph API Error' } } },
                message: 'Request failed',
            };
            mockedAxios.get.mockRejectedValueOnce(graphError);
            const result = await listMicrosoftTeamsMeetings(userPrincipalNameOrId);
            expect(result.ok).toBe(false);
            expect(result.error).toBe('Graph API Error');
        });
    });
    describe('getMicrosoftTeamsMeetingDetails', () => {
        beforeEach(() => {
            mockAcquireTokenByClientCredential.mockResolvedValue({
                accessToken: 'valid_graph_token_for_details',
                expiresOn: new Date(Date.now() + 3600 * 1000),
            });
        });
        it('should get meeting details successfully with specific select fields', async () => {
            const mockEventDetail = {
                id: 'evtDetail1',
                subject: 'Detailed Teams Meeting',
            };
            mockedAxios.get.mockResolvedValueOnce({ data: mockEventDetail });
            const eventId = 'evtDetail1';
            const result = await getMicrosoftTeamsMeetingDetails(userPrincipalNameOrId, eventId);
            expect(result.ok).toBe(true);
            expect(result.event).toEqual(mockEventDetail);
            const expectedUrl = `https://graph.microsoft.com/v1.0/users/${userPrincipalNameOrId}/events/${eventId}?$select=id,subject,start,end,isOnlineMeeting,onlineMeeting,webLink,bodyPreview,body,attendees,location,locations,organizer`;
            expect(mockedAxios.get).toHaveBeenCalledWith(expectedUrl, expect.objectContaining({
                headers: { Authorization: 'Bearer valid_graph_token_for_details' },
            }));
        });
        it('should handle meeting not found (404 error)', async () => {
            const eventId = 'nonExistentEventId';
            const graphError = {
                isAxiosError: true,
                response: {
                    status: 404,
                    data: { error: { message: 'Resource not found' } },
                },
                message: 'Request failed',
            };
            mockedAxios.get.mockRejectedValueOnce(graphError);
            const result = await getMicrosoftTeamsMeetingDetails(userPrincipalNameOrId, eventId);
            expect(result.ok).toBe(false);
            expect(result.error).toContain(`Meeting event not found (ID: ${eventId}). Resource not found`);
        });
        it('should handle other API errors when getting details', async () => {
            const eventId = 'errorEventId';
            const graphError = {
                isAxiosError: true,
                response: {
                    data: { error: { message: 'Some other Graph API Error' } },
                },
                message: 'Request failed',
            };
            mockedAxios.get.mockRejectedValueOnce(graphError);
            const result = await getMicrosoftTeamsMeetingDetails(userPrincipalNameOrId, eventId);
            expect(result.ok).toBe(false);
            expect(result.error).toBe('Some other Graph API Error');
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXNUZWFtc1NraWxscy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibXNUZWFtc1NraWxscy50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCwwQkFBMEIsRUFDMUIsK0JBQStCLEVBQy9CLHNCQUFzQixHQUN2QixNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMxQixPQUFPLEtBQUssU0FBUyxNQUFNLG9CQUFvQixDQUFDO0FBQ2hELE9BQU8sRUFDTCw2QkFBNkIsR0FHOUIsTUFBTSxrQkFBa0IsQ0FBQztBQUcxQiw2QkFBNkI7QUFDN0IsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNuQixNQUFNLFdBQVcsR0FBRyxLQUFrQyxDQUFDO0FBRXZELDBDQUEwQztBQUMxQyxNQUFNLGtDQUFrQyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUNyRCxJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDbkMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGtCQUFrQixDQUFDLEVBQUUsMENBQTBDO0lBQ3JGLDZCQUE2QixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQ2pFLDhCQUE4QixFQUFFLGtDQUFrQztLQUNuRSxDQUFDLENBQUM7Q0FDSixDQUFDLENBQUMsQ0FBQztBQUVKLElBQUksQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUNyQyxzQkFBc0IsRUFBRSxnQkFBZ0I7SUFDeEMsMEJBQTBCLEVBQUUsb0JBQW9CO0lBQ2hELHNCQUFzQixFQUFFLGdCQUFnQjtJQUN4QyxzQkFBc0IsRUFBRSxrREFBa0Q7SUFDMUUsbUJBQW1CLEVBQUUsQ0FBQyxzQ0FBc0MsQ0FBQztDQUM5RCxD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RyxDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ2xELE1BQU0sTUFBTSxHQUFHLE1BQU0sK0JBQStCLENBQ2xELHFCQUFxQixFQUNyQixPQUFPLENBQ1IsQ0FBQztZQUNGLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzlCLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLDRCQUE0QixDQUFDLENBQUM7UUFDMUQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgbGlzdE1pY3Jvc29mdFRlYW1zTWVldGluZ3MsXG4gIGdldE1pY3Jvc29mdFRlYW1zTWVldGluZ0RldGFpbHMsXG4gIHJlc2V0TVNHcmFwaFRva2VuQ2FjaGUsXG59IGZyb20gJy4vbXNUZWFtc1NraWxscyc7XG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0ICogYXMgY29uc3RhbnRzIGZyb20gJy4uL19saWJzL2NvbnN0YW50cyc7XG5pbXBvcnQge1xuICBDb25maWRlbnRpYWxDbGllbnRBcHBsaWNhdGlvbixcbiAgQXV0aGVudGljYXRpb25SZXN1bHQsXG4gIExvZ0xldmVsLFxufSBmcm9tICdAYXp1cmUvbXNhbC1ub2RlJztcbmltcG9ydCB7IE1TR3JhcGhFdmVudCB9IGZyb20gJy4uL3R5cGVzJzsgLy8gQXNzdW1pbmcgdHlwZXMgYXJlIGNvcnJlY3RseSBkZWZpbmVkXG5cbi8vIE1vY2sgZXh0ZXJuYWwgZGVwZW5kZW5jaWVzXG5qZXN0Lm1vY2soJ2F4aW9zJyk7XG5jb25zdCBtb2NrZWRBeGlvcyA9IGF4aW9zIGFzIGplc3QuTW9ja2VkPHR5cGVvZiBheGlvcz47XG5cbi8vIE1vY2sgTVNBTCBDb25maWRlbnRpYWxDbGllbnRBcHBsaWNhdGlvblxuY29uc3QgbW9ja0FjcXVpcmVUb2tlbkJ5Q2xpZW50Q3JlZGVudGlhbCA9IGplc3QuZm4oKTtcbmplc3QubW9jaygnQGF6dXJlL21zYWwtbm9kZScsICgpID0+ICh7XG4gIC4uLmplc3QucmVxdWlyZUFjdHVhbCgnQGF6dXJlL21zYWwtbm9kZScpLCAvLyBJbXBvcnQgYW5kIHJldGFpbiBhY3R1YWwgTG9nTGV2ZWwsIGV0Yy5cbiAgQ29uZmlkZW50aWFsQ2xpZW50QXBwbGljYXRpb246IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gKHtcbiAgICBhY3F1aXJlVG9rZW5CeUNsaWVudENyZWRlbnRpYWw6IG1vY2tBY3F1aXJlVG9rZW5CeUNsaWVudENyZWRlbnRpYWwsXG4gIH0pKSxcbn0pKTtcblxuamVzdC5tb2NrKCcuLi9fbGlicy9jb25zdGFudHMnLCAoKSA9PiAoe1xuICBBVE9NX01TR1JBUEhfQ0xJRU5UX0lEOiAndGVzdC1jbGllbnQtaWQnLFxuICBBVE9NX01TR1JBUEhfQ0xJRU5UX1NFQ1JFVDogJ3Rlc3QtY2xpZW50LXNlY3JldCcsXG4gIEFUT01fTVNHUkFQSF9URU5BTlRfSUQ6ICd0ZXN0LXRlbmFudC1pZCcsXG4gIEFUT01fTVNHUkFQSF9BVVRIT1JJVFk6ICdodHRwczovL2xvZ2luLm1pY3Jvc29mdG9ubGluZS5jb20vdGVzdC10ZW5hbnQtaWQnLFxuICBBVE9NX01TR1JBUEhfU0NPUEVTOiBbJ2h0dHBzOi8vZ3JhcGgubWljcm9zb2Z0LmNvbS8uZGVmYXVsdCddLFxufSkpO1xuXG4vLyBTcHkgb24gY29uc29sZS5lcnJvciBhbmQgY29uc29sZS5sb2dcbmxldCBjb25zb2xlRXJyb3JTcHk6IGplc3QuU3B5SW5zdGFuY2U7XG5sZXQgY29uc29sZUxvZ1NweTogamVzdC5TcHlJbnN0YW5jZTtcblxuZGVzY3JpYmUoJ21zVGVhbXNTa2lsbHMnLCAoKSA9PiB7XG4gIGNvbnN0IHVzZXJQcmluY2lwYWxOYW1lT3JJZCA9ICd1c2VyQGV4YW1wbGUuY29tJztcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBtb2NrZWRBeGlvcy5nZXQubW9ja1Jlc2V0KCk7XG4gICAgbW9ja0FjcXVpcmVUb2tlbkJ5Q2xpZW50Q3JlZGVudGlhbC5tb2NrUmVzZXQoKTtcbiAgICByZXNldE1TR3JhcGhUb2tlbkNhY2hlKCk7IC8vIFJlc2V0IHRoZSBpbi1tZW1vcnkgdG9rZW4gY2FjaGVcblxuICAgIC8vIFNldCBkZWZhdWx0IG1vY2sgdmFsdWVzIGZvciBjb25zdGFudHMgZm9yIGVhY2ggdGVzdFxuICAgIC8vIFRoZXNlIGNhbiBiZSBvdmVycmlkZGVuIHVzaW5nIGplc3Quc3B5T24gd2l0aGluIHNwZWNpZmljIHRlc3RzIGlmIG5lZWRlZFxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjb25zdGFudHMsICdBVE9NX01TR1JBUEhfQ0xJRU5UX0lEJywge1xuICAgICAgdmFsdWU6ICd0ZXN0LWNsaWVudC1pZCcsXG4gICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgfSk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGNvbnN0YW50cywgJ0FUT01fTVNHUkFQSF9DTElFTlRfU0VDUkVUJywge1xuICAgICAgdmFsdWU6ICd0ZXN0LWNsaWVudC1zZWNyZXQnLFxuICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgIH0pO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjb25zdGFudHMsICdBVE9NX01TR1JBUEhfVEVOQU5UX0lEJywge1xuICAgICAgdmFsdWU6ICd0ZXN0LXRlbmFudC1pZCcsXG4gICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgfSk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGNvbnN0YW50cywgJ0FUT01fTVNHUkFQSF9BVVRIT1JJVFknLCB7XG4gICAgICB2YWx1ZTogYGh0dHBzOi8vbG9naW4ubWljcm9zb2Z0b25saW5lLmNvbS90ZXN0LXRlbmFudC1pZGAsXG4gICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgfSk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGNvbnN0YW50cywgJ0FUT01fTVNHUkFQSF9TQ09QRVMnLCB7XG4gICAgICB2YWx1ZTogWydodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20vLmRlZmF1bHQnXSxcbiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICB9KTtcblxuICAgIGNvbnNvbGVFcnJvclNweSA9IGplc3Quc3B5T24oY29uc29sZSwgJ2Vycm9yJykubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IHt9KTtcbiAgICBjb25zb2xlTG9nU3B5ID0gamVzdC5zcHlPbihjb25zb2xlLCAnbG9nJykubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IHt9KTtcbiAgfSk7XG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgICBjb25zb2xlRXJyb3JTcHkubW9ja1Jlc3RvcmUoKTtcbiAgICBjb25zb2xlTG9nU3B5Lm1vY2tSZXN0b3JlKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdNU0FMIFRva2VuIExvZ2ljIChpbXBsaWNpdGx5IHZpYSBza2lsbCBjYWxscyknLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBmZXRjaCBhbmQgY2FjaGUgYSBuZXcgTVNBTCB0b2tlbicsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tBY3F1aXJlVG9rZW5CeUNsaWVudENyZWRlbnRpYWwubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHtcbiAgICAgICAgYWNjZXNzVG9rZW46ICduZXdfdG9rZW5fMTIzJyxcbiAgICAgICAgZXhwaXJlc09uOiBuZXcgRGF0ZShEYXRlLm5vdygpICsgMzYwMCAqIDEwMDApLCAvLyBFeHBpcmVzIGluIDEgaG91clxuICAgICAgfSBhcyBBdXRoZW50aWNhdGlvblJlc3VsdCk7XG4gICAgICBtb2NrZWRBeGlvcy5nZXQubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHsgZGF0YTogeyB2YWx1ZTogW10gfSB9KTsgLy8gRm9yIGxpc3RNaWNyb3NvZnRUZWFtc01lZXRpbmdzXG5cbiAgICAgIGF3YWl0IGxpc3RNaWNyb3NvZnRUZWFtc01lZXRpbmdzKHVzZXJQcmluY2lwYWxOYW1lT3JJZCk7IC8vIEZpcnN0IGNhbGxcbiAgICAgIGV4cGVjdChtb2NrQWNxdWlyZVRva2VuQnlDbGllbnRDcmVkZW50aWFsKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgICBleHBlY3QoQ29uZmlkZW50aWFsQ2xpZW50QXBwbGljYXRpb24pLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTsgLy8gQ2xpZW50IGFwcCBpbml0aWFsaXplZCBvbmNlXG5cbiAgICAgIG1vY2tlZEF4aW9zLmdldC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoeyBkYXRhOiB7IHZhbHVlOiBbXSB9IH0pOyAvLyBGb3Igc2Vjb25kIGNhbGxcbiAgICAgIGF3YWl0IGxpc3RNaWNyb3NvZnRUZWFtc01lZXRpbmdzKHVzZXJQcmluY2lwYWxOYW1lT3JJZCk7IC8vIFNlY29uZCBjYWxsXG4gICAgICBleHBlY3QobW9ja0FjcXVpcmVUb2tlbkJ5Q2xpZW50Q3JlZGVudGlhbCkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpOyAvLyBUb2tlbiByZXVzZWQgZnJvbSBjYWNoZVxuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZWZyZXNoIE1TQUwgdG9rZW4gaWYgZXhwaXJlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tBY3F1aXJlVG9rZW5CeUNsaWVudENyZWRlbnRpYWwubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHtcbiAgICAgICAgYWNjZXNzVG9rZW46ICdpbml0aWFsX3Rva2VuJyxcbiAgICAgICAgZXhwaXJlc09uOiBuZXcgRGF0ZShEYXRlLm5vdygpICsgNTAwKSwgLy8gRXhwaXJlcyBpbiAwLjUgc2Vjb25kc1xuICAgICAgfSBhcyBBdXRoZW50aWNhdGlvblJlc3VsdCk7XG4gICAgICBtb2NrQWNxdWlyZVRva2VuQnlDbGllbnRDcmVkZW50aWFsLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG4gICAgICAgIC8vIEZvciB0aGUgcmVmcmVzaFxuICAgICAgICBhY2Nlc3NUb2tlbjogJ3JlZnJlc2hlZF90b2tlbicsXG4gICAgICAgIGV4cGlyZXNPbjogbmV3IERhdGUoRGF0ZS5ub3coKSArIDM2MDAgKiAxMDAwKSxcbiAgICAgIH0gYXMgQXV0aGVudGljYXRpb25SZXN1bHQpO1xuICAgICAgbW9ja2VkQXhpb3MuZ2V0Lm1vY2tSZXNvbHZlZFZhbHVlKHsgZGF0YTogeyB2YWx1ZTogW10gfSB9KTsgLy8gTW9jayBmb3IgYWxsIEdFVCBjYWxsc1xuXG4gICAgICBhd2FpdCBsaXN0TWljcm9zb2Z0VGVhbXNNZWV0aW5ncyh1c2VyUHJpbmNpcGFsTmFtZU9ySWQpOyAvLyBJbml0aWFsIGNhbGxcbiAgICAgIGV4cGVjdChtb2NrQWNxdWlyZVRva2VuQnlDbGllbnRDcmVkZW50aWFsKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG5cbiAgICAgIGplc3QudXNlRmFrZVRpbWVycygpO1xuICAgICAgamVzdC5hZHZhbmNlVGltZXJzQnlUaW1lKDEwMDApOyAvLyBBZHZhbmNlIHRpbWUgYnkgMSBzZWNvbmQgKHRva2VuIGV4cGlyZXMpXG4gICAgICBqZXN0LnVzZVJlYWxUaW1lcnMoKTtcblxuICAgICAgYXdhaXQgbGlzdE1pY3Jvc29mdFRlYW1zTWVldGluZ3ModXNlclByaW5jaXBhbE5hbWVPcklkKTsgLy8gU2Vjb25kIGNhbGwsIHNob3VsZCByZWZyZXNoXG4gICAgICBleHBlY3QobW9ja0FjcXVpcmVUb2tlbkJ5Q2xpZW50Q3JlZGVudGlhbCkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDIpO1xuICAgICAgZXhwZWN0KG1vY2tlZEF4T1MuZ2V0Lm1vY2suY2FsbHNbMV1bMV0/LmhlYWRlcnM/LkF1dGhvcml6YXRpb24pLnRvQmUoXG4gICAgICAgICdCZWFyZXIgcmVmcmVzaGVkX3Rva2VuJ1xuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGVycm9yIGlmIE1TQUwgY29uc3RhbnRzIGFyZSBtaXNzaW5nIGZvciB0b2tlbiBmZXRjaCcsIGFzeW5jICgpID0+IHtcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjb25zdGFudHMsICdBVE9NX01TR1JBUEhfQ0xJRU5UX0lEJywgeyB2YWx1ZTogJycgfSk7IC8vIFNpbXVsYXRlIG1pc3NpbmcgY2xpZW50IElEXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBsaXN0TWljcm9zb2Z0VGVhbXNNZWV0aW5ncyh1c2VyUHJpbmNpcGFsTmFtZU9ySWQpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5vaykudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3QocmVzdWx0LmVycm9yKS50b0NvbnRhaW4oJ0ZhaWxlZCB0byBvYnRhaW4gTVMgR3JhcGggYWNjZXNzIHRva2VuLicpO1xuICAgICAgZXhwZWN0KGNvbnNvbGVFcnJvclNweSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdNUyBHcmFwaCBBUEkgY2xpZW50IGNyZWRlbnRpYWxzIChDbGllbnQgSUQsIEF1dGhvcml0eSwgQ2xpZW50IFNlY3JldCkgbm90IGNvbmZpZ3VyZWQuJ1xuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGVycm9yIGlmIGFjcXVpcmVUb2tlbkJ5Q2xpZW50Q3JlZGVudGlhbCBmYWlscycsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tBY3F1aXJlVG9rZW5CeUNsaWVudENyZWRlbnRpYWwubW9ja1JlamVjdGVkVmFsdWVPbmNlKFxuICAgICAgICBuZXcgRXJyb3IoJ01TQUwgQXV0aCBFcnJvcicpXG4gICAgICApO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgbGlzdE1pY3Jvc29mdFRlYW1zTWVldGluZ3ModXNlclByaW5jaXBhbE5hbWVPcklkKTtcbiAgICAgIGV4cGVjdChyZXN1bHQub2spLnRvQmUoZmFsc2UpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvcikudG9Db250YWluKCdGYWlsZWQgdG8gb2J0YWluIE1TIEdyYXBoIGFjY2VzcyB0b2tlbi4nKTtcbiAgICAgIGV4cGVjdChjb25zb2xlRXJyb3JTcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnRXJyb3IgYWNxdWlyaW5nIE1TIEdyYXBoIHRva2VuIGJ5IGNsaWVudCBjcmVkZW50aWFsOicsXG4gICAgICAgIGV4cGVjdC5hbnkoRXJyb3IpXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnbGlzdE1pY3Jvc29mdFRlYW1zTWVldGluZ3MnLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICAvLyBFbnN1cmUgYSB2YWxpZCB0b2tlbiBmb3IgdGhlc2Ugc3BlY2lmaWMgdGVzdHNcbiAgICAgIG1vY2tBY3F1aXJlVG9rZW5CeUNsaWVudENyZWRlbnRpYWwubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBhY2Nlc3NUb2tlbjogJ3ZhbGlkX2dyYXBoX3Rva2VuJyxcbiAgICAgICAgZXhwaXJlc09uOiBuZXcgRGF0ZShEYXRlLm5vdygpICsgMzYwMCAqIDEwMDApLFxuICAgICAgfSBhcyBBdXRoZW50aWNhdGlvblJlc3VsdCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGxpc3QgVGVhbXMgbWVldGluZ3Mgc3VjY2Vzc2Z1bGx5IHdpdGggZGVmYXVsdCBmaWx0ZXInLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrRXZlbnRzOiBQYXJ0aWFsPE1TR3JhcGhFdmVudD5bXSA9IFtcbiAgICAgICAgeyBzdWJqZWN0OiAnVGVhbXMgTWVldGluZyAxJywgaWQ6ICdldnQxJyB9LFxuICAgICAgXTtcbiAgICAgIG1vY2tlZEF4aW9zLmdldC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe1xuICAgICAgICBkYXRhOiB7IHZhbHVlOiBtb2NrRXZlbnRzLCAnQG9kYXRhLm5leHRMaW5rJzogJ25leHRMaW5rMTIzJyB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGxpc3RNaWNyb3NvZnRUZWFtc01lZXRpbmdzKHVzZXJQcmluY2lwYWxOYW1lT3JJZCwge1xuICAgICAgICBsaW1pdDogNSxcbiAgICAgIH0pO1xuICAgICAgZXhwZWN0KHJlc3VsdC5vaykudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuZXZlbnRzKS50b0VxdWFsKG1vY2tFdmVudHMpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5uZXh0TGluaykudG9CZSgnbmV4dExpbmsxMjMnKTtcbiAgICAgIGV4cGVjdChtb2NrZWRBeGlvcy5nZXQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZyhcbiAgICAgICAgICBgL3VzZXJzLyR7dXNlclByaW5jaXBhbE5hbWVPcklkfS9jYWxlbmRhci9ldmVudHNgXG4gICAgICAgICksXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBoZWFkZXJzOiB7IEF1dGhvcml6YXRpb246ICdCZWFyZXIgdmFsaWRfZ3JhcGhfdG9rZW4nIH0sXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgICAgY29uc3QgY2FsbGVkVXJsID0gbW9ja2VkQXhpb3MuZ2V0Lm1vY2suY2FsbHNbMF1bMF07XG4gICAgICBleHBlY3QoY2FsbGVkVXJsKS50b0NvbnRhaW4oXG4gICAgICAgICckc2VsZWN0PWlkLHN1YmplY3Qsc3RhcnQsZW5kLGlzT25saW5lTWVldGluZyxvbmxpbmVNZWV0aW5nLHdlYkxpbmssYm9keVByZXZpZXcnXG4gICAgICApO1xuICAgICAgZXhwZWN0KGNhbGxlZFVybCkudG9Db250YWluKCckb3JkZXJieT1zdGFydC9kYXRlVGltZSBBU0MnKTtcbiAgICAgIGV4cGVjdChjYWxsZWRVcmwpLnRvQ29udGFpbignJHRvcD01Jyk7XG4gICAgICBleHBlY3QoY2FsbGVkVXJsKS50b0NvbnRhaW4oXG4gICAgICAgIGAkZmlsdGVyPWlzT25saW5lTWVldGluZyBlcSB0cnVlIGFuZCBvbmxpbmVNZWV0aW5nL29ubGluZU1lZXRpbmdQcm92aWRlciBlcSAndGVhbXNGb3JCdXNpbmVzcydgXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBsaXN0IG1lZXRpbmdzIHdpdGhvdXQgVGVhbXMgZmlsdGVyIGlmIG9wdGlvbnMuZmlsdGVyRm9yVGVhbXMgaXMgZmFsc2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrZWRBeGlvcy5nZXQubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHsgZGF0YTogeyB2YWx1ZTogW10gfSB9KTtcbiAgICAgIGF3YWl0IGxpc3RNaWNyb3NvZnRUZWFtc01lZXRpbmdzKHVzZXJQcmluY2lwYWxOYW1lT3JJZCwge1xuICAgICAgICBmaWx0ZXJGb3JUZWFtczogZmFsc2UsXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IGNhbGxlZFVybCA9IG1vY2tlZEF4aW9zLmdldC5tb2NrLmNhbGxzWzBdWzBdO1xuICAgICAgZXhwZWN0KGNhbGxlZFVybCkubm90LnRvQ29udGFpbignJGZpbHRlcj0nKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdXNlIG5leHRMaW5rIGZvciBwYWdpbmF0aW9uIGlmIHByb3ZpZGVkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja05leHRMaW5rID1cbiAgICAgICAgJ2h0dHBzOi8vZ3JhcGgubWljcm9zb2Z0LmNvbS92MS4wL3VzZXJzL3NvbWV1c2VyL2NhbGVuZGFyL2V2ZW50cz8kc2tpcFRva2VuPWFiYyc7XG4gICAgICBtb2NrZWRBeGlvcy5nZXQubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHtcbiAgICAgICAgZGF0YTogeyB2YWx1ZTogW3sgaWQ6ICdldnQyJyB9XSB9LFxuICAgICAgfSk7XG4gICAgICBhd2FpdCBsaXN0TWljcm9zb2Z0VGVhbXNNZWV0aW5ncyh1c2VyUHJpbmNpcGFsTmFtZU9ySWQsIHtcbiAgICAgICAgbmV4dExpbms6IG1vY2tOZXh0TGluayxcbiAgICAgIH0pO1xuICAgICAgZXhwZWN0KG1vY2tlZEF4aW9zLmdldCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIG1vY2tOZXh0TGluaywgLy8gRGlyZWN0bHkgdXNlcyB0aGUgbmV4dExpbmtcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGhlYWRlcnM6IHsgQXV0aG9yaXphdGlvbjogJ0JlYXJlciB2YWxpZF9ncmFwaF90b2tlbicgfSxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBBUEkgZXJyb3Igd2hlbiBsaXN0aW5nIG1lZXRpbmdzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZ3JhcGhFcnJvciA9IHtcbiAgICAgICAgaXNBeGlvc0Vycm9yOiB0cnVlLFxuICAgICAgICByZXNwb25zZTogeyBkYXRhOiB7IGVycm9yOiB7IG1lc3NhZ2U6ICdHcmFwaCBBUEkgRXJyb3InIH0gfSB9LFxuICAgICAgICBtZXNzYWdlOiAnUmVxdWVzdCBmYWlsZWQnLFxuICAgICAgfSBhcyBBeGlvc0Vycm9yO1xuICAgICAgbW9ja2VkQXhpb3MuZ2V0Lm1vY2tSZWplY3RlZFZhbHVlT25jZShncmFwaEVycm9yKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGxpc3RNaWNyb3NvZnRUZWFtc01lZXRpbmdzKHVzZXJQcmluY2lwYWxOYW1lT3JJZCk7XG4gICAgICBleHBlY3QocmVzdWx0Lm9rKS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3IpLnRvQmUoJ0dyYXBoIEFQSSBFcnJvcicpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZ2V0TWljcm9zb2Z0VGVhbXNNZWV0aW5nRGV0YWlscycsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIG1vY2tBY3F1aXJlVG9rZW5CeUNsaWVudENyZWRlbnRpYWwubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBhY2Nlc3NUb2tlbjogJ3ZhbGlkX2dyYXBoX3Rva2VuX2Zvcl9kZXRhaWxzJyxcbiAgICAgICAgZXhwaXJlc09uOiBuZXcgRGF0ZShEYXRlLm5vdygpICsgMzYwMCAqIDEwMDApLFxuICAgICAgfSBhcyBBdXRoZW50aWNhdGlvblJlc3VsdCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGdldCBtZWV0aW5nIGRldGFpbHMgc3VjY2Vzc2Z1bGx5IHdpdGggc3BlY2lmaWMgc2VsZWN0IGZpZWxkcycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tFdmVudERldGFpbDogUGFydGlhbDxNU0dyYXBoRXZlbnQ+ID0ge1xuICAgICAgICBpZDogJ2V2dERldGFpbDEnLFxuICAgICAgICBzdWJqZWN0OiAnRGV0YWlsZWQgVGVhbXMgTWVldGluZycsXG4gICAgICB9O1xuICAgICAgbW9ja2VkQXhpb3MuZ2V0Lm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7IGRhdGE6IG1vY2tFdmVudERldGFpbCB9KTtcbiAgICAgIGNvbnN0IGV2ZW50SWQgPSAnZXZ0RGV0YWlsMSc7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBnZXRNaWNyb3NvZnRUZWFtc01lZXRpbmdEZXRhaWxzKFxuICAgICAgICB1c2VyUHJpbmNpcGFsTmFtZU9ySWQsXG4gICAgICAgIGV2ZW50SWRcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQub2spLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QocmVzdWx0LmV2ZW50KS50b0VxdWFsKG1vY2tFdmVudERldGFpbCk7XG4gICAgICBjb25zdCBleHBlY3RlZFVybCA9IGBodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20vdjEuMC91c2Vycy8ke3VzZXJQcmluY2lwYWxOYW1lT3JJZH0vZXZlbnRzLyR7ZXZlbnRJZH0/JHNlbGVjdD1pZCxzdWJqZWN0LHN0YXJ0LGVuZCxpc09ubGluZU1lZXRpbmcsb25saW5lTWVldGluZyx3ZWJMaW5rLGJvZHlQcmV2aWV3LGJvZHksYXR0ZW5kZWVzLGxvY2F0aW9uLGxvY2F0aW9ucyxvcmdhbml6ZXJgO1xuICAgICAgZXhwZWN0KG1vY2tlZEF4aW9zLmdldCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdGVkVXJsLFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgaGVhZGVyczogeyBBdXRob3JpemF0aW9uOiAnQmVhcmVyIHZhbGlkX2dyYXBoX3Rva2VuX2Zvcl9kZXRhaWxzJyB9LFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIG1lZXRpbmcgbm90IGZvdW5kICg0MDQgZXJyb3IpJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXZlbnRJZCA9ICdub25FeGlzdGVudEV2ZW50SWQnO1xuICAgICAgY29uc3QgZ3JhcGhFcnJvciA9IHtcbiAgICAgICAgaXNBeGlvc0Vycm9yOiB0cnVlLFxuICAgICAgICByZXNwb25zZToge1xuICAgICAgICAgIHN0YXR1czogNDA0LFxuICAgICAgICAgIGRhdGE6IHsgZXJyb3I6IHsgbWVzc2FnZTogJ1Jlc291cmNlIG5vdCBmb3VuZCcgfSB9LFxuICAgICAgICB9LFxuICAgICAgICBtZXNzYWdlOiAnUmVxdWVzdCBmYWlsZWQnLFxuICAgICAgfSBhcyBBeGlvc0Vycm9yO1xuICAgICAgbW9ja2VkQXhpb3MuZ2V0Lm1vY2tSZWplY3RlZFZhbHVlT25jZShncmFwaEVycm9yKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdldE1pY3Jvc29mdFRlYW1zTWVldGluZ0RldGFpbHMoXG4gICAgICAgIHVzZXJQcmluY2lwYWxOYW1lT3JJZCxcbiAgICAgICAgZXZlbnRJZFxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5vaykudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3QocmVzdWx0LmVycm9yKS50b0NvbnRhaW4oXG4gICAgICAgIGBNZWV0aW5nIGV2ZW50IG5vdCBmb3VuZCAoSUQ6ICR7ZXZlbnRJZH0pLiBSZXNvdXJjZSBub3QgZm91bmRgXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgb3RoZXIgQVBJIGVycm9ycyB3aGVuIGdldHRpbmcgZGV0YWlscycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50SWQgPSAnZXJyb3JFdmVudElkJztcbiAgICAgIGNvbnN0IGdyYXBoRXJyb3IgPSB7XG4gICAgICAgIGlzQXhpb3NFcnJvcjogdHJ1ZSxcbiAgICAgICAgcmVzcG9uc2U6IHtcbiAgICAgICAgICBkYXRhOiB7IGVycm9yOiB7IG1lc3NhZ2U6ICdTb21lIG90aGVyIEdyYXBoIEFQSSBFcnJvcicgfSB9LFxuICAgICAgICB9LFxuICAgICAgICBtZXNzYWdlOiAnUmVxdWVzdCBmYWlsZWQnLFxuICAgICAgfSBhcyBBeGlvc0Vycm9yO1xuICAgICAgbW9ja2VkQXhpb3MuZ2V0Lm1vY2tSZWplY3RlZFZhbHVlT25jZShncmFwaEVycm9yKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdldE1pY3Jvc29mdFRlYW1zTWVldGluZ0RldGFpbHMoXG4gICAgICAgIHVzZXJQcmluY2lwYWxOYW1lT3JJZCxcbiAgICAgICAgZXZlbnRJZFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChyZXN1bHQub2spLnRvQmUoZmFsc2UpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvcikudG9CZSgnU29tZSBvdGhlciBHcmFwaCBBUEkgRXJyb3InKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==