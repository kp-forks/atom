import axios from 'axios';
import { executeGraphQLQuery, executeGraphQLMutation } from './graphqlClient';
import { HASURA_GRAPHQL_URL, HASURA_ADMIN_SECRET } from './constants';
jest.mock('axios');
const mockedAxios = axios;
// Mock constants
jest.mock('./constants', () => ({
    HASURA_GRAPHQL_URL: 'http://test-hasura.com/v1/graphql',
    HASURA_ADMIN_SECRET: 'test-admin-secret',
}));
describe('graphqlClient', () => {
    const query = 'query TestQuery { test { id } }';
    const variables = { id: '123' };
    const operationName = 'TestQuery';
    const userId = 'test-user';
    const mockSuccessData = { test: { id: '123', name: 'Test Data' } };
    const mockGraphQLErrors = [{ message: 'Some GraphQL error' }];
    beforeEach(() => {
        mockedAxios.post.mockReset();
        // jest.resetModules() // Not strictly needed here if constants are properly mocked via jest.mock factory
        // Spy on console.error and console.warn to check logging
        jest.spyOn(console, 'error').mockImplementation(() => { });
        jest.spyOn(console, 'warn').mockImplementation(() => { });
    });
    afterEach(() => {
        jest.restoreAllMocks();
    });
    describe('executeGraphQLQuery', () => {
        it('should execute query successfully on first attempt', async () => {
            mockedAxios.post.mockResolvedValueOnce({
                data: { data: mockSuccessData },
            });
            const result = await executeGraphQLQuery(query, variables, operationName, userId);
            expect(result).toEqual(mockSuccessData);
            expect(mockedAxios.post).toHaveBeenCalledTimes(1);
            expect(mockedAxios.post).toHaveBeenCalledWith(HASURA_GRAPHQL_URL, { query, variables, operationName }, {
                headers: {
                    'Content-Type': 'application/json',
                    'X-Hasura-Admin-Secret': HASURA_ADMIN_SECRET,
                    'X-Hasura-Role': 'user',
                    'X-Hasura-User-Id': userId,
                },
                timeout: 15000,
            });
        });
        it('should use admin role if userId is not provided', async () => {
            mockedAxios.post.mockResolvedValueOnce({
                data: { data: mockSuccessData },
            });
            await executeGraphQLQuery(query, variables, operationName);
            expect(mockedAxios.post).toHaveBeenCalledWith(HASURA_GRAPHQL_URL, expect.anything(), expect.objectContaining({
                headers: expect.objectContaining({
                    'X-Hasura-Role': 'admin',
                    'X-Hasura-User-Id': undefined,
                }),
            }));
        });
        it('should succeed on the second attempt after a 503 error', async () => {
            mockedAxios.post
                .mockRejectedValueOnce({
                isAxiosError: true,
                response: { status: 503, data: 'Service Unavailable' },
                request: {},
                config: {},
            })
                .mockResolvedValueOnce({ data: { data: mockSuccessData } });
            const result = await executeGraphQLQuery(query, variables, operationName, userId);
            expect(result).toEqual(mockSuccessData);
            expect(mockedAxios.post).toHaveBeenCalledTimes(2);
            expect(console.error).toHaveBeenCalledWith(expect.stringContaining('HTTP error 503'), expect.any(String));
        });
        it('should succeed on the second attempt after a timeout (ECONNABORTED)', async () => {
            mockedAxios.post
                .mockRejectedValueOnce({
                isAxiosError: true,
                code: 'ECONNABORTED',
                message: 'timeout exceeded',
                request: {},
                config: {},
            })
                .mockResolvedValueOnce({ data: { data: mockSuccessData } });
            const result = await executeGraphQLQuery(query, variables, operationName, userId);
            expect(result).toEqual(mockSuccessData);
            expect(mockedAxios.post).toHaveBeenCalledTimes(2);
            // Check console.warn for timeout log
            expect(console.warn).toHaveBeenCalledWith(expect.stringContaining(`Network error or timeout for GraphQL operation '${operationName}'`), expect.any(String));
        });
        it('should fail after all retries for persistent 500 errors', async () => {
            mockedAxios.post
                .mockRejectedValueOnce({
                isAxiosError: true,
                response: { status: 500, data: 'Server Error 1' },
                request: {},
                config: {},
            })
                .mockRejectedValueOnce({
                isAxiosError: true,
                response: { status: 500, data: 'Server Error 2' },
                request: {},
                config: {},
            })
                .mockRejectedValueOnce({
                isAxiosError: true,
                response: { status: 500, data: 'Server Error 3' },
                request: {},
                config: {},
            });
            await expect(executeGraphQLQuery(query, variables, operationName, userId)).rejects.toThrow(expect.objectContaining({
                message: `HTTP error 500 executing operation '${operationName}'. Not retrying.`,
            }) // The last error thrown before retry logic gives up
            );
            expect(mockedAxios.post).toHaveBeenCalledTimes(3);
            expect(console.error).toHaveBeenCalledWith(expect.stringContaining('Failed GraphQL operation'), expect.anything());
        });
        it('should fail immediately on a non-retryable 400 error', async () => {
            mockedAxios.post.mockRejectedValueOnce({
                isAxiosError: true,
                response: { status: 400, data: 'Bad Request' },
                request: {},
                config: {},
            });
            await expect(executeGraphQLQuery(query, variables, operationName, userId)).rejects.toThrow(expect.objectContaining({
                message: `HTTP error 400 executing operation '${operationName}'. Not retrying.`,
            }));
            expect(mockedAxios.post).toHaveBeenCalledTimes(1);
            expect(console.error).toHaveBeenCalledWith(expect.stringContaining('HTTP error 400'), expect.any(String));
            expect(console.error).toHaveBeenCalledWith(expect.stringContaining('Failed GraphQL operation'), expect.anything());
        });
        it('should retry on GraphQL execution errors then succeed', async () => {
            mockedAxios.post
                .mockResolvedValueOnce({ data: { errors: mockGraphQLErrors } })
                .mockResolvedValueOnce({ data: { data: mockSuccessData } });
            const result = await executeGraphQLQuery(query, variables, operationName, userId);
            expect(result).toEqual(mockSuccessData);
            expect(mockedAxios.post).toHaveBeenCalledTimes(2);
            expect(console.error).toHaveBeenCalledWith('GraphQL errors:', JSON.stringify(mockGraphQLErrors, null, 2));
        });
        it('should fail after all retries for persistent GraphQL errors', async () => {
            mockedAxios.post.mockResolvedValue({
                data: { errors: mockGraphQLErrors },
            }); // Fails all 3 times
            await expect(executeGraphQLQuery(query, variables, operationName, userId)).rejects.toThrow(expect.objectContaining({
                message: `GraphQL error executing operation '${operationName}'.`,
            }));
            expect(mockedAxios.post).toHaveBeenCalledTimes(3);
            expect(console.error).toHaveBeenCalledTimes(3 + 1); // 3 for each attempt's GraphQL error log, 1 for final failure
        });
        it('should throw config error if HASURA_GRAPHQL_URL is not set', async () => {
            const originalUrl = constants.HASURA_GRAPHQL_URL;
            constants.HASURA_GRAPHQL_URL = undefined;
            await expect(executeGraphQLQuery(query, variables, operationName, userId)).rejects.toThrow('Hasura GraphQL URL or Admin Secret is not configured.');
            constants.HASURA_GRAPHQL_URL = originalUrl; // Restore
        });
    });
    describe('executeGraphQLMutation', () => {
        // Since executeGraphQLMutation just calls executeGraphQLQuery, we only need a basic test
        // to ensure it's wired up correctly. The retry/timeout logic is tested via executeGraphQLQuery.
        it('should execute mutation successfully', async () => {
            const mutation = 'mutation TestMutation { testMutate { id } }';
            mockedAxios.post.mockResolvedValueOnce({
                data: { data: mockSuccessData },
            });
            const result = await executeGraphQLMutation(mutation, variables, 'TestMutation', userId);
            expect(result).toEqual(mockSuccessData);
            expect(mockedAxios.post).toHaveBeenCalledTimes(1);
            expect(mockedAxios.post).toHaveBeenCalledWith(HASURA_GRAPHQL_URL, { query: mutation, variables, operationName: 'TestMutation' }, expect.anything());
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGhxbENsaWVudC50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZ3JhcGhxbENsaWVudC50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMxQixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM5RSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFdEUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNuQixNQUFNLFdBQVcsR0FBRyxLQUFrQyxDQUFDO0FBRXZELGlCQUFpQjtBQUNqQixJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQzlCLGtCQUFrQixFQUFFLG1DQUFtQztJQUN2RCxtQkFBbUIsRUFBRSxtQkFBbUI7Q0FDekMsQ0FBQyxDQUFDLENBQUM7QUFFSixRQUFRLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtJQUM3QixNQUFNLEtBQUssR0FBRyxpQ0FBaUMsQ0FBQztJQUNoRCxNQUFNLFNBQVMsR0FBRyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQztJQUNoQyxNQUFNLGFBQWEsR0FBRyxXQUFXLENBQUM7SUFDbEMsTUFBTSxNQUFNLEdBQUcsV0FBVyxDQUFDO0lBRTNCLE1BQU0sZUFBZSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLEVBQUUsQ0FBQztJQUNuRSxNQUFNLGlCQUFpQixHQUFHLENBQUMsRUFBRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsQ0FBQyxDQUFDO0lBRTlELFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQzdCLHlHQUF5RztRQUN6Ryx5REFB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QyxvQkFBb0IsQ0FDM0Msa0JBQWtCLEVBQ2xCLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLGNBQWMsRUFBRSxFQUM3RCxNQUFNLENBQUMsUUFBUSxFQUFFLENBQ2xCLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHsgZXhlY3V0ZUdyYXBoUUxRdWVyeSwgZXhlY3V0ZUdyYXBoUUxNdXRhdGlvbiB9IGZyb20gJy4vZ3JhcGhxbENsaWVudCc7XG5pbXBvcnQgeyBIQVNVUkFfR1JBUEhRTF9VUkwsIEhBU1VSQV9BRE1JTl9TRUNSRVQgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5cbmplc3QubW9jaygnYXhpb3MnKTtcbmNvbnN0IG1vY2tlZEF4aW9zID0gYXhpb3MgYXMgamVzdC5Nb2NrZWQ8dHlwZW9mIGF4aW9zPjtcblxuLy8gTW9jayBjb25zdGFudHNcbmplc3QubW9jaygnLi9jb25zdGFudHMnLCAoKSA9PiAoe1xuICBIQVNVUkFfR1JBUEhRTF9VUkw6ICdodHRwOi8vdGVzdC1oYXN1cmEuY29tL3YxL2dyYXBocWwnLFxuICBIQVNVUkFfQURNSU5fU0VDUkVUOiAndGVzdC1hZG1pbi1zZWNyZXQnLFxufSkpO1xuXG5kZXNjcmliZSgnZ3JhcGhxbENsaWVudCcsICgpID0+IHtcbiAgY29uc3QgcXVlcnkgPSAncXVlcnkgVGVzdFF1ZXJ5IHsgdGVzdCB7IGlkIH0gfSc7XG4gIGNvbnN0IHZhcmlhYmxlcyA9IHsgaWQ6ICcxMjMnIH07XG4gIGNvbnN0IG9wZXJhdGlvbk5hbWUgPSAnVGVzdFF1ZXJ5JztcbiAgY29uc3QgdXNlcklkID0gJ3Rlc3QtdXNlcic7XG5cbiAgY29uc3QgbW9ja1N1Y2Nlc3NEYXRhID0geyB0ZXN0OiB7IGlkOiAnMTIzJywgbmFtZTogJ1Rlc3QgRGF0YScgfSB9O1xuICBjb25zdCBtb2NrR3JhcGhRTEVycm9ycyA9IFt7IG1lc3NhZ2U6ICdTb21lIEdyYXBoUUwgZXJyb3InIH1dO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIG1vY2tlZEF4aW9zLnBvc3QubW9ja1Jlc2V0KCk7XG4gICAgLy8gamVzdC5yZXNldE1vZHVsZXMoKSAvLyBOb3Qgc3RyaWN0bHkgbmVlZGVkIGhlcmUgaWYgY29uc3RhbnRzIGFyZSBwcm9wZXJseSBtb2NrZWQgdmlhIGplc3QubW9jayBmYWN0b3J5XG4gICAgLy8gU3B5IG9uIGNvbnNvbGUuZXJyb3IgYW5kIGNvbnNvbGUud2FybiB0byBjaGVjayBsb2dnaW5nXG4gICAgamVzdC5zcHlPbihjb25zb2xlLCAnZXJyb3InKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4ge30pO1xuICAgIGplc3Quc3B5T24oY29uc29sZSwgJ3dhcm4nKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4ge30pO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGplc3QucmVzdG9yZUFsbE1vY2tzKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdleGVjdXRlR3JhcGhRTFF1ZXJ5JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBxdWVyeSBzdWNjZXNzZnVsbHkgb24gZmlyc3QgYXR0ZW1wdCcsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tlZEF4aW9zLnBvc3QubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHtcbiAgICAgICAgZGF0YTogeyBkYXRhOiBtb2NrU3VjY2Vzc0RhdGEgfSxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZXhlY3V0ZUdyYXBoUUxRdWVyeShcbiAgICAgICAgcXVlcnksXG4gICAgICAgIHZhcmlhYmxlcyxcbiAgICAgICAgb3BlcmF0aW9uTmFtZSxcbiAgICAgICAgdXNlcklkXG4gICAgICApO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChtb2NrU3VjY2Vzc0RhdGEpO1xuICAgICAgZXhwZWN0KG1vY2tlZEF4aW9zLnBvc3QpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdChtb2NrZWRBeGlvcy5wb3N0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgSEFTVVJBX0dSQVBIUUxfVVJMLFxuICAgICAgICB7IHF1ZXJ5LCB2YXJpYWJsZXMsIG9wZXJhdGlvbk5hbWUgfSxcbiAgICAgICAge1xuICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgICAnWC1IYXN1cmEtQWRtaW4tU2VjcmV0JzogSEFTVVJBX0FETUlOX1NFQ1JFVCxcbiAgICAgICAgICAgICdYLUhhc3VyYS1Sb2xlJzogJ3VzZXInLFxuICAgICAgICAgICAgJ1gtSGFzdXJhLVVzZXItSWQnOiB1c2VySWQsXG4gICAgICAgICAgfSxcbiAgICAgICAgICB0aW1lb3V0OiAxNTAwMCxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdXNlIGFkbWluIHJvbGUgaWYgdXNlcklkIGlzIG5vdCBwcm92aWRlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tlZEF4aW9zLnBvc3QubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHtcbiAgICAgICAgZGF0YTogeyBkYXRhOiBtb2NrU3VjY2Vzc0RhdGEgfSxcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgZXhlY3V0ZUdyYXBoUUxRdWVyeShxdWVyeSwgdmFyaWFibGVzLCBvcGVyYXRpb25OYW1lKTtcbiAgICAgIGV4cGVjdChtb2NrZWRBeGlvcy5wb3N0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgSEFTVVJBX0dSQVBIUUxfVVJMLFxuICAgICAgICBleHBlY3QuYW55dGhpbmcoKSxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGhlYWRlcnM6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICdYLUhhc3VyYS1Sb2xlJzogJ2FkbWluJyxcbiAgICAgICAgICAgICdYLUhhc3VyYS1Vc2VyLUlkJzogdW5kZWZpbmVkLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgc3VjY2VlZCBvbiB0aGUgc2Vjb25kIGF0dGVtcHQgYWZ0ZXIgYSA1MDMgZXJyb3InLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrZWRBeGlvcy5wb3N0XG4gICAgICAgIC5tb2NrUmVqZWN0ZWRWYWx1ZU9uY2Uoe1xuICAgICAgICAgIGlzQXhpb3NFcnJvcjogdHJ1ZSxcbiAgICAgICAgICByZXNwb25zZTogeyBzdGF0dXM6IDUwMywgZGF0YTogJ1NlcnZpY2UgVW5hdmFpbGFibGUnIH0sXG4gICAgICAgICAgcmVxdWVzdDoge30sXG4gICAgICAgICAgY29uZmlnOiB7fSxcbiAgICAgICAgfSlcbiAgICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7IGRhdGE6IHsgZGF0YTogbW9ja1N1Y2Nlc3NEYXRhIH0gfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGV4ZWN1dGVHcmFwaFFMUXVlcnkoXG4gICAgICAgIHF1ZXJ5LFxuICAgICAgICB2YXJpYWJsZXMsXG4gICAgICAgIG9wZXJhdGlvbk5hbWUsXG4gICAgICAgIHVzZXJJZFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwobW9ja1N1Y2Nlc3NEYXRhKTtcbiAgICAgIGV4cGVjdChtb2NrZWRBeGlvcy5wb3N0KS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG4gICAgICBleHBlY3QoY29uc29sZS5lcnJvcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdIVFRQIGVycm9yIDUwMycpLFxuICAgICAgICBleHBlY3QuYW55KFN0cmluZylcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHN1Y2NlZWQgb24gdGhlIHNlY29uZCBhdHRlbXB0IGFmdGVyIGEgdGltZW91dCAoRUNPTk5BQk9SVEVEKScsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tlZEF4aW9zLnBvc3RcbiAgICAgICAgLm1vY2tSZWplY3RlZFZhbHVlT25jZSh7XG4gICAgICAgICAgaXNBeGlvc0Vycm9yOiB0cnVlLFxuICAgICAgICAgIGNvZGU6ICdFQ09OTkFCT1JURUQnLFxuICAgICAgICAgIG1lc3NhZ2U6ICd0aW1lb3V0IGV4Y2VlZGVkJyxcbiAgICAgICAgICByZXF1ZXN0OiB7fSxcbiAgICAgICAgICBjb25maWc6IHt9LFxuICAgICAgICB9KVxuICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHsgZGF0YTogeyBkYXRhOiBtb2NrU3VjY2Vzc0RhdGEgfSB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZXhlY3V0ZUdyYXBoUUxRdWVyeShcbiAgICAgICAgcXVlcnksXG4gICAgICAgIHZhcmlhYmxlcyxcbiAgICAgICAgb3BlcmF0aW9uTmFtZSxcbiAgICAgICAgdXNlcklkXG4gICAgICApO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChtb2NrU3VjY2Vzc0RhdGEpO1xuICAgICAgZXhwZWN0KG1vY2tlZEF4aW9zLnBvc3QpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygyKTtcbiAgICAgIC8vIENoZWNrIGNvbnNvbGUud2FybiBmb3IgdGltZW91dCBsb2dcbiAgICAgIGV4cGVjdChjb25zb2xlLndhcm4pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZyhcbiAgICAgICAgICBgTmV0d29yayBlcnJvciBvciB0aW1lb3V0IGZvciBHcmFwaFFMIG9wZXJhdGlvbiAnJHtvcGVyYXRpb25OYW1lfSdgXG4gICAgICAgICksXG4gICAgICAgIGV4cGVjdC5hbnkoU3RyaW5nKVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZmFpbCBhZnRlciBhbGwgcmV0cmllcyBmb3IgcGVyc2lzdGVudCA1MDAgZXJyb3JzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbW9ja2VkQXhpb3MucG9zdFxuICAgICAgICAubW9ja1JlamVjdGVkVmFsdWVPbmNlKHtcbiAgICAgICAgICBpc0F4aW9zRXJyb3I6IHRydWUsXG4gICAgICAgICAgcmVzcG9uc2U6IHsgc3RhdHVzOiA1MDAsIGRhdGE6ICdTZXJ2ZXIgRXJyb3IgMScgfSxcbiAgICAgICAgICByZXF1ZXN0OiB7fSxcbiAgICAgICAgICBjb25maWc6IHt9LFxuICAgICAgICB9KVxuICAgICAgICAubW9ja1JlamVjdGVkVmFsdWVPbmNlKHtcbiAgICAgICAgICBpc0F4aW9zRXJyb3I6IHRydWUsXG4gICAgICAgICAgcmVzcG9uc2U6IHsgc3RhdHVzOiA1MDAsIGRhdGE6ICdTZXJ2ZXIgRXJyb3IgMicgfSxcbiAgICAgICAgICByZXF1ZXN0OiB7fSxcbiAgICAgICAgICBjb25maWc6IHt9LFxuICAgICAgICB9KVxuICAgICAgICAubW9ja1JlamVjdGVkVmFsdWVPbmNlKHtcbiAgICAgICAgICBpc0F4aW9zRXJyb3I6IHRydWUsXG4gICAgICAgICAgcmVzcG9uc2U6IHsgc3RhdHVzOiA1MDAsIGRhdGE6ICdTZXJ2ZXIgRXJyb3IgMycgfSxcbiAgICAgICAgICByZXF1ZXN0OiB7fSxcbiAgICAgICAgICBjb25maWc6IHt9LFxuICAgICAgICB9KTtcblxuICAgICAgYXdhaXQgZXhwZWN0KFxuICAgICAgICBleGVjdXRlR3JhcGhRTFF1ZXJ5KHF1ZXJ5LCB2YXJpYWJsZXMsIG9wZXJhdGlvbk5hbWUsIHVzZXJJZClcbiAgICAgICkucmVqZWN0cy50b1Rocm93KFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgbWVzc2FnZTogYEhUVFAgZXJyb3IgNTAwIGV4ZWN1dGluZyBvcGVyYXRpb24gJyR7b3BlcmF0aW9uTmFtZX0nLiBOb3QgcmV0cnlpbmcuYCxcbiAgICAgICAgfSkgLy8gVGhlIGxhc3QgZXJyb3IgdGhyb3duIGJlZm9yZSByZXRyeSBsb2dpYyBnaXZlcyB1cFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrZWRBeGlvcy5wb3N0KS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMyk7XG4gICAgICBleHBlY3QoY29uc29sZS5lcnJvcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdGYWlsZWQgR3JhcGhRTCBvcGVyYXRpb24nKSxcbiAgICAgICAgZXhwZWN0LmFueXRoaW5nKClcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGZhaWwgaW1tZWRpYXRlbHkgb24gYSBub24tcmV0cnlhYmxlIDQwMCBlcnJvcicsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tlZEF4aW9zLnBvc3QubW9ja1JlamVjdGVkVmFsdWVPbmNlKHtcbiAgICAgICAgaXNBeGlvc0Vycm9yOiB0cnVlLFxuICAgICAgICByZXNwb25zZTogeyBzdGF0dXM6IDQwMCwgZGF0YTogJ0JhZCBSZXF1ZXN0JyB9LFxuICAgICAgICByZXF1ZXN0OiB7fSxcbiAgICAgICAgY29uZmlnOiB7fSxcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIGV4ZWN1dGVHcmFwaFFMUXVlcnkocXVlcnksIHZhcmlhYmxlcywgb3BlcmF0aW9uTmFtZSwgdXNlcklkKVxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBtZXNzYWdlOiBgSFRUUCBlcnJvciA0MDAgZXhlY3V0aW5nIG9wZXJhdGlvbiAnJHtvcGVyYXRpb25OYW1lfScuIE5vdCByZXRyeWluZy5gLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrZWRBeGlvcy5wb3N0KS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgICBleHBlY3QoY29uc29sZS5lcnJvcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdIVFRQIGVycm9yIDQwMCcpLFxuICAgICAgICBleHBlY3QuYW55KFN0cmluZylcbiAgICAgICk7XG4gICAgICBleHBlY3QoY29uc29sZS5lcnJvcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdGYWlsZWQgR3JhcGhRTCBvcGVyYXRpb24nKSxcbiAgICAgICAgZXhwZWN0LmFueXRoaW5nKClcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHJ5IG9uIEdyYXBoUUwgZXhlY3V0aW9uIGVycm9ycyB0aGVuIHN1Y2NlZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrZWRBeGlvcy5wb3N0XG4gICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoeyBkYXRhOiB7IGVycm9yczogbW9ja0dyYXBoUUxFcnJvcnMgfSB9KVxuICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHsgZGF0YTogeyBkYXRhOiBtb2NrU3VjY2Vzc0RhdGEgfSB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZXhlY3V0ZUdyYXBoUUxRdWVyeShcbiAgICAgICAgcXVlcnksXG4gICAgICAgIHZhcmlhYmxlcyxcbiAgICAgICAgb3BlcmF0aW9uTmFtZSxcbiAgICAgICAgdXNlcklkXG4gICAgICApO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChtb2NrU3VjY2Vzc0RhdGEpO1xuICAgICAgZXhwZWN0KG1vY2tlZEF4aW9zLnBvc3QpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygyKTtcbiAgICAgIGV4cGVjdChjb25zb2xlLmVycm9yKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ0dyYXBoUUwgZXJyb3JzOicsXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KG1vY2tHcmFwaFFMRXJyb3JzLCBudWxsLCAyKVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZmFpbCBhZnRlciBhbGwgcmV0cmllcyBmb3IgcGVyc2lzdGVudCBHcmFwaFFMIGVycm9ycycsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tlZEF4aW9zLnBvc3QubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBkYXRhOiB7IGVycm9yczogbW9ja0dyYXBoUUxFcnJvcnMgfSxcbiAgICAgIH0pOyAvLyBGYWlscyBhbGwgMyB0aW1lc1xuXG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIGV4ZWN1dGVHcmFwaFFMUXVlcnkocXVlcnksIHZhcmlhYmxlcywgb3BlcmF0aW9uTmFtZSwgdXNlcklkKVxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBtZXNzYWdlOiBgR3JhcGhRTCBlcnJvciBleGVjdXRpbmcgb3BlcmF0aW9uICcke29wZXJhdGlvbk5hbWV9Jy5gLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrZWRBeGlvcy5wb3N0KS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMyk7XG4gICAgICBleHBlY3QoY29uc29sZS5lcnJvcikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDMgKyAxKTsgLy8gMyBmb3IgZWFjaCBhdHRlbXB0J3MgR3JhcGhRTCBlcnJvciBsb2csIDEgZm9yIGZpbmFsIGZhaWx1cmVcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgY29uZmlnIGVycm9yIGlmIEhBU1VSQV9HUkFQSFFMX1VSTCBpcyBub3Qgc2V0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3Qgb3JpZ2luYWxVcmwgPSAoY29uc3RhbnRzIGFzIGFueSkuSEFTVVJBX0dSQVBIUUxfVVJMO1xuICAgICAgKGNvbnN0YW50cyBhcyBhbnkpLkhBU1VSQV9HUkFQSFFMX1VSTCA9IHVuZGVmaW5lZDtcblxuICAgICAgYXdhaXQgZXhwZWN0KFxuICAgICAgICBleGVjdXRlR3JhcGhRTFF1ZXJ5KHF1ZXJ5LCB2YXJpYWJsZXMsIG9wZXJhdGlvbk5hbWUsIHVzZXJJZClcbiAgICAgICkucmVqZWN0cy50b1Rocm93KFxuICAgICAgICAnSGFzdXJhIEdyYXBoUUwgVVJMIG9yIEFkbWluIFNlY3JldCBpcyBub3QgY29uZmlndXJlZC4nXG4gICAgICApO1xuICAgICAgKGNvbnN0YW50cyBhcyBhbnkpLkhBU1VSQV9HUkFQSFFMX1VSTCA9IG9yaWdpbmFsVXJsOyAvLyBSZXN0b3JlXG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdleGVjdXRlR3JhcGhRTE11dGF0aW9uJywgKCkgPT4ge1xuICAgIC8vIFNpbmNlIGV4ZWN1dGVHcmFwaFFMTXV0YXRpb24ganVzdCBjYWxscyBleGVjdXRlR3JhcGhRTFF1ZXJ5LCB3ZSBvbmx5IG5lZWQgYSBiYXNpYyB0ZXN0XG4gICAgLy8gdG8gZW5zdXJlIGl0J3Mgd2lyZWQgdXAgY29ycmVjdGx5LiBUaGUgcmV0cnkvdGltZW91dCBsb2dpYyBpcyB0ZXN0ZWQgdmlhIGV4ZWN1dGVHcmFwaFFMUXVlcnkuXG4gICAgaXQoJ3Nob3VsZCBleGVjdXRlIG11dGF0aW9uIHN1Y2Nlc3NmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG11dGF0aW9uID0gJ211dGF0aW9uIFRlc3RNdXRhdGlvbiB7IHRlc3RNdXRhdGUgeyBpZCB9IH0nO1xuICAgICAgbW9ja2VkQXhpb3MucG9zdC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe1xuICAgICAgICBkYXRhOiB7IGRhdGE6IG1vY2tTdWNjZXNzRGF0YSB9LFxuICAgICAgfSk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBleGVjdXRlR3JhcGhRTE11dGF0aW9uKFxuICAgICAgICBtdXRhdGlvbixcbiAgICAgICAgdmFyaWFibGVzLFxuICAgICAgICAnVGVzdE11dGF0aW9uJyxcbiAgICAgICAgdXNlcklkXG4gICAgICApO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChtb2NrU3VjY2Vzc0RhdGEpO1xuICAgICAgZXhwZWN0KG1vY2tlZEF4aW9zLnBvc3QpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdChtb2NrZWRBeGlvcy5wb3N0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgSEFTVVJBX0dSQVBIUUxfVVJMLFxuICAgICAgICB7IHF1ZXJ5OiBtdXRhdGlvbiwgdmFyaWFibGVzLCBvcGVyYXRpb25OYW1lOiAnVGVzdE11dGF0aW9uJyB9LFxuICAgICAgICBleHBlY3QuYW55dGhpbmcoKVxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==