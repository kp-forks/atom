import { callOpenAIWithMessageHistoryOnly, listEventsForUserGivenDates, } from '@chat/_libs/api-helper';
import { dailyScheduleExampleInput, dailyScheduleExampleOutput, dailySchedulePrompt, dailyScheduleTemplate, } from './prompts';
import { dayjs } from '@chat/_libs/datetime/date-utils';
import { defaultOpenAIAPIKey, openAIChatGPT35Model, } from '@chat/_libs/constants';
import OpenAI from 'openai';
import { generateWorkTimesForUser, getUserPreferences, } from '@chat/_libs/skills/askCalendar/api-helper';
import { TemplateEngine } from '@chat/_libs/template-engine';
const openai = new OpenAI({
    apiKey: defaultOpenAIAPIKey,
});
export const createDayScheduleForTasks = async (userId, tasks, // make sure to add previous events inside tasks when submitting
timezone, dayWindowStartDate, dayWindowEndDate, userCurrentTime, bufferTime, startDate // dayjs().format()
) => {
    try {
        // get previous events
        const previousEvents = await listEventsForUserGivenDates(userId, dayWindowStartDate, dayWindowEndDate);
        // create prompt
        // h:mm a
        const queryDateSysMessage = {
            role: 'system',
            content: dailySchedulePrompt,
        };
        const queryDateMessageHistory = [];
        const queryDateUserMessage1 = {
            role: 'user',
            content: dailyScheduleExampleInput,
        };
        const queryDateAssistantMessage1 = {
            role: 'assistant',
            content: dailyScheduleExampleOutput,
        };
        // user work times
        const userPreferences = await getUserPreferences(userId);
        const workTimesObject = generateWorkTimesForUser(userPreferences, timezone);
        let userWorkTimes = '';
        for (const workTimeObject of workTimesObject) {
            userWorkTimes += `${workTimeObject?.dayOfWeek}: ${workTimeObject?.startTime} - ${workTimeObject?.endTime} \n`;
        }
        console.log(userWorkTimes, ' userWorkTimes');
        let startDateTime = startDate;
        if (startDate) {
            const startHour = dayjs(startDate).tz(timezone).hour();
            const startMinute = dayjs(startDate).tz(timezone).minute();
            if (startHour === 0 && startMinute === 0) {
                startDateTime = null;
            }
        }
        const userInput = `
            ${bufferTime?.afterEvent || bufferTime?.beforeEvent ? `Add buffer time if any time available to each task with before: ${bufferTime?.beforeEvent || '0'} min and after: ${bufferTime?.afterEvent || '0'} min with title: Buffer time` : ''}
            ${startDateTime ? `start time for tasks: ${dayjs(startDateTime).tz(timezone).format('h:mm a')}` : ''}
            tasks:
            ${tasks?.reduce((prev, curr) => `${prev}, ${curr}`, '')},
            ${previousEvents
            ?.map((e) => `From ${dayjs(e?.startDate?.slice(0, 19)).tz(timezone, true).format('h:mm a')} to ${dayjs(e?.endDate?.slice(0, 19)).tz(timezone, true).format('h:mm a')}: ${e?.summary} ${e?.notes}`)
            ?.reduce((prev, curr) => `${prev}, ${curr}`, '')}
        `;
        console.log(userInput, ' userInput');
        const queryDateEngine = new TemplateEngine(dailyScheduleTemplate);
        const queryDateRendered = queryDateEngine.render({
            userCurrentTime,
            userWorkTimes: userWorkTimes,
            userInput,
        });
        const queryDateUserMessageInput = {
            role: 'user',
            content: queryDateRendered,
        };
        queryDateMessageHistory.push(queryDateSysMessage, queryDateUserMessage1, queryDateAssistantMessage1, queryDateUserMessageInput);
        // get res from openai
        const openAIRes = await callOpenAIWithMessageHistoryOnly(openai, queryDateMessageHistory, openAIChatGPT35Model);
        // validate openai res
        if (!openAIRes) {
            throw new Error('no openAIRes present inside createAgenda');
        }
        console.log(openAIRes, ' openAIRes');
        // create event
        // format response for all day
        /*
                format is JSON array [{"start_time": "", "end_time": "", "task": ""}]
            */
        const startIndex = openAIRes?.indexOf('[');
        const endIndex = openAIRes?.lastIndexOf(']');
        const finalString = openAIRes.slice(startIndex, endIndex + 1);
        console.log('finalString: ', finalString);
        const parsedText = JSON.parse(finalString);
        console.log('parsedText: ', parsedText);
        return parsedText;
    }
    catch (e) {
        console.log(e, ' unable to create daily schedule');
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFwaS1oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLGdDQUFnQyxFQUNoQywyQkFBMkIsR0FDNUIsTUFBTSx3QkFBd0IsQ0FBQztBQUNoQyxPQUFPLEVBQ0wseUJBQXlCLEVBQ3pCLDBCQUEwQixFQUMxQixtQkFBbUIsRUFDbkIscUJBQXFCLEdBQ3RCLE1BQU0sV0FBVyxDQUFDO0FBQ25CLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUN4RCxPQUFPLEVBQ0wsbUJBQW1CLEVBQ25CLG9CQUFvQixHQUNyQixNQUFNLHVCQUF1QixDQUFDO0FBQy9CLE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQztBQUk1QixPQUFPLEVBQ0wsd0JBQXdCLEVBQ3hCLGtCQUFrQixHQUNuQixNQUFNLDJDQUEyQyxDQUFDO0FBQ25ELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUc3RCxNQUFNLE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQztJQUN4QixNQUFNLEVBQUUsbUJBQW1CO0NBQzVCLENBQUMsQ0FBQztBQUVILE1BQU0sQ0FBQyxNQUFNLHlCQUF5QixHQUFHLEtBQUssRUFDNUMsTUFBYyxFQUNkLEtBQWUsRUFBRSxnRUFBZ0U7QUFDakYsUUFBZ0IsRUFDaEIsa0JBQTBCLEVBQzFCLGdCQUF3QixFQUN4QixlQUF1QixFQUN2QixVQUEyQixFQUMzQixTQUFrQixDQUFDLG1CQUFtQjtFQUN0QyxFQUFFO0lBQ0YsSUFBSSxDQUFDO1FBQ0gsc0JBQXNCO1FBQ3RCLE1BQU0sY0FBYyxHQUFHLE1BQU0sMkJBQTJCLENBQ3RELE1BQU0sRUFDTixrQkFBa0IsRUFDbEIsZ0JBQWdCLENBQ2pCLENBQUM7UUFFRixnQkFBZ0I7UUFDaEIsU0FBUztRQUVULE1BQU0sbUJBQW1CLEdBQUc7WUFDMUIsSUFBSSxFQUFFLFFBQTJCO1lBQ2pDLE9BQU8sRUFBRSxtQkFBbUI7U0FDN0IsQ0FBQztRQUNGLE1BQU0sdUJBQXVCLEdBQThCLEVBQUUsQ0FBQztRQUU5RCxNQUFNLHFCQUFxQixHQUFHO1lBQzVCLElBQUksRUFBRSxNQUF5QjtZQUMvQixPQUFPLEVBQUUseUJBQXlCO1NBQ25DLENBQUM7UUFDRixNQUFNLDBCQUEwQixHQUFHO1lBQ2pDLElBQUksRUFBRSxXQUE4QjtZQUNwQyxPQUFPLEVBQUUsMEJBQTBCO1NBQ3BDLENBQUM7UUFFRixrQkFBa0I7UUFDbEIsTUFBTSxlQUFlLEdBQUcsTUFBTSxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUV6RCxNQUFNLGVBQWUsR0FBRyx3QkFBd0IsQ0FBQyxlQUFlLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDNUUsSUFBSSxhQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLEtBQUssTUFBTSxjQUFjLElBQUksZUFBZSxFQUFFLENBQUM7WUFDN0MsYUFBYSxJQUFJLEdBQUcsY0FBYyxFQUFFLFNBQVMsS0FBSyxjQUFjLEVBQUUsU0FBUyxNQUFNLGNBQWMsRUFBRSxPQUFPLEtBQUssQ0FBQztRQUNoSCxDQUFDO1FBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztRQUU3QyxJQUFJLGFBQWEsR0FBRyxTQUFTLENBQUM7UUFFOUIsSUFBSSxTQUFTLEVBQUUsQ0FBQztZQUNkLE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDdkQsTUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUMzRCxJQUFJLFNBQVMsS0FBSyxDQUFDLElBQUksV0FBVyxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUN6QyxhQUFhLEdBQUcsSUFBSSxDQUFDO1lBQ3ZCLENBQUM7UUFDSCxDQUFDO1FBRUQsTUFBTSxTQUFTLEdBQUc7Y0FDUixVQUFVLEVBQUUsVUFBVSxJQUFJLFVBQVUsRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDLG1FQUFtRSxVQUFVLEVBQUUsV0FBVyxJQUFJLEdBQUcsbUJBQW1CLFVBQVUsRUFBRSxVQUFVLElBQUksR0FBRyw4QkFBOEIsQ0FBQyxDQUFDLENBQUMsRUFBRTtjQUN4TyxhQUFhLENBQUMsQ0FBQyxDQUFDLHlCQUF5QixLQUFLLENBQUMsYUFBYSxDQUFDLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFOztjQUVsRyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsR0FBRyxJQUFJLEtBQUssSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDO2NBQ3JELGNBQWM7WUFDZCxFQUFFLEdBQUcsQ0FDSCxDQUFDLENBQUMsRUFBRSxFQUFFLENBQ0osUUFBUSxLQUFLLENBQUMsQ0FBQyxFQUFFLFNBQVMsRUFBRSxLQUFLLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE9BQU8sS0FBSyxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRSxPQUFPLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUN2TDtZQUNELEVBQUUsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsR0FBRyxJQUFJLEtBQUssSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDO1NBQ3JELENBQUM7UUFDTixPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUNyQyxNQUFNLGVBQWUsR0FBRyxJQUFJLGNBQWMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQ2xFLE1BQU0saUJBQWlCLEdBQUcsZUFBZSxDQUFDLE1BQU0sQ0FBQztZQUMvQyxlQUFlO1lBQ2YsYUFBYSxFQUFFLGFBQWE7WUFDNUIsU0FBUztTQUNWLENBQUMsQ0FBQztRQUVILE1BQU0seUJBQXlCLEdBQUc7WUFDaEMsSUFBSSxFQUFFLE1BQXlCO1lBQy9CLE9BQU8sRUFBRSxpQkFBaUI7U0FDM0IsQ0FBQztRQUNGLHVCQUF1QixDQUFDLElBQUksQ0FDMUIsbUJBQW1CLEVBQ25CLHFCQUFxQixFQUNyQiwwQkFBMEIsRUFDMUIseUJBQXlCLENBQzFCLENBQUM7UUFDRixzQkFBc0I7UUFDdEIsTUFBTSxTQUFTLEdBQUcsTUFBTSxnQ0FBZ0MsQ0FDdEQsTUFBTSxFQUNOLHVCQUF1QixFQUN2QixvQkFBb0IsQ0FDckIsQ0FBQztRQUVGLHNCQUFzQjtRQUN0QixJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDZixNQUFNLElBQUksS0FBSyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7UUFDOUQsQ0FBQztRQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBRXJDLGVBQWU7UUFFZiw4QkFBOEI7UUFDOUI7O2NBRU07UUFFTixNQUFNLFVBQVUsR0FBRyxTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzNDLE1BQU0sUUFBUSxHQUFHLFNBQVMsRUFBRSxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFN0MsTUFBTSxXQUFXLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsUUFBUSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRTlELE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBRTFDLE1BQU0sVUFBVSxHQUE4QixJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRXRFLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBRXhDLE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7SUFBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1FBQ1gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsa0NBQWtDLENBQUMsQ0FBQztJQUNyRCxDQUFDO0FBQ0gsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgY2FsbE9wZW5BSVdpdGhNZXNzYWdlSGlzdG9yeU9ubHksXG4gIGxpc3RFdmVudHNGb3JVc2VyR2l2ZW5EYXRlcyxcbn0gZnJvbSAnQGNoYXQvX2xpYnMvYXBpLWhlbHBlcic7XG5pbXBvcnQge1xuICBkYWlseVNjaGVkdWxlRXhhbXBsZUlucHV0LFxuICBkYWlseVNjaGVkdWxlRXhhbXBsZU91dHB1dCxcbiAgZGFpbHlTY2hlZHVsZVByb21wdCxcbiAgZGFpbHlTY2hlZHVsZVRlbXBsYXRlLFxufSBmcm9tICcuL3Byb21wdHMnO1xuaW1wb3J0IHsgZGF5anMgfSBmcm9tICdAY2hhdC9fbGlicy9kYXRldGltZS9kYXRlLXV0aWxzJztcbmltcG9ydCB7XG4gIGRlZmF1bHRPcGVuQUlBUElLZXksXG4gIG9wZW5BSUNoYXRHUFQzNU1vZGVsLFxufSBmcm9tICdAY2hhdC9fbGlicy9jb25zdGFudHMnO1xuaW1wb3J0IE9wZW5BSSBmcm9tICdvcGVuYWknO1xuaW1wb3J0IHsgRGFpbHlTY2hlZHVsZU9iamVjdFR5cGUgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IEJ1ZmZlclRpbWVUeXBlIH0gZnJvbSAnQGNoYXQvX2xpYnMvdHlwZXMvRXZlbnRUeXBlJztcbmltcG9ydCB7IENoYXRHUFRNZXNzYWdlSGlzdG9yeVR5cGUgfSBmcm9tICdAY2hhdC9fbGlicy90eXBlcy9DaGF0R1BUVHlwZXMnO1xuaW1wb3J0IHtcbiAgZ2VuZXJhdGVXb3JrVGltZXNGb3JVc2VyLFxuICBnZXRVc2VyUHJlZmVyZW5jZXMsXG59IGZyb20gJ0BjaGF0L19saWJzL3NraWxscy9hc2tDYWxlbmRhci9hcGktaGVscGVyJztcbmltcG9ydCB7IFRlbXBsYXRlRW5naW5lIH0gZnJvbSAnQGNoYXQvX2xpYnMvdGVtcGxhdGUtZW5naW5lJztcbmltcG9ydCB7IENoYXRHUFRSb2xlVHlwZSB9IGZyb20gJ0AvZ3B0LW1lZXRpbmcvX2xpYnMvdHlwZXMvQ2hhdEdQVFR5cGVzJztcblxuY29uc3Qgb3BlbmFpID0gbmV3IE9wZW5BSSh7XG4gIGFwaUtleTogZGVmYXVsdE9wZW5BSUFQSUtleSxcbn0pO1xuXG5leHBvcnQgY29uc3QgY3JlYXRlRGF5U2NoZWR1bGVGb3JUYXNrcyA9IGFzeW5jIChcbiAgdXNlcklkOiBzdHJpbmcsXG4gIHRhc2tzOiBzdHJpbmdbXSwgLy8gbWFrZSBzdXJlIHRvIGFkZCBwcmV2aW91cyBldmVudHMgaW5zaWRlIHRhc2tzIHdoZW4gc3VibWl0dGluZ1xuICB0aW1lem9uZTogc3RyaW5nLFxuICBkYXlXaW5kb3dTdGFydERhdGU6IHN0cmluZyxcbiAgZGF5V2luZG93RW5kRGF0ZTogc3RyaW5nLFxuICB1c2VyQ3VycmVudFRpbWU6IHN0cmluZyxcbiAgYnVmZmVyVGltZT86IEJ1ZmZlclRpbWVUeXBlLFxuICBzdGFydERhdGU/OiBzdHJpbmcgLy8gZGF5anMoKS5mb3JtYXQoKVxuKSA9PiB7XG4gIHRyeSB7XG4gICAgLy8gZ2V0IHByZXZpb3VzIGV2ZW50c1xuICAgIGNvbnN0IHByZXZpb3VzRXZlbnRzID0gYXdhaXQgbGlzdEV2ZW50c0ZvclVzZXJHaXZlbkRhdGVzKFxuICAgICAgdXNlcklkLFxuICAgICAgZGF5V2luZG93U3RhcnREYXRlLFxuICAgICAgZGF5V2luZG93RW5kRGF0ZVxuICAgICk7XG5cbiAgICAvLyBjcmVhdGUgcHJvbXB0XG4gICAgLy8gaDptbSBhXG5cbiAgICBjb25zdCBxdWVyeURhdGVTeXNNZXNzYWdlID0ge1xuICAgICAgcm9sZTogJ3N5c3RlbScgYXMgQ2hhdEdQVFJvbGVUeXBlLFxuICAgICAgY29udGVudDogZGFpbHlTY2hlZHVsZVByb21wdCxcbiAgICB9O1xuICAgIGNvbnN0IHF1ZXJ5RGF0ZU1lc3NhZ2VIaXN0b3J5OiBDaGF0R1BUTWVzc2FnZUhpc3RvcnlUeXBlID0gW107XG5cbiAgICBjb25zdCBxdWVyeURhdGVVc2VyTWVzc2FnZTEgPSB7XG4gICAgICByb2xlOiAndXNlcicgYXMgQ2hhdEdQVFJvbGVUeXBlLFxuICAgICAgY29udGVudDogZGFpbHlTY2hlZHVsZUV4YW1wbGVJbnB1dCxcbiAgICB9O1xuICAgIGNvbnN0IHF1ZXJ5RGF0ZUFzc2lzdGFudE1lc3NhZ2UxID0ge1xuICAgICAgcm9sZTogJ2Fzc2lzdGFudCcgYXMgQ2hhdEdQVFJvbGVUeXBlLFxuICAgICAgY29udGVudDogZGFpbHlTY2hlZHVsZUV4YW1wbGVPdXRwdXQsXG4gICAgfTtcblxuICAgIC8vIHVzZXIgd29yayB0aW1lc1xuICAgIGNvbnN0IHVzZXJQcmVmZXJlbmNlcyA9IGF3YWl0IGdldFVzZXJQcmVmZXJlbmNlcyh1c2VySWQpO1xuXG4gICAgY29uc3Qgd29ya1RpbWVzT2JqZWN0ID0gZ2VuZXJhdGVXb3JrVGltZXNGb3JVc2VyKHVzZXJQcmVmZXJlbmNlcywgdGltZXpvbmUpO1xuICAgIGxldCB1c2VyV29ya1RpbWVzID0gJyc7XG4gICAgZm9yIChjb25zdCB3b3JrVGltZU9iamVjdCBvZiB3b3JrVGltZXNPYmplY3QpIHtcbiAgICAgIHVzZXJXb3JrVGltZXMgKz0gYCR7d29ya1RpbWVPYmplY3Q/LmRheU9mV2Vla306ICR7d29ya1RpbWVPYmplY3Q/LnN0YXJ0VGltZX0gLSAke3dvcmtUaW1lT2JqZWN0Py5lbmRUaW1lfSBcXG5gO1xuICAgIH1cbiAgICBjb25zb2xlLmxvZyh1c2VyV29ya1RpbWVzLCAnIHVzZXJXb3JrVGltZXMnKTtcblxuICAgIGxldCBzdGFydERhdGVUaW1lID0gc3RhcnREYXRlO1xuXG4gICAgaWYgKHN0YXJ0RGF0ZSkge1xuICAgICAgY29uc3Qgc3RhcnRIb3VyID0gZGF5anMoc3RhcnREYXRlKS50eih0aW1lem9uZSkuaG91cigpO1xuICAgICAgY29uc3Qgc3RhcnRNaW51dGUgPSBkYXlqcyhzdGFydERhdGUpLnR6KHRpbWV6b25lKS5taW51dGUoKTtcbiAgICAgIGlmIChzdGFydEhvdXIgPT09IDAgJiYgc3RhcnRNaW51dGUgPT09IDApIHtcbiAgICAgICAgc3RhcnREYXRlVGltZSA9IG51bGw7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgdXNlcklucHV0ID0gYFxuICAgICAgICAgICAgJHtidWZmZXJUaW1lPy5hZnRlckV2ZW50IHx8IGJ1ZmZlclRpbWU/LmJlZm9yZUV2ZW50ID8gYEFkZCBidWZmZXIgdGltZSBpZiBhbnkgdGltZSBhdmFpbGFibGUgdG8gZWFjaCB0YXNrIHdpdGggYmVmb3JlOiAke2J1ZmZlclRpbWU/LmJlZm9yZUV2ZW50IHx8ICcwJ30gbWluIGFuZCBhZnRlcjogJHtidWZmZXJUaW1lPy5hZnRlckV2ZW50IHx8ICcwJ30gbWluIHdpdGggdGl0bGU6IEJ1ZmZlciB0aW1lYCA6ICcnfVxuICAgICAgICAgICAgJHtzdGFydERhdGVUaW1lID8gYHN0YXJ0IHRpbWUgZm9yIHRhc2tzOiAke2RheWpzKHN0YXJ0RGF0ZVRpbWUpLnR6KHRpbWV6b25lKS5mb3JtYXQoJ2g6bW0gYScpfWAgOiAnJ31cbiAgICAgICAgICAgIHRhc2tzOlxuICAgICAgICAgICAgJHt0YXNrcz8ucmVkdWNlKChwcmV2LCBjdXJyKSA9PiBgJHtwcmV2fSwgJHtjdXJyfWAsICcnKX0sXG4gICAgICAgICAgICAke3ByZXZpb3VzRXZlbnRzXG4gICAgICAgICAgICAgID8ubWFwKFxuICAgICAgICAgICAgICAgIChlKSA9PlxuICAgICAgICAgICAgICAgICAgYEZyb20gJHtkYXlqcyhlPy5zdGFydERhdGU/LnNsaWNlKDAsIDE5KSkudHoodGltZXpvbmUsIHRydWUpLmZvcm1hdCgnaDptbSBhJyl9IHRvICR7ZGF5anMoZT8uZW5kRGF0ZT8uc2xpY2UoMCwgMTkpKS50eih0aW1lem9uZSwgdHJ1ZSkuZm9ybWF0KCdoOm1tIGEnKX06ICR7ZT8uc3VtbWFyeX0gJHtlPy5ub3Rlc31gXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgPy5yZWR1Y2UoKHByZXYsIGN1cnIpID0+IGAke3ByZXZ9LCAke2N1cnJ9YCwgJycpfVxuICAgICAgICBgO1xuICAgIGNvbnNvbGUubG9nKHVzZXJJbnB1dCwgJyB1c2VySW5wdXQnKTtcbiAgICBjb25zdCBxdWVyeURhdGVFbmdpbmUgPSBuZXcgVGVtcGxhdGVFbmdpbmUoZGFpbHlTY2hlZHVsZVRlbXBsYXRlKTtcbiAgICBjb25zdCBxdWVyeURhdGVSZW5kZXJlZCA9IHF1ZXJ5RGF0ZUVuZ2luZS5yZW5kZXIoe1xuICAgICAgdXNlckN1cnJlbnRUaW1lLFxuICAgICAgdXNlcldvcmtUaW1lczogdXNlcldvcmtUaW1lcyxcbiAgICAgIHVzZXJJbnB1dCxcbiAgICB9KTtcblxuICAgIGNvbnN0IHF1ZXJ5RGF0ZVVzZXJNZXNzYWdlSW5wdXQgPSB7XG4gICAgICByb2xlOiAndXNlcicgYXMgQ2hhdEdQVFJvbGVUeXBlLFxuICAgICAgY29udGVudDogcXVlcnlEYXRlUmVuZGVyZWQsXG4gICAgfTtcbiAgICBxdWVyeURhdGVNZXNzYWdlSGlzdG9yeS5wdXNoKFxuICAgICAgcXVlcnlEYXRlU3lzTWVzc2FnZSxcbiAgICAgIHF1ZXJ5RGF0ZVVzZXJNZXNzYWdlMSxcbiAgICAgIHF1ZXJ5RGF0ZUFzc2lzdGFudE1lc3NhZ2UxLFxuICAgICAgcXVlcnlEYXRlVXNlck1lc3NhZ2VJbnB1dFxuICAgICk7XG4gICAgLy8gZ2V0IHJlcyBmcm9tIG9wZW5haVxuICAgIGNvbnN0IG9wZW5BSVJlcyA9IGF3YWl0IGNhbGxPcGVuQUlXaXRoTWVzc2FnZUhpc3RvcnlPbmx5KFxuICAgICAgb3BlbmFpLFxuICAgICAgcXVlcnlEYXRlTWVzc2FnZUhpc3RvcnksXG4gICAgICBvcGVuQUlDaGF0R1BUMzVNb2RlbFxuICAgICk7XG5cbiAgICAvLyB2YWxpZGF0ZSBvcGVuYWkgcmVzXG4gICAgaWYgKCFvcGVuQUlSZXMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignbm8gb3BlbkFJUmVzIHByZXNlbnQgaW5zaWRlIGNyZWF0ZUFnZW5kYScpO1xuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKG9wZW5BSVJlcywgJyBvcGVuQUlSZXMnKTtcblxuICAgIC8vIGNyZWF0ZSBldmVudFxuXG4gICAgLy8gZm9ybWF0IHJlc3BvbnNlIGZvciBhbGwgZGF5XG4gICAgLypcbiAgICAgICAgICAgIGZvcm1hdCBpcyBKU09OIGFycmF5IFt7XCJzdGFydF90aW1lXCI6IFwiXCIsIFwiZW5kX3RpbWVcIjogXCJcIiwgXCJ0YXNrXCI6IFwiXCJ9XVxuICAgICAgICAqL1xuXG4gICAgY29uc3Qgc3RhcnRJbmRleCA9IG9wZW5BSVJlcz8uaW5kZXhPZignWycpO1xuICAgIGNvbnN0IGVuZEluZGV4ID0gb3BlbkFJUmVzPy5sYXN0SW5kZXhPZignXScpO1xuXG4gICAgY29uc3QgZmluYWxTdHJpbmcgPSBvcGVuQUlSZXMuc2xpY2Uoc3RhcnRJbmRleCwgZW5kSW5kZXggKyAxKTtcblxuICAgIGNvbnNvbGUubG9nKCdmaW5hbFN0cmluZzogJywgZmluYWxTdHJpbmcpO1xuXG4gICAgY29uc3QgcGFyc2VkVGV4dDogRGFpbHlTY2hlZHVsZU9iamVjdFR5cGVbXSA9IEpTT04ucGFyc2UoZmluYWxTdHJpbmcpO1xuXG4gICAgY29uc29sZS5sb2coJ3BhcnNlZFRleHQ6ICcsIHBhcnNlZFRleHQpO1xuXG4gICAgcmV0dXJuIHBhcnNlZFRleHQ7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBjb25zb2xlLmxvZyhlLCAnIHVuYWJsZSB0byBjcmVhdGUgZGFpbHkgc2NoZWR1bGUnKTtcbiAgfVxufTtcbiJdfQ==