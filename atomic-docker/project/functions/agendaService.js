import { Agenda } from 'agenda';
import axios from 'axios'; // Added for making HTTP calls
import { sendSlackMessage } from './atom-agent/skills/slackSkills';
import logger from './lib/logger';
// Default MongoDB connection string - replace with your actual URI in production
const mongoConnectionString = process.env.MONGODB_URI || 'mongodb://mongo:27017/atomicAgentJobs';
// URL for the agent's internal invocation endpoint
const AGENT_INTERNAL_INVOKE_URL = process.env.AGENT_INTERNAL_INVOKE_URL ||
    'http://localhost:3000/api/agent-handler';
// Initialize Agenda
export const agenda = new Agenda({
    db: { address: mongoConnectionString, collection: 'agentScheduledTasks' },
    processEvery: '1 minute', // How often Agenda checks for jobs
    maxConcurrency: 20, // Max number of jobs to run at once
});
export function defineJob(name, handler) {
    agenda.define(name, handler);
    logger.info(`Job defined: ${name}`);
}
export async function startAgenda() {
    try {
        logger.info('Attempting to start Agenda...');
        await agenda.start();
        logger.info('Agenda started successfully.');
        agenda.define('EXECUTE_AGENT_ACTION', async (job) => {
            const data = job.attrs.data;
            if (!data) {
                const errorMessage = `Job ${job.attrs.name} (ID: ${job.attrs._id}) is missing data.`;
                logger.error({
                    job_name: job.attrs.name,
                    job_id: job.attrs._id,
                    error_message: errorMessage,
                }, errorMessage);
                job.fail(errorMessage);
                await job.save();
                return;
            }
            const { originalUserIntent, entities, userId } = data;
            logger.info({
                job_name: job.attrs.name,
                job_id: job.attrs._id,
                user_id: userId,
                intent: originalUserIntent,
                entities: entities,
            }, `Executing scheduled agent action for user ${userId} (Job ID: ${job.attrs._id}): intent ${originalUserIntent}`);
            try {
                const agentPayload = {
                    message: `Execute scheduled task: ${originalUserIntent}`,
                    userId: userId,
                    intentName: originalUserIntent,
                    entities: entities,
                    conversationId: data.conversationId,
                    requestSource: 'ScheduledJobExecutor',
                };
                logger.info({
                    job_name: job.attrs.name,
                    job_id: job.attrs._id,
                    user_id: userId,
                    agent_url: AGENT_INTERNAL_INVOKE_URL,
                    payload: agentPayload,
                }, `Invoking agent at ${AGENT_INTERNAL_INVOKE_URL}`);
                const response = await axios.post(AGENT_INTERNAL_INVOKE_URL, agentPayload, {
                    headers: { 'Content-Type': 'application/json' },
                });
                logger.info({
                    job_name: job.attrs.name,
                    job_id: job.attrs._id,
                    user_id: userId,
                    agent_response_status: response.status,
                    agent_response_data: response.data,
                }, `Scheduled task ${job.attrs.name} (ID: ${job.attrs._id}) for user ${userId} processed by agent. Agent response status: ${response.status}`);
            }
            catch (error) {
                let errorMessage = 'Failed to execute agent action via HTTP.';
                if (axios.isAxiosError(error)) {
                    errorMessage = error.response
                        ? `Agent endpoint error: ${error.response.status} - ${JSON.stringify(error.response.data)}`
                        : `Agent endpoint error: ${error.message}`;
                }
                else if (error instanceof Error) {
                    errorMessage = error.message;
                }
                logger.error({
                    job_name: job.attrs.name,
                    job_id: job.attrs._id,
                    user_id: userId,
                    error_message: errorMessage,
                    error_stack: error instanceof Error ? error.stack : undefined,
                }, `Error executing scheduled task ${job.attrs.name} (ID: ${job.attrs._id}) for user ${userId}: ${errorMessage}`);
                job.fail(errorMessage);
                await job.save();
            }
        });
        agenda.define('send task reminder', async (job) => {
            const { userId, taskId, taskDescription } = job.attrs.data;
            console.log(`Sending reminder for task "${taskDescription}" (ID: ${taskId}) to user ${userId}`);
            try {
                await sendSlackMessage(userId, userId, `Reminder: Task "${taskDescription}" is due.`);
            }
            catch (error) {
                console.error(`Failed to send task reminder for task ${taskId} to user ${userId}:`, error);
            }
        });
    }
    catch (error) {
        logger.error({
            error_message: error instanceof Error ? error.message : 'Unknown error',
            error_stack: error instanceof Error ? error.stack : undefined,
        }, 'Failed to start Agenda:');
    }
}
export async function stopAgenda() {
    try {
        logger.info('Attempting to stop Agenda...');
        await agenda.stop();
        logger.info('Agenda stopped successfully.');
    }
    catch (error) {
        logger.error({
            error_message: error instanceof Error ? error.message : 'Unknown error',
            error_stack: error instanceof Error ? error.stack : undefined,
        }, 'Failed to stop Agenda gracefully:');
    }
}
agenda.on('ready', () => logger.info('Agenda ready and connected to MongoDB.'));
agenda.on('error', (err) => logger.error({
    error_message: err.message,
    error_stack: err.stack,
}, 'Agenda connection error:'));
agenda.on('start', (job) => logger.info({ job_name: job.attrs.name, job_id: job.attrs._id }, `Job ${job.attrs.name} starting.`));
agenda.on('complete', (job) => logger.info({ job_name: job.attrs.name, job_id: job.attrs._id }, `Job ${job.attrs.name} completed.`));
agenda.on('success', (job) => logger.info({ job_name: job.attrs.name, job_id: job.attrs._id }, `Job ${job.attrs.name} succeeded.`));
agenda.on('fail', (err, job) => logger.error({
    job_name: job.attrs.name,
    job_id: job.attrs._id,
    error_message: err.message,
    error_stack: err.stack,
}, `Job ${job.attrs.name} failed with error: ${err.message}.`));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWdlbmRhU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFnZW5kYVNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBTyxNQUFNLFFBQVEsQ0FBQztBQUNyQyxPQUFPLEtBQUssTUFBTSxPQUFPLENBQUMsQ0FBQyw4QkFBOEI7QUFDekQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDbkUsT0FBTyxNQUFNLE1BQU0sY0FBYyxDQUFDO0FBaUJsQyxpRkFBaUY7QUFDakYsTUFBTSxxQkFBcUIsR0FDekIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLElBQUksdUNBQXVDLENBQUM7QUFFckUsbURBQW1EO0FBQ25ELE1BQU0seUJBQXlCLEdBQzdCLE9BQU8sQ0FBQyxHQUFHLENBQUMseUJBQXlCO0lBQ3JDLHlDQUF5QyxDQUFDO0FBRTVDLG9CQUFvQjtBQUNwQixNQUFNLENBQUMsTUFBTSxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUM7SUFDL0IsRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLFVBQVUsRUFBRSxxQkFBcUIsRUFBRTtJQUN6RSxZQUFZLEVBQUUsVUFBVSxFQUFFLG1DQUFtQztJQUM3RCxjQUFjLEVBQUUsRUFBRSxFQUFFLG9DQUFvQztDQUN6RCxDQUFDLENBQUM7QUFFSCxNQUFNLFVBQVUsU0FBUyxDQUN2QixJQUFZLEVBQ1osT0FBdUM7SUFFdkMsTUFBTSxDQUFDLE1BQU0sQ0FBSSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDaEMsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxFQUFFLENBQUMsQ0FBQztBQUN0QyxDQUFDO0FBRUQsTUFBTSxDQUFDLEtBQUssVUFBVSxXQUFXO0lBQy9CLElBQUksQ0FBQztRQUNILE1BQU0sQ0FBQyxJQUFJLENBQUMsK0JBQStCLENBQUMsQ0FBQztRQUM3QyxNQUFNLE1BQU0sQ0FB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QUMsU0FBUyxFQUFFLENBQUMsR0FBUSxFQUFFLEVBQUUsQ0FDaEMsTUFBTSxDQUFDLElBQUksQ0FDVCxFQUFFLFFBQVEsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsRUFDbkQsT0FBTyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksYUFBYSxDQUNuQyxDQUNGLENBQUM7QUFDRixNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQVUsRUFBRSxHQUFRLEVBQUUsRUFBRSxDQUN6QyxNQUFNLENBQUMsS0FBSyxDQUNWO0lBQ0UsUUFBUSxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSTtJQUN4QixNQUFNLEVBQUUsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHO0lBQ3JCLGFBQWEsRUFBRSxHQUFHLENBQUMsT0FBTztJQUMxQixXQUFXLEVBQUUsR0FBRyxDQUFDLEtBQUs7Q0FDdkIsRUFDRCxPQUFPLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSx1QkFBdUIsR0FBRyxDQUFDLE9BQU8sR0FBRyxDQUMzRCxDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZ2VuZGEsIEpvYiB9IGZyb20gJ2FnZW5kYSc7XG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnOyAvLyBBZGRlZCBmb3IgbWFraW5nIEhUVFAgY2FsbHNcbmltcG9ydCB7IHNlbmRTbGFja01lc3NhZ2UgfSBmcm9tICcuL2F0b20tYWdlbnQvc2tpbGxzL3NsYWNrU2tpbGxzJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9saWIvbG9nZ2VyJztcblxuLy8gRGVmaW5lIHRoZSBzdHJ1Y3R1cmUgZm9yIGpvYiBkYXRhXG5leHBvcnQgaW50ZXJmYWNlIFNjaGVkdWxlZEFnZW50VGFza0RhdGEge1xuICBvcmlnaW5hbFVzZXJJbnRlbnQ6IHN0cmluZzsgLy8gZS5nLiwgXCJDUkVBVEVfVEFTS1wiLCBcIlNFTkRfRU1BSUxcIlxuICBlbnRpdGllczogUmVjb3JkPHN0cmluZywgYW55PjsgLy8gU3RvcmUgZXh0cmFjdGVkIE5MVSBlbnRpdGllc1xuICB1c2VySWQ6IHN0cmluZztcbiAgY29udmVyc2F0aW9uSWQ/OiBzdHJpbmc7IC8vIE9wdGlvbmFsOiBpZiBuZWVkZWQgdG8gbWFpbnRhaW4gY29udGV4dFxuICAvLyBhZGRpdGlvbmFsQ29udGV4dD86IFJlY29yZDxzdHJpbmcsIGFueT47IC8vIEZvciBhbnkgb3RoZXIgbmVjZXNzYXJ5IGRhdGFcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTZW5kVGFza1JlbWluZGVyRGF0YSB7XG4gIHVzZXJJZDogc3RyaW5nO1xuICB0YXNrSWQ6IHN0cmluZztcbiAgdGFza0Rlc2NyaXB0aW9uOiBzdHJpbmc7XG59XG5cbi8vIERlZmF1bHQgTW9uZ29EQiBjb25uZWN0aW9uIHN0cmluZyAtIHJlcGxhY2Ugd2l0aCB5b3VyIGFjdHVhbCBVUkkgaW4gcHJvZHVjdGlvblxuY29uc3QgbW9uZ29Db25uZWN0aW9uU3RyaW5nID1cbiAgcHJvY2Vzcy5lbnYuTU9OR09EQl9VUkkgfHwgJ21vbmdvZGI6Ly9tb25nbzoyNzAxNy9hdG9taWNBZ2VudEpvYnMnO1xuXG4vLyBVUkwgZm9yIHRoZSBhZ2VudCdzIGludGVybmFsIGludm9jYXRpb24gZW5kcG9pbnRcbmNvbnN0IEFHRU5UX0lOVEVSTkFMX0lOVk9LRV9VUkwgPVxuICBwcm9jZXNzLmVudi5BR0VOVF9JTlRFUk5BTF9JTlZPS0VfVVJMIHx8XG4gICdodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL2FnZW50LWhhbmRsZXInO1xuXG4vLyBJbml0aWFsaXplIEFnZW5kYVxuZXhwb3J0IGNvbnN0IGFnZW5kYSA9IG5ldyBBZ2VuZGEoe1xuICBkYjogeyBhZGRyZXNzOiBtb25nb0Nvbm5lY3Rpb25TdHJpbmcsIGNvbGxlY3Rpb246ICdhZ2VudFNjaGVkdWxlZFRhc2tzJyB9LFxuICBwcm9jZXNzRXZlcnk6ICcxIG1pbnV0ZScsIC8vIEhvdyBvZnRlbiBBZ2VuZGEgY2hlY2tzIGZvciBqb2JzXG4gIG1heENvbmN1cnJlbmN5OiAyMCwgLy8gTWF4IG51bWJlciBvZiBqb2JzIHRvIHJ1biBhdCBvbmNlXG59KTtcblxuZXhwb3J0IGZ1bmN0aW9uIGRlZmluZUpvYjxUPihcbiAgbmFtZTogc3RyaW5nLFxuICBoYW5kbGVyOiAoam9iOiBKb2I8VD4pID0+IFByb21pc2U8dm9pZD5cbik6IHZvaWQge1xuICBhZ2VuZGEuZGVmaW5lPFQ+KG5hbWUsIGhhbmRsZXIpO1xuICBsb2dnZXIuaW5mbyhgSm9iIGRlZmluZWQ6ICR7bmFtZX1gKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHN0YXJ0QWdlbmRhKCk6IFByb21pc2U8dm9pZD4ge1xuICB0cnkge1xuICAgIGxvZ2dlci5pbmZvKCdBdHRlbXB0aW5nIHRvIHN0YXJ0IEFnZW5kYS4uLicpO1xuICAgIGF3YWl0IGFnZW5kYS5zdGFydCgpO1xuICAgIGxvZ2dlci5pbmZvKCdBZ2VuZGEgc3RhcnRlZCBzdWNjZXNzZnVsbHkuJyk7XG5cbiAgICBhZ2VuZGEuZGVmaW5lPFNjaGVkdWxlZEFnZW50VGFza0RhdGE+KFxuICAgICAgJ0VYRUNVVEVfQUdFTlRfQUNUSU9OJyxcbiAgICAgIGFzeW5jIChqb2IpID0+IHtcbiAgICAgICAgY29uc3QgZGF0YSA9IGpvYi5hdHRycy5kYXRhO1xuICAgICAgICBpZiAoIWRhdGEpIHtcbiAgICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBgSm9iICR7am9iLmF0dHJzLm5hbWV9IChJRDogJHtqb2IuYXR0cnMuX2lkfSkgaXMgbWlzc2luZyBkYXRhLmA7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBqb2JfbmFtZTogam9iLmF0dHJzLm5hbWUsXG4gICAgICAgICAgICAgIGpvYl9pZDogam9iLmF0dHJzLl9pZCxcbiAgICAgICAgICAgICAgZXJyb3JfbWVzc2FnZTogZXJyb3JNZXNzYWdlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yTWVzc2FnZVxuICAgICAgICAgICk7XG4gICAgICAgICAgam9iLmZhaWwoZXJyb3JNZXNzYWdlKTtcbiAgICAgICAgICBhd2FpdCBqb2Iuc2F2ZSgpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHsgb3JpZ2luYWxVc2VySW50ZW50LCBlbnRpdGllcywgdXNlcklkIH0gPSBkYXRhO1xuICAgICAgICBsb2dnZXIuaW5mbyhcbiAgICAgICAgICB7XG4gICAgICAgICAgICBqb2JfbmFtZTogam9iLmF0dHJzLm5hbWUsXG4gICAgICAgICAgICBqb2JfaWQ6IGpvYi5hdHRycy5faWQsXG4gICAgICAgICAgICB1c2VyX2lkOiB1c2VySWQsXG4gICAgICAgICAgICBpbnRlbnQ6IG9yaWdpbmFsVXNlckludGVudCxcbiAgICAgICAgICAgIGVudGl0aWVzOiBlbnRpdGllcyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGBFeGVjdXRpbmcgc2NoZWR1bGVkIGFnZW50IGFjdGlvbiBmb3IgdXNlciAke3VzZXJJZH0gKEpvYiBJRDogJHtqb2IuYXR0cnMuX2lkfSk6IGludGVudCAke29yaWdpbmFsVXNlckludGVudH1gXG4gICAgICAgICk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCBhZ2VudFBheWxvYWQgPSB7XG4gICAgICAgICAgICBtZXNzYWdlOiBgRXhlY3V0ZSBzY2hlZHVsZWQgdGFzazogJHtvcmlnaW5hbFVzZXJJbnRlbnR9YCxcbiAgICAgICAgICAgIHVzZXJJZDogdXNlcklkLFxuICAgICAgICAgICAgaW50ZW50TmFtZTogb3JpZ2luYWxVc2VySW50ZW50LFxuICAgICAgICAgICAgZW50aXRpZXM6IGVudGl0aWVzLFxuICAgICAgICAgICAgY29udmVyc2F0aW9uSWQ6IGRhdGEuY29udmVyc2F0aW9uSWQsXG4gICAgICAgICAgICByZXF1ZXN0U291cmNlOiAnU2NoZWR1bGVkSm9iRXhlY3V0b3InLFxuICAgICAgICAgIH07XG4gICAgICAgICAgbG9nZ2VyLmluZm8oXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGpvYl9uYW1lOiBqb2IuYXR0cnMubmFtZSxcbiAgICAgICAgICAgICAgam9iX2lkOiBqb2IuYXR0cnMuX2lkLFxuICAgICAgICAgICAgICB1c2VyX2lkOiB1c2VySWQsXG4gICAgICAgICAgICAgIGFnZW50X3VybDogQUdFTlRfSU5URVJOQUxfSU5WT0tFX1VSTCxcbiAgICAgICAgICAgICAgcGF5bG9hZDogYWdlbnRQYXlsb2FkLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGBJbnZva2luZyBhZ2VudCBhdCAke0FHRU5UX0lOVEVSTkFMX0lOVk9LRV9VUkx9YFxuICAgICAgICAgICk7XG5cbiAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGF4aW9zLnBvc3QoXG4gICAgICAgICAgICBBR0VOVF9JTlRFUk5BTF9JTlZPS0VfVVJMLFxuICAgICAgICAgICAgYWdlbnRQYXlsb2FkLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBoZWFkZXJzOiB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICApO1xuXG4gICAgICAgICAgbG9nZ2VyLmluZm8oXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGpvYl9uYW1lOiBqb2IuYXR0cnMubmFtZSxcbiAgICAgICAgICAgICAgam9iX2lkOiBqb2IuYXR0cnMuX2lkLFxuICAgICAgICAgICAgICB1c2VyX2lkOiB1c2VySWQsXG4gICAgICAgICAgICAgIGFnZW50X3Jlc3BvbnNlX3N0YXR1czogcmVzcG9uc2Uuc3RhdHVzLFxuICAgICAgICAgICAgICBhZ2VudF9yZXNwb25zZV9kYXRhOiByZXNwb25zZS5kYXRhLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGBTY2hlZHVsZWQgdGFzayAke2pvYi5hdHRycy5uYW1lfSAoSUQ6ICR7am9iLmF0dHJzLl9pZH0pIGZvciB1c2VyICR7dXNlcklkfSBwcm9jZXNzZWQgYnkgYWdlbnQuIEFnZW50IHJlc3BvbnNlIHN0YXR1czogJHtyZXNwb25zZS5zdGF0dXN9YFxuICAgICAgICAgICk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgbGV0IGVycm9yTWVzc2FnZSA9ICdGYWlsZWQgdG8gZXhlY3V0ZSBhZ2VudCBhY3Rpb24gdmlhIEhUVFAuJztcbiAgICAgICAgICBpZiAoYXhpb3MuaXNBeGlvc0Vycm9yKGVycm9yKSkge1xuICAgICAgICAgICAgZXJyb3JNZXNzYWdlID0gZXJyb3IucmVzcG9uc2VcbiAgICAgICAgICAgICAgPyBgQWdlbnQgZW5kcG9pbnQgZXJyb3I6ICR7ZXJyb3IucmVzcG9uc2Uuc3RhdHVzfSAtICR7SlNPTi5zdHJpbmdpZnkoZXJyb3IucmVzcG9uc2UuZGF0YSl9YFxuICAgICAgICAgICAgICA6IGBBZ2VudCBlbmRwb2ludCBlcnJvcjogJHtlcnJvci5tZXNzYWdlfWA7XG4gICAgICAgICAgfSBlbHNlIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICAgICAgICBlcnJvck1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBsb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGpvYl9uYW1lOiBqb2IuYXR0cnMubmFtZSxcbiAgICAgICAgICAgICAgam9iX2lkOiBqb2IuYXR0cnMuX2lkLFxuICAgICAgICAgICAgICB1c2VyX2lkOiB1c2VySWQsXG4gICAgICAgICAgICAgIGVycm9yX21lc3NhZ2U6IGVycm9yTWVzc2FnZSxcbiAgICAgICAgICAgICAgZXJyb3Jfc3RhY2s6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5zdGFjayA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBgRXJyb3IgZXhlY3V0aW5nIHNjaGVkdWxlZCB0YXNrICR7am9iLmF0dHJzLm5hbWV9IChJRDogJHtqb2IuYXR0cnMuX2lkfSkgZm9yIHVzZXIgJHt1c2VySWR9OiAke2Vycm9yTWVzc2FnZX1gXG4gICAgICAgICAgKTtcbiAgICAgICAgICBqb2IuZmFpbChlcnJvck1lc3NhZ2UpO1xuICAgICAgICAgIGF3YWl0IGpvYi5zYXZlKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICApO1xuXG4gICAgYWdlbmRhLmRlZmluZTxTZW5kVGFza1JlbWluZGVyRGF0YT4oJ3NlbmQgdGFzayByZW1pbmRlcicsIGFzeW5jIChqb2IpID0+IHtcbiAgICAgIGNvbnN0IHsgdXNlcklkLCB0YXNrSWQsIHRhc2tEZXNjcmlwdGlvbiB9ID0gam9iLmF0dHJzLmRhdGE7XG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgYFNlbmRpbmcgcmVtaW5kZXIgZm9yIHRhc2sgXCIke3Rhc2tEZXNjcmlwdGlvbn1cIiAoSUQ6ICR7dGFza0lkfSkgdG8gdXNlciAke3VzZXJJZH1gXG4gICAgICApO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgc2VuZFNsYWNrTWVzc2FnZShcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIGBSZW1pbmRlcjogVGFzayBcIiR7dGFza0Rlc2NyaXB0aW9ufVwiIGlzIGR1ZS5gXG4gICAgICAgICk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICAgIGBGYWlsZWQgdG8gc2VuZCB0YXNrIHJlbWluZGVyIGZvciB0YXNrICR7dGFza0lkfSB0byB1c2VyICR7dXNlcklkfTpgLFxuICAgICAgICAgIGVycm9yXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKFxuICAgICAge1xuICAgICAgICBlcnJvcl9tZXNzYWdlOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgICAgZXJyb3Jfc3RhY2s6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5zdGFjayA6IHVuZGVmaW5lZCxcbiAgICAgIH0sXG4gICAgICAnRmFpbGVkIHRvIHN0YXJ0IEFnZW5kYTonXG4gICAgKTtcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc3RvcEFnZW5kYSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgdHJ5IHtcbiAgICBsb2dnZXIuaW5mbygnQXR0ZW1wdGluZyB0byBzdG9wIEFnZW5kYS4uLicpO1xuICAgIGF3YWl0IGFnZW5kYS5zdG9wKCk7XG4gICAgbG9nZ2VyLmluZm8oJ0FnZW5kYSBzdG9wcGVkIHN1Y2Nlc3NmdWxseS4nKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoXG4gICAgICB7XG4gICAgICAgIGVycm9yX21lc3NhZ2U6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgICAgICBlcnJvcl9zdGFjazogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLnN0YWNrIDogdW5kZWZpbmVkLFxuICAgICAgfSxcbiAgICAgICdGYWlsZWQgdG8gc3RvcCBBZ2VuZGEgZ3JhY2VmdWxseTonXG4gICAgKTtcbiAgfVxufVxuXG5hZ2VuZGEub24oJ3JlYWR5JywgKCkgPT4gbG9nZ2VyLmluZm8oJ0FnZW5kYSByZWFkeSBhbmQgY29ubmVjdGVkIHRvIE1vbmdvREIuJykpO1xuYWdlbmRhLm9uKCdlcnJvcicsIChlcnI6IEVycm9yKSA9PlxuICBsb2dnZXIuZXJyb3IoXG4gICAge1xuICAgICAgZXJyb3JfbWVzc2FnZTogZXJyLm1lc3NhZ2UsXG4gICAgICBlcnJvcl9zdGFjazogZXJyLnN0YWNrLFxuICAgIH0sXG4gICAgJ0FnZW5kYSBjb25uZWN0aW9uIGVycm9yOidcbiAgKVxuKTtcbmFnZW5kYS5vbignc3RhcnQnLCAoam9iOiBKb2IpID0+XG4gIGxvZ2dlci5pbmZvKFxuICAgIHsgam9iX25hbWU6IGpvYi5hdHRycy5uYW1lLCBqb2JfaWQ6IGpvYi5hdHRycy5faWQgfSxcbiAgICBgSm9iICR7am9iLmF0dHJzLm5hbWV9IHN0YXJ0aW5nLmBcbiAgKVxuKTtcbmFnZW5kYS5vbignY29tcGxldGUnLCAoam9iOiBKb2IpID0+XG4gIGxvZ2dlci5pbmZvKFxuICAgIHsgam9iX25hbWU6IGpvYi5hdHRycy5uYW1lLCBqb2JfaWQ6IGpvYi5hdHRycy5faWQgfSxcbiAgICBgSm9iICR7am9iLmF0dHJzLm5hbWV9IGNvbXBsZXRlZC5gXG4gIClcbik7XG5hZ2VuZGEub24oJ3N1Y2Nlc3MnLCAoam9iOiBKb2IpID0+XG4gIGxvZ2dlci5pbmZvKFxuICAgIHsgam9iX25hbWU6IGpvYi5hdHRycy5uYW1lLCBqb2JfaWQ6IGpvYi5hdHRycy5faWQgfSxcbiAgICBgSm9iICR7am9iLmF0dHJzLm5hbWV9IHN1Y2NlZWRlZC5gXG4gIClcbik7XG5hZ2VuZGEub24oJ2ZhaWwnLCAoZXJyOiBFcnJvciwgam9iOiBKb2IpID0+XG4gIGxvZ2dlci5lcnJvcihcbiAgICB7XG4gICAgICBqb2JfbmFtZTogam9iLmF0dHJzLm5hbWUsXG4gICAgICBqb2JfaWQ6IGpvYi5hdHRycy5faWQsXG4gICAgICBlcnJvcl9tZXNzYWdlOiBlcnIubWVzc2FnZSxcbiAgICAgIGVycm9yX3N0YWNrOiBlcnIuc3RhY2ssXG4gICAgfSxcbiAgICBgSm9iICR7am9iLmF0dHJzLm5hbWV9IGZhaWxlZCB3aXRoIGVycm9yOiAke2Vyci5tZXNzYWdlfS5gXG4gIClcbik7XG4iXX0=