import { Kafka, logLevel } from 'kafkajs';
import ip from 'ip';
import { kafkaFeaturesApplyTopic, } from '../_libs/constants';
import _ from 'lodash';
const kafka = new Kafka({
    logLevel: logLevel.ERROR, // Changed to ERROR
    brokers: [`kafka1:29092`], // Consider making brokers configurable
    clientId: `atomic-features-apply-auth-publisher-${ip.address()}`, // More specific client ID
    sasl: {
        mechanism: 'plain',
        username: process.env.KAFKA_USERNAME,
        password: process.env.KAFKA_PASSWORD,
    },
});
const publisher = async (req, res) => {
    // Validate request body
    if (!req.body || _.isEmpty(req.body)) {
        return res.status(400).json({
            ok: false,
            error: {
                code: 'VALIDATION_ERROR',
                message: 'Request body cannot be empty.',
            },
        });
    }
    // Additional validation for specific fields if this endpoint expects a certain structure
    // For example, if it's for Hasura Event Triggers, check for event.data.new or event.data.old
    if (!req.body.event ||
        !req.body.event.data ||
        (!req.body.event.data.new && !req.body.event.data.old)) {
        return res.status(400).json({
            ok: false,
            error: {
                code: 'VALIDATION_ERROR',
                message: 'Invalid Hasura event trigger payload structure.',
            },
        });
    }
    const producer = kafka.producer({ maxInFlightRequests: 1, idempotent: true });
    let transaction;
    try {
        await producer.connect();
        transaction = await producer.transaction();
        const eventItem = req.body;
        const response = await transaction.send({
            topic: kafkaFeaturesApplyTopic,
            messages: [{ value: JSON.stringify(eventItem) }],
        });
        // Simplified: Removed complex offset management from publisher side
        await transaction.commit();
        const messageId = response?.[0]?.baseOffset || 'N/A';
        console.log(`Message successfully added to queue topic ${kafkaFeaturesApplyTopic} by auth-publisher. Message ID/Offset: ${messageId}`);
        return res.status(202).json({
            ok: true,
            data: {
                message: 'Successfully published message to features worker queue (auth).',
                messageId: messageId.toString(),
            },
        });
    }
    catch (e) {
        console.error('Failed to publish message to Kafka (auth-publisher):', e);
        if (transaction) {
            try {
                await transaction.abort();
            }
            catch (abortError) {
                console.error('Failed to abort Kafka transaction (auth-publisher):', abortError);
            }
        }
        return res.status(500).json({
            ok: false,
            error: {
                code: 'KAFKA_PUBLISH_ERROR',
                message: e.message ||
                    'An error occurred while publishing the message to Kafka.',
                details: e.toString(),
            },
        });
    }
    finally {
        if (producer) {
            try {
                await producer.disconnect();
            }
            catch (disconnectError) {
                console.error('Failed to disconnect Kafka producer (auth-publisher):', disconnectError);
            }
        }
    }
};
export default publisher;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmVhdHVyZXMtd29ya2VyLXRvLXF1ZXVlLWF1dGguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJmZWF0dXJlcy13b3JrZXItdG8tcXVldWUtYXV0aC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUMxQyxPQUFPLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDcEIsT0FBTyxFQUVMLHVCQUF1QixHQUN4QixNQUFNLG9CQUFvQixDQUFDO0FBQzVCLE9BQU8sQ0FBQyxNQUFNLFFBQVEsQ0FBQztBQVF2QixNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQztJQUN0QixRQUFRLEVBQUUsUUFBUSxDQUFDLEtBQUssRUFBRSxtQkFBbUI7SUFDN0MsT0FBTyxFQUFFLENBQUMsY0FBYyxDQUFDLEVBQUUsdUNBQXVDO0lBQ2xFLFFBQVEsRUFBRSx3Q0FBd0MsRUFBRSxDQUFDLE9BQU8sRUFBRSxFQUFFLEVBQUUsMEJBQTBCO0lBQzVGLElBQUksRUFBRTtRQUNKLFNBQVMsRUFBRSxPQUFPO1FBQ2xCLFFBQVEsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWM7UUFDcEMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYztLQUNyQztDQUNGLENBQUMsQ0FBQztBQUVILE1BQU0sU0FBUyxHQUFHLEtBQUssRUFDckIsR0FBWSxFQUNaLEdBQW9ELEVBQ3BELEVBQUU7SUFDRix3QkFBd0I7SUFDeEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztRQUNyQyxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLEVBQUUsRUFBRSxLQUFLO1lBQ1QsS0FBSyxFQUFFO2dCQUNMLElBQUksRUFBRSxrQkFBa0I7Z0JBQ3hCLE9B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QUFRLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDOUIsQ0FBQztZQUFDLE9BQU8sZUFBb0IsRUFBRSxDQUFDO2dCQUM5QixPQUFPLENBQUMsS0FBSyxDQUNYLHVEQUF1RCxFQUN2RCxlQUFlLENBQ2hCLENBQUM7WUFDSixDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7QUFDSCxDQUFDLENBQUM7QUFFRixlQUFlLFNBQVMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBLYWZrYSwgbG9nTGV2ZWwgfSBmcm9tICdrYWZrYWpzJztcbmltcG9ydCBpcCBmcm9tICdpcCc7XG5pbXBvcnQge1xuICBrYWZrYUZlYXR1cmVzQXBwbHlHcm91cElkLFxuICBrYWZrYUZlYXR1cmVzQXBwbHlUb3BpYyxcbn0gZnJvbSAnLi4vX2xpYnMvY29uc3RhbnRzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBGZWF0dXJlc0FwcGx5UmVzcG9uc2UsIFNraWxsRXJyb3IgfSBmcm9tICcuLi9fbGlicy90eXBlcyc7IC8vIEltcG9ydCBzdGFuZGFyZGl6ZWQgdHlwZXNcblxuaW50ZXJmYWNlIFN1Y2Nlc3NQYXlsb2FkIHtcbiAgbWVzc2FnZTogc3RyaW5nO1xuICBtZXNzYWdlSWQ/OiBzdHJpbmc7XG59XG5cbmNvbnN0IGthZmthID0gbmV3IEthZmthKHtcbiAgbG9nTGV2ZWw6IGxvZ0xldmVsLkVSUk9SLCAvLyBDaGFuZ2VkIHRvIEVSUk9SXG4gIGJyb2tlcnM6IFtga2Fma2ExOjI5MDkyYF0sIC8vIENvbnNpZGVyIG1ha2luZyBicm9rZXJzIGNvbmZpZ3VyYWJsZVxuICBjbGllbnRJZDogYGF0b21pYy1mZWF0dXJlcy1hcHBseS1hdXRoLXB1Ymxpc2hlci0ke2lwLmFkZHJlc3MoKX1gLCAvLyBNb3JlIHNwZWNpZmljIGNsaWVudCBJRFxuICBzYXNsOiB7XG4gICAgbWVjaGFuaXNtOiAncGxhaW4nLFxuICAgIHVzZXJuYW1lOiBwcm9jZXNzLmVudi5LQUZLQV9VU0VSTkFNRSxcbiAgICBwYXNzd29yZDogcHJvY2Vzcy5lbnYuS0FGS0FfUEFTU1dPUkQsXG4gIH0sXG59KTtcblxuY29uc3QgcHVibGlzaGVyID0gYXN5bmMgKFxuICByZXE6IFJlcXVlc3QsXG4gIHJlczogUmVzcG9uc2U8RmVhdHVyZXNBcHBseVJlc3BvbnNlPFN1Y2Nlc3NQYXlsb2FkPj5cbikgPT4ge1xuICAvLyBWYWxpZGF0ZSByZXF1ZXN0IGJvZHlcbiAgaWYgKCFyZXEuYm9keSB8fCBfLmlzRW1wdHkocmVxLmJvZHkpKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgIG9rOiBmYWxzZSxcbiAgICAgIGVycm9yOiB7XG4gICAgICAgIGNvZGU6ICdWQUxJREFUSU9OX0VSUk9SJyxcbiAgICAgICAgbWVzc2FnZTogJ1JlcXVlc3QgYm9keSBjYW5ub3QgYmUgZW1wdHkuJyxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cbiAgLy8gQWRkaXRpb25hbCB2YWxpZGF0aW9uIGZvciBzcGVjaWZpYyBmaWVsZHMgaWYgdGhpcyBlbmRwb2ludCBleHBlY3RzIGEgY2VydGFpbiBzdHJ1Y3R1cmVcbiAgLy8gRm9yIGV4YW1wbGUsIGlmIGl0J3MgZm9yIEhhc3VyYSBFdmVudCBUcmlnZ2VycywgY2hlY2sgZm9yIGV2ZW50LmRhdGEubmV3IG9yIGV2ZW50LmRhdGEub2xkXG4gIGlmIChcbiAgICAhcmVxLmJvZHkuZXZlbnQgfHxcbiAgICAhcmVxLmJvZHkuZXZlbnQuZGF0YSB8fFxuICAgICghcmVxLmJvZHkuZXZlbnQuZGF0YS5uZXcgJiYgIXJlcS5ib2R5LmV2ZW50LmRhdGEub2xkKVxuICApIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgb2s6IGZhbHNlLFxuICAgICAgZXJyb3I6IHtcbiAgICAgICAgY29kZTogJ1ZBTElEQVRJT05fRVJST1InLFxuICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBIYXN1cmEgZXZlbnQgdHJpZ2dlciBwYXlsb2FkIHN0cnVjdHVyZS4nLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IHByb2R1Y2VyID0ga2Fma2EucHJvZHVjZXIoeyBtYXhJbkZsaWdodFJlcXVlc3RzOiAxLCBpZGVtcG90ZW50OiB0cnVlIH0pO1xuICBsZXQgdHJhbnNhY3Rpb247XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCBwcm9kdWNlci5jb25uZWN0KCk7XG4gICAgdHJhbnNhY3Rpb24gPSBhd2FpdCBwcm9kdWNlci50cmFuc2FjdGlvbigpO1xuXG4gICAgY29uc3QgZXZlbnRJdGVtID0gcmVxLmJvZHk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRyYW5zYWN0aW9uLnNlbmQoe1xuICAgICAgdG9waWM6IGthZmthRmVhdHVyZXNBcHBseVRvcGljLFxuICAgICAgbWVzc2FnZXM6IFt7IHZhbHVlOiBKU09OLnN0cmluZ2lmeShldmVudEl0ZW0pIH1dLFxuICAgIH0pO1xuXG4gICAgLy8gU2ltcGxpZmllZDogUmVtb3ZlZCBjb21wbGV4IG9mZnNldCBtYW5hZ2VtZW50IGZyb20gcHVibGlzaGVyIHNpZGVcbiAgICBhd2FpdCB0cmFuc2FjdGlvbi5jb21taXQoKTtcblxuICAgIGNvbnN0IG1lc3NhZ2VJZCA9IHJlc3BvbnNlPy5bMF0/LmJhc2VPZmZzZXQgfHwgJ04vQSc7XG4gICAgY29uc29sZS5sb2coXG4gICAgICBgTWVzc2FnZSBzdWNjZXNzZnVsbHkgYWRkZWQgdG8gcXVldWUgdG9waWMgJHtrYWZrYUZlYXR1cmVzQXBwbHlUb3BpY30gYnkgYXV0aC1wdWJsaXNoZXIuIE1lc3NhZ2UgSUQvT2Zmc2V0OiAke21lc3NhZ2VJZH1gXG4gICAgKTtcblxuICAgIHJldHVybiByZXMuc3RhdHVzKDIwMikuanNvbih7XG4gICAgICBvazogdHJ1ZSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAnU3VjY2Vzc2Z1bGx5IHB1Ymxpc2hlZCBtZXNzYWdlIHRvIGZlYXR1cmVzIHdvcmtlciBxdWV1ZSAoYXV0aCkuJyxcbiAgICAgICAgbWVzc2FnZUlkOiBtZXNzYWdlSWQudG9TdHJpbmcoKSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGU6IGFueSkge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBwdWJsaXNoIG1lc3NhZ2UgdG8gS2Fma2EgKGF1dGgtcHVibGlzaGVyKTonLCBlKTtcbiAgICBpZiAodHJhbnNhY3Rpb24pIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRyYW5zYWN0aW9uLmFib3J0KCk7XG4gICAgICB9IGNhdGNoIChhYm9ydEVycm9yOiBhbnkpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgICAnRmFpbGVkIHRvIGFib3J0IEthZmthIHRyYW5zYWN0aW9uIChhdXRoLXB1Ymxpc2hlcik6JyxcbiAgICAgICAgICBhYm9ydEVycm9yXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBvazogZmFsc2UsXG4gICAgICBlcnJvcjoge1xuICAgICAgICBjb2RlOiAnS0FGS0FfUFVCTElTSF9FUlJPUicsXG4gICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgZS5tZXNzYWdlIHx8XG4gICAgICAgICAgJ0FuIGVycm9yIG9jY3VycmVkIHdoaWxlIHB1Ymxpc2hpbmcgdGhlIG1lc3NhZ2UgdG8gS2Fma2EuJyxcbiAgICAgICAgZGV0YWlsczogZS50b1N0cmluZygpLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSBmaW5hbGx5IHtcbiAgICBpZiAocHJvZHVjZXIpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHByb2R1Y2VyLmRpc2Nvbm5lY3QoKTtcbiAgICAgIH0gY2F0Y2ggKGRpc2Nvbm5lY3RFcnJvcjogYW55KSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICAgJ0ZhaWxlZCB0byBkaXNjb25uZWN0IEthZmthIHByb2R1Y2VyIChhdXRoLXB1Ymxpc2hlcik6JyxcbiAgICAgICAgICBkaXNjb25uZWN0RXJyb3JcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IHB1Ymxpc2hlcjtcbiJdfQ==