import expressWinston from 'express-winston';
import winston from 'winston';
import { ENV } from '@utils/env';
export const LOG_LEVEL = process.env.AUTH_LOG_LEVEL || 'info';
// * Create a common Winston logger that can be used in both middlewares and manually
export const logger = winston.createLogger({
    transports: [new winston.transports.Console({ level: LOG_LEVEL })],
    format: winston.format.combine(winston.format.json()),
});
// * Give more importance to Unauthorized and Forbidden status codes to give more visibility to hacking attempts
const SUSPICIOUS_REQUEST_CODES = [401, 403];
const maskUrl = (url) => {
    if (ENV.AUTH_SHOW_LOG_QUERY_PARAMS ||
        LOG_LEVEL === 'debug' ||
        (!url.includes('?') && !url.includes('#'))) {
        return url;
    }
    const { pathname, searchParams, hash } = new URL(url, 'http://noop');
    const queryParameters = Array.from(searchParams.keys());
    if (queryParameters.length > 0) {
        return `${pathname}?${queryParameters
            .map((param) => `${param}=*****`)
            .join('&')}`;
    }
    if (hash) {
        return `${pathname}#*****`;
    }
    return pathname;
};
const maskHeaders = (headers) => {
    if (LOG_LEVEL === 'DEBUG') {
        return headers;
    }
    return Object.keys(headers).reduce((returnableHeaders, key) => ({
        ...returnableHeaders,
        [key]: '*****',
    }), {});
};
const loggerOptions = {
    winstonInstance: logger,
    // * Put meta fields at the root of the logged object
    metaField: null,
    responseField: null,
    msg: (req, res) => `${req.method} ${maskUrl(req.url)} ${res.statusCode} ${
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    res.responseTime}ms`,
    // * Always log status, method, url, and userId when it exists
    dynamicMeta: ({ method, url, auth, headers }, res) => {
        const { responseTime, statusCode, body } = res;
        const meta = {
            statusCode,
            method,
            latencyInNs: responseTime * 1e6,
        };
        if (statusCode >= 400) {
            meta.reason = body;
        }
        if (LOG_LEVEL === 'debug') {
            meta.url = url;
            meta.headers = headers;
        }
        else {
            meta.url = maskUrl(url);
            meta.headers = maskHeaders(headers);
        }
        const userId = auth?.userId;
        if (userId) {
            meta.userId = userId;
        }
        return meta;
    },
    // * Flag /healthz and /change-env as debug, and everything else as info
    level: (req, res) => {
        if (['/healthz', '/change-env'].includes(req.path))
            return 'debug';
        if (SUSPICIOUS_REQUEST_CODES.includes(res.statusCode)) {
            return 'warn';
        }
        if (res.statusCode >= 500) {
            return 'error';
        }
        return 'info';
    },
    requestWhitelist: [],
    responseWhitelist: ['responseTime', 'body'],
};
/**
 * Logger for non 5xx, non suspicious requests e.g. 200, 204, 400...
 * - Requests are logged as info, expect for /healthz et and /change-env which are logged as debug
 * - No additional meta is logged
 * */
export const httpLogger = expressWinston.logger(loggerOptions);
export const uncaughtErrorLogger = expressWinston.errorLogger(loggerOptions);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibG9nZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sY0FBaUMsTUFBTSxpQkFBaUIsQ0FBQztBQUNoRSxPQUFPLE9BQU8sTUFBTSxTQUFTLENBQUM7QUFDOUIsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUNqQyxNQUFNLENBQUMsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLElBQUksTUFBTSxDQUFDO0FBRTlELHFGQUFxRjtBQUNyRixNQUFNLENBQUMsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQztJQUN6QyxVQUFVLEVBQUUsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7SUFDbEUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7Q0FDdEQsQ0FBQyxDQUFDO0FBRUgsZ0hBQWdIO0FBQ2hILE1BQU0sd0JBQXdCLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFFNUMsTUFBTSxPQUFPLEdBQUcsQ0FBQyxHQUFXLEVBQUUsRUFBRTtJQUM5QixJQUNFLEdBQUcsQ0FBQywwQkFBMEI7UUFDOUIsU0FBUyxLQUFLLE9BQU87UUFDckIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQzFDLENBQUM7UUFDRCxPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7SUFFRCxNQUFNLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLEVBQUUsYUFBYSxDQUFDLENBQUM7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QUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztZQUN0RCxPQUFPLE1BQU0sQ0FBQztRQUNoQixDQUFDO1FBQ0QsSUFBSSxHQUFHLENBQUMsVUFBVSxJQUFJLEdBQUcsRUFBRSxDQUFDO1lBQzFCLE9BQU8sT0FBTyxDQUFDO1FBQ2pCLENBQUM7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBQ0QsZ0JBQWdCLEVBQUUsRUFBRTtJQUNwQixpQkFBaUIsRUFBRSxDQUFDLGNBQWMsRUFBRSxNQUFNLENBQUM7Q0FDNUMsQ0FBQztBQUVGOzs7O0tBSUs7QUFDTCxNQUFNLENBQUMsTUFBTSxVQUFVLEdBQUcsY0FBYyxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUUvRCxNQUFNLENBQUMsTUFBTSxtQkFBbUIsR0FBRyxjQUFjLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBleHByZXNzV2luc3RvbiwgeyBMb2dnZXJPcHRpb25zIH0gZnJvbSAnZXhwcmVzcy13aW5zdG9uJztcbmltcG9ydCB3aW5zdG9uIGZyb20gJ3dpbnN0b24nO1xuaW1wb3J0IHsgRU5WIH0gZnJvbSAnQHV0aWxzL2Vudic7XG5leHBvcnQgY29uc3QgTE9HX0xFVkVMID0gcHJvY2Vzcy5lbnYuQVVUSF9MT0dfTEVWRUwgfHwgJ2luZm8nO1xuXG4vLyAqIENyZWF0ZSBhIGNvbW1vbiBXaW5zdG9uIGxvZ2dlciB0aGF0IGNhbiBiZSB1c2VkIGluIGJvdGggbWlkZGxld2FyZXMgYW5kIG1hbnVhbGx5XG5leHBvcnQgY29uc3QgbG9nZ2VyID0gd2luc3Rvbi5jcmVhdGVMb2dnZXIoe1xuICB0cmFuc3BvcnRzOiBbbmV3IHdpbnN0b24udHJhbnNwb3J0cy5Db25zb2xlKHsgbGV2ZWw6IExPR19MRVZFTCB9KV0sXG4gIGZvcm1hdDogd2luc3Rvbi5mb3JtYXQuY29tYmluZSh3aW5zdG9uLmZvcm1hdC5qc29uKCkpLFxufSk7XG5cbi8vICogR2l2ZSBtb3JlIGltcG9ydGFuY2UgdG8gVW5hdXRob3JpemVkIGFuZCBGb3JiaWRkZW4gc3RhdHVzIGNvZGVzIHRvIGdpdmUgbW9yZSB2aXNpYmlsaXR5IHRvIGhhY2tpbmcgYXR0ZW1wdHNcbmNvbnN0IFNVU1BJQ0lPVVNfUkVRVUVTVF9DT0RFUyA9IFs0MDEsIDQwM107XG5cbmNvbnN0IG1hc2tVcmwgPSAodXJsOiBzdHJpbmcpID0+IHtcbiAgaWYgKFxuICAgIEVOVi5BVVRIX1NIT1dfTE9HX1FVRVJZX1BBUkFNUyB8fFxuICAgIExPR19MRVZFTCA9PT0gJ2RlYnVnJyB8fFxuICAgICghdXJsLmluY2x1ZGVzKCc/JykgJiYgIXVybC5pbmNsdWRlcygnIycpKVxuICApIHtcbiAgICByZXR1cm4gdXJsO1xuICB9XG5cbiAgY29uc3QgeyBwYXRobmFtZSwgc2VhcmNoUGFyYW1zLCBoYXNoIH0gPSBuZXcgVVJMKHVybCwgJ2h0dHA6Ly9ub29wJyk7XG4gIGNvbnN0IHF1ZXJ5UGFyYW1ldGVycyA9IEFycmF5LmZyb20oc2VhcmNoUGFyYW1zLmtleXMoKSk7XG5cbiAgaWYgKHF1ZXJ5UGFyYW1ldGVycy5sZW5ndGggPiAwKSB7XG4gICAgcmV0dXJuIGAke3BhdGhuYW1lfT8ke3F1ZXJ5UGFyYW1ldGVyc1xuICAgICAgLm1hcCgocGFyYW0pID0+IGAke3BhcmFtfT0qKioqKmApXG4gICAgICAuam9pbignJicpfWA7XG4gIH1cblxuICBpZiAoaGFzaCkge1xuICAgIHJldHVybiBgJHtwYXRobmFtZX0jKioqKipgO1xuICB9XG5cbiAgcmV0dXJuIHBhdGhuYW1lO1xufTtcblxuY29uc3QgbWFza0hlYWRlcnMgPSAoaGVhZGVyczogUmVjb3JkPHN0cmluZywgdW5rbm93bj4pID0+IHtcbiAgaWYgKExPR19MRVZFTCA9PT0gJ0RFQlVHJykge1xuICAgIHJldHVybiBoZWFkZXJzO1xuICB9XG5cbiAgcmV0dXJuIE9iamVjdC5rZXlzKGhlYWRlcnMpLnJlZHVjZShcbiAgICAocmV0dXJuYWJsZUhlYWRlcnMsIGtleSkgPT4gKHtcbiAgICAgIC4uLnJldHVybmFibGVIZWFkZXJzLFxuICAgICAgW2tleV06ICcqKioqKicsXG4gICAgfSksXG4gICAge31cbiAgKTtcbn07XG5cbmNvbnN0IGxvZ2dlck9wdGlvbnM6IExvZ2dlck9wdGlvbnMgPSB7XG4gIHdpbnN0b25JbnN0YW5jZTogbG9nZ2VyLFxuICAvLyAqIFB1dCBtZXRhIGZpZWxkcyBhdCB0aGUgcm9vdCBvZiB0aGUgbG9nZ2VkIG9iamVjdFxuICBtZXRhRmllbGQ6IG51bGwsXG4gIHJlc3BvbnNlRmllbGQ6IG51bGwsXG4gIG1zZzogKHJlcSwgcmVzKSA9PlxuICAgIGAke3JlcS5tZXRob2R9ICR7bWFza1VybChyZXEudXJsKX0gJHtyZXMuc3RhdHVzQ29kZX0gJHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgICAocmVzIGFzIGFueSkucmVzcG9uc2VUaW1lXG4gICAgfW1zYCxcbiAgLy8gKiBBbHdheXMgbG9nIHN0YXR1cywgbWV0aG9kLCB1cmwsIGFuZCB1c2VySWQgd2hlbiBpdCBleGlzdHNcbiAgZHluYW1pY01ldGE6ICh7IG1ldGhvZCwgdXJsLCBhdXRoLCBoZWFkZXJzIH0sIHJlcykgPT4ge1xuICAgIGNvbnN0IHsgcmVzcG9uc2VUaW1lLCBzdGF0dXNDb2RlLCBib2R5IH0gPSByZXMgYXMgUmVzcG9uc2UgJiB7XG4gICAgICByZXNwb25zZVRpbWU6IG51bWJlcjtcbiAgICAgIGJvZHk6IHVua25vd247XG4gICAgfTtcblxuICAgIGNvbnN0IG1ldGE6IFJlY29yZDxzdHJpbmcsIHVua25vd24+ID0ge1xuICAgICAgc3RhdHVzQ29kZSxcbiAgICAgIG1ldGhvZCxcbiAgICAgIGxhdGVuY3lJbk5zOiByZXNwb25zZVRpbWUgKiAxZTYsXG4gICAgfTtcblxuICAgIGlmIChzdGF0dXNDb2RlID49IDQwMCkge1xuICAgICAgbWV0YS5yZWFzb24gPSBib2R5O1xuICAgIH1cblxuICAgIGlmIChMT0dfTEVWRUwgPT09ICdkZWJ1ZycpIHtcbiAgICAgIG1ldGEudXJsID0gdXJsO1xuICAgICAgbWV0YS5oZWFkZXJzID0gaGVhZGVycztcbiAgICB9IGVsc2Uge1xuICAgICAgbWV0YS51cmwgPSBtYXNrVXJsKHVybCk7XG4gICAgICBtZXRhLmhlYWRlcnMgPSBtYXNrSGVhZGVycyhoZWFkZXJzKTtcbiAgICB9XG4gICAgY29uc3QgdXNlcklkID0gYXV0aD8udXNlcklkO1xuICAgIGlmICh1c2VySWQpIHtcbiAgICAgIG1ldGEudXNlcklkID0gdXNlcklkO1xuICAgIH1cbiAgICByZXR1cm4gbWV0YTtcbiAgfSxcbiAgLy8gKiBGbGFnIC9oZWFsdGh6IGFuZCAvY2hhbmdlLWVudiBhcyBkZWJ1ZywgYW5kIGV2ZXJ5dGhpbmcgZWxzZSBhcyBpbmZvXG4gIGxldmVsOiAocmVxLCByZXMpID0+IHtcbiAgICBpZiAoWycvaGVhbHRoeicsICcvY2hhbmdlLWVudiddLmluY2x1ZGVzKHJlcS5wYXRoKSkgcmV0dXJuICdkZWJ1Zyc7XG4gICAgaWYgKFNVU1BJQ0lPVVNfUkVRVUVTVF9DT0RFUy5pbmNsdWRlcyhyZXMuc3RhdHVzQ29kZSkpIHtcbiAgICAgIHJldHVybiAnd2Fybic7XG4gICAgfVxuICAgIGlmIChyZXMuc3RhdHVzQ29kZSA+PSA1MDApIHtcbiAgICAgIHJldHVybiAnZXJyb3InO1xuICAgIH1cbiAgICByZXR1cm4gJ2luZm8nO1xuICB9LFxuICByZXF1ZXN0V2hpdGVsaXN0OiBbXSxcbiAgcmVzcG9uc2VXaGl0ZWxpc3Q6IFsncmVzcG9uc2VUaW1lJywgJ2JvZHknXSxcbn07XG5cbi8qKlxuICogTG9nZ2VyIGZvciBub24gNXh4LCBub24gc3VzcGljaW91cyByZXF1ZXN0cyBlLmcuIDIwMCwgMjA0LCA0MDAuLi5cbiAqIC0gUmVxdWVzdHMgYXJlIGxvZ2dlZCBhcyBpbmZvLCBleHBlY3QgZm9yIC9oZWFsdGh6IGV0IGFuZCAvY2hhbmdlLWVudiB3aGljaCBhcmUgbG9nZ2VkIGFzIGRlYnVnXG4gKiAtIE5vIGFkZGl0aW9uYWwgbWV0YSBpcyBsb2dnZWRcbiAqICovXG5leHBvcnQgY29uc3QgaHR0cExvZ2dlciA9IGV4cHJlc3NXaW5zdG9uLmxvZ2dlcihsb2dnZXJPcHRpb25zKTtcblxuZXhwb3J0IGNvbnN0IHVuY2F1Z2h0RXJyb3JMb2dnZXIgPSBleHByZXNzV2luc3Rvbi5lcnJvckxvZ2dlcihsb2dnZXJPcHRpb25zKTtcbiJdfQ==