import { sendEmail } from './email'; // The function to test
import { ENV } from '@utils/env';
import { logger } from '@utils/logger';
// Mock dependencies
jest.mock('nodemailer');
jest.mock('email-templates');
jest.mock('@utils/env', () => ({
    ENV: {
        AUTH_SMTP_HOST: 'smtp.example.com',
        AUTH_SMTP_PORT: '587',
        AUTH_SMTP_SECURE: 'false',
        AUTH_SMTP_PASS: 'password',
        AUTH_SMTP_USER: 'user',
        AUTH_SMTP_SENDER: 'sender@example.com',
        AUTH_SMTP_X_SMTPAPI_HEADER: '',
        LOG_LEVEL: 'info', // Or whatever default you want for tests
    },
}));
jest.mock('@utils/logger', () => ({
    logger: {
        info: jest.fn(),
        warn: jest.fn(),
        error: jest.fn(),
        debug: jest.fn(), // Add other levels if used by the module
    },
}));
const mockNodemailer = require('nodemailer');
const mockEmailTemplates = require('email-templates');
describe('sendEmail (Nodemailer via _utils/email/email.ts)', () => {
    let mockTransportSendMail;
    let mockEmailClientSend;
    beforeEach(() => {
        jest.clearAllMocks();
        mockTransportSendMail = jest.fn();
        mockNodemailer.createTransport.mockReturnValue({
            sendMail: mockTransportSendMail,
        });
        // Mock the email-templates client's send method
        // This is a bit more involved because sendEmail uses `new Email().send()`
        // We need to mock the Email class constructor and its send method.
        mockEmailClientSend = jest.fn();
        mockEmailTemplates.mockImplementation(() => {
            return {
                send: mockEmailClientSend,
            };
        });
    });
    const emailOptions = {
        template: 'test-template',
        message: {
            to: 'recipient@example.com',
            subject: 'Test Subject', // Added subject for completeness
        },
        locals: { name: 'Tester' },
    };
    it('should send an email successfully on the first attempt', async () => {
        mockEmailClientSend.mockResolvedValueOnce({
            messageId: 'nodemailer-message-id-123',
        });
        await sendEmail(emailOptions);
        expect(mockEmailClientSend).toHaveBeenCalledTimes(1);
        expect(mockEmailClientSend).toHaveBeenCalledWith(expect.objectContaining({
            template: emailOptions.template,
            message: expect.objectContaining({ to: emailOptions.message.to }),
        }));
        expect(logger.info).toHaveBeenCalledWith(expect.stringContaining('Email sent successfully via SMTP on attempt 1'), expect.anything());
        expect(logger.warn).not.toHaveBeenCalled();
        expect(logger.error).not.toHaveBeenCalled();
    });
    it('should send an email successfully on the second attempt after one failure', async () => {
        mockEmailClientSend
            .mockRejectedValueOnce(new Error('SMTP Error Attempt 1'))
            .mockResolvedValueOnce({ messageId: 'nodemailer-message-id-456' });
        await sendEmail(emailOptions);
        expect(mockEmailClientSend).toHaveBeenCalledTimes(2);
        expect(logger.warn).toHaveBeenCalledTimes(1);
        expect(logger.warn).toHaveBeenCalledWith(expect.stringContaining('Attempt 1 to send email via SMTP failed. Retrying...'), expect.objectContaining({ errorMessage: 'SMTP Error Attempt 1' }));
        expect(logger.info).toHaveBeenCalledWith(expect.stringContaining('Email sent successfully via SMTP on attempt 2'), expect.anything());
        expect(logger.error).not.toHaveBeenCalled();
    });
    it('should fail after all retry attempts and log the final error', async () => {
        mockEmailClientSend
            .mockRejectedValueOnce(new Error('SMTP Error Attempt 1'))
            .mockRejectedValueOnce(new Error('SMTP Error Attempt 2'))
            .mockRejectedValueOnce(new Error('SMTP Error Attempt 3'));
        await expect(sendEmail(emailOptions)).rejects.toThrow('SMTP Error Attempt 3');
        expect(mockEmailClientSend).toHaveBeenCalledTimes(3);
        expect(logger.warn).toHaveBeenCalledTimes(3);
        expect(logger.warn).toHaveBeenNthCalledWith(1, expect.stringContaining('Attempt 1'), expect.anything());
        expect(logger.warn).toHaveBeenNthCalledWith(2, expect.stringContaining('Attempt 2'), expect.anything());
        expect(logger.warn).toHaveBeenNthCalledWith(3, expect.stringContaining('Attempt 3'), expect.anything());
        expect(logger.error).toHaveBeenCalledTimes(1);
        expect(logger.error).toHaveBeenCalledWith(expect.stringContaining('SMTP error after 3 attempts'), expect.anything(), // The actual error object, which is hard to match exactly
        expect.anything() // The context object
        );
    });
    it('should include X-SMTPAPI header if ENV var is set', async () => {
        const originalSmtpApiHeader = ENV.AUTH_SMTP_X_SMTPAPI_HEADER;
        ENV.AUTH_SMTP_X_SMTPAPI_HEADER = '{"category": "test"}';
        mockEmailClientSend.mockResolvedValueOnce({
            messageId: 'nodemailer-header-test',
        });
        await sendEmail(emailOptions);
        expect(mockEmailClientSend).toHaveBeenCalledTimes(1);
        expect(mockEmailClientSend).toHaveBeenCalledWith(expect.objectContaining({
            message: expect.objectContaining({
                headers: expect.objectContaining({
                    'X-SMTPAPI': '{"category": "test"}',
                }),
            }),
        }));
        // Restore ENV var
        ENV.AUTH_SMTP_X_SMTPAPI_HEADER = originalSmtpApiHeader;
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1haWwudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImVtYWlsLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFNBQVMsQ0FBQyxDQUFDLHVCQUF1QjtBQUM1RCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFdkMsb0JBQW9CO0FBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDeEIsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQzdCLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDN0IsR0FBRyxFQUFFO1FBQ0gsY0FBYyxFQUFFLGtCQUFrQjtRQUNsQyxjQUFjLEVBQUUsS0FBSztRQUNyQixnQkFBZ0IsRUFBRSxPQUFPO1FBQ3pCLGNBQWMsRUFBRSxVQUFVO1FBQzFCLGNBQWMsRUFBRSxNQUFNO1FBQ3RCLGdCQUFnQixFQUFFLG9CQUFvQjtRQUN0QywwQkFBMEIsRUFBRSxFQUFFO1FBQzlCLFNBQVMsRUFBRSxNQUFNLEVBQUUseUNBQXlDO0tBQzdEO0NBQ0YsQ0FBQyxDQUFDLENBQUM7QUFDSixJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ2hDLE1BQU0sRUFBRTtRQUNOLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2YsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNoQixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxFQUFFLHlDQUF5QztLQUM1RDtDQUNGLENBQUMsQ0FBQyxDQUFDO0FBRUosTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFD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QkFBZ0IsQ0FBQztvQkFDL0IsV0FBVyxFQUFFLHNCQUFzQjtpQkFDcEMsQ0FBQzthQUNILENBQUM7U0FDSCxDQUFDLENBQ0gsQ0FBQztRQUNGLGtCQUFrQjtRQUNsQixHQUFHLENBQUMsMEJBQTBCLEdBQUcscUJBQXFCLENBQUM7SUFDekQsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHNlbmRFbWFpbCB9IGZyb20gJy4vZW1haWwnOyAvLyBUaGUgZnVuY3Rpb24gdG8gdGVzdFxuaW1wb3J0IHsgRU5WIH0gZnJvbSAnQHV0aWxzL2Vudic7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICdAdXRpbHMvbG9nZ2VyJztcblxuLy8gTW9jayBkZXBlbmRlbmNpZXNcbmplc3QubW9jaygnbm9kZW1haWxlcicpO1xuamVzdC5tb2NrKCdlbWFpbC10ZW1wbGF0ZXMnKTtcbmplc3QubW9jaygnQHV0aWxzL2VudicsICgpID0+ICh7XG4gIEVOVjoge1xuICAgIEFVVEhfU01UUF9IT1NUOiAnc210cC5leGFtcGxlLmNvbScsXG4gICAgQVVUSF9TTVRQX1BPUlQ6ICc1ODcnLFxuICAgIEFVVEhfU01UUF9TRUNVUkU6ICdmYWxzZScsXG4gICAgQVVUSF9TTVRQX1BBU1M6ICdwYXNzd29yZCcsXG4gICAgQVVUSF9TTVRQX1VTRVI6ICd1c2VyJyxcbiAgICBBVVRIX1NNVFBfU0VOREVSOiAnc2VuZGVyQGV4YW1wbGUuY29tJyxcbiAgICBBVVRIX1NNVFBfWF9TTVRQQVBJX0hFQURFUjogJycsXG4gICAgTE9HX0xFVkVMOiAnaW5mbycsIC8vIE9yIHdoYXRldmVyIGRlZmF1bHQgeW91IHdhbnQgZm9yIHRlc3RzXG4gIH0sXG59KSk7XG5qZXN0Lm1vY2soJ0B1dGlscy9sb2dnZXInLCAoKSA9PiAoe1xuICBsb2dnZXI6IHtcbiAgICBpbmZvOiBqZXN0LmZuKCksXG4gICAgd2FybjogamVzdC5mbigpLFxuICAgIGVycm9yOiBqZXN0LmZuKCksXG4gICAgZGVidWc6IGplc3QuZm4oKSwgLy8gQWRkIG90aGVyIGxldmVscyBpZiB1c2VkIGJ5IHRoZSBtb2R1bGVcbiAgfSxcbn0pKTtcblxuY29uc3QgbW9ja05vZGVtYWlsZXIgPSByZXF1aXJlKCdub2RlbWFpbGVyJyk7XG5jb25zdCBtb2NrRW1haWxUZW1wbGF0ZXMgPSByZXF1aXJlKCdlbWFpbC10ZW1wbGF0ZXMnKTtcblxuZGVzY3JpYmUoJ3NlbmRFbWFpbCAoTm9kZW1haWxlciB2aWEgX3V0aWxzL2VtYWlsL2VtYWlsLnRzKScsICgpID0+IHtcbiAgbGV0IG1vY2tUcmFuc3BvcnRTZW5kTWFpbDogamVzdC5Nb2NrO1xuICBsZXQgbW9ja0VtYWlsQ2xpZW50U2VuZDogamVzdC5Nb2NrO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuXG4gICAgbW9ja1RyYW5zcG9ydFNlbmRNYWlsID0gamVzdC5mbigpO1xuICAgIG1vY2tOb2RlbWFpbGVyLmNyZWF0ZVRyYW5zcG9ydC5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgc2VuZE1haWw6IG1vY2tUcmFuc3BvcnRTZW5kTWFpbCxcbiAgICB9KTtcblxuICAgIC8vIE1vY2sgdGhlIGVtYWlsLXRlbXBsYXRlcyBjbGllbnQncyBzZW5kIG1ldGhvZFxuICAgIC8vIFRoaXMgaXMgYSBiaXQgbW9yZSBpbnZvbHZlZCBiZWNhdXNlIHNlbmRFbWFpbCB1c2VzIGBuZXcgRW1haWwoKS5zZW5kKClgXG4gICAgLy8gV2UgbmVlZCB0byBtb2NrIHRoZSBFbWFpbCBjbGFzcyBjb25zdHJ1Y3RvciBhbmQgaXRzIHNlbmQgbWV0aG9kLlxuICAgIG1vY2tFbWFpbENsaWVudFNlbmQgPSBqZXN0LmZuKCk7XG4gICAgbW9ja0VtYWlsVGVtcGxhdGVzLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzZW5kOiBtb2NrRW1haWxDbGllbnRTZW5kLFxuICAgICAgfTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgY29uc3QgZW1haWxPcHRpb25zID0ge1xuICAgIHRlbXBsYXRlOiAndGVzdC10ZW1wbGF0ZScsXG4gICAgbWVzc2FnZToge1xuICAgICAgdG86ICdyZWNpcGllbnRAZXhhbXBsZS5jb20nLFxuICAgICAgc3ViamVjdDogJ1Rlc3QgU3ViamVjdCcsIC8vIEFkZGVkIHN1YmplY3QgZm9yIGNvbXBsZXRlbmVzc1xuICAgIH0sXG4gICAgbG9jYWxzOiB7IG5hbWU6ICdUZXN0ZXInIH0sXG4gIH07XG5cbiAgaXQoJ3Nob3VsZCBzZW5kIGFuIGVtYWlsIHN1Y2Nlc3NmdWxseSBvbiB0aGUgZmlyc3QgYXR0ZW1wdCcsIGFzeW5jICgpID0+IHtcbiAgICBtb2NrRW1haWxDbGllbnRTZW5kLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG4gICAgICBtZXNzYWdlSWQ6ICdub2RlbWFpbGVyLW1lc3NhZ2UtaWQtMTIzJyxcbiAgICB9KTtcblxuICAgIGF3YWl0IHNlbmRFbWFpbChlbWFpbE9wdGlvbnMpO1xuXG4gICAgZXhwZWN0KG1vY2tFbWFpbENsaWVudFNlbmQpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICBleHBlY3QobW9ja0VtYWlsQ2xpZW50U2VuZCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgIHRlbXBsYXRlOiBlbWFpbE9wdGlvbnMudGVtcGxhdGUsXG4gICAgICAgIG1lc3NhZ2U6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHsgdG86IGVtYWlsT3B0aW9ucy5tZXNzYWdlLnRvIH0pLFxuICAgICAgfSlcbiAgICApO1xuICAgIGV4cGVjdChsb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnRW1haWwgc2VudCBzdWNjZXNzZnVsbHkgdmlhIFNNVFAgb24gYXR0ZW1wdCAxJyksXG4gICAgICBleHBlY3QuYW55dGhpbmcoKVxuICAgICk7XG4gICAgZXhwZWN0KGxvZ2dlci53YXJuKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIGV4cGVjdChsb2dnZXIuZXJyb3IpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgc2VuZCBhbiBlbWFpbCBzdWNjZXNzZnVsbHkgb24gdGhlIHNlY29uZCBhdHRlbXB0IGFmdGVyIG9uZSBmYWlsdXJlJywgYXN5bmMgKCkgPT4ge1xuICAgIG1vY2tFbWFpbENsaWVudFNlbmRcbiAgICAgIC5tb2NrUmVqZWN0ZWRWYWx1ZU9uY2UobmV3IEVycm9yKCdTTVRQIEVycm9yIEF0dGVtcHQgMScpKVxuICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7IG1lc3NhZ2VJZDogJ25vZGVtYWlsZXItbWVzc2FnZS1pZC00NTYnIH0pO1xuXG4gICAgYXdhaXQgc2VuZEVtYWlsKGVtYWlsT3B0aW9ucyk7XG5cbiAgICBleHBlY3QobW9ja0VtYWlsQ2xpZW50U2VuZCkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDIpO1xuICAgIGV4cGVjdChsb2dnZXIud2FybikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgIGV4cGVjdChsb2dnZXIud2FybikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZyhcbiAgICAgICAgJ0F0dGVtcHQgMSB0byBzZW5kIGVtYWlsIHZpYSBTTVRQIGZhaWxlZC4gUmV0cnlpbmcuLi4nXG4gICAgICApLFxuICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoeyBlcnJvck1lc3NhZ2U6ICdTTVRQIEVycm9yIEF0dGVtcHQgMScgfSlcbiAgICApO1xuICAgIGV4cGVjdChsb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnRW1haWwgc2VudCBzdWNjZXNzZnVsbHkgdmlhIFNNVFAgb24gYXR0ZW1wdCAyJyksXG4gICAgICBleHBlY3QuYW55dGhpbmcoKVxuICAgICk7XG4gICAgZXhwZWN0KGxvZ2dlci5lcnJvcikubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBmYWlsIGFmdGVyIGFsbCByZXRyeSBhdHRlbXB0cyBhbmQgbG9nIHRoZSBmaW5hbCBlcnJvcicsIGFzeW5jICgpID0+IHtcbiAgICBtb2NrRW1haWxDbGllbnRTZW5kXG4gICAgICAubW9ja1JlamVjdGVkVmFsdWVPbmNlKG5ldyBFcnJvcignU01UUCBFcnJvciBBdHRlbXB0IDEnKSlcbiAgICAgIC5tb2NrUmVqZWN0ZWRWYWx1ZU9uY2UobmV3IEVycm9yKCdTTVRQIEVycm9yIEF0dGVtcHQgMicpKVxuICAgICAgLm1vY2tSZWplY3RlZFZhbHVlT25jZShuZXcgRXJyb3IoJ1NNVFAgRXJyb3IgQXR0ZW1wdCAzJykpO1xuXG4gICAgYXdhaXQgZXhwZWN0KHNlbmRFbWFpbChlbWFpbE9wdGlvbnMpKS5yZWplY3RzLnRvVGhyb3coXG4gICAgICAnU01UUCBFcnJvciBBdHRlbXB0IDMnXG4gICAgKTtcblxuICAgIGV4cGVjdChtb2NrRW1haWxDbGllbnRTZW5kKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMyk7XG4gICAgZXhwZWN0KGxvZ2dlci53YXJuKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMyk7XG4gICAgZXhwZWN0KGxvZ2dlci53YXJuKS50b0hhdmVCZWVuTnRoQ2FsbGVkV2l0aChcbiAgICAgIDEsXG4gICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnQXR0ZW1wdCAxJyksXG4gICAgICBleHBlY3QuYW55dGhpbmcoKVxuICAgICk7XG4gICAgZXhwZWN0KGxvZ2dlci53YXJuKS50b0hhdmVCZWVuTnRoQ2FsbGVkV2l0aChcbiAgICAgIDIsXG4gICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnQXR0ZW1wdCAyJyksXG4gICAgICBleHBlY3QuYW55dGhpbmcoKVxuICAgICk7XG4gICAgZXhwZWN0KGxvZ2dlci53YXJuKS50b0hhdmVCZWVuTnRoQ2FsbGVkV2l0aChcbiAgICAgIDMsXG4gICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnQXR0ZW1wdCAzJyksXG4gICAgICBleHBlY3QuYW55dGhpbmcoKVxuICAgICk7XG4gICAgZXhwZWN0KGxvZ2dlci5lcnJvcikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgIGV4cGVjdChsb2dnZXIuZXJyb3IpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ1NNVFAgZXJyb3IgYWZ0ZXIgMyBhdHRlbXB0cycpLFxuICAgICAgZXhwZWN0LmFueXRoaW5nKCksIC8vIFRoZSBhY3R1YWwgZXJyb3Igb2JqZWN0LCB3aGljaCBpcyBoYXJkIHRvIG1hdGNoIGV4YWN0bHlcbiAgICAgIGV4cGVjdC5hbnl0aGluZygpIC8vIFRoZSBjb250ZXh0IG9iamVjdFxuICAgICk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgaW5jbHVkZSBYLVNNVFBBUEkgaGVhZGVyIGlmIEVOViB2YXIgaXMgc2V0JywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG9yaWdpbmFsU210cEFwaUhlYWRlciA9IEVOVi5BVVRIX1NNVFBfWF9TTVRQQVBJX0hFQURFUjtcbiAgICBFTlYuQVVUSF9TTVRQX1hfU01UUEFQSV9IRUFERVIgPSAne1wiY2F0ZWdvcnlcIjogXCJ0ZXN0XCJ9JztcbiAgICBtb2NrRW1haWxDbGllbnRTZW5kLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG4gICAgICBtZXNzYWdlSWQ6ICdub2RlbWFpbGVyLWhlYWRlci10ZXN0JyxcbiAgICB9KTtcblxuICAgIGF3YWl0IHNlbmRFbWFpbChlbWFpbE9wdGlvbnMpO1xuXG4gICAgZXhwZWN0KG1vY2tFbWFpbENsaWVudFNlbmQpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICBleHBlY3QobW9ja0VtYWlsQ2xpZW50U2VuZCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgIG1lc3NhZ2U6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBoZWFkZXJzOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICAnWC1TTVRQQVBJJzogJ3tcImNhdGVnb3J5XCI6IFwidGVzdFwifScsXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pLFxuICAgICAgfSlcbiAgICApO1xuICAgIC8vIFJlc3RvcmUgRU5WIHZhclxuICAgIEVOVi5BVVRIX1NNVFBfWF9TTVRQQVBJX0hFQURFUiA9IG9yaWdpbmFsU210cEFwaUhlYWRlcjtcbiAgfSk7XG59KTtcbiJdfQ==