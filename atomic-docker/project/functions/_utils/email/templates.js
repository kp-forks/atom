import axios from 'axios';
import path from 'path';
import fs from 'fs';
import urlJoin from 'url-join';
import { logger } from '@utils/logger';
import { ENV } from '@utils/env';
const templateEngine = ({ content, variables }) => {
    let templatedContent = content;
    for (const key in variables) {
        const regex = new RegExp(`\\\${${key}}`, 'g');
        templatedContent = templatedContent.replace(regex, variables[key]);
    }
    return templatedContent;
};
const convertFieldToFileName = (field) => {
    if (field === 'subject') {
        return 'subject.txt';
    }
    if (field === 'html') {
        return 'body.html';
    }
    if (field === 'text') {
        return 'body.txt';
    }
    return null;
};
const getFileName = (view, locals) => {
    // generate path to template
    const viewSplit = view.split('/');
    const id = viewSplit[0];
    const field = viewSplit[1];
    const { locale } = locals;
    const fileName = convertFieldToFileName(field);
    return `${locale}/${id}/${fileName}`;
};
const readFile = (view, locals) => {
    const { locale } = locals;
    const fullPath = path.join(ENV.PWD, '_utils', 'email', 'email-templates', getFileName(view, locals));
    logger.debug(`Using email template: ${fullPath}`);
    try {
        return fs.readFileSync(fullPath).toString();
    }
    catch (error) {
        if (locale !== ENV.AUTH_LOCALE_DEFAULT) {
            logger.debug(`No template found at ${fullPath}, falling back to default locale ${ENV.AUTH_LOCALE_DEFAULT}`);
            return readFile(view, { ...locals, locale: ENV.AUTH_LOCALE_DEFAULT });
        }
        else {
            throw Error();
        }
    }
};
/** @deprecated */
const readRemoteTemplate = async (view, locals) => {
    const { locale } = locals;
    const fileName = getFileName(view, locals);
    const url = urlJoin(ENV.AUTH_EMAIL_TEMPLATE_FETCH_URL, fileName);
    logger.debug(`Using email template: ${url}`);
    try {
        const result = await axios.get(url);
        return result.data;
    }
    catch (error) {
        if (locale !== ENV.AUTH_LOCALE_DEFAULT)
            return readRemoteTemplate(view, {
                ...locals,
                locale: ENV.AUTH_LOCALE_DEFAULT,
            });
        else {
            logger.warn(`No template found at ${url}`);
            throw Error();
        }
    }
};
export const renderTemplate = async (view, locals) => {
    try {
        const content = ENV.AUTH_EMAIL_TEMPLATE_FETCH_URL
            ? await readRemoteTemplate(view, locals)
            : readFile(view, locals);
        return templateEngine({ content, variables: locals });
    }
    catch (error) {
        return null;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVtcGxhdGVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVtcGxhdGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMxQixPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3BCLE9BQU8sT0FBTyxNQUFNLFVBQVUsQ0FBQztBQUMvQixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFTakMsTUFBTSxjQUFjLEdBQUcsQ0FBQyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQXVCLEVBQUUsRUFBRTtJQUNyRSxJQUFJLGdCQUFnQixHQUFHLE9BQU8sQ0FBQztJQUUvQixLQUFLLE1BQU0sR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDO1FBQzVCLE1BQU0sS0FBSyxHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsR0FBRyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDOUMsZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNyRSxDQUFDO0lBRUQsT0FBTyxnQkFBZ0IsQ0FBQztBQUMxQixDQUFDLENBQUM7QUFLRixNQUFNLHNCQUFzQixHQUFHLENBQUMsS0FBNEIsRUFBRSxFQUFFO0lBQzlELElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRSxDQUFDO1FBQ3hCLE9BQU8sYUFBYSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxJQUFJLEtBQUssS0FBSyxNQUFNLEVBQUUsQ0FBQztRQUNyQixPQUFPLFdBQVcsQ0FBQztJQUNyQixDQUFDO0lBRUQsSUFBSSxLQUFLLEtBQUssTUFBTSxFQUFFLENBQUM7UUFDckIsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQztJQUVELE9BQU8sSUFB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LEdBQUcsS0FBSyxFQUNqQyxJQUFZLEVBQ1osTUFBK0IsRUFDL0IsRUFBRTtJQUNGLElBQUksQ0FBQztRQUNILE1BQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQyw2QkFBNkI7WUFDL0MsQ0FBQyxDQUFDLE1BQU0sa0JBQWtCLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQztZQUN4QyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztRQUMzQixPQUFPLGNBQWMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztBQUNILENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBheGlvcyBmcm9tICdheGlvcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgdXJsSm9pbiBmcm9tICd1cmwtam9pbic7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICdAdXRpbHMvbG9nZ2VyJztcbmltcG9ydCB7IEVOViB9IGZyb20gJ0B1dGlscy9lbnYnO1xuXG50eXBlIFRlbXBsYXRlRW5naW5lUHJvcHMgPSB7XG4gIGNvbnRlbnQ6IHN0cmluZztcbiAgdmFyaWFibGVzOiB7XG4gICAgW2tleTogc3RyaW5nXTogc3RyaW5nO1xuICB9O1xufTtcblxuY29uc3QgdGVtcGxhdGVFbmdpbmUgPSAoeyBjb250ZW50LCB2YXJpYWJsZXMgfTogVGVtcGxhdGVFbmdpbmVQcm9wcykgPT4ge1xuICBsZXQgdGVtcGxhdGVkQ29udGVudCA9IGNvbnRlbnQ7XG5cbiAgZm9yIChjb25zdCBrZXkgaW4gdmFyaWFibGVzKSB7XG4gICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKGBcXFxcXFwkeyR7a2V5fX1gLCAnZycpO1xuICAgIHRlbXBsYXRlZENvbnRlbnQgPSB0ZW1wbGF0ZWRDb250ZW50LnJlcGxhY2UocmVnZXgsIHZhcmlhYmxlc1trZXldKTtcbiAgfVxuXG4gIHJldHVybiB0ZW1wbGF0ZWRDb250ZW50O1xufTtcblxudHlwZSBFbWFpbEZpZWxkID0gJ3N1YmplY3QnIHwgJ2h0bWwnIHwgJ3RleHQnO1xudHlwZSBTbXNGaWVsZCA9ICd0ZXh0JztcblxuY29uc3QgY29udmVydEZpZWxkVG9GaWxlTmFtZSA9IChmaWVsZDogRW1haWxGaWVsZCB8IFNtc0ZpZWxkKSA9PiB7XG4gIGlmIChmaWVsZCA9PT0gJ3N1YmplY3QnKSB7XG4gICAgcmV0dXJuICdzdWJqZWN0LnR4dCc7XG4gIH1cblxuICBpZiAoZmllbGQgPT09ICdodG1sJykge1xuICAgIHJldHVybiAnYm9keS5odG1sJztcbiAgfVxuXG4gIGlmIChmaWVsZCA9PT0gJ3RleHQnKSB7XG4gICAgcmV0dXJuICdib2R5LnR4dCc7XG4gIH1cblxuICByZXR1cm4gbnVsbDtcbn07XG5cbmNvbnN0IGdldEZpbGVOYW1lID0gKHZpZXc6IHN0cmluZywgbG9jYWxzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+KSA9PiB7XG4gIC8vIGdlbmVyYXRlIHBhdGggdG8gdGVtcGxhdGVcbiAgY29uc3Qgdmlld1NwbGl0ID0gdmlldy5zcGxpdCgnLycpO1xuICBjb25zdCBpZCA9IHZpZXdTcGxpdFswXTtcbiAgY29uc3QgZmllbGQgPSB2aWV3U3BsaXRbMV0gYXMgRW1haWxGaWVsZCB8IFNtc0ZpZWxkO1xuICBjb25zdCB7IGxvY2FsZSB9ID0gbG9jYWxzO1xuICBjb25zdCBmaWxlTmFtZSA9IGNvbnZlcnRGaWVsZFRvRmlsZU5hbWUoZmllbGQpO1xuICByZXR1cm4gYCR7bG9jYWxlfS8ke2lkfS8ke2ZpbGVOYW1lfWA7XG59O1xuXG5jb25zdCByZWFkRmlsZSA9ICh2aWV3OiBzdHJpbmcsIGxvY2FsczogUmVjb3JkPHN0cmluZywgc3RyaW5nPik6IHN0cmluZyA9PiB7XG4gIGNvbnN0IHsgbG9jYWxlIH0gPSBsb2NhbHM7XG4gIGNvbnN0IGZ1bGxQYXRoID0gcGF0aC5qb2luKFxuICAgIEVOVi5QV0QsXG4gICAgJ191dGlscycsXG4gICAgJ2VtYWlsJyxcbiAgICAnZW1haWwtdGVtcGxhdGVzJyxcbiAgICBnZXRGaWxlTmFtZSh2aWV3LCBsb2NhbHMpXG4gICk7XG4gIGxvZ2dlci5kZWJ1ZyhgVXNpbmcgZW1haWwgdGVtcGxhdGU6ICR7ZnVsbFBhdGh9YCk7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhmdWxsUGF0aCkudG9TdHJpbmcoKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAobG9jYWxlICE9PSBFTlYuQVVUSF9MT0NBTEVfREVGQVVMVCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICBgTm8gdGVtcGxhdGUgZm91bmQgYXQgJHtmdWxsUGF0aH0sIGZhbGxpbmcgYmFjayB0byBkZWZhdWx0IGxvY2FsZSAke0VOVi5BVVRIX0xPQ0FMRV9ERUZBVUxUfWBcbiAgICAgICk7XG4gICAgICByZXR1cm4gcmVhZEZpbGUodmlldywgeyAuLi5sb2NhbHMsIGxvY2FsZTogRU5WLkFVVEhfTE9DQUxFX0RFRkFVTFQgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IEVycm9yKCk7XG4gICAgfVxuICB9XG59O1xuXG4vKiogQGRlcHJlY2F0ZWQgKi9cbmNvbnN0IHJlYWRSZW1vdGVUZW1wbGF0ZSA9IGFzeW5jIChcbiAgdmlldzogc3RyaW5nLFxuICBsb2NhbHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbik6IFByb21pc2U8c3RyaW5nPiA9PiB7XG4gIGNvbnN0IHsgbG9jYWxlIH0gPSBsb2NhbHM7XG4gIGNvbnN0IGZpbGVOYW1lID0gZ2V0RmlsZU5hbWUodmlldywgbG9jYWxzKTtcbiAgY29uc3QgdXJsID0gdXJsSm9pbihFTlYuQVVUSF9FTUFJTF9URU1QTEFURV9GRVRDSF9VUkwsIGZpbGVOYW1lKTtcbiAgbG9nZ2VyLmRlYnVnKGBVc2luZyBlbWFpbCB0ZW1wbGF0ZTogJHt1cmx9YCk7XG4gIHRyeSB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXhpb3MuZ2V0KHVybCk7XG4gICAgcmV0dXJuIHJlc3VsdC5kYXRhO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGlmIChsb2NhbGUgIT09IEVOVi5BVVRIX0xPQ0FMRV9ERUZBVUxUKVxuICAgICAgcmV0dXJuIHJlYWRSZW1vdGVUZW1wbGF0ZSh2aWV3LCB7XG4gICAgICAgIC4uLmxvY2FscyxcbiAgICAgICAgbG9jYWxlOiBFTlYuQVVUSF9MT0NBTEVfREVGQVVMVCxcbiAgICAgIH0pO1xuICAgIGVsc2Uge1xuICAgICAgbG9nZ2VyLndhcm4oYE5vIHRlbXBsYXRlIGZvdW5kIGF0ICR7dXJsfWApO1xuICAgICAgdGhyb3cgRXJyb3IoKTtcbiAgICB9XG4gIH1cbn07XG5cbnR5cGUgQ29tbW9uTG9jYWxzID0ge1xuICBkaXNwbGF5TmFtZTogc3RyaW5nO1xuICBsb2NhbGU6IHN0cmluZztcbn07XG5cbmV4cG9ydCB0eXBlIFNtc0xvY2FscyA9IENvbW1vbkxvY2FscyAmIHtcbiAgY29kZTogc3RyaW5nO1xufTtcblxuZXhwb3J0IHR5cGUgRW1haWxMb2NhbHMgPSBDb21tb25Mb2NhbHMgJiB7XG4gIGxpbms6IHN0cmluZztcbiAgZW1haWw6IHN0cmluZztcbiAgbmV3RW1haWw6IHN0cmluZztcbiAgdGlja2V0OiBzdHJpbmc7XG4gIHJlZGlyZWN0VG86IHN0cmluZztcbiAgc2VydmVyVXJsOiBzdHJpbmc7XG4gIGNsaWVudFVybDogc3RyaW5nO1xuICBba2V5OiBzdHJpbmddOiBzdHJpbmc7XG59O1xuXG5leHBvcnQgY29uc3QgcmVuZGVyVGVtcGxhdGUgPSBhc3luYyAoXG4gIHZpZXc6IHN0cmluZyxcbiAgbG9jYWxzOiBFbWFpbExvY2FscyB8IFNtc0xvY2Fsc1xuKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgY29udGVudCA9IEVOVi5BVVRIX0VNQUlMX1RFTVBMQVRFX0ZFVENIX1VSTFxuICAgICAgPyBhd2FpdCByZWFkUmVtb3RlVGVtcGxhdGUodmlldywgbG9jYWxzKVxuICAgICAgOiByZWFkRmlsZSh2aWV3LCBsb2NhbHMpO1xuICAgIHJldHVybiB0ZW1wbGF0ZUVuZ2luZSh7IGNvbnRlbnQsIHZhcmlhYmxlczogbG9jYWxzIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHJldHVybiBudWxsO1xuICB9XG59O1xuIl19