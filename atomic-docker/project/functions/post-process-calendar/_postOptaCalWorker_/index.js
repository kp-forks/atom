import dayjs from 'dayjs';
import isoWeek from 'dayjs/plugin/isoWeek';
import duration from 'dayjs/plugin/duration';
import isBetween from 'dayjs/plugin/isBetween';
import timezone from 'dayjs/plugin/timezone';
import utc from 'dayjs/plugin/utc';
import { streamToString, updateAllCalendarEventsPostPlanner, } from '@post_process_calendar/_libs/api-helper';
import { S3Client, GetObjectCommand, DeleteObjectCommand, } from '@aws-sdk/client-s3';
import { bucketName, kafkaPostProcessCalGroupId, kafkaPostProcessCalTopic, } from '@post_process_calendar/_libs/constants';
import _ from 'lodash';
import { Kafka, logLevel } from 'kafkajs';
dayjs.extend(isoWeek);
dayjs.extend(duration);
dayjs.extend(isBetween);
dayjs.extend(timezone);
dayjs.extend(utc);
const s3Client = new S3Client({
    credentials: {
        accessKeyId: process.env.S3_ACCESS_KEY,
        secretAccessKey: process.env.S3_SECRET_KEY,
    },
    endpoint: process.env.S3_ENDPOINT,
    forcePathStyle: true,
});
const kafka = new Kafka({
    logLevel: logLevel.DEBUG,
    brokers: [`kafka1:29092`],
    clientId: 'atomic',
    // ssl: true,
    sasl: {
        mechanism: 'plain', // scram-sha-256 or scram-sha-512
        username: process.env.KAFKA_USERNAME,
        password: process.env.KAFKA_PASSWORD,
    },
});
const processPostOptaPlanQueueBody = async (body) => {
    try {
        const allEvents = body.allEvents;
        const newBufferTimes = body?.newHostBufferTimes;
        const newReminders = body?.newHostReminders;
        const breaks = body?.breaks;
        const plannerBodyResponse = body?.plannerBodyResponse;
        const oldEvents = body?.oldEvents;
        const oldAttendeeExternalEvents = body?.oldAttendeeEvents;
        const hostTimezone = body?.hostTimezone;
        // Extract new replan fields
        const isReplan = body?.isReplan;
        const originalGoogleEventId = body?.originalGoogleEventId;
        const originalCalendarId = body?.originalCalendarId;
        newReminders.forEach((r) => console.log(r, ' newReminders before updateAllCalendarEventsPostPlanner'));
        const eventsToUpdate = [];
        if (plannerBodyResponse?.userList?.[0]?.id) {
            const eventPartParentFiltered = _.uniqBy(plannerBodyResponse.eventPartList, 'eventId');
            for (const eventPartParent of eventPartParentFiltered) {
                const eventPartList = [];
                for (const eventPartChild of plannerBodyResponse.eventPartList) {
                    if (eventPartParent.eventId === eventPartChild.eventId) {
                        const oldEventPart = allEvents.find((e) => e.id === eventPartChild.eventId);
                        eventPartList.push({
                            ...eventPartChild,
                            recurringEventId: oldEventPart?.recurringEventId,
                        });
                    }
                }
                eventsToUpdate.push(eventPartList);
            }
        }
        const eventsToValidate = [];
        if (plannerBodyResponse?.userList?.[0]?.id) {
            const eventPartParentFiltered = _.uniqBy(plannerBodyResponse.eventPartList, 'groupId');
            for (const eventPartParent of eventPartParentFiltered) {
                const eventPartList = [];
                for (const eventPartChild of plannerBodyResponse.eventPartList) {
                    if (eventPartParent.groupId === eventPartChild.groupId) {
                        const oldEventPart = allEvents.find((e) => e.id === eventPartChild.eventId);
                        eventPartList.push({
                            ...eventPartChild,
                            recurringEventId: oldEventPart?.recurringEventId,
                        });
                    }
                }
                eventsToValidate.push(eventPartList);
            }
        }
        eventsToUpdate?.map((e) => console.log(e, ' eventsToUpdate'));
        console.log(eventsToUpdate.length, ' updateEvents length ');
        await updateAllCalendarEventsPostPlanner(eventsToUpdate, eventsToValidate, allEvents, 
        // isoWeekOfStartDates,
        oldEvents, hostTimezone, newBufferTimes, newReminders, breaks, oldAttendeeExternalEvents, 
        // Pass new replan fields
        isReplan, originalGoogleEventId, originalCalendarId);
    }
    catch (e) {
        console.log(e, ' processCalendarForOptaPlanner');
    }
};
const processQueueMessage = async (body) => {
    // find old event in database using elastic search
    // validate bodyData
    console.log(body, ' body');
    if (!body?.eventParts?.[0]?.eventId) {
        throw new Error('eventParts is required');
    }
    if (!body?.allEvents?.[0]?.id) {
        throw new Error('allEvents is required');
    }
    if (!body?.plannerBodyResponse?.userList?.[0]?.id) {
        throw new Error('plannerBodyResponse is required');
    }
    if (!body?.hostTimezone) {
        throw new Error('hostTimezone not present');
    }
    return processPostOptaPlanQueueBody(body);
};
const queueWorker = async () => {
    try {
        const consumer = kafka.consumer({ groupId: kafkaPostProcessCalGroupId });
        await consumer.connect();
        await consumer.subscribe({ topic: kafkaPostProcessCalTopic });
        await consumer.run({
            eachMessage: async ({ topic, partition, message }) => {
                console.log({
                    key: message?.key?.toString(),
                    value: message?.value?.toString(),
                    headers: message?.headers,
                });
                // '{"fileKey":"fc5df674-b4ee-43c7-ad9e-298ae0eb6208/aed7b93e-8da4-447c-83e7-f0f0f1420226.json"}'
                const bodyData = JSON.parse(message?.value?.toString());
                const fileKey = bodyData.fileKey;
                console.log(bodyData, ' bodyData');
                const s3GetCommand = new GetObjectCommand({
                    Bucket: bucketName,
                    Key: fileKey,
                });
                const s3GetCommandOutput = await s3Client.send(s3GetCommand);
                const bodyString = await streamToString(s3GetCommandOutput.Body);
                const body = JSON.parse(bodyString);
                console.log(body, ' body');
                const s3DeleteCommand = new DeleteObjectCommand({
                    Bucket: bucketName,
                    Key: fileKey,
                });
                const s3DeleteCommandOutput = await s3Client.send(s3DeleteCommand);
                console.log(s3DeleteCommandOutput, ' s3DeleteCommandOutput');
                return processQueueMessage(body);
            },
        });
    }
    catch (e) {
        console.log(e, ' unable to process message');
        return e;
    }
};
export default queueWorker;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDMUIsT0FBTyxPQUFPLE1BQU0sc0JBQXNCLENBQUM7QUFDM0MsT0FBTyxRQUFRLE1BQU0sdUJBQXVCLENBQUM7QUFDN0MsT0FBTyxTQUFTLE1BQU0sd0JBQXdCLENBQUM7QUFDL0MsT0FBTyxRQUFRLE1BQU0sdUJBQXVCLENBQUM7QUFDN0MsT0FBTyxHQUFHLE1BQU0sa0JBQWtCLENBQUM7QUFFbkMsT0FBTyxFQUNMLGNBQWMsRUFDZCxrQ0FBa0MsR0FDbkMsTUFBTSx5Q0FBeUMsQ0FBQztBQU9qRCxPQUFPLEVBQ0wsUUFBUSxFQUNSLGdCQUFnQixFQUNoQixtQkFBbUIsR0FDcEIsTUFBTSxvQkFBb0IsQ0FBQztBQUM1QixPQUFPLEVBQ0wsVUFBVSxFQUNWLDBCQUEwQixFQUMxQix3QkFBd0IsR0FDekIsTUFBTSx3Q0FBd0MsQ0FBQztBQUVoRCxPQUFPLENBQUMsTUFBTSxRQUFRLENBQUM7QUFDdkIsT0FBTyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFHMUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN0QixLQUFLLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3ZCLEtBQUssQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDeEIsS0FBSyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUN2QixLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBRWxCLE1BQU0sUUFBUSxHQUFHLElBQUksUUFBUSxDQUFDO0lBQzVCLFdBQVcsRUFBRTtRQUNYLFdBQVcsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWE7UUFDdEMsZUFBZSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFB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TUFBTSxlQUFlLEdBQUcsSUFBSSxtQkFBbUIsQ0FBQztvQkFDOUMsTUFBTSxFQUFFLFVBQVU7b0JBQ2xCLEdBQUcsRUFBRSxPQUFPO2lCQUNiLENBQUMsQ0FBQztnQkFDSCxNQUFNLHFCQUFxQixHQUFHLE1BQU0sUUFBUSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztnQkFDbkUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsRUFBRSx3QkFBd0IsQ0FBQyxDQUFDO2dCQUU3RCxPQUFPLG1CQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ25DLENBQUM7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztRQUNYLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLDRCQUE0QixDQUFDLENBQUM7UUFFN0MsT0FBTyxDQUFDLENBQUM7SUFDWCxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBRUYsZUFBZSxXQUFXLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZGF5anMgZnJvbSAnZGF5anMnO1xuaW1wb3J0IGlzb1dlZWsgZnJvbSAnZGF5anMvcGx1Z2luL2lzb1dlZWsnO1xuaW1wb3J0IGR1cmF0aW9uIGZyb20gJ2RheWpzL3BsdWdpbi9kdXJhdGlvbic7XG5pbXBvcnQgaXNCZXR3ZWVuIGZyb20gJ2RheWpzL3BsdWdpbi9pc0JldHdlZW4nO1xuaW1wb3J0IHRpbWV6b25lIGZyb20gJ2RheWpzL3BsdWdpbi90aW1lem9uZSc7XG5pbXBvcnQgdXRjIGZyb20gJ2RheWpzL3BsdWdpbi91dGMnO1xuXG5pbXBvcnQge1xuICBzdHJlYW1Ub1N0cmluZyxcbiAgdXBkYXRlQWxsQ2FsZW5kYXJFdmVudHNQb3N0UGxhbm5lcixcbn0gZnJvbSAnQHBvc3RfcHJvY2Vzc19jYWxlbmRhci9fbGlicy9hcGktaGVscGVyJztcblxuaW1wb3J0IHtcbiAgTWVzc2FnZVF1ZXVlVHlwZSxcbiAgUG9zdFByb2Nlc3NRdWV1ZUJvZHlGb3JDYWxlbmRhclR5cGUsXG59IGZyb20gJ0Bwb3N0X3Byb2Nlc3NfY2FsZW5kYXIvX2xpYnMvdHlwZXMvcG9zdE9wdGFDYWxXb3JrZXIvdHlwZXMnO1xuaW1wb3J0IHsgRXZlbnRQbGFubmVyUmVzcG9uc2VCb2R5VHlwZSB9IGZyb20gJ0Bwb3N0X3Byb2Nlc3NfY2FsZW5kYXIvX2xpYnMvdHlwZXMnO1xuaW1wb3J0IHtcbiAgUzNDbGllbnQsXG4gIEdldE9iamVjdENvbW1hbmQsXG4gIERlbGV0ZU9iamVjdENvbW1hbmQsXG59IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5pbXBvcnQge1xuICBidWNrZXROYW1lLFxuICBrYWZrYVBvc3RQcm9jZXNzQ2FsR3JvdXBJZCxcbiAga2Fma2FQb3N0UHJvY2Vzc0NhbFRvcGljLFxufSBmcm9tICdAcG9zdF9wcm9jZXNzX2NhbGVuZGFyL19saWJzL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBSZWFkYWJsZSB9IGZyb20gJ3N0cmVhbSc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgS2Fma2EsIGxvZ0xldmVsIH0gZnJvbSAna2Fma2Fqcyc7XG5pbXBvcnQgaXAgZnJvbSAnaXAnO1xuXG5kYXlqcy5leHRlbmQoaXNvV2Vlayk7XG5kYXlqcy5leHRlbmQoZHVyYXRpb24pO1xuZGF5anMuZXh0ZW5kKGlzQmV0d2Vlbik7XG5kYXlqcy5leHRlbmQodGltZXpvbmUpO1xuZGF5anMuZXh0ZW5kKHV0Yyk7XG5cbmNvbnN0IHMzQ2xpZW50ID0gbmV3IFMzQ2xpZW50KHtcbiAgY3JlZGVudGlhbHM6IHtcbiAgICBhY2Nlc3NLZXlJZDogcHJvY2Vzcy5lbnYuUzNfQUNDRVNTX0tFWSxcbiAgICBzZWNyZXRBY2Nlc3NLZXk6IHByb2Nlc3MuZW52LlMzX1NFQ1JFVF9LRVksXG4gIH0sXG4gIGVuZHBvaW50OiBwcm9jZXNzLmVudi5TM19FTkRQT0lOVCxcbiAgZm9yY2VQYXRoU3R5bGU6IHRydWUsXG59KTtcblxuY29uc3Qga2Fma2EgPSBuZXcgS2Fma2Eoe1xuICBsb2dMZXZlbDogbG9nTGV2ZWwuREVCVUcsXG4gIGJyb2tlcnM6IFtga2Fma2ExOjI5MDkyYF0sXG4gIGNsaWVudElkOiAnYXRvbWljJyxcbiAgLy8gc3NsOiB0cnVlLFxuICBzYXNsOiB7XG4gICAgbWVjaGFuaXNtOiAncGxhaW4nLCAvLyBzY3JhbS1zaGEtMjU2IG9yIHNjcmFtLXNoYS01MTJcbiAgICB1c2VybmFtZTogcHJvY2Vzcy5lbnYuS0FGS0FfVVNFUk5BTUUsXG4gICAgcGFzc3dvcmQ6IHByb2Nlc3MuZW52LktBRktBX1BBU1NXT1JELFxuICB9LFxufSk7XG5cbmNvbnN0IHByb2Nlc3NQb3N0T3B0YVBsYW5RdWV1ZUJvZHkgPSBhc3luYyAoXG4gIGJvZHk6IFBvc3RQcm9jZXNzUXVldWVCb2R5Rm9yQ2FsZW5kYXJUeXBlXG4pID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBhbGxFdmVudHMgPSBib2R5LmFsbEV2ZW50cztcbiAgICBjb25zdCBuZXdCdWZmZXJUaW1lcyA9IGJvZHk/Lm5ld0hvc3RCdWZmZXJUaW1lcztcbiAgICBjb25zdCBuZXdSZW1pbmRlcnMgPSBib2R5Py5uZXdIb3N0UmVtaW5kZXJzO1xuICAgIGNvbnN0IGJyZWFrcyA9IGJvZHk/LmJyZWFrcztcbiAgICBjb25zdCBwbGFubmVyQm9keVJlc3BvbnNlID0gYm9keT8ucGxhbm5lckJvZHlSZXNwb25zZTtcbiAgICBjb25zdCBvbGRFdmVudHMgPSBib2R5Py5vbGRFdmVudHM7XG4gICAgY29uc3Qgb2xkQXR0ZW5kZWVFeHRlcm5hbEV2ZW50cyA9IGJvZHk/Lm9sZEF0dGVuZGVlRXZlbnRzO1xuICAgIGNvbnN0IGhvc3RUaW1lem9uZSA9IGJvZHk/Lmhvc3RUaW1lem9uZTtcbiAgICAvLyBFeHRyYWN0IG5ldyByZXBsYW4gZmllbGRzXG4gICAgY29uc3QgaXNSZXBsYW4gPSBib2R5Py5pc1JlcGxhbjtcbiAgICBjb25zdCBvcmlnaW5hbEdvb2dsZUV2ZW50SWQgPSBib2R5Py5vcmlnaW5hbEdvb2dsZUV2ZW50SWQ7XG4gICAgY29uc3Qgb3JpZ2luYWxDYWxlbmRhcklkID0gYm9keT8ub3JpZ2luYWxDYWxlbmRhcklkO1xuXG4gICAgbmV3UmVtaW5kZXJzLmZvckVhY2goKHIpID0+XG4gICAgICBjb25zb2xlLmxvZyhyLCAnIG5ld1JlbWluZGVycyBiZWZvcmUgdXBkYXRlQWxsQ2FsZW5kYXJFdmVudHNQb3N0UGxhbm5lcicpXG4gICAgKTtcbiAgICBjb25zdCBldmVudHNUb1VwZGF0ZTogRXZlbnRQbGFubmVyUmVzcG9uc2VCb2R5VHlwZVtdW10gPSBbXTtcbiAgICBpZiAocGxhbm5lckJvZHlSZXNwb25zZT8udXNlckxpc3Q/LlswXT8uaWQpIHtcbiAgICAgIGNvbnN0IGV2ZW50UGFydFBhcmVudEZpbHRlcmVkID0gXy51bmlxQnkoXG4gICAgICAgIHBsYW5uZXJCb2R5UmVzcG9uc2UuZXZlbnRQYXJ0TGlzdCxcbiAgICAgICAgJ2V2ZW50SWQnXG4gICAgICApO1xuICAgICAgZm9yIChjb25zdCBldmVudFBhcnRQYXJlbnQgb2YgZXZlbnRQYXJ0UGFyZW50RmlsdGVyZWQpIHtcbiAgICAgICAgY29uc3QgZXZlbnRQYXJ0TGlzdCA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IGV2ZW50UGFydENoaWxkIG9mIHBsYW5uZXJCb2R5UmVzcG9uc2UuZXZlbnRQYXJ0TGlzdCkge1xuICAgICAgICAgIGlmIChldmVudFBhcnRQYXJlbnQuZXZlbnRJZCA9PT0gZXZlbnRQYXJ0Q2hpbGQuZXZlbnRJZCkge1xuICAgICAgICAgICAgY29uc3Qgb2xkRXZlbnRQYXJ0ID0gYWxsRXZlbnRzLmZpbmQoXG4gICAgICAgICAgICAgIChlKSA9PiBlLmlkID09PSBldmVudFBhcnRDaGlsZC5ldmVudElkXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgZXZlbnRQYXJ0TGlzdC5wdXNoKHtcbiAgICAgICAgICAgICAgLi4uZXZlbnRQYXJ0Q2hpbGQsXG4gICAgICAgICAgICAgIHJlY3VycmluZ0V2ZW50SWQ6IG9sZEV2ZW50UGFydD8ucmVjdXJyaW5nRXZlbnRJZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBldmVudHNUb1VwZGF0ZS5wdXNoKGV2ZW50UGFydExpc3QpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGV2ZW50c1RvVmFsaWRhdGU6IEV2ZW50UGxhbm5lclJlc3BvbnNlQm9keVR5cGVbXVtdID0gW107XG4gICAgaWYgKHBsYW5uZXJCb2R5UmVzcG9uc2U/LnVzZXJMaXN0Py5bMF0/LmlkKSB7XG4gICAgICBjb25zdCBldmVudFBhcnRQYXJlbnRGaWx0ZXJlZCA9IF8udW5pcUJ5KFxuICAgICAgICBwbGFubmVyQm9keVJlc3BvbnNlLmV2ZW50UGFydExpc3QsXG4gICAgICAgICdncm91cElkJ1xuICAgICAgKTtcbiAgICAgIGZvciAoY29uc3QgZXZlbnRQYXJ0UGFyZW50IG9mIGV2ZW50UGFydFBhcmVudEZpbHRlcmVkKSB7XG4gICAgICAgIGNvbnN0IGV2ZW50UGFydExpc3QgPSBbXTtcbiAgICAgICAgZm9yIChjb25zdCBldmVudFBhcnRDaGlsZCBvZiBwbGFubmVyQm9keVJlc3BvbnNlLmV2ZW50UGFydExpc3QpIHtcbiAgICAgICAgICBpZiAoZXZlbnRQYXJ0UGFyZW50Lmdyb3VwSWQgPT09IGV2ZW50UGFydENoaWxkLmdyb3VwSWQpIHtcbiAgICAgICAgICAgIGNvbnN0IG9sZEV2ZW50UGFydCA9IGFsbEV2ZW50cy5maW5kKFxuICAgICAgICAgICAgICAoZSkgPT4gZS5pZCA9PT0gZXZlbnRQYXJ0Q2hpbGQuZXZlbnRJZFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGV2ZW50UGFydExpc3QucHVzaCh7XG4gICAgICAgICAgICAgIC4uLmV2ZW50UGFydENoaWxkLFxuICAgICAgICAgICAgICByZWN1cnJpbmdFdmVudElkOiBvbGRFdmVudFBhcnQ/LnJlY3VycmluZ0V2ZW50SWQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZXZlbnRzVG9WYWxpZGF0ZS5wdXNoKGV2ZW50UGFydExpc3QpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGV2ZW50c1RvVXBkYXRlPy5tYXAoKGUpID0+IGNvbnNvbGUubG9nKGUsICcgZXZlbnRzVG9VcGRhdGUnKSk7XG4gICAgY29uc29sZS5sb2coZXZlbnRzVG9VcGRhdGUubGVuZ3RoLCAnIHVwZGF0ZUV2ZW50cyBsZW5ndGggJyk7XG4gICAgYXdhaXQgdXBkYXRlQWxsQ2FsZW5kYXJFdmVudHNQb3N0UGxhbm5lcihcbiAgICAgIGV2ZW50c1RvVXBkYXRlLFxuICAgICAgZXZlbnRzVG9WYWxpZGF0ZSxcbiAgICAgIGFsbEV2ZW50cyxcbiAgICAgIC8vIGlzb1dlZWtPZlN0YXJ0RGF0ZXMsXG4gICAgICBvbGRFdmVudHMsXG4gICAgICBob3N0VGltZXpvbmUsXG4gICAgICBuZXdCdWZmZXJUaW1lcyxcbiAgICAgIG5ld1JlbWluZGVycyxcbiAgICAgIGJyZWFrcyxcbiAgICAgIG9sZEF0dGVuZGVlRXh0ZXJuYWxFdmVudHMsXG4gICAgICAvLyBQYXNzIG5ldyByZXBsYW4gZmllbGRzXG4gICAgICBpc1JlcGxhbixcbiAgICAgIG9yaWdpbmFsR29vZ2xlRXZlbnRJZCxcbiAgICAgIG9yaWdpbmFsQ2FsZW5kYXJJZFxuICAgICk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBjb25zb2xlLmxvZyhlLCAnIHByb2Nlc3NDYWxlbmRhckZvck9wdGFQbGFubmVyJyk7XG4gIH1cbn07XG5cbmNvbnN0IHByb2Nlc3NRdWV1ZU1lc3NhZ2UgPSBhc3luYyAoXG4gIGJvZHk6IFBvc3RQcm9jZXNzUXVldWVCb2R5Rm9yQ2FsZW5kYXJUeXBlXG4pID0+IHtcbiAgLy8gZmluZCBvbGQgZXZlbnQgaW4gZGF0YWJhc2UgdXNpbmcgZWxhc3RpYyBzZWFyY2hcbiAgLy8gdmFsaWRhdGUgYm9keURhdGFcbiAgY29uc29sZS5sb2coYm9keSwgJyBib2R5Jyk7XG4gIGlmICghYm9keT8uZXZlbnRQYXJ0cz8uWzBdPy5ldmVudElkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdldmVudFBhcnRzIGlzIHJlcXVpcmVkJyk7XG4gIH1cblxuICBpZiAoIWJvZHk/LmFsbEV2ZW50cz8uWzBdPy5pZCkge1xuICAgIHRocm93IG5ldyBFcnJvcignYWxsRXZlbnRzIGlzIHJlcXVpcmVkJyk7XG4gIH1cblxuICBpZiAoIWJvZHk/LnBsYW5uZXJCb2R5UmVzcG9uc2U/LnVzZXJMaXN0Py5bMF0/LmlkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdwbGFubmVyQm9keVJlc3BvbnNlIGlzIHJlcXVpcmVkJyk7XG4gIH1cblxuICBpZiAoIWJvZHk/Lmhvc3RUaW1lem9uZSkge1xuICAgIHRocm93IG5ldyBFcnJvcignaG9zdFRpbWV6b25lIG5vdCBwcmVzZW50Jyk7XG4gIH1cblxuICByZXR1cm4gcHJvY2Vzc1Bvc3RPcHRhUGxhblF1ZXVlQm9keShib2R5KTtcbn07XG5cbmNvbnN0IHF1ZXVlV29ya2VyID0gYXN5bmMgKCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGNvbnN1bWVyID0ga2Fma2EuY29uc3VtZXIoeyBncm91cElkOiBrYWZrYVBvc3RQcm9jZXNzQ2FsR3JvdXBJZCB9KTtcbiAgICBhd2FpdCBjb25zdW1lci5jb25uZWN0KCk7XG5cbiAgICBhd2FpdCBjb25zdW1lci5zdWJzY3JpYmUoeyB0b3BpYzoga2Fma2FQb3N0UHJvY2Vzc0NhbFRvcGljIH0pO1xuXG4gICAgYXdhaXQgY29uc3VtZXIucnVuKHtcbiAgICAgIGVhY2hNZXNzYWdlOiBhc3luYyAoeyB0b3BpYywgcGFydGl0aW9uLCBtZXNzYWdlIH0pID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coe1xuICAgICAgICAgIGtleTogbWVzc2FnZT8ua2V5Py50b1N0cmluZygpLFxuICAgICAgICAgIHZhbHVlOiBtZXNzYWdlPy52YWx1ZT8udG9TdHJpbmcoKSxcbiAgICAgICAgICBoZWFkZXJzOiBtZXNzYWdlPy5oZWFkZXJzLFxuICAgICAgICB9KTtcbiAgICAgICAgLy8gJ3tcImZpbGVLZXlcIjpcImZjNWRmNjc0LWI0ZWUtNDNjNy1hZDllLTI5OGFlMGViNjIwOC9hZWQ3YjkzZS04ZGE0LTQ0N2MtODNlNy1mMGYwZjE0MjAyMjYuanNvblwifSdcbiAgICAgICAgY29uc3QgYm9keURhdGEgPSBKU09OLnBhcnNlKG1lc3NhZ2U/LnZhbHVlPy50b1N0cmluZygpKTtcbiAgICAgICAgY29uc3QgZmlsZUtleSA9IGJvZHlEYXRhLmZpbGVLZXk7XG4gICAgICAgIGNvbnNvbGUubG9nKGJvZHlEYXRhLCAnIGJvZHlEYXRhJyk7XG4gICAgICAgIGNvbnN0IHMzR2V0Q29tbWFuZCA9IG5ldyBHZXRPYmplY3RDb21tYW5kKHtcbiAgICAgICAgICBCdWNrZXQ6IGJ1Y2tldE5hbWUsXG4gICAgICAgICAgS2V5OiBmaWxlS2V5LFxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBzM0dldENvbW1hbmRPdXRwdXQgPSBhd2FpdCBzM0NsaWVudC5zZW5kKHMzR2V0Q29tbWFuZCk7XG4gICAgICAgIGNvbnN0IGJvZHlTdHJpbmcgPSBhd2FpdCBzdHJlYW1Ub1N0cmluZyhcbiAgICAgICAgICBzM0dldENvbW1hbmRPdXRwdXQuQm9keSBhcyBSZWFkYWJsZVxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IGJvZHk6IFBvc3RQcm9jZXNzUXVldWVCb2R5Rm9yQ2FsZW5kYXJUeXBlID1cbiAgICAgICAgICBKU09OLnBhcnNlKGJvZHlTdHJpbmcpO1xuICAgICAgICBjb25zb2xlLmxvZyhib2R5LCAnIGJvZHknKTtcblxuICAgICAgICBjb25zdCBzM0RlbGV0ZUNvbW1hbmQgPSBuZXcgRGVsZXRlT2JqZWN0Q29tbWFuZCh7XG4gICAgICAgICAgQnVja2V0OiBidWNrZXROYW1lLFxuICAgICAgICAgIEtleTogZmlsZUtleSxcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IHMzRGVsZXRlQ29tbWFuZE91dHB1dCA9IGF3YWl0IHMzQ2xpZW50LnNlbmQoczNEZWxldGVDb21tYW5kKTtcbiAgICAgICAgY29uc29sZS5sb2coczNEZWxldGVDb21tYW5kT3V0cHV0LCAnIHMzRGVsZXRlQ29tbWFuZE91dHB1dCcpO1xuXG4gICAgICAgIHJldHVybiBwcm9jZXNzUXVldWVNZXNzYWdlKGJvZHkpO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUubG9nKGUsICcgdW5hYmxlIHRvIHByb2Nlc3MgbWVzc2FnZScpO1xuXG4gICAgcmV0dXJuIGU7XG4gIH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IHF1ZXVlV29ya2VyO1xuIl19