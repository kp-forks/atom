import { S3Client, GetObjectCommand, DeleteObjectCommand, } from '@aws-sdk/client-s3';
import { bucketName, kafkaGoogleCalendarSyncGroupId, kafkaGoogleCalendarSyncTopic, } from '@google_calendar_sync/_libs/constants';
import { convertEventTitleToOpenAIVector } from '../_libs/event2VectorsWorker/api-helper';
import { bulkUpsertToLanceDBEvents, bulkDeleteFromLanceDBEvents, } from '../_libs/lancedb_helper';
import { dayjs } from '@google_calendar_sync/_libs/date-utils';
import { Kafka, logLevel } from 'kafkajs';
import { streamToString } from '../_libs/api-helper';
const s3Client = new S3Client({
    credentials: {
        accessKeyId: process.env.S3_ACCESS_KEY,
        secretAccessKey: process.env.S3_SECRET_KEY,
    },
    endpoint: process.env.S3_ENDPOINT,
    forcePathStyle: true,
});
const kafka = new Kafka({
    logLevel: logLevel.DEBUG,
    brokers: [`kafka1:29092`],
    clientId: 'atomic',
    // ssl: true,
    sasl: {
        mechanism: 'plain', // scram-sha-256 or scram-sha-512
        username: process.env.KAFKA_USERNAME,
        password: process.env.KAFKA_PASSWORD,
    },
});
export const event2VectorBody = async (body) => {
    try {
        const eventsToUpsert = []; // For LanceDB
        for (const eventObject of body?.events) {
            if (eventObject?.method === 'upsert') {
                const { event } = eventObject;
                let text = event?.summary || '';
                if (event?.description) {
                    text += `:${event?.description}`;
                }
                const vector = await convertEventTitleToOpenAIVector(text.trim());
                const startDate = dayjs(event?.start?.dateTime?.slice(0, 19) ||
                    event?.start?.date?.slice(0, 19))
                    .tz(event?.start?.timeZone, true)
                    .format();
                const endDate = dayjs(event?.end?.dateTime?.slice(0, 19) || event?.end?.date?.slice(0, 19))
                    .tz(event?.end?.timeZone || event?.start?.timeZone, true)
                    .format(); // Corrected: use end.timeZone if available for end date
                eventsToUpsert.push({
                    id: `${event?.id}#${eventObject?.calendarId}`,
                    userId: body?.userId,
                    vector,
                    start_date: startDate,
                    end_date: endDate,
                    raw_event_text: text.trim(),
                });
            }
        }
        if (eventsToUpsert?.length > 0) {
            await bulkUpsertToLanceDBEvents(eventsToUpsert);
        }
        const idsToDelete = [];
        for (const eventObject of body?.events) {
            if (eventObject?.method === 'delete') {
                const { event } = eventObject;
                idsToDelete.push(`${event?.id}#${eventObject?.calendarId}`);
            }
        }
        if (idsToDelete?.length > 0) {
            await bulkDeleteFromLanceDBEvents(idsToDelete);
        }
    }
    catch (e) {
        console.log(e, ' unable to event2vectorBody');
    }
};
export const processQueueMessage = async (body) => {
    try {
        console.log(body, ' body');
        if (!body?.events?.[0]?.event?.id) {
            throw new Error('no events available');
        }
        return event2VectorBody(body);
    }
    catch (e) {
        console.log(e, ' unable to process queue message');
    }
};
const queueWorker = async (event) => {
    try {
        const consumer = kafka.consumer({
            groupId: kafkaGoogleCalendarSyncGroupId,
        });
        await consumer.connect();
        await consumer.subscribe({ topic: kafkaGoogleCalendarSyncTopic });
        await consumer.run({
            eachMessage: async ({ topic, partition, message }) => {
                console.log({
                    key: message?.key?.toString(),
                    value: message?.value?.toString(),
                    headers: message?.headers,
                });
                // '{"fileKey":"fc5df674-b4ee-43c7-ad9e-298ae0eb6208/aed7b93e-8da4-447c-83e7-f0f0f1420226.json"}'
                const bodyData = JSON.parse(message?.value?.toString());
                const fileKey = bodyData.fileKey;
                console.log(bodyData, ' bodyData');
                const s3GetCommand = new GetObjectCommand({
                    Bucket: bucketName,
                    Key: fileKey,
                });
                const s3GetCommandOutput = await s3Client.send(s3GetCommand);
                const bodyString = await streamToString(s3GetCommandOutput.Body);
                const body = JSON.parse(bodyString);
                console.log(body, ' body');
                const s3DeleteCommand = new DeleteObjectCommand({
                    Bucket: bucketName,
                    Key: fileKey,
                });
                const s3DeleteCommandOutput = await s3Client.send(s3DeleteCommand);
                console.log(s3DeleteCommandOutput, ' s3DeleteCommandOutput');
                return processQueueMessage(body);
            },
        });
    }
    catch (e) {
        console.log(e, ' unable to event to vector');
    }
};
export default queueWorker;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsUUFBUSxFQUNSLGdCQUFnQixFQUNoQixtQkFBbUIsR0FDcEIsTUFBTSxvQkFBb0IsQ0FBQztBQUU1QixPQUFPLEVBQ0wsVUFBVSxFQUNWLDhCQUE4QixFQUM5Qiw0QkFBNEIsR0FDN0IsTUFBTSx1Q0FBdUMsQ0FBQztBQUcvQyxPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQUMxRixPQUFPLEVBQ0wseUJBQXlCLEVBQ3pCLDJCQUEyQixHQUM1QixNQUFNLHlCQUF5QixDQUFDO0FBQ2pDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUMvRCxPQUFPLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUkxQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFckQsTUFBTSxRQUFRLEdBQUcsSUFBSSxRQUFRLENBQUM7SUFDNUIsV0FBVyxFQUFFO1FBQ1gsV0FBVyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYTtRQUN0QyxlQUFlLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhO0tBQzNDO0lBQ0QsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVztJQUNqQyxjQUFjLEVBQUUsSUFBSTtDQUNyQixDQUFDLENBQUM7QUFFSCxNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQztJQUN0QixRQUFRLEVBQUUsUUFBUSxDQUFDLEtBQUs7SUFDeEIsT0FBTyxFQUFFLENBQUMsY0FBYyxDQUFDO0lBQ3pCLFFBQVEsRUFBRSxRQUFRO0lBQ2xCLGFBQWE7SUFDYixJQUFJLEVBQUU7UUFDSixTQUFTLEVBQUUsT0FBTyxFQUFFLGlDQUFpQztRQUNyRCxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxj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QUFDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7UUFDWCxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSw0QkFBNEIsQ0FBQyxDQUFDO0lBQy9DLENBQUM7QUFDSCxDQUFDLENBQUM7QUFFRixlQUFlLFdBQVcsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIFMzQ2xpZW50LFxuICBHZXRPYmplY3RDb21tYW5kLFxuICBEZWxldGVPYmplY3RDb21tYW5kLFxufSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xuXG5pbXBvcnQge1xuICBidWNrZXROYW1lLFxuICBrYWZrYUdvb2dsZUNhbGVuZGFyU3luY0dyb3VwSWQsXG4gIGthZmthR29vZ2xlQ2FsZW5kYXJTeW5jVG9waWMsXG59IGZyb20gJ0Bnb29nbGVfY2FsZW5kYXJfc3luYy9fbGlicy9jb25zdGFudHMnO1xuaW1wb3J0IHsgUmVhZGFibGUgfSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0IHsgRXZlbnQyVmVjdG9yQm9keVR5cGUgfSBmcm9tICcuLi9fbGlicy90eXBlcy9ldmVudDJWZWN0b3JzL3R5cGVzJztcbmltcG9ydCB7IGNvbnZlcnRFdmVudFRpdGxlVG9PcGVuQUlWZWN0b3IgfSBmcm9tICcuLi9fbGlicy9ldmVudDJWZWN0b3JzV29ya2VyL2FwaS1oZWxwZXInO1xuaW1wb3J0IHtcbiAgYnVsa1Vwc2VydFRvTGFuY2VEQkV2ZW50cyxcbiAgYnVsa0RlbGV0ZUZyb21MYW5jZURCRXZlbnRzLFxufSBmcm9tICcuLi9fbGlicy9sYW5jZWRiX2hlbHBlcic7XG5pbXBvcnQgeyBkYXlqcyB9IGZyb20gJ0Bnb29nbGVfY2FsZW5kYXJfc3luYy9fbGlicy9kYXRlLXV0aWxzJztcbmltcG9ydCB7IEthZmthLCBsb2dMZXZlbCB9IGZyb20gJ2thZmthanMnO1xuaW1wb3J0IGlwIGZyb20gJ2lwJztcbmltcG9ydCB7IGNyZWF0ZURheVNjaGVkdWxlIH0gZnJvbSAnQC9ncHQvX2xpYnMvYXBpLWhlbHBlcic7XG5pbXBvcnQgeyBDcmVhdGVEYXlTY2hlZHVsZUJvZHlUeXBlIH0gZnJvbSAnQC9ncHQvX2xpYnMvdHlwZXMnO1xuaW1wb3J0IHsgc3RyZWFtVG9TdHJpbmcgfSBmcm9tICcuLi9fbGlicy9hcGktaGVscGVyJztcblxuY29uc3QgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoe1xuICBjcmVkZW50aWFsczoge1xuICAgIGFjY2Vzc0tleUlkOiBwcm9jZXNzLmVudi5TM19BQ0NFU1NfS0VZLFxuICAgIHNlY3JldEFjY2Vzc0tleTogcHJvY2Vzcy5lbnYuUzNfU0VDUkVUX0tFWSxcbiAgfSxcbiAgZW5kcG9pbnQ6IHByb2Nlc3MuZW52LlMzX0VORFBPSU5ULFxuICBmb3JjZVBhdGhTdHlsZTogdHJ1ZSxcbn0pO1xuXG5jb25zdCBrYWZrYSA9IG5ldyBLYWZrYSh7XG4gIGxvZ0xldmVsOiBsb2dMZXZlbC5ERUJVRyxcbiAgYnJva2VyczogW2BrYWZrYTE6MjkwOTJgXSxcbiAgY2xpZW50SWQ6ICdhdG9taWMnLFxuICAvLyBzc2w6IHRydWUsXG4gIHNhc2w6IHtcbiAgICBtZWNoYW5pc206ICdwbGFpbicsIC8vIHNjcmFtLXNoYS0yNTYgb3Igc2NyYW0tc2hhLTUxMlxuICAgIHVzZXJuYW1lOiBwcm9jZXNzLmVudi5LQUZLQV9VU0VSTkFNRSxcbiAgICBwYXNzd29yZDogcHJvY2Vzcy5lbnYuS0FGS0FfUEFTU1dPUkQsXG4gIH0sXG59KTtcblxuZXhwb3J0IGNvbnN0IGV2ZW50MlZlY3RvckJvZHkgPSBhc3luYyAoYm9keTogRXZlbnQyVmVjdG9yQm9keVR5cGUpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBldmVudHNUb1Vwc2VydCA9IFtdOyAvLyBGb3IgTGFuY2VEQlxuXG4gICAgZm9yIChjb25zdCBldmVudE9iamVjdCBvZiBib2R5Py5ldmVudHMpIHtcbiAgICAgIGlmIChldmVudE9iamVjdD8ubWV0aG9kID09PSAndXBzZXJ0Jykge1xuICAgICAgICBjb25zdCB7IGV2ZW50IH0gPSBldmVudE9iamVjdDtcbiAgICAgICAgbGV0IHRleHQgPSBldmVudD8uc3VtbWFyeSB8fCAnJztcbiAgICAgICAgaWYgKGV2ZW50Py5kZXNjcmlwdGlvbikge1xuICAgICAgICAgIHRleHQgKz0gYDoke2V2ZW50Py5kZXNjcmlwdGlvbn1gO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdmVjdG9yID0gYXdhaXQgY29udmVydEV2ZW50VGl0bGVUb09wZW5BSVZlY3Rvcih0ZXh0LnRyaW0oKSk7XG4gICAgICAgIGNvbnN0IHN0YXJ0RGF0ZSA9IGRheWpzKFxuICAgICAgICAgIGV2ZW50Py5zdGFydD8uZGF0ZVRpbWU/LnNsaWNlKDAsIDE5KSB8fFxuICAgICAgICAgICAgZXZlbnQ/LnN0YXJ0Py5kYXRlPy5zbGljZSgwLCAxOSlcbiAgICAgICAgKVxuICAgICAgICAgIC50eihldmVudD8uc3RhcnQ/LnRpbWVab25lLCB0cnVlKVxuICAgICAgICAgIC5mb3JtYXQoKTtcbiAgICAgICAgY29uc3QgZW5kRGF0ZSA9IGRheWpzKFxuICAgICAgICAgIGV2ZW50Py5lbmQ/LmRhdGVUaW1lPy5zbGljZSgwLCAxOSkgfHwgZXZlbnQ/LmVuZD8uZGF0ZT8uc2xpY2UoMCwgMTkpXG4gICAgICAgIClcbiAgICAgICAgICAudHooZXZlbnQ/LmVuZD8udGltZVpvbmUgfHwgZXZlbnQ/LnN0YXJ0Py50aW1lWm9uZSwgdHJ1ZSlcbiAgICAgICAgICAuZm9ybWF0KCk7IC8vIENvcnJlY3RlZDogdXNlIGVuZC50aW1lWm9uZSBpZiBhdmFpbGFibGUgZm9yIGVuZCBkYXRlXG5cbiAgICAgICAgZXZlbnRzVG9VcHNlcnQucHVzaCh7XG4gICAgICAgICAgaWQ6IGAke2V2ZW50Py5pZH0jJHtldmVudE9iamVjdD8uY2FsZW5kYXJJZH1gLFxuICAgICAgICAgIHVzZXJJZDogYm9keT8udXNlcklkLFxuICAgICAgICAgIHZlY3RvcixcbiAgICAgICAgICBzdGFydF9kYXRlOiBzdGFydERhdGUsXG4gICAgICAgICAgZW5kX2RhdGU6IGVuZERhdGUsXG4gICAgICAgICAgcmF3X2V2ZW50X3RleHQ6IHRleHQudHJpbSgpLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoZXZlbnRzVG9VcHNlcnQ/Lmxlbmd0aCA+IDApIHtcbiAgICAgIGF3YWl0IGJ1bGtVcHNlcnRUb0xhbmNlREJFdmVudHMoZXZlbnRzVG9VcHNlcnQpO1xuICAgIH1cblxuICAgIGNvbnN0IGlkc1RvRGVsZXRlOiBzdHJpbmdbXSA9IFtdO1xuICAgIGZvciAoY29uc3QgZXZlbnRPYmplY3Qgb2YgYm9keT8uZXZlbnRzKSB7XG4gICAgICBpZiAoZXZlbnRPYmplY3Q/Lm1ldGhvZCA9PT0gJ2RlbGV0ZScpIHtcbiAgICAgICAgY29uc3QgeyBldmVudCB9ID0gZXZlbnRPYmplY3Q7XG4gICAgICAgIGlkc1RvRGVsZXRlLnB1c2goYCR7ZXZlbnQ/LmlkfSMke2V2ZW50T2JqZWN0Py5jYWxlbmRhcklkfWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChpZHNUb0RlbGV0ZT8ubGVuZ3RoID4gMCkge1xuICAgICAgYXdhaXQgYnVsa0RlbGV0ZUZyb21MYW5jZURCRXZlbnRzKGlkc1RvRGVsZXRlKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBjb25zb2xlLmxvZyhlLCAnIHVuYWJsZSB0byBldmVudDJ2ZWN0b3JCb2R5Jyk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBwcm9jZXNzUXVldWVNZXNzYWdlID0gYXN5bmMgKGJvZHk6IEV2ZW50MlZlY3RvckJvZHlUeXBlKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc29sZS5sb2coYm9keSwgJyBib2R5Jyk7XG5cbiAgICBpZiAoIWJvZHk/LmV2ZW50cz8uWzBdPy5ldmVudD8uaWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignbm8gZXZlbnRzIGF2YWlsYWJsZScpO1xuICAgIH1cblxuICAgIHJldHVybiBldmVudDJWZWN0b3JCb2R5KGJvZHkpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgY29uc29sZS5sb2coZSwgJyB1bmFibGUgdG8gcHJvY2VzcyBxdWV1ZSBtZXNzYWdlJyk7XG4gIH1cbn07XG5cbmNvbnN0IHF1ZXVlV29ya2VyID0gYXN5bmMgKGV2ZW50KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgY29uc3VtZXIgPSBrYWZrYS5jb25zdW1lcih7XG4gICAgICBncm91cElkOiBrYWZrYUdvb2dsZUNhbGVuZGFyU3luY0dyb3VwSWQsXG4gICAgfSk7XG4gICAgYXdhaXQgY29uc3VtZXIuY29ubmVjdCgpO1xuXG4gICAgYXdhaXQgY29uc3VtZXIuc3Vic2NyaWJlKHsgdG9waWM6IGthZmthR29vZ2xlQ2FsZW5kYXJTeW5jVG9waWMgfSk7XG5cbiAgICBhd2FpdCBjb25zdW1lci5ydW4oe1xuICAgICAgZWFjaE1lc3NhZ2U6IGFzeW5jICh7IHRvcGljLCBwYXJ0aXRpb24sIG1lc3NhZ2UgfSkgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyh7XG4gICAgICAgICAga2V5OiBtZXNzYWdlPy5rZXk/LnRvU3RyaW5nKCksXG4gICAgICAgICAgdmFsdWU6IG1lc3NhZ2U/LnZhbHVlPy50b1N0cmluZygpLFxuICAgICAgICAgIGhlYWRlcnM6IG1lc3NhZ2U/LmhlYWRlcnMsXG4gICAgICAgIH0pO1xuICAgICAgICAvLyAne1wiZmlsZUtleVwiOlwiZmM1ZGY2NzQtYjRlZS00M2M3LWFkOWUtMjk4YWUwZWI2MjA4L2FlZDdiOTNlLThkYTQtNDQ3Yy04M2U3LWYwZjBmMTQyMDIyNi5qc29uXCJ9J1xuICAgICAgICBjb25zdCBib2R5RGF0YSA9IEpTT04ucGFyc2UobWVzc2FnZT8udmFsdWU/LnRvU3RyaW5nKCkpO1xuICAgICAgICBjb25zdCBmaWxlS2V5ID0gYm9keURhdGEuZmlsZUtleTtcbiAgICAgICAgY29uc29sZS5sb2coYm9keURhdGEsICcgYm9keURhdGEnKTtcbiAgICAgICAgY29uc3QgczNHZXRDb21tYW5kID0gbmV3IEdldE9iamVjdENvbW1hbmQoe1xuICAgICAgICAgIEJ1Y2tldDogYnVja2V0TmFtZSxcbiAgICAgICAgICBLZXk6IGZpbGVLZXksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHMzR2V0Q29tbWFuZE91dHB1dCA9IGF3YWl0IHMzQ2xpZW50LnNlbmQoczNHZXRDb21tYW5kKTtcbiAgICAgICAgY29uc3QgYm9keVN0cmluZyA9IGF3YWl0IHN0cmVhbVRvU3RyaW5nKFxuICAgICAgICAgIHMzR2V0Q29tbWFuZE91dHB1dC5Cb2R5IGFzIFJlYWRhYmxlXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgYm9keTogRXZlbnQyVmVjdG9yQm9keVR5cGUgPSBKU09OLnBhcnNlKGJvZHlTdHJpbmcpO1xuICAgICAgICBjb25zb2xlLmxvZyhib2R5LCAnIGJvZHknKTtcblxuICAgICAgICBjb25zdCBzM0RlbGV0ZUNvbW1hbmQgPSBuZXcgRGVsZXRlT2JqZWN0Q29tbWFuZCh7XG4gICAgICAgICAgQnVja2V0OiBidWNrZXROYW1lLFxuICAgICAgICAgIEtleTogZmlsZUtleSxcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IHMzRGVsZXRlQ29tbWFuZE91dHB1dCA9IGF3YWl0IHMzQ2xpZW50LnNlbmQoczNEZWxldGVDb21tYW5kKTtcbiAgICAgICAgY29uc29sZS5sb2coczNEZWxldGVDb21tYW5kT3V0cHV0LCAnIHMzRGVsZXRlQ29tbWFuZE91dHB1dCcpO1xuXG4gICAgICAgIHJldHVybiBwcm9jZXNzUXVldWVNZXNzYWdlKGJvZHkpO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUubG9nKGUsICcgdW5hYmxlIHRvIGV2ZW50IHRvIHZlY3RvcicpO1xuICB9XG59O1xuXG5leHBvcnQgZGVmYXVsdCBxdWV1ZVdvcmtlcjtcbiJdfQ==