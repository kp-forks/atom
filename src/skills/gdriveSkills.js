"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.listGoogleDriveFiles = listGoogleDriveFiles;
exports.getGoogleDriveFileMetadata = getGoogleDriveFileMetadata;
exports.triggerGoogleDriveFileIngestion = triggerGoogleDriveFileIngestion;
exports.getGDriveConnectionStatus = getGDriveConnectionStatus;
exports.disconnectGDrive = disconnectGDrive;
const axios_1 = __importDefault(require("axios"));
const constants_1 = require("../../atomic-docker/project/functions/atom-agent/_libs/constants");
const logger_1 = require("../../atomic-docker/project/functions/_utils/logger");
const GDRIVE_API_TIMEOUT = 20000; // Default for most GDrive ops
const GDRIVE_STATUS_TIMEOUT = 5000; // Shorter for status checks
const GDRIVE_DISCONNECT_TIMEOUT = 10000;
// Helper to construct SkillResponse from axios errors
function handleAxiosError(error, operationName) {
    if (error.response) {
        logger_1.logger.error(`[gdriveSkills:${operationName}] Error: ${error.response.status}`, error.response.data);
        const errData = error.response.data;
        return {
            ok: false,
            error: {
                code: errData?.error?.code || `HTTP_${error.response.status}`,
                message: errData?.error?.message || `Failed to ${operationName}. Status: ${error.response.status}`,
                details: errData?.error?.details || errData,
            },
        };
    }
    else if (error.request) {
        logger_1.logger.error(`[gdriveSkills:${operationName}] Error: No response received for ${operationName}`, error.request);
        return { ok: false, error: { code: 'NETWORK_ERROR', message: `No response received for ${operationName}.` } };
    }
    else {
        logger_1.logger.error(`[gdriveSkills:${operationName}] Error setting up request: ${error.message}`);
        return { ok: false, error: { code: 'REQUEST_SETUP_ERROR', message: `Error setting up request for ${operationName}: ${error.message}` } };
    }
}
async function listGoogleDriveFiles(userId, folderId, query, pageSize = 50, pageToken) {
    if (!constants_1.PYTHON_API_SERVICE_BASE_URL) {
        return { ok: false, error: { code: 'CONFIG_ERROR', message: 'PYTHON_API_SERVICE_BASE_URL not configured.' } };
    }
    if (!userId) {
        return { ok: false, error: { code: 'VALIDATION_ERROR', message: 'userId is required to list Google Drive files.' } };
    }
    // No longer directly fetching access_token here; backend will handle it.
    const endpoint = `${constants_1.PYTHON_API_SERVICE_BASE_URL}/api/gdrive/list-files`;
    const payload = {
        user_id: userId, // Send user_id instead of access_token
        folder_id: folderId,
        query: query,
        page_size: pageSize,
        page_token: pageToken
    };
    logger_1.logger.info(`[listGoogleDriveFiles] Listing GDrive files for user ${userId}. Folder: ${folderId || 'root/all'}, Query: ${query || 'none'}`);
    try {
        // Python endpoint now returns SkillResponse-like structure directly
        const response = await axios_1.default.post(endpoint, payload, { timeout: GDRIVE_API_TIMEOUT });
        if (response.data && response.data.ok && response.data.data) {
            logger_1.logger.info(`[listGoogleDriveFiles] Successfully listed ${response.data.data.files?.length || 0} GDrive files for user ${userId}.`);
            return { ok: true, data: response.data.data };
        }
        else if (response.data && !response.data.ok && response.data.error) {
            logger_1.logger.warn(`[listGoogleDriveFiles] Failed for user ${userId}. API Error:`, response.data.error);
            return { ok: false, error: response.data.error };
        }
        else {
            // Fallback for unexpected response structure
            logger_1.logger.warn(`[listGoogleDriveFiles] Failed for user ${userId}. Unexpected response structure.`, response.data);
            return { ok: false, error: { code: 'UNEXPECTED_RESPONSE', message: 'Unexpected response from GDrive list files API.' } };
        }
    }
    catch (error) {
        return handleAxiosError(error, 'listGoogleDriveFiles');
    }
}
async function getGoogleDriveFileMetadata(userId, fileId, fields // Optional fields string for the API
) {
    if (!constants_1.PYTHON_API_SERVICE_BASE_URL) {
        return { ok: false, error: { code: 'CONFIG_ERROR', message: 'PYTHON_API_SERVICE_BASE_URL not configured.' } };
    }
    if (!userId)
        return { ok: false, error: { code: 'VALIDATION_ERROR', message: 'userId is required.' } };
    if (!fileId)
        return { ok: false, error: { code: 'VALIDATION_ERROR', message: 'fileId is required.' } };
    // No longer directly fetching access_token here.
    const endpoint = `${constants_1.PYTHON_API_SERVICE_BASE_URL}/api/gdrive/get-file-metadata`;
    const payload = {
        user_id: userId,
        file_id: fileId
    };
    if (fields)
        payload.fields = fields;
    logger_1.logger.info(`[getGoogleDriveFileMetadata] Fetching metadata for GDrive file ID ${fileId} for user ${userId}`);
    try {
        const response = await axios_1.default.post(endpoint, payload, { timeout: GDRIVE_API_TIMEOUT });
        if (response.data && response.data.ok && response.data.data) {
            logger_1.logger.info(`[getGoogleDriveFileMetadata] Successfully fetched metadata for GDrive file ID ${fileId}`);
            return { ok: true, data: response.data.data };
        }
        else if (response.data && !response.data.ok && response.data.error) {
            logger_1.logger.warn(`[getGoogleDriveFileMetadata] Failed for file ID ${fileId}. API Error:`, response.data.error);
            return { ok: false, error: response.data.error };
        }
        else {
            logger_1.logger.warn(`[getGoogleDriveFileMetadata] Failed for file ID ${fileId}. Unexpected response.`, response.data);
            return { ok: false, error: { code: 'UNEXPECTED_RESPONSE', message: 'Unexpected response from GDrive get metadata API.' } };
        }
    }
    catch (error) {
        return handleAxiosError(error, 'getGoogleDriveFileMetadata');
    }
}
async function triggerGoogleDriveFileIngestion(userId, gdriveFileId, originalFileMetadata) {
    if (!constants_1.PYTHON_API_SERVICE_BASE_URL) {
        return { ok: false, error: { code: 'CONFIG_ERROR', message: 'PYTHON_API_SERVICE_BASE_URL not configured.' } };
    }
    if (!userId)
        return { ok: false, error: { code: 'VALIDATION_ERROR', message: 'userId is required.' } };
    if (!gdriveFileId)
        return { ok: false, error: { code: 'VALIDATION_ERROR', message: 'gdriveFileId is required.' } };
    if (!originalFileMetadata || !originalFileMetadata.name || !originalFileMetadata.mimeType) {
        return { ok: false, error: { code: 'VALIDATION_ERROR', message: 'originalFileMetadata (with name and mimeType) is required.' } };
    }
    // No longer directly fetching access_token here.
    const endpoint = `${constants_1.PYTHON_API_SERVICE_BASE_URL}/api/ingest-gdrive-document`;
    const payload = {
        user_id: userId,
        gdrive_file_id: gdriveFileId,
        original_file_metadata: originalFileMetadata,
    };
    logger_1.logger.info(`[triggerGoogleDriveFileIngestion] Triggering ingestion for GDrive file ID ${gdriveFileId} for user ${userId}`);
    try {
        const response = await axios_1.default.post(endpoint, payload, { timeout: GDRIVE_API_TIMEOUT * 2 });
        if (response.data && response.data.ok && response.data.data) {
            logger_1.logger.info(`[triggerGoogleDriveFileIngestion] Successfully triggered ingestion for GDrive file ${gdriveFileId}. Doc ID: ${response.data.data.doc_id}`);
            return { ok: true, data: response.data.data };
        }
        else if (response.data && !response.data.ok && response.data.error) {
            logger_1.logger.warn(`[triggerGoogleDriveFileIngestion] Failed. API Error:`, response.data.error);
            return { ok: false, error: response.data.error };
        }
        else {
            logger_1.logger.warn(`[triggerGoogleDriveFileIngestion] Failed. Unexpected response.`, response.data);
            return { ok: false, error: { code: 'UNEXPECTED_RESPONSE', message: 'Unexpected response from GDrive trigger ingestion API.' } };
        }
    }
    catch (error) {
        return handleAxiosError(error, 'triggerGoogleDriveFileIngestion');
    }
}
// --- New functions for GDrive Connection Management ---
async function getGDriveConnectionStatus(userId) {
    if (!constants_1.PYTHON_API_SERVICE_BASE_URL) {
        return { ok: false, error: { code: 'CONFIG_ERROR', message: 'PYTHON_API_SERVICE_BASE_URL not configured.' } };
    }
    if (!userId)
        return { ok: false, error: { code: 'VALIDATION_ERROR', message: 'userId is required.' } };
    const endpoint = `${constants_1.PYTHON_API_SERVICE_BASE_URL}/api/gdrive/connection-status?user_id=${userId}`;
    logger_1.logger.info(`[getGDriveConnectionStatus] Checking GDrive connection status for user ${userId}`);
    try {
        const response = await axios_1.default.get(endpoint, { timeout: GDRIVE_STATUS_TIMEOUT });
        if (response.data && response.data.ok && typeof response.data.data?.isConnected === 'boolean') {
            logger_1.logger.info(`[getGDriveConnectionStatus] Status for user ${userId}: Connected - ${response.data.data.isConnected}, Email - ${response.data.data.email}`);
            return { ok: true, data: response.data.data };
        }
        else if (response.data && !response.data.ok && response.data.error) {
            logger_1.logger.warn(`[getGDriveConnectionStatus] Failed. API Error:`, response.data.error);
            return { ok: false, error: response.data.error };
        }
        else {
            logger_1.logger.warn(`[getGDriveConnectionStatus] Failed. Unexpected response.`, response.data);
            return { ok: false, error: { code: 'UNEXPECTED_RESPONSE', message: 'Unexpected response from GDrive connection status API.' } };
        }
    }
    catch (error) {
        return handleAxiosError(error, 'getGDriveConnectionStatus');
    }
}
async function disconnectGDrive(userId) {
    if (!constants_1.PYTHON_API_SERVICE_BASE_URL) {
        return { ok: false, error: { code: 'CONFIG_ERROR', message: 'PYTHON_API_SERVICE_BASE_URL not configured.' } };
    }
    if (!userId)
        return { ok: false, error: { code: 'VALIDATION_ERROR', message: 'userId is required.' } };
    const endpoint = `${constants_1.PYTHON_API_SERVICE_BASE_URL}/api/auth/gdrive/disconnect`;
    const payload = { user_id: userId };
    logger_1.logger.info(`[disconnectGDrive] Disconnecting GDrive for user ${userId}`);
    try {
        const response = await axios_1.default.post(endpoint, payload, { timeout: GDRIVE_DISCONNECT_TIMEOUT });
        if (response.data && response.data.ok) {
            logger_1.logger.info(`[disconnectGDrive] Successfully disconnected GDrive for user ${userId}. Message: ${response.data.message}`);
            return { ok: true, data: { message: response.data.message || "Successfully disconnected." }, message: response.data.message };
        }
        else if (response.data && !response.data.ok && response.data.error) {
            logger_1.logger.warn(`[disconnectGDrive] Failed. API Error:`, response.data.error);
            return { ok: false, error: response.data.error };
        }
        else {
            logger_1.logger.warn(`[disconnectGDrive] Failed. Unexpected response.`, response.data);
            return { ok: false, error: { code: 'UNEXPECTED_RESPONSE', message: 'Unexpected response from GDrive disconnect API.' } };
        }
    }
    catch (error) {
        return handleAxiosError(error, 'disconnectGDrive');
    }
}
`` `
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2RyaXZlU2tpbGxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZ2RyaXZlU2tpbGxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBa0VBLG9EQTJDQztBQUVELGdFQW1DQztBQUVELDBFQTBDQztBQUlELDhEQXdCQztBQUVELDRDQXlCQztBQXJQRCxrREFBMEM7QUFJMUMsZ0dBQStHO0FBQy9HLGdGQUE2RTtBQUU3RSxNQUFNLGtCQUFrQixHQUFHLEtBQUssQ0FBQyxDQUFDLDhCQUE4QjtBQUNoRSxNQUFNLHFCQUFxQixHQUFHLElBQUksQ0FBQyxDQUFDLDRCQUE0QjtBQUNoRSxNQUFNLHlCQUF5QixHQUFHLEtBQUssQ0FBQztBQW1DeEMsc0RBQXNEO0FBQ3RELFNBQVMsZ0JBQWdCLENBQUMsS0FBaUIsRUFBRSxhQUFxQjtJQUNoRSxJQUFJLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNuQixlQUFNLENBQUMsS0FBSyxDQUFDLGlCQUFpQixhQUFhLFlBQVksS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JHLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBVyxDQUFDO1FBQzNDLE9BQU87WUFDTCxFQUFFLEVBQUUsS0FBSztZQUNULEtBQUssRUFBRTtnQkFDTCxJQUFJLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLElBQUksUUFBUSxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRTtnQkFDN0QsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsT0FBTyxJQUFJLGFBQWEsYUFBYSxhQUFhLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFO2dCQUNsRyxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxPQUFPLElBQUksT0FBTzthQUM1QztTQUNGLENBQUM7SUFDSixDQUFDO1NBQU0sSUFBSSxLQUFL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SSxDQUFDLHVDQUF1QyxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDMUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDbkQsQ0FBQzthQUFNLENBQUM7WUFDTixlQUFNLENBQUMsSUFBSSxDQUFDLGlEQUFpRCxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM5RSxPQUFPLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRSxJQUFJLEVBQUUscUJBQXFCLEVBQUUsT0FBTyxFQUFFLGlEQUFpRCxFQUFFLEVBQUMsQ0FBQztRQUMxSCxDQUFDO0lBQ0gsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLGdCQUFnQixDQUFDLEtBQW1CLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztJQUNuRSxDQUFDO0FBQ0gsQ0FBQztBQUVELEVBQUUsQ0FBQTtBQUNGLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXhpb3MsIHsgQXhpb3NFcnJvciB9IGZyb20gJ2F4aW9zJztcbmltcG9ydCB7XG4gIFNraWxsUmVzcG9uc2UsXG59IGZyb20gJy4uLy4uL2F0b21pYy1kb2NrZXIvcHJvamVjdC9mdW5jdGlvbnMvYXRvbS1hZ2VudC90eXBlcyc7XG5pbXBvcnQgeyBQWVRIT05fQVBJX1NFUlZJQ0VfQkFTRV9VUkwgfSBmcm9tICcuLi8uLi9hdG9taWMtZG9ja2VyL3Byb2plY3QvZnVuY3Rpb25zL2F0b20tYWdlbnQvX2xpYnMvY29uc3RhbnRzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uLy4uL2F0b21pYy1kb2NrZXIvcHJvamVjdC9mdW5jdGlvbnMvX3V0aWxzL2xvZ2dlcic7XG5cbmNvbnN0IEdEUklWRV9BUElfVElNRU9VVCA9IDIwMDAwOyAvLyBEZWZhdWx0IGZvciBtb3N0IEdEcml2ZSBvcHNcbmNvbnN0IEdEUklWRV9TVEFUVVNfVElNRU9VVCA9IDUwMDA7IC8vIFNob3J0ZXIgZm9yIHN0YXR1cyBjaGVja3NcbmNvbnN0IEdEUklWRV9ESVNDT05ORUNUX1RJTUVPVVQgPSAxMDAwMDtcblxuLy8gSW50ZXJmYWNlIGZvciBHRHJpdmUgQ29ubmVjdGlvbiBTdGF0dXNcbmV4cG9ydCBpbnRlcmZhY2UgR0RyaXZlQ29ubmVjdGlvblN0YXR1c0luZm8ge1xuICBpc0Nvbm5lY3RlZDogYm9vbGVhbjtcbiAgZW1haWw/OiBzdHJpbmc7XG4gIHJlYXNvbj86IHN0cmluZztcbn1cblxuLy8gVXBkYXRlZCBJbnRlcmZhY2UgZm9yIEdvb2dsZSBEcml2ZSBmaWxlIG1ldGFkYXRhXG5leHBvcnQgaW50ZXJmYWNlIEdvb2dsZURyaXZlRmlsZSB7XG4gIGlkOiBzdHJpbmc7XG4gIG5hbWU6IHN0cmluZztcbiAgbWltZVR5cGU6IHN0cmluZztcbiAgbW9kaWZpZWRUaW1lPzogc3RyaW5nOyAvLyBJU08gODYwMSBzdHJpbmcgZnJvbSBEcml2ZSBBUElcbiAgd2ViVmlld0xpbms/OiBzdHJpbmc7XG4gIHBhcmVudHM/OiBzdHJpbmdbXTtcbiAgY2FwYWJpbGl0aWVzPzoge1xuICAgIGNhbkRvd25sb2FkPzogYm9vbGVhbjtcbiAgICBjYW5FeHBvcnQ/OiBib29sZWFuO1xuICB9O1xuICBleHBvcnRMaW5rcz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz47IC8vIGUuZy4sIHsgXCJhcHBsaWNhdGlvbi9wZGZcIjogXCIuLi5cIiwgXCJ0ZXh0L2h0bWxcIjogXCIuLi5cIiB9XG4gIHNob3J0Y3V0RGV0YWlscz86IHtcbiAgICB0YXJnZXRJZDogc3RyaW5nO1xuICAgIHRhcmdldE1pbWVUeXBlPzogc3RyaW5nO1xuICB9O1xuICAvLyBGaWVsZHMgYWRkZWQgYnkgb3VyIGdkcml2ZV9zZXJ2aWNlIHdoZW4gYSBzaG9ydGN1dCBpcyByZXNvbHZlZDpcbiAgaXNfc2hvcnRjdXRfdG8/OiB7XG4gICAgc2hvcnRjdXRJZDogc3RyaW5nO1xuICAgIHNob3J0Y3V0TmFtZT86IHN0cmluZztcbiAgICBzaG9ydGN1dFdlYlZpZXdMaW5rPzogc3RyaW5nO1xuICB9O1xuICBvcmlnaW5hbF9zaG9ydGN1dF9pZF9pZl9hcHBsaWNhYmxlPzogc3RyaW5nO1xufVxuXG4vLyBIZWxwZXIgdG8gY29uc3RydWN0IFNraWxsUmVzcG9uc2UgZnJvbSBheGlvcyBlcnJvcnNcbmZ1bmN0aW9uIGhhbmRsZUF4aW9zRXJyb3IoZXJyb3I6IEF4aW9zRXJyb3IsIG9wZXJhdGlvbk5hbWU6IHN0cmluZyk6IFNraWxsUmVzcG9uc2U8bnVsbD4ge1xuICBpZiAoZXJyb3IucmVzcG9uc2UpIHtcbiAgICBsb2dnZXIuZXJyb3IoYFtnZHJpdmVTa2lsbHM6JHtvcGVyYXRpb25OYW1lfV0gRXJyb3I6ICR7ZXJyb3IucmVzcG9uc2Uuc3RhdHVzfWAsIGVycm9yLnJlc3BvbnNlLmRhdGEpO1xuICAgIGNvbnN0IGVyckRhdGEgPSBlcnJvci5yZXNwb25zZS5kYXRhIGFzIGFueTtcbiAgICByZXR1cm4ge1xuICAgICAgb2s6IGZhbHNlLFxuICAgICAgZXJyb3I6IHtcbiAgICAgICAgY29kZTogZXJyRGF0YT8uZXJyb3I/LmNvZGUgfHwgYEhUVFBfJHtlcnJvci5yZXNwb25zZS5zdGF0dXN9YCxcbiAgICAgICAgbWVzc2FnZTogZXJyRGF0YT8uZXJyb3I/Lm1lc3NhZ2UgfHwgYEZhaWxlZCB0byAke29wZXJhdGlvbk5hbWV9LiBTdGF0dXM6ICR7ZXJyb3IucmVzcG9uc2Uuc3RhdHVzfWAsXG4gICAgICAgIGRldGFpbHM6IGVyckRhdGE/LmVycm9yPy5kZXRhaWxzIHx8IGVyckRhdGEsXG4gICAgICB9LFxuICAgIH07XG4gIH0gZWxzZSBpZiAoZXJyb3IucmVxdWVzdCkge1xuICAgIGxvZ2dlci5lcnJvcihgW2dkcml2ZVNraWxsczoke29wZXJhdGlvbk5hbWV9XSBFcnJvcjogTm8gcmVzcG9uc2UgcmVjZWl2ZWQgZm9yICR7b3BlcmF0aW9uTmFtZX1gLCBlcnJvci5yZXF1ZXN0KTtcbiAgICByZXR1cm4geyBvazogZmFsc2UsIGVycm9yOiB7IGNvZGU6ICdORVRXT1JLX0VSUk9SJywgbWVzc2FnZTogYE5vIHJlc3BvbnNlIHJlY2VpdmVkIGZvciAke29wZXJhdGlvbk5hbWV9LmAgfSB9O1xuICB9IGVsc2Uge1xuICAgIGxvZ2dlci5lcnJvcihgW2dkcml2ZVNraWxsczoke29wZXJhdGlvbk5hbWV9XSBFcnJvciBzZXR0aW5nIHVwIHJlcXVlc3Q6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICByZXR1cm4geyBvazogZmFsc2UsIGVycm9yOiB7IGNvZGU6ICdSRVFVRVNUX1NFVFVQX0VSUk9SJywgbWVzc2FnZTogYEVycm9yIHNldHRpbmcgdXAgcmVxdWVzdCBmb3IgJHtvcGVyYXRpb25OYW1lfTogJHtlcnJvci5tZXNzYWdlfWAgfSB9O1xuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsaXN0R29vZ2xlRHJpdmVGaWxlcyhcbiAgdXNlcklkOiBzdHJpbmcsXG4gIGZvbGRlcklkPzogc3RyaW5nLFxuICBxdWVyeT86IHN0cmluZyxcbiAgcGFnZVNpemU6IG51bWJlciA9IDUwLFxuICBwYWdlVG9rZW4/OiBzdHJpbmdcbik6IFByb21pc2U8U2tpbGxSZXNwb25zZTx7IGZpbGVzOiBHb29nbGVEcml2ZUZpbGVbXTsgbmV4dFBhZ2VUb2tlbj86IHN0cmluZyB9Pj4ge1xuICBpZiAoIVBZVEhPTl9BUElfU0VSVklDRV9CQVNFX1VSTCkge1xuICAgIHJldHVybiB7IG9rOiBmYWxzZSwgZXJyb3I6IHsgY29kZTogJ0NPTkZJR19FUlJPUicsIG1lc3NhZ2U6ICdQWVRIT05fQVBJX1NFUlZJQ0VfQkFTRV9VUkwgbm90IGNvbmZpZ3VyZWQuJyB9fTtcbiAgfVxuICBpZiAoIXVzZXJJZCkge1xuICAgIHJldHVybiB7IG9rOiBmYWxzZSwgZXJyb3I6IHsgY29kZTogJ1ZBTElEQVRJT05fRVJST1InLCBtZXNzYWdlOiAndXNlcklkIGlzIHJlcXVpcmVkIHRvIGxpc3QgR29vZ2xlIERyaXZlIGZpbGVzLicgfX07XG4gIH1cblxuICAvLyBObyBsb25nZXIgZGlyZWN0bHkgZmV0Y2hpbmcgYWNjZXNzX3Rva2VuIGhlcmU7IGJhY2tlbmQgd2lsbCBoYW5kbGUgaXQuXG4gIGNvbnN0IGVuZHBvaW50ID0gYCR7UFlUSE9OX0FQSV9TRVJWSUNFX0JBU0VfVVJMfS9hcGkvZ2RyaXZlL2xpc3QtZmlsZXNgO1xuICBjb25zdCBwYXlsb2FkID0ge1xuICAgIHVzZXJfaWQ6IHVzZXJJZCwgLy8gU2VuZCB1c2VyX2lkIGluc3RlYWQgb2YgYWNjZXNzX3Rva2VuXG4gICAgZm9sZGVyX2lkOiBmb2xkZXJJZCxcbiAgICBxdWVyeTogcXVlcnksXG4gICAgcGFnZV9zaXplOiBwYWdlU2l6ZSxcbiAgICBwYWdlX3Rva2VuOiBwYWdlVG9rZW5cbiAgfTtcbiAgbG9nZ2VyLmluZm8oYFtsaXN0R29vZ2xlRHJpdmVGaWxlc10gTGlzdGluZyBHRHJpdmUgZmlsZXMgZm9yIHVzZXIgJHt1c2VySWR9LiBGb2xkZXI6ICR7Zm9sZGVySWQgfHwgJ3Jvb3QvYWxsJ30sIFF1ZXJ5OiAke3F1ZXJ5IHx8ICdub25lJ31gKTtcblxuICB0cnkge1xuICAgIC8vIFB5dGhvbiBlbmRwb2ludCBub3cgcmV0dXJucyBTa2lsbFJlc3BvbnNlLWxpa2Ugc3RydWN0dXJlIGRpcmVjdGx5XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5wb3N0PFNraWxsUmVzcG9uc2U8eyBmaWxlczogR29vZ2xlRHJpdmVGaWxlW107IG5leHRQYWdlVG9rZW4/OiBzdHJpbmcgfT4+KGVuZHBvaW50LCBwYXlsb2FkLCB7IHRpbWVvdXQ6IEdEUklWRV9BUElfVElNRU9VVCB9KTtcblxuICAgIGlmIChyZXNwb25zZS5kYXRhICYmIHJlc3BvbnNlLmRhdGEub2sgJiYgcmVzcG9uc2UuZGF0YS5kYXRhKSB7XG4gICAgICBsb2dnZXIuaW5mbyhgW2xpc3RHb29nbGVEcml2ZUZpbGVzXSBTdWNjZXNzZnVsbHkgbGlzdGVkICR7cmVzcG9uc2UuZGF0YS5kYXRhLmZpbGVzPy5sZW5ndGggfHwgMH0gR0RyaXZlIGZpbGVzIGZvciB1c2VyICR7dXNlcklkfS5gKTtcbiAgICAgIHJldHVybiB7IG9rOiB0cnVlLCBkYXRhOiByZXNwb25zZS5kYXRhLmRhdGEgfTtcbiAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEgJiYgIXJlc3BvbnNlLmRhdGEub2sgJiYgcmVzcG9uc2UuZGF0YS5lcnJvcikge1xuICAgICAgbG9nZ2VyLndhcm4oYFtsaXN0R29vZ2xlRHJpdmVGaWxlc10gRmFpbGVkIGZvciB1c2VyICR7dXNlcklkfS4gQVBJIEVycm9yOmAsIHJlc3BvbnNlLmRhdGEuZXJyb3IpO1xuICAgICAgcmV0dXJuIHsgb2s6IGZhbHNlLCBlcnJvcjogcmVzcG9uc2UuZGF0YS5lcnJvciB9O1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBGYWxsYmFjayBmb3IgdW5leHBlY3RlZCByZXNwb25zZSBzdHJ1Y3R1cmVcbiAgICAgIGxvZ2dlci53YXJuKGBbbGlzdEdvb2dsZURyaXZlRmlsZXNdIEZhaWxlZCBmb3IgdXNlciAke3VzZXJJZH0uIFVuZXhwZWN0ZWQgcmVzcG9uc2Ugc3RydWN0dXJlLmAsIHJlc3BvbnNlLmRhdGEpO1xuICAgICAgcmV0dXJuIHsgb2s6IGZhbHNlLCBlcnJvcjogeyBjb2RlOiAnVU5FWFBFQ1RFRF9SRVNQT05TRScsIG1lc3NhZ2U6ICdVbmV4cGVjdGVkIHJlc3BvbnNlIGZyb20gR0RyaXZlIGxpc3QgZmlsZXMgQVBJLicgfX07XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHJldHVybiBoYW5kbGVBeGlvc0Vycm9yKGVycm9yIGFzIEF4aW9zRXJyb3IsICdsaXN0R29vZ2xlRHJpdmVGaWxlcycpO1xuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRHb29nbGVEcml2ZUZpbGVNZXRhZGF0YShcbiAgdXNlcklkOiBzdHJpbmcsXG4gIGZpbGVJZDogc3RyaW5nLFxuICBmaWVsZHM/OiBzdHJpbmcgLy8gT3B0aW9uYWwgZmllbGRzIHN0cmluZyBmb3IgdGhlIEFQSVxuKTogUHJvbWlzZTxTa2lsbFJlc3BvbnNlPEdvb2dsZURyaXZlRmlsZT4+IHtcbiAgaWYgKCFQWVRIT05fQVBJX1NFUlZJQ0VfQkFTRV9VUkwpIHtcbiAgICByZXR1cm4geyBvazogZmFsc2UsIGVycm9yOiB7IGNvZGU6ICdDT05GSUdfRVJST1InLCBtZXNzYWdlOiAnUFlUSE9OX0FQSV9TRVJWSUNFX0JBU0VfVVJMIG5vdCBjb25maWd1cmVkLicgfX07XG4gIH1cbiAgaWYgKCF1c2VySWQpIHJldHVybiB7IG9rOiBmYWxzZSwgZXJyb3I6IHsgY29kZTogJ1ZBTElEQVRJT05fRVJST1InLCBtZXNzYWdlOiAndXNlcklkIGlzIHJlcXVpcmVkLicgfX07XG4gIGlmICghZmlsZUlkKSByZXR1cm4geyBvazogZmFsc2UsIGVycm9yOiB7IGNvZGU6ICdWQUxJREFUSU9OX0VSUk9SJywgbWVzc2FnZTogJ2ZpbGVJZCBpcyByZXF1aXJlZC4nIH19O1xuXG4gIC8vIE5vIGxvbmdlciBkaXJlY3RseSBmZXRjaGluZyBhY2Nlc3NfdG9rZW4gaGVyZS5cbiAgY29uc3QgZW5kcG9pbnQgPSBgJHtQWVRIT05fQVBJX1NFUlZJQ0VfQkFTRV9VUkx9L2FwaS9nZHJpdmUvZ2V0LWZpbGUtbWV0YWRhdGFgO1xuICBjb25zdCBwYXlsb2FkOiB7IHVzZXJfaWQ6IHN0cmluZzsgZmlsZV9pZDogc3RyaW5nOyBmaWVsZHM/OiBzdHJpbmcgfSA9IHsgLy8gdXNlcl9pZCBpbnN0ZWFkIG9mIGFjY2Vzc190b2tlblxuICAgIHVzZXJfaWQ6IHVzZXJJZCxcbiAgICBmaWxlX2lkOiBmaWxlSWRcbiAgfTtcbiAgaWYgKGZpZWxkcykgcGF5bG9hZC5maWVsZHMgPSBmaWVsZHM7XG5cbiAgbG9nZ2VyLmluZm8oYFtnZXRHb29nbGVEcml2ZUZpbGVNZXRhZGF0YV0gRmV0Y2hpbmcgbWV0YWRhdGEgZm9yIEdEcml2ZSBmaWxlIElEICR7ZmlsZUlkfSBmb3IgdXNlciAke3VzZXJJZH1gKTtcbiAgdHJ5IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGF4aW9zLnBvc3Q8U2tpbGxSZXNwb25zZTxHb29nbGVEcml2ZUZpbGU+PihlbmRwb2ludCwgcGF5bG9hZCwgeyB0aW1lb3V0OiBHRFJJVkVfQVBJX1RJTUVPVVQgfSk7XG4gICAgaWYgKHJlc3BvbnNlLmRhdGEgJiYgcmVzcG9uc2UuZGF0YS5vayAmJiByZXNwb25zZS5kYXRhLmRhdGEpIHtcbiAgICAgIGxvZ2dlci5pbmZvKGBbZ2V0R29vZ2xlRHJpdmVGaWxlTWV0YWRhdGFdIFN1Y2Nlc3NmdWxseSBmZXRjaGVkIG1ldGFkYXRhIGZvciBHRHJpdmUgZmlsZSBJRCAke2ZpbGVJZH1gKTtcbiAgICAgIHJldHVybiB7IG9rOiB0cnVlLCBkYXRhOiByZXNwb25zZS5kYXRhLmRhdGEgfTtcbiAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEgJiYgIXJlc3BvbnNlLmRhdGEub2sgJiYgcmVzcG9uc2UuZGF0YS5lcnJvcikge1xuICAgICAgbG9nZ2VyLndhcm4oYFtnZXRHb29nbGVEcml2ZUZpbGVNZXRhZGF0YV0gRmFpbGVkIGZvciBmaWxlIElEICR7ZmlsZUlkfS4gQVBJIEVycm9yOmAsIHJlc3BvbnNlLmRhdGEuZXJyb3IpO1xuICAgICAgcmV0dXJuIHsgb2s6IGZhbHNlLCBlcnJvcjogcmVzcG9uc2UuZGF0YS5lcnJvciB9O1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIud2FybihgW2dldEdvb2dsZURyaXZlRmlsZU1ldGFkYXRhXSBGYWlsZWQgZm9yIGZpbGUgSUQgJHtmaWxlSWR9LiBVbmV4cGVjdGVkIHJlc3BvbnNlLmAsIHJlc3BvbnNlLmRhdGEpO1xuICAgICAgcmV0dXJuIHsgb2s6IGZhbHNlLCBlcnJvcjogeyBjb2RlOiAnVU5FWFBFQ1RFRF9SRVNQT05TRScsIG1lc3NhZ2U6ICdVbmV4cGVjdGVkIHJlc3BvbnNlIGZyb20gR0RyaXZlIGdldCBtZXRhZGF0YSBBUEkuJyB9fTtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIGhhbmRsZUF4aW9zRXJyb3IoZXJyb3IgYXMgQXhpb3NFcnJvciwgJ2dldEdvb2dsZURyaXZlRmlsZU1ldGFkYXRhJyk7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHRyaWdnZXJHb29nbGVEcml2ZUZpbGVJbmdlc3Rpb24oXG4gIHVzZXJJZDogc3RyaW5nLFxuICBnZHJpdmVGaWxlSWQ6IHN0cmluZyxcbiAgb3JpZ2luYWxGaWxlTWV0YWRhdGE6IHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgbWltZVR5cGU6IHN0cmluZztcbiAgICB3ZWJWaWV3TGluaz86IHN0cmluZztcbiAgfVxuKTogUHJvbWlzZTxTa2lsbFJlc3BvbnNlPHsgZG9jX2lkOiBzdHJpbmc7IG51bV9jaHVua3Nfc3RvcmVkOiBudW1iZXIgfSB8IG51bGwgPj4ge1xuICBpZiAoIVBZVEhPTl9BUElfU0VSVklDRV9CQVNFX1VSTCkge1xuICAgICByZXR1cm4geyBvazogZmFsc2UsIGVycm9yOiB7IGNvZGU6ICdDT05GSUdfRVJST1InLCBtZXNzYWdlOiAnUFlUSE9OX0FQSV9TRVJWSUNFX0JBU0VfVVJMIG5vdCBjb25maWd1cmVkLicgfX07XG4gIH1cbiAgaWYgKCF1c2VySWQpIHJldHVybiB7IG9rOiBmYWxzZSwgZXJyb3I6IHtjb2RlOiAnVkFMSURBVElPTl9FUlJPUicsIG1lc3NhZ2U6ICd1c2VySWQgaXMgcmVxdWlyZWQuJ319O1xuICBpZiAoIWdkcml2ZUZpbGVJZCkgcmV0dXJuIHsgb2s6IGZhbHNlLCBlcnJvcjoge2NvZGU6ICdWQUxJREFUSU9OX0VSUk9SJywgbWVzc2FnZTogJ2dkcml2ZUZpbGVJZCBpcyByZXF1aXJlZC4nfX07XG4gIGlmICghb3JpZ2luYWxGaWxlTWV0YWRhdGEgfHwgIW9yaWdpbmFsRmlsZU1ldGFkYXRhLm5hbWUgfHwgIW9yaWdpbmFsRmlsZU1ldGFkYXRhLm1pbWVUeXBlKSB7XG4gICAgcmV0dXJuIHsgb2s6IGZhbHNlLCBlcnJvcjoge2NvZGU6ICdWQUxJREFUSU9OX0VSUk9SJywgbWVzc2FnZTogJ29yaWdpbmFsRmlsZU1ldGFkYXRhICh3aXRoIG5hbWUgYW5kIG1pbWVUeXBlKSBpcyByZXF1aXJlZC4nfX07XG4gIH1cblxuICAvLyBObyBsb25nZXIgZGlyZWN0bHkgZmV0Y2hpbmcgYWNjZXNzX3Rva2VuIGhlcmUuXG4gIGNvbnN0IGVuZHBvaW50ID0gYCR7UFlUSE9OX0FQSV9TRVJWSUNFX0JBU0VfVVJMfS9hcGkvaW5nZXN0LWdkcml2ZS1kb2N1bWVudGA7XG4gIGNvbnN0IHBheWxvYWQgPSB7IC8vIHVzZXJfaWQgaW5zdGVhZCBvZiBhY2Nlc3NfdG9rZW5cbiAgICB1c2VyX2lkOiB1c2VySWQsXG4gICAgZ2RyaXZlX2ZpbGVfaWQ6IGdkcml2ZUZpbGVJZCxcbiAgICBvcmlnaW5hbF9maWxlX21ldGFkYXRhOiBvcmlnaW5hbEZpbGVNZXRhZGF0YSxcbiAgfTtcblxuICBsb2dnZXIuaW5mbyhgW3RyaWdnZXJHb29nbGVEcml2ZUZpbGVJbmdlc3Rpb25dIFRyaWdnZXJpbmcgaW5nZXN0aW9uIGZvciBHRHJpdmUgZmlsZSBJRCAke2dkcml2ZUZpbGVJZH0gZm9yIHVzZXIgJHt1c2VySWR9YCk7XG4gIHRyeSB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5wb3N0PFNraWxsUmVzcG9uc2U8eyBkb2NfaWQ6IHN0cmluZzsgbnVtX2NodW5rc19zdG9yZWQ6IG51bWJlciB9IHwgbnVsbCA+PihlbmRwb2ludCwgcGF5bG9hZCwgeyB0aW1lb3V0OiBHRFJJVkVfQVBJX1RJTUVPVVQgKiAyIH0pO1xuICAgIGlmIChyZXNwb25zZS5kYXRhICYmIHJlc3BvbnNlLmRhdGEub2sgJiYgcmVzcG9uc2UuZGF0YS5kYXRhKSB7XG4gICAgICBsb2dnZXIuaW5mbyhgW3RyaWdnZXJHb29nbGVEcml2ZUZpbGVJbmdlc3Rpb25dIFN1Y2Nlc3NmdWxseSB0cmlnZ2VyZWQgaW5nZXN0aW9uIGZvciBHRHJpdmUgZmlsZSAke2dkcml2ZUZpbGVJZH0uIERvYyBJRDogJHtyZXNwb25zZS5kYXRhLmRhdGEuZG9jX2lkfWApO1xuICAgICAgcmV0dXJuIHsgb2s6IHRydWUsIGRhdGE6IHJlc3BvbnNlLmRhdGEuZGF0YSB9O1xuICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YSAmJiAhcmVzcG9uc2UuZGF0YS5vayAmJiByZXNwb25zZS5kYXRhLmVycm9yKSB7XG4gICAgICBsb2dnZXIud2FybihgW3RyaWdnZXJHb29nbGVEcml2ZUZpbGVJbmdlc3Rpb25dIEZhaWxlZC4gQVBJIEVycm9yOmAsIHJlc3BvbnNlLmRhdGEuZXJyb3IpO1xuICAgICAgcmV0dXJuIHsgb2s6IGZhbHNlLCBlcnJvcjogcmVzcG9uc2UuZGF0YS5lcnJvciB9O1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIud2FybihgW3RyaWdnZXJHb29nbGVEcml2ZUZpbGVJbmdlc3Rpb25dIEZhaWxlZC4gVW5leHBlY3RlZCByZXNwb25zZS5gLCByZXNwb25zZS5kYXRhKTtcbiAgICAgIHJldHVybiB7IG9rOiBmYWxzZSwgZXJyb3I6IHsgY29kZTogJ1VORVhQRUNURURfUkVTUE9OU0UnLCBtZXNzYWdlOiAnVW5leHBlY3RlZCByZXNwb25zZSBmcm9tIEdEcml2ZSB0cmlnZ2VyIGluZ2VzdGlvbiBBUEkuJyB9fTtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIGhhbmRsZUF4aW9zRXJyb3IoZXJyb3IgYXMgQXhpb3NFcnJvciwgJ3RyaWdnZXJHb29nbGVEcml2ZUZpbGVJbmdlc3Rpb24nKTtcbiAgfVxufVxuXG4vLyAtLS0gTmV3IGZ1bmN0aW9ucyBmb3IgR0RyaXZlIENvbm5lY3Rpb24gTWFuYWdlbWVudCAtLS1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEdEcml2ZUNvbm5lY3Rpb25TdGF0dXModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPFNraWxsUmVzcG9uc2U8R0RyaXZlQ29ubmVjdGlvblN0YXR1c0luZm8+PiB7XG4gIGlmICghUFlUSE9OX0FQSV9TRVJWSUNFX0JBU0VfVVJMKSB7XG4gICAgcmV0dXJuIHsgb2s6IGZhbHNlLCBlcnJvcjogeyBjb2RlOiAnQ09ORklHX0VSUk9SJywgbWVzc2FnZTogJ1BZVEhPTl9BUElfU0VSVklDRV9CQVNFX1VSTCBub3QgY29uZmlndXJlZC4nIH19O1xuICB9XG4gIGlmICghdXNlcklkKSByZXR1cm4geyBvazogZmFsc2UsIGVycm9yOiB7IGNvZGU6ICdWQUxJREFUSU9OX0VSUk9SJywgbWVzc2FnZTogJ3VzZXJJZCBpcyByZXF1aXJlZC4nIH19O1xuXG4gIGNvbnN0IGVuZHBvaW50ID0gYCR7UFlUSE9OX0FQSV9TRVJWSUNFX0JBU0VfVVJMfS9hcGkvZ2RyaXZlL2Nvbm5lY3Rpb24tc3RhdHVzP3VzZXJfaWQ9JHt1c2VySWR9YDtcbiAgbG9nZ2VyLmluZm8oYFtnZXRHRHJpdmVDb25uZWN0aW9uU3RhdHVzXSBDaGVja2luZyBHRHJpdmUgY29ubmVjdGlvbiBzdGF0dXMgZm9yIHVzZXIgJHt1c2VySWR9YCk7XG5cbiAgdHJ5IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGF4aW9zLmdldDxTa2lsbFJlc3BvbnNlPEdEcml2ZUNvbm5lY3Rpb25TdGF0dXNJbmZvPj4oZW5kcG9pbnQsIHsgdGltZW91dDogR0RSSVZFX1NUQVRVU19USU1FT1VUIH0pO1xuICAgIGlmIChyZXNwb25zZS5kYXRhICYmIHJlc3BvbnNlLmRhdGEub2sgJiYgdHlwZW9mIHJlc3BvbnNlLmRhdGEuZGF0YT8uaXNDb25uZWN0ZWQgPT09ICdib29sZWFuJykge1xuICAgICAgbG9nZ2VyLmluZm8oYFtnZXRHRHJpdmVDb25uZWN0aW9uU3RhdHVzXSBTdGF0dXMgZm9yIHVzZXIgJHt1c2VySWR9OiBDb25uZWN0ZWQgLSAke3Jlc3BvbnNlLmRhdGEuZGF0YS5pc0Nvbm5lY3RlZH0sIEVtYWlsIC0gJHtyZXNwb25zZS5kYXRhLmRhdGEuZW1haWx9YCk7XG4gICAgICByZXR1cm4geyBvazogdHJ1ZSwgZGF0YTogcmVzcG9uc2UuZGF0YS5kYXRhIH07XG4gICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhICYmICFyZXNwb25zZS5kYXRhLm9rICYmIHJlc3BvbnNlLmRhdGEuZXJyb3IpIHtcbiAgICAgIGxvZ2dlci53YXJuKGBbZ2V0R0RyaXZlQ29ubmVjdGlvblN0YXR1c10gRmFpbGVkLiBBUEkgRXJyb3I6YCwgcmVzcG9uc2UuZGF0YS5lcnJvcik7XG4gICAgICByZXR1cm4geyBvazogZmFsc2UsIGVycm9yOiByZXNwb25zZS5kYXRhLmVycm9yIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci53YXJuKGBbZ2V0R0RyaXZlQ29ubmVjdGlvblN0YXR1c10gRmFpbGVkLiBVbmV4cGVjdGVkIHJlc3BvbnNlLmAsIHJlc3BvbnNlLmRhdGEpO1xuICAgICAgcmV0dXJuIHsgb2s6IGZhbHNlLCBlcnJvcjogeyBjb2RlOiAnVU5FWFBFQ1RFRF9SRVNQT05TRScsIG1lc3NhZ2U6ICdVbmV4cGVjdGVkIHJlc3BvbnNlIGZyb20gR0RyaXZlIGNvbm5lY3Rpb24gc3RhdHVzIEFQSS4nIH19O1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICByZXR1cm4gaGFuZGxlQXhpb3NFcnJvcihlcnJvciBhcyBBeGlvc0Vycm9yLCAnZ2V0R0RyaXZlQ29ubmVjdGlvblN0YXR1cycpO1xuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkaXNjb25uZWN0R0RyaXZlKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxTa2lsbFJlc3BvbnNlPHsgbWVzc2FnZTogc3RyaW5nIH0+PiB7XG4gIGlmICghUFlUSE9OX0FQSV9TRVJWSUNFX0JBU0VfVVJMKSB7XG4gICAgcmV0dXJuIHsgb2s6IGZhbHNlLCBlcnJvcjogeyBjb2RlOiAnQ09ORklHX0VSUk9SJywgbWVzc2FnZTogJ1BZVEhPTl9BUElfU0VSVklDRV9CQVNFX1VSTCBub3QgY29uZmlndXJlZC4nIH19O1xuICB9XG4gIGlmICghdXNlcklkKSByZXR1cm4geyBvazogZmFsc2UsIGVycm9yOiB7IGNvZGU6ICdWQUxJREFUSU9OX0VSUk9SJywgbWVzc2FnZTogJ3VzZXJJZCBpcyByZXF1aXJlZC4nIH19O1xuXG4gIGNvbnN0IGVuZHBvaW50ID0gYCR7UFlUSE9OX0FQSV9TRVJWSUNFX0JBU0VfVVJMfS9hcGkvYXV0aC9nZHJpdmUvZGlzY29ubmVjdGA7XG4gIGNvbnN0IHBheWxvYWQgPSB7IHVzZXJfaWQ6IHVzZXJJZCB9O1xuICBsb2dnZXIuaW5mbyhgW2Rpc2Nvbm5lY3RHRHJpdmVdIERpc2Nvbm5lY3RpbmcgR0RyaXZlIGZvciB1c2VyICR7dXNlcklkfWApO1xuXG4gIHRyeSB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5wb3N0PFNraWxsUmVzcG9uc2U8eyBtZXNzYWdlOiBzdHJpbmcgfT4+KGVuZHBvaW50LCBwYXlsb2FkLCB7IHRpbWVvdXQ6IEdEUklWRV9ESVNDT05ORUNUX1RJTUVPVVQgfSk7XG4gICAgaWYgKHJlc3BvbnNlLmRhdGEgJiYgcmVzcG9uc2UuZGF0YS5vaykge1xuICAgICAgbG9nZ2VyLmluZm8oYFtkaXNjb25uZWN0R0RyaXZlXSBTdWNjZXNzZnVsbHkgZGlzY29ubmVjdGVkIEdEcml2ZSBmb3IgdXNlciAke3VzZXJJZH0uIE1lc3NhZ2U6ICR7cmVzcG9uc2UuZGF0YS5tZXNzYWdlfWApO1xuICAgICAgcmV0dXJuIHsgb2s6IHRydWUsIGRhdGE6IHsgbWVzc2FnZTogcmVzcG9uc2UuZGF0YS5tZXNzYWdlIHx8IFwiU3VjY2Vzc2Z1bGx5IGRpc2Nvbm5lY3RlZC5cIiB9LCBtZXNzYWdlOiByZXNwb25zZS5kYXRhLm1lc3NhZ2UgfTtcbiAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEgJiYgIXJlc3BvbnNlLmRhdGEub2sgJiYgcmVzcG9uc2UuZGF0YS5lcnJvcikge1xuICAgICAgbG9nZ2VyLndhcm4oYFtkaXNjb25uZWN0R0RyaXZlXSBGYWlsZWQuIEFQSSBFcnJvcjpgLCByZXNwb25zZS5kYXRhLmVycm9yKTtcbiAgICAgIHJldHVybiB7IG9rOiBmYWxzZSwgZXJyb3I6IHJlc3BvbnNlLmRhdGEuZXJyb3IgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLndhcm4oYFtkaXNjb25uZWN0R0RyaXZlXSBGYWlsZWQuIFVuZXhwZWN0ZWQgcmVzcG9uc2UuYCwgcmVzcG9uc2UuZGF0YSk7XG4gICAgICByZXR1cm4geyBvazogZmFsc2UsIGVycm9yOiB7IGNvZGU6ICdVTkVYUEVDVEVEX1JFU1BPTlNFJywgbWVzc2FnZTogJ1VuZXhwZWN0ZWQgcmVzcG9uc2UgZnJvbSBHRHJpdmUgZGlzY29ubmVjdCBBUEkuJyB9fTtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIGhhbmRsZUF4aW9zRXJyb3IoZXJyb3IgYXMgQXhpb3NFcnJvciwgJ2Rpc2Nvbm5lY3RHRHJpdmUnKTtcbiAgfVxufVxuXG5gYGBcbiJdfQ==